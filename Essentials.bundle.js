require({cache:{"geocortex/config":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.config={baseUrl:"http://localhost/",io:{errorHandler:function(e,t){dojo.publish("geocortex.Error",[e])},postLength:2e3,timeout:6e4},REST_version:"3.0",authenticationDialogId:null}})}}}),function(){require({cache:{"geocortex/essentials":function(){},"geocortex/essentials/ArcGisPortalSecurityContext":function(){define(["require","exports","./OAuth2Client","./utilities/DecomposedUri","./utilities/StringUtilities"],function(e,t,i,r,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t,i){this.baseUrl=e,this.domains=t,this.clientId=i}return e.prototype.initiate=function(){return this.tokenResult||(this.tokenResult=i.OAuth2Client.getTokenFromImplicitGrant()),this.tokenResult?(i.OAuth2Client.removeImplicitGrantParamsAndUpdateUrlHash(),!0):(this.error=i.OAuth2Client.getErrorFromImplicitGrant(),this.error||i.OAuth2Client.redirectToLogOnPage(this.getLogOnUrl(),this.clientId),i.OAuth2Client.removeImplicitGrantParamsAndUpdateUrlHash(),!1)},e.prototype.getLogOnUrl=function(){return this.baseUrl+"oauth2/authorize"},e.prototype.getToken=function(e){return this.tokenResult&&e&&this.appliesTo(e)?this.tokenResult.token:null},e.prototype.appliesTo=function(e){for(var t=r.DecomposedUri.getHost(e),i=0;i<this.domains.length;i++)if(n.StringUtilities.endsWith(t,this.domains[i]))return!0;return!1},e}();t.ArcGisPortalSecurityContext=s})},"geocortex/essentials/AsyncInitializable":function(){define(["require","exports","./../geocortex"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e){this.initializationFailure=null,this.isInitialized=!1,this.onInitializationFailed=null,this.onInitialized=null,this._initializing=!1,this.url=e,this._initializedHandler=dojo.hitch(this,this._initializedHandler),this._initializationFailedHandler=dojo.hitch(this,this._initializationFailedHandler),this._restLoadHandler=dojo.hitch(this,this._restLoadHandler),this._restErrorHandler=dojo.hitch(this,this._restErrorHandler)}return e.prototype.initialize=function(e){if(!this.isInitialized&&!this._initializing){var t=void 0!==e&&null!==e;if(t)this._restLoadHandler(!0,e);else{if(!this.url)throw new Error("Unable to initialize AsyncInitializable without a valid URL.");this._initializing=!0,i.request({url:this.url,content:{f:"json"},load:dojo.hitch(this,this._restLoadHandler,t),error:this._restErrorHandler,callbackParamName:"CallBack"})}}},e.prototype.doWhenInitialized=function(e,t){if(1===arguments.length&&(t=e,e=this),this.isInitialized)t.call(e,this);else var i=dojo.connect(this,"onInitialized",this,function(){dojo.disconnect(i),t.apply(e,arguments)})},e.prototype._configureObject=function(e,t){},e.prototype._initializationFailedHandler=function(e){this.initializationFailure=e,this.onInitializationFailed&&this.onInitializationFailed(e)},e.prototype._initializedHandler=function(e){this.isInitialized=!0,this.onInitialized&&this.onInitialized(e),this._initializing=!1},e.prototype._restErrorHandler=function(e){this._initializationFailedHandler(e),this._initializedHandler(this)},e.prototype._restLoadHandler=function(e,t){this._configureObject(t,e),this._initializedHandler(this)},e}();t.AsyncInitializable=r})},"geocortex/essentials/AuthenticationControlBlock":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){this.messageFromServer=null,this.password=null,this.pendingCalls=[],this.tokenService=null,this.tokenRootUri=null,this.targetRootUri=null,this.token=null,this.username=null};t.AuthenticationControlBlock=i})},"geocortex/essentials/AuthenticationControlBlockStore":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){this._authenticationControlBlocks=[]}return e.prototype.add=function(e){null===this.find(e.tokenRootUri)&&this._authenticationControlBlocks.push(e)},e.prototype.remove=function(e){for(var t=0;t<this._authenticationControlBlocks.length;t++)if(this._authenticationControlBlocks[t]===e)return this._authenticationControlBlocks.splice(t,1),!0;return!1},e.prototype.find=function(e){for(var t=0;t<this._authenticationControlBlocks.length;t++){var i=this._authenticationControlBlocks[t],r=i.tokenRootUri,n=i.targetRootUri;if(0===e.toLowerCase().indexOf(r.toLowerCase())||0===e.toLowerCase().indexOf(n.toLowerCase()))return i}return null},e.prototype.removeAt=function(e){this._authenticationControlBlocks.splice(e,1)},e}();t.AuthenticationControlBlockStore=i})},"geocortex/essentials/BaseMap":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(e){if(this.displayName=null,this.essentialsMap=null,this.extensions=[],this.id=null,this.iconUri=null,this.exportTilesMapServiceUri=null,this.properties={},this.services=[],!e)throw new Error("Essentials map is required for a basemap.");this.essentialsMap=e};t.BaseMap=i})},"geocortex/essentials/BaseMapService":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(e){if(this.mapService=null,!e)throw new Error("Map service is required for a basemap service.");this.mapService=e};t.BaseMapService=i})},"geocortex/essentials/DataLink":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./AsyncInitializable","./../geocortex"],function(e,i,r,n){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var s=function(e){function i(t){var i=e.call(this,t)||this;return i.displayName=null,i.extensions=[],i.id=null,i.visible=null,i.isOneToOne=!1,i.layer=null,i.parameters=[],i.searches=[],i.properties={},i._numDataLinkingRequests=0,i}return t(i,e),i.prototype.isDataLinking=function(){return!!this._numDataLinkingRequests},i.prototype.performDataLinking=function(e,t,i){var r=this,s=function(e){i&&i(new Error(e))};!e&&this.parameters.length>0&&s("No FeatureSetParameters provided");for(var a=this.url+"/link",o=null,l=0;l<this.parameters.length;l++){for(var u=this.parameters[l],c="",p=0;p<e.features.length;p++){var h=e.features[p],d=h.attributes[u.featureField];if(!d&&this.layer&&this.layer.fields){for(var f,y=0;y<this.layer.fields.length;y++){var m=this.layer.fields[y];if(m.name===u.featureField){f=m;break}}var v;if(f)f.alias&&f.alias in h.attributes?v=f.alias:f.displayName&&f.displayName in h.attributes&&(v=f.displayName),v&&v in h.attributes&&h.attributes[v]}c+=(0===c.length?"":",")+(d?this._prepParamValue(d):" ")}c&&c.length>0&&((o=null===o?{}:o)[u.id]=c)}if(o){var g=n.encodeJson(dojo.mixin({f:"json"},o));this._numDataLinkingRequests++,n.request({url:a,content:g,load:function(e){r._numDataLinkingRequests--,!e&&i&&i(new Error("No results")),e.error&&i&&i(e.error),t&&t(r._parseConvertDates(e.results))},error:function(e){r._numDataLinkingRequests--,i&&i(e)},callbackParamName:"CallBack"})}else s("Missing Feature Fields.")},i.prototype._configureObject=function(e,t){if(void 0===e||void 0===e.displayName||void 0===e.parameters)throw new Error("Incorrect data link object returned from initialization");if(this.displayName=e.displayName,this.id=e.id,this.visible=void 0===e.visible||e.visible,this.isOneToOne=!!e.isOneToOne,this.parameters=e.parameters,this.searches=e.searches,this.searches)for(var i=0,r=this.searches.length;i<r;i++)this.searches[i].dataLink=this;t&&(this.isInitialized=!0),this.properties=n._getProperties(e.properties),this.extensions=n._getExtensions(e.extensions)},i.prototype._parseConvertDates=function(e){for(var t in e)if(e.hasOwnProperty(t)){var i=e[t];if("string"==typeof i){if(i.length>6&&"/Date("===i.substring(0,6)){i=parseInt(i.substring(6));var r=new Date(i);e[t]=r}}else"object"==typeof i&&(e[t]=this._parseConvertDates(i))}return e},i.prototype._prepParamValue=function(e){var t="";return"number"==typeof e?t=e.toString():"string"==typeof e&&(t=e.replace(/,/g,"\\,")),t},i}(r.AsyncInitializable);i.DataLink=s})},"geocortex/essentials/DataLinkParameter":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){this.featureField=null,this.id=null,this.name=null,this.type=null};t.DataLinkParameter=i})},"geocortex/essentials/DataLinkSearch":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/DistanceUnit":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i,r,n=function(){function e(e,t){this.name=e,this.type=t}return e.prototype.isLinear=function(){return!(this.type===i.DEGREES||this.type===i.RADIANS||this.type===i.GRADS||this.type===i.OTHER)},e}();t.DistanceUnit=n,(r=i=t.DistanceUnitType||(t.DistanceUnitType={})).OTHER="Other",r.INCHES="Inches",r.FEET="Feet",r.US_SURVEY_FEET="USSurveyFeet",r.YARDS="Yards",r.MILES="Miles",r.NAUTICAL_MILES="NauticalMiles",r.MILLIMETERS="Millimeters",r.CENTIMETERS="Centimeters",r.DECIMETERS="Decimeters",r.METERS="Meters",r.KILOMETERS="Kilometers",r.DEGREES="Degrees",r.RADIANS="Radians",r.GRADS="Grads"})},"geocortex/essentials/EssentialsFeatureSet":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){}return e.prototype.toJson=function(){return JSON.stringify(this)},e}();t.EssentialsFeatureSet=i})},"geocortex/essentials/EssentialsLayerInfo":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){};t.EssentialsLayerInfo=i})},"geocortex/essentials/ExportMapImageOptions":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(e,t){void 0===t&&(t="Png"),this.defaultOutputFormat=t,this.allowIncludeGeoreferenceData=e};t.ExportMapImageOptions=i})},"geocortex/essentials/Extension":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(e,t){this.className=e,this.instance=t};t.Extension=i})},"geocortex/essentials/ExtentManager":function(){define(["require","exports"],function(e,t){"use strict";var i,r;Object.defineProperty(t,"__esModule",{value:!0}),(r=i||(i={}))[r.NONE=-1]="NONE",r[r.RESIZE=0]="RESIZE",r[r.REPOSITION=1]="REPOSITION",r[r.EXTENT_CHANGE=2]="EXTENT_CHANGE";var n=function(){function e(e,t){this._map=null,this._currentExtentChangePriority=-1,this._queuedExtentChangePriority=-1,this._queuedExtentChange=[],this._extentChangeInProgress=!1,this._fitTiledMapsToExtent=!1,this._newLayers=[],this._initialExtent=null,this.currentExtentChangeHandle=null,this._firstMapResizeExecuted=!1,this._map=e,this._fitTiledMapsToExtent=!!t,this._fitTiledMapsToExtent&&console.log("The fitTiledMapsToExtent parameter is active. When true, for maps that contain tiled map service layers, you are guaranteed to have the input extent shown completely on the map."),this._map.on("resize",dojo.hitch(this,this._onResize)),this._map.on("reposition",dojo.hitch(this,this._onReposition))}return e.prototype.setInitialExtent=function(e){var t=this;this._map&&this._map.loaded?this._setInitialExtentImpl(e):this._map.on("load",function(){return t._setInitialExtentImpl(e)})},e.prototype._setInitialExtentImpl=function(e){this._initialExtent=e;var t=esri.config.defaults.map.panDuration;esri.config.defaults.map.panDuration=0,this._map.reposition(),this._map.setExtent(e,this._fitTiledMapsToExtent),esri.config.defaults.map.panDuration=t,this._firstMapResizeExecuted=!0},e.prototype._setInitialExtentImplWithPromise=function(e){var t=this;return new Promise(function(i,r){t._map.setExtent(e).then(function(){i()},function(){i()})})},e.prototype._onResize=function(e,t,i){if(!this._firstMapResizeExecuted)return this._firstMapResizeExecuted=!0,void this.firstResize();this._handleNextExtentChange()},e.prototype._onReposition=function(e,t){this._handleNextExtentChange()},e.prototype._onExtentChange=function(){this._extentChangeInProgress&&(this._currentExtentChangePriority=-1,this._extentChangeInProgress=!1,this._handleNextExtentChange())},e.prototype.registerLayer=function(e){this._hasLoaded()||this._newLayers.push(e)},e.prototype.firstResize=function(){this._initialExtent&&this._map.extent&&!this._fitTiledMapsToExtent&&!this._map.extent.expand(1.75).contains(this._initialExtent)&&console.log("The 'fitTiledMapsToExtent' parameter may need to be set to true in configuration for the initial extent to be shown completely on the map."),this._handleNextExtentChange()},e.prototype._handleNextExtentChange=function(){if(this._hasLoaded())if(null!==this._queuedExtentChange[i.RESIZE]&&void 0!==this._queuedExtentChange[i.RESIZE]){var e=this._queuedExtentChange[i.RESIZE];this._queuedExtentChange[i.RESIZE]=null,e(this._map)}else if(null!==this._queuedExtentChange[i.REPOSITION]&&void 0!==this._queuedExtentChange[i.REPOSITION]){var t=this._queuedExtentChange[i.REPOSITION];this._queuedExtentChange[i.REPOSITION]=null,t(this._map)}else if(null!==this._queuedExtentChange[i.EXTENT_CHANGE]&&void 0!==this._queuedExtentChange[i.EXTENT_CHANGE]){this._extentChangeInProgress=!0,this._currentExtentChangePriority=this._queuedExtentChangePriority,this._queuedExtentChangePriority=-1;var r=this._queuedExtentChange[i.EXTENT_CHANGE];this._queuedExtentChange[i.EXTENT_CHANGE]=null,r(this._map)}},e.prototype.changeExtentWithPriority=function(e,t){var r=this,n=void 0!==t?t:5,s=function(t){null!==r.currentExtentChangeHandle&&r.currentExtentChangeHandle.cancel(),r.currentExtentChangeHandle=e(t),r.currentExtentChangeHandle.then(dojo.hitch(r,r._onExtentChange),dojo.hitch(r,r._onExtentChange))};if(this._isExtentChangeBlocked()){if(n<this._queuedExtentChangePriority)return;this._queuedExtentChangePriority=n,this._queuedExtentChange[i.EXTENT_CHANGE]=s}else{if(n<this._currentExtentChangePriority)return;this._currentExtentChangePriority=n,this._extentChangeInProgress=!0,s(this._map)}},e.prototype.setExtentWithPriority=function(e,t){var i=this;this.changeExtentWithPriority(function(t){return new Promise(function(r,n){t.setExtent(e,i._fitTiledMapsToExtent).finally(r())})},t)},e.prototype.centerAtWithPriority=function(e,t){this.changeExtentWithPriority(function(t){var i=t.extent.getCenter(),r=t.extent.getWidth()/t.width,n=t.extent.getHeight()/t.height;return e&&(Math.abs(i.x-e.x)>=r||Math.abs(i.y-e.y)>=n)?new Promise(function(i,r){t.centerAt(e).finally(i())}):Promise.resolve()},t)},e.prototype.setScaleWithPriority=function(e,t){this.changeExtentWithPriority(function(t){return e!==t.getScale()?new Promise(function(i,r){t.setScale(e).finally(i())}):Promise.resolve()},t)},e.prototype.blockForResize=function(e,t,r){e===this._map.width&&t===this._map.height||(this._isResizeBlocked()?this._queuedExtentChange[i.RESIZE]=function(e){e.position.update(0,0),e.resize(r)}:(this._map.position.update(0,0),this._map.resize(r)))},e.prototype.blockForReposition=function(){this._isRepositionBlocked()?this._queuedExtentChange[i.REPOSITION]=function(e){e.position.update(0,0),e.resize()}:(this._map.position.update(0,0),this._map.resize())},e.prototype._isExtentChangeBlocked=function(){return null!=this._queuedExtentChange[i.REPOSITION]||null!=this._queuedExtentChange[i.RESIZE]||!this._hasLoaded()},e.prototype._isRepositionBlocked=function(){return this._extentChangeInProgress||!this._hasLoaded()},e.prototype._isResizeBlocked=function(){return this._isRepositionBlocked()},e.prototype._hasLoaded=function(){return this._map&&this._map.loaded&&this._firstMapResizeExecuted},e}();t.ExtentManager=n})},"geocortex/essentials/FeatureCluster":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/FeatureHeatMap":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/FeatureHyperlink":function(){define(["require","exports","./RestHelper"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(e,t){this.encodeUriReplacementValues=e.encodeUriReplacementValues,this.target=e.target,this.text=e.text,this.toolTip=e.toolTip;var r=null;t&&t.mapService&&t.mapService.essentialsMap&&(r=t.mapService.essentialsMap.site),this.uri=i.RestHelper.processClientSideTokens(r,e.uri),this.iconUri=i.RestHelper.processClientSideTokens(r,e.iconUri),this.layer=t};t.FeatureHyperlink=r})},"geocortex/essentials/FeatureLayerService":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./MapService","./../geocortex","./RestHelperHTTPService"],function(e,i,r,n,s){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var a=function(e){function i(t){var i=e.call(this,t)||this;return i.color=[255,0,0],i.selectionColor=[0,255,255],i.disableClientCaching=!1,i.onDemandCacheSize=1e3,i.outFields="",i.queryMode=esri.layers.FeatureLayer.MODE_ONDEMAND,i.tileHeight=null,i.tileWidth=null,i.where=null,i.canUpdate=null,i.canAdd=null,i.canDelete=null,i.canEdit=null,i.canAddAttachments=null,i.moveEnabled=null,i.rotateEnabled=null,i.editVerticesEnabled=null,i.scaleEnabled=null,i.renderer=null,i._colorSet=!1,i._initialFeatureCollection=null,i._serviceLayer=null,i.serviceUrl=t,i}return t(i,e),i.prototype.getEmptyFeatureCollection=function(){return JSON.parse(this._initialFeatureCollection)},i.prototype.restoreFeatureLayer=function(){if(!this._serviceLayer._mode)switch(this._serviceLayer.mode){case esri.layers.FeatureLayer.MODE_SNAPSHOT:this._serviceLayer._mode=new esri.layers._SnapshotMode(this._serviceLayer);break;case esri.layers.FeatureLayer.MODE_ONDEMAND:this._serviceLayer._mode=new esri.layers._OnDemandMode(this._serviceLayer);break;case esri.layers.FeatureLayer.MODE_SELECTION:this._serviceLayer._mode=new esri.layers._SelectionMode(this._serviceLayer)}this.replaceFeatureLayer(this._serviceLayer,!0,!0,!0),this.serviceLayer.resume(),this.serviceLayer.mode===esri.layers.FeatureLayer.MODE_SNAPSHOT&&0===this.serviceLayer.graphics.length&&this.serviceLayer.refresh()},i.prototype.replaceFeatureLayer=function(e,t,i,r){var n=this.serviceLayer;if(!e)throw new Error("featureLayer cannot be null in order to replace the feature layer.");var s=this._getEsriMap();if(!s)throw new Error("Unable to get access to the Esri map object to perform the Feature Layer replace.");if(!this.serviceLayer)throw new Error("ServiceLayer not present. Can't replace the the FeatureLayer");t&&(e.visible=n.visible,e.setMaxScale(n.maxScale),e.setMinScale(n.minScale)),i&&(e.opacity=n.opacity),r&&e.setRenderer(n.renderer);var a=dojo.indexOf(s.graphicsLayerIds,n.id);this.serviceLayer=e,n.suspend(),s.removeLayer(n),s.addLayer(e,a),n.url||this._cleanUpLayer(n)},i.prototype._cleanUpLayer=function(e){if(e.clear(),e._essentialsMetadata){var t=e._essentialsMetadata.eventHandlers,i=0;for(i=0;i<t.length;i++)dojo.disconnect(t[i])}},i.prototype.queryCount=function(e,t,i){this.isServiceLayerLoaded&&this.serviceLayer&&this.serviceLayer.queryCount(e,function(e){t&&t(e)},function(e){i&&i(e)})},i.prototype.queryFeatures=function(e,t,i){if(this.isServiceLayerLoaded&&this.serviceLayer)return this.serviceLayer.queryFeatures(e,t,i);var r=new Error("Esri layer has not finished loading");if(i)return i(r),null;var n=new dojo.Deferred;return n.reject(r),n},i.prototype.queryIds=function(e,t,i){if(this.isServiceLayerLoaded&&this.serviceLayer)return this.serviceLayer.queryIds(e,t,i);if(i){var r=new Error("Esri layer has not finished loading");i(r);var n=new dojo.Deferred;return n.reject(r),n}},i.prototype.queryRelatedFeatures=function(e,t,i){if(this.isServiceLayerLoaded&&this.serviceLayer)return this.serviceLayer.queryRelatedFeatures(e,t,i);if(i){var r=new Error("Esri layer has not finished loading");i(r);var n=new dojo.Deferred;return n.reject(r),n}},i.prototype._getEsriMap=function(){var e=null;return null!==this.essentialsMap&&null!==this.essentialsMap.site&&(e=this.essentialsMap.site.getMap()),e},i.prototype._configureObject=function(t,i){if(void 0===t||void 0===t.outFields||void 0===t.queryMode||void 0===t.where)throw new Error("Incorrect map service object returned from initialization");this._configurePropertiesAndrenderer(t),e.prototype._configureObject.call(this,t,i)},i.prototype._configurePropertiesAndrenderer=function(e){if(this.disableClientCaching=!!e.disableClientCaching,this.onDemandCacheSize=void 0===e.onDemandCacheSize||null===e.onDemandCacheSize?this.onDemandCacheSize:e.onDemandCacheSize,e.outFields||(e.outFields="*"),this.outFields=e.outFields,this.where=e.where,void 0===e.queryMode)this.queryMode=esri.layers.FeatureLayer.MODE_ONDEMAND;else switch(e.queryMode){case"Selection":case"SelectionOnly":this.queryMode=esri.layers.FeatureLayer.MODE_SELECTION;break;case"Snapshot":this.queryMode=esri.layers.FeatureLayer.MODE_SNAPSHOT;break;default:this.queryMode=esri.layers.FeatureLayer.MODE_ONDEMAND}if(e.tileHeight&&(this.tileHeight=e.tileHeight),e.tileWidth&&(this.tileWidth=e.tileWidth),e.selectionColor&&(this.selectionColor=e.selectionColor),e.color&&(this.color=e.color,this._colorSet=!0,this.color.length>3&&(this.color[3]=this.color[3]/255)),this.editVerticesEnabled=!e.hasOwnProperty("editVerticesEnabled")||e.editVerticesEnabled,this.moveEnabled=!e.hasOwnProperty("moveEnabled")||e.moveEnabled,this.scaleEnabled=!e.hasOwnProperty("scaleEnabled")||e.scaleEnabled,this.rotateEnabled=!e.hasOwnProperty("rotateEnabled")||e.rotateEnabled,e.renderer)try{this.renderer=esri.renderer.fromJson(e.renderer)}catch(e){}},i.prototype._updateServiceToken=function(t){if(e.prototype._updateServiceToken.call(this,t),this.serviceLayer){var i=this.serviceLayer._task;i&&i._url&&i._url.query&&(i._url.query.token=t)}},i.prototype._createServiceLayer=function(){e.prototype._createServiceLayer.call(this);var t=this.serviceUrl;this.serviceToken&&(t=s.RestHelperHTTPService.appendTokenToUrl(t,this.serviceToken));var i={};i.id=this.id,i.opacity=this.configuredOpacity,i.visible=this._computeInitServiceLayerVisibility(),this.outFields&&this.outFields.length>0&&(i.outFields=this.outFields.split(",")),null!==this.queryMode&&(i.mode=this.queryMode),null!==this.tileHeight&&null!==this.tileWidth&&this.queryMode==esri.layers.FeatureLayer.MODE_ONDEMAND&&(i.tileHeight=this.tileHeight,i.tileWidth=this.tileWidth),this.serviceLayer=new esri.layers.FeatureLayer(t,i),this.serviceLayer.setRenderer(this.renderer),this.attributionDataUrl&&""!==this.attributionDataUrl?(this.serviceLayer.attributionDataUrl=this.attributionDataUrl,this.serviceLayer.hasAttributionData=!0):this.hasAttributionData&&(this.serviceLayer.attributionDataUrl=this.url+"/Attribution",this.serviceLayer.hasAttributionData=!0),this._serviceLayer=this.serviceLayer,this.where&&this.serviceLayer.setDefinitionExpression(this.where),dojo.connect(this.serviceLayer,"onError",this,this._layerLoadErrorHandler),this.serviceLayer.loaded?this._handleLayerLoadEvent(this.serviceLayer):dojo.connect(this.serviceLayer,"onLoad",dojo.hitch(this,this._handleLayerLoadEvent)),e.prototype.initiateServiceFailureTimer.call(this)},i.prototype._computeInitServiceLayerVisibility=function(){var e=this._initiallyVisible;return e&&this.layers&&1===this.layers.length&&(e=this.layers[0].isVisible()),e},i.prototype._handleLayerLoadEvent=function(e){if(this.serviceLayer.version<10||this._colorSet){var t=null;if("esriGeometryPoint"==this.serviceLayer.geometryType){t=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,15,null,new esri.Color(this.selectionColor));var i=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,15,null,new esri.Color(this.color)),r=new esri.renderer.SimpleRenderer(i);this.serviceLayer.setRenderer(r)}else if("esriGeometryPolyline"==this.serviceLayer.geometryType){t=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color(this.selectionColor),1);var n=new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color(this.color),1),s=new esri.renderer.SimpleRenderer(n);this.serviceLayer.setRenderer(s)}else if("esriGeometryPolygon"==this.serviceLayer.geometryType){t=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color([0,0,0]),1),new esri.Color(this.selectionColor));var a=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color([0,0,0]),1),new esri.Color(this.color)),o=new esri.renderer.SimpleRenderer(a);this.serviceLayer.setRenderer(o)}this.serviceLayer.setSelectionSymbol(t)}var l=this.serviceLayer.getEditCapabilities();this.canUpdate=l.canUpdate,this.canAdd=l.canCreate,this.canDelete=l.canDelete,this.canEdit=this.serviceLayer.isEditable(),this.canAddAttachments=!1,this.serviceLayer.capabilities&&(this.canAddAttachments=this.serviceLayer.version&&this.serviceLayer.version>=10.1&&this.serviceLayer.hasAttachments&&this.canEdit),this._initialFeatureCollection=JSON.stringify(this.serviceLayer.toJson()),this._handleServiceLayerLoaded(e)},i.prototype.hasOriginRelationships=function(){if(this.serviceLayer&&this.serviceLayer.version>=10.1&&this.serviceLayer.relationships&&this.serviceLayer.relationships.length>0){for(var e=0;e<this.serviceLayer.relationships.length;e++)if("esriRelRoleOrigin"===this.serviceLayer.relationships[e].role)return!0;return!1}return!1},i.prototype.getRelatedFeatureLayer=function(e,t,i){var r=new dojo.Deferred;if(this.serviceLayer.version<10.1)return o=new Error("getRelatedFeatureLayer is only available for feature layer from ArcGIS 10.1 or greater."),r&&-1==r.fired&&r.resolve(o),"function"==typeof i&&i(o),r;var a=this._getEsriRelation(e);if(!a){var o=new Error("Relation not found: "+e);return r&&r.reject(o),"function"==typeof i&&i(o),r}var l=this.serviceUrl.substring(0,this.serviceUrl.lastIndexOf("/")+1)+a.relatedTableId;this.serviceToken&&(l=s.RestHelperHTTPService.appendTokenToUrl(l,this.serviceToken)),void 0===esri.getProxyRule(l)&&null!==this.proxyUrl&&esri.addProxyRule({urlPrefix:l,proxyUrl:this.proxyUrl});var u=new esri.layers.FeatureLayer(l,{mode:esri.layers.FeatureLayer.MODE_SELECTION,outFields:["*"]});return dojo.connect(u,"onLoad",dojo.hitch(this,function(e){n.deferredResolve(r,e),"function"==typeof t&&t(e)})),dojo.connect(u,"onError",dojo.hitch(this,function(e){r&&-1==r.fired&&r.resolve(e),"function"==typeof i&&i(e)})),r},i.prototype._getEsriRelation=function(e){if("string"==typeof e&&(e=parseInt(e)),this.serviceLayer.relationships)for(var t=0;t<this.serviceLayer.relationships.length;t++)if(this.serviceLayer.relationships[t].id==e)return this.serviceLayer.relationships[t];return null},i.prototype._getRelation=function(e){return this.layers&&this.layers.length>0?this.layers[0]._getRelation(e):null},i}(r.MapService);i.FeatureLayerService=a})},"geocortex/essentials/Field":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){};i.esriFieldTypeSmallInteger="esriFieldTypeSmallInteger",i.esriFieldTypeInteger="esriFieldTypeInteger",i.esriFieldTypeSingle="esriFieldTypeSingle",i.esriFieldTypeDouble="esriFieldTypeDouble",i.esriFieldTypeString="esriFieldTypeString",i.esriFieldTypeDate="esriFieldTypeDate",i.esriFieldTypeOID="esriFieldTypeOID",i.esriFieldTypeGeometry="esriFieldTypeGeometry",i.esriFieldTypeBlob="esriFieldTypeBlob",i.esriFieldTypeRaster="esriFieldTypeRaster",i.esriFieldTypeGUID="esriFieldTypeGUID",i.esriFieldTypeGlobalID="esriFieldTypeGlobalID",i.esriFieldTypeXML="esriFieldTypeXML",t.EsriFieldTypes=i;var r=function(){};r.essentialsFieldTypeSmallInteger="Int16",r.essentialsFieldTypeInteger="Int32",r.essentialsFieldTypeSingle="Single",r.essentialsFieldTypeDouble="Double",r.essentialsFieldTypeString="String",r.essentialsFieldTypeDate="DateTime",r.essentialsFieldTypeGUID="Guid",r.essentialsFieldTypeObject="Object",t.EssentialsFieldTypes=r;var n=function(){function e(e){if(this.layer=null,!e||!e.layer)throw new Error("Layer is required.");this.layer=e.layer,this.alias=e.alias,this.dataType=e.dataType,this.displayName=e.displayName,this.focusField=!!e.focusField,this.hyperlinkLabel=e.hyperlinkLabel,this.name=e.name,this.searchable=!!e.searchable,this.visible=!!e.visible,this.editable=null===e.editable||void 0===e.editable||e.editable,this.format=e.format}return e.prototype.toJson=function(){return{alias:this.alias,dataType:this.dataType,displayName:this.displayName,focusField:this.focusField,hyperlinkLabel:this.hyperlinkLabel,name:this.name,searchable:this.searchable,visible:this.visible,editable:this.editable,format:this.format}},e.convertFromEsriType=function(e){if(!e||0!==e.indexOf("esriFieldType"))return e;switch(e){case i.esriFieldTypeGeometry:case i.esriFieldTypeBlob:case i.esriFieldTypeRaster:return r.essentialsFieldTypeObject;case i.esriFieldTypeDate:return r.essentialsFieldTypeDate;case i.esriFieldTypeDouble:return r.essentialsFieldTypeDouble;case i.esriFieldTypeGlobalID:return r.essentialsFieldTypeGUID;case i.esriFieldTypeInteger:case i.esriFieldTypeOID:return r.essentialsFieldTypeInteger;case i.esriFieldTypeSingle:return r.essentialsFieldTypeSingle;case i.esriFieldTypeSmallInteger:return r.essentialsFieldTypeSmallInteger;case i.esriFieldTypeGUID:case i.esriFieldTypeString:case i.esriFieldTypeXML:default:return r.essentialsFieldTypeString}},e.convertToEsriFieldType=function(e){switch(e){case r.essentialsFieldTypeObject:return i.esriFieldTypeBlob;case r.essentialsFieldTypeDate:return i.esriFieldTypeDate;case r.essentialsFieldTypeDouble:return i.esriFieldTypeDouble;case r.essentialsFieldTypeGUID:return i.esriFieldTypeGlobalID;case r.essentialsFieldTypeInteger:return i.esriFieldTypeInteger;case r.essentialsFieldTypeSingle:return i.esriFieldTypeSingle;case r.essentialsFieldTypeSmallInteger:return i.esriFieldTypeSmallInteger;case r.essentialsFieldTypeString:default:return i.esriFieldTypeString}},e}();t.Field=n})},"geocortex/essentials/GeocodingEndpoint":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./../geocortex","./AsyncInitializable","./ServiceHelper"],function(e,i,r,n,s){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var a,o,l=function(e){function i(t){var i=e.call(this,t)||this;return i.bingProperties=null,i.displayName=null,i.extensions=[],i.id=null,i.properties={},i.geocoderType=null,i.geocoderUrl=null,i.geocoderToken=null,i.includeInGlobalSearch=!1,i.iconUri=null,i.featureZoomScale=null,i.isDefaultReverseGeocoder=!1,i.site=null,i.parameters=[],i.globalSearchKey=null,i.isDefaultBatchGeocoder=!1,i}return t(i,e),i.prototype._configureObject=function(e){if(!(e.hasOwnProperty("id")&&e.hasOwnProperty("displayName")&&e.hasOwnProperty("serviceType")&&e.hasOwnProperty("connectionString")&&e.hasOwnProperty("globalSearchKey")&&e.hasOwnProperty("parameters")))throw new Error("Incorrect geocoding endpoint object returned from initialization");this.id=e.id,this.displayName=e.displayName,this.iconUri=e.iconUri,this.featureZoomScale=e.featureZoomScale,this.geocoderType=e.serviceType,this.includeInGlobalSearch=e.includeInGlobalSearch,this.isDefaultReverseGeocoder=e.isDefaultReverseGeocoder,this.globalSearchKey=e.globalSearchKey,this.isDefaultBatchGeocoder=e.isDefaultBatchGeocoder,this._processConnectionString(e.connectionString),this.properties=r._getProperties(e.properties),this.extensions=r._getExtensions(e.extensions),this.parameters=e.parameters},i.prototype._processConnectionString=function(e){var t=s.ServiceHelper.extractConnectionStringValue;if(this.geocoderType===a.BING_GEOCODER){this.bingProperties={};var i=t(e,"key");i&&i.length>0&&(this.bingProperties.bingMapsKey=i),(i=t(e,"culture"))&&i.length>0&&(this.bingProperties.culture=i)}else if(this.geocoderType===a.ARCGIS_GEOCODER){var r=t(e,"url");r&&r.length>0&&(this.geocoderUrl=r),this.geocoderToken=t(e,"token")}else console.error("Unknown geocoder type '"+this.geocoderType+"'")},i}(n.AsyncInitializable);i.GeocodingEndpoint=l,(o=a=i.GeocodingEndpointType||(i.GeocodingEndpointType={})).ARCGIS_GEOCODER="ArcGisGeocoder",o.BING_GEOCODER="BingGeocoder"})},"geocortex/essentials/GeometryEndpoint":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./AsyncInitializable","./../geocortex","./ServiceHelper"],function(e,i,r,n,s){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var a,o=function(e){function i(t){var i=e.call(this,t)||this;return i.displayName=null,i.extensions=[],i.id=null,i.properties={},i.geometryServiceType=null,i.geometryServiceUrl=null,i.geometryServiceToken=null,i.site=null,i}return t(i,e),i.prototype._configureObject=function(e){if(void 0===e.id||void 0===e.displayName||void 0===e.connectionString)throw new Error("Incorrect geometry endpoint object returned from initialization");this.id=e.id,this.displayName=e.displayName,this.geometryServiceType=e.serviceType,this._processConnectionString(e.connectionString),this.properties=n._getProperties(e.properties),this.extensions=n._getExtensions(e.extensions)},i.prototype._processConnectionString=function(e){var t=s.ServiceHelper.extractConnectionStringValue;if(this.geometryServiceType===a.ARCGIS_GEOMETRY){var i=t(e,"url");i&&i.length>0&&(this.geometryServiceUrl=i),this.geometryServiceToken=t(e,"token")}else console.error("Unknown geometry service type '"+this.geometryServiceType+"'")},i}(r.AsyncInitializable);i.GeometryEndpoint=o,(a=i.GeometryEndpointType||(i.GeometryEndpointType={})).ARCGIS_GEOMETRY="ArcGisGeometry"})},"geocortex/essentials/GeometryUtilities":function(){define(["require","exports"],function(e,t){"use strict";function i(e,t,i){return null==e||null==t?i:!!(e.isWebMercator&&t.isWebMercator&&e.isWebMercator()&&t.isWebMercator())||e.wkid===t.wkid&&(e.wkid>0||e.wkt.toLowerCase()==t.wkt.toLowerCase())}function r(e){var t=e.rings[0][0],i=e.rings[0][1],r=null,n=e.rings[0].slice(2,e.rings[0].length);n.push(t);for(var s=0;s<n.length;++s){var a=n[s],o=this.crossProduct(a,t,i);if(o>0&&!0===r||o<0&&!1===r)return!1;r=o>0,t=i,i=a}return!0}function n(e,t,i){return i||(i=[0,0]),(e[0]-i[0])*(t[1]-i[1])-(e[1]-i[1])*(t[0]-i[0])}Object.defineProperty(t,"__esModule",{value:!0}),t.spatialRefsAreEqual=i,t.envelopesAreEqual=function(e,t){return null==e||null==t?null==e&&null==t:i(e.spatialReference,t.spatialReference)&&e.xmin==t.xmin&&e.ymin==t.ymin&&e.xmax==t.xmax&&e.ymax==t.ymax},t.getExtent=function(e){if(e.length)var t=new esri.geometry.Extent(Number.MAX_VALUE,Number.MAX_VALUE,Number.MIN_VALUE,Number.MIN_VALUE,e[0].spatialReference);for(var i=0;i<e.length;++i){var r=e[i].getExtent();t.xmin=Math.min(r.xmin,t.xmin),t.ymin=Math.min(r.ymin,t.ymin),t.xmax=Math.min(r.xmax,t.xmax),t.xmax=Math.min(r.ymax,t.ymax)}return t},t.envelopeToPolygon=function(e){var t=new esri.geometry.Polygon(e.spatialReference);return t.addRing([[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]),t},t.isValidGeometry=function(e){if("polygon"!=e.type)return!0;var t=e;if(0==t.rings.length||t.rings.length<3)return!0;if(r(t)){var i=t.rings[0][0],s=t.rings[0][1],a=t.rings[0].slice(2,t.rings[0].length);for(a.push(i),h=0;h<a.length;++h){var o=a[h];if(n(i,o,s)>0)return!0;i=s,s=o}return!1}for(var l=0,u=0;u<t.rings.length;++u)for(var c=t.rings[u],p=0,h=0;h<c.length;++h)p=(h+1)%c.length,l+=c[h][0]*-c[p][1],l-=-c[h][1]*c[p][0];return l>0},t.isSelfIntersectingPolygon=function(e){if(esri.geometry.polygonSelfIntersecting)return esri.geometry.polygonSelfIntersecting(e);if(e.isSelfIntersecting)return e.isSelfIntersecting(e);throw new Error("No self intersection method found")},t.isConvex=r,t.pointInEnvelope=function(e,t){if(!this.spatialRefsAreEqual(e.spatialReference,t.spatialReference,!0))throw new Error("Mismatched spatial references.");return!(e.x<t.xmin||e.x>t.xmax||e.y<t.ymin||e.y>t.ymax)},t.clipEnvelope=function(e,t){if(!this.spatialRefsAreEqual(e.spatialReference,t.spatialReference,!0))throw new Error("Mismatched spatial references.");var i=new esri.geometry.Extent(e.xmin,e.ymin,e.xmax,e.ymax,e.spatialReference),r=function(e,t,i){return e<t?t:e>i?i:e};return i.xmin=r(e.xmin,t.xmin,t.xmax),i.xmin=r(e.ymin,t.ymin,t.ymax),i.xmin=r(e.xmax,t.xmin,t.xmax),i.xmin=r(e.ymax,t.ymin,t.ymax),i},t.scaleEnvelope=function(e,t,i){return new esri.geometry.Extent(e.xmin*t,e.ymin*i,e.xmax*t,e.ymax*i,e.spatialReference)},t.scaleEnvelopeWithoutTranslation=function(e,t){if(null==e)return null;var i=e.getCenter();return new esri.geometry.Extent(i.x-e.getWidth()*(t/2),i.y-e.getHeight()*(t/2),i.x+e.getWidth()*(t/2),i.y+e.getHeight()*(t/2),e.spatialReference)},t.computeDistance=function(e,t){var i=t.x-e.x,r=t.y-e.y;return Math.sqrt(i*i+r*r)},t.translateEnvelope=function(e,t,i){return new esri.geometry.Extent(e.xmin+t,e.ymin+i,e.xmax+t,e.ymax+i,e.spatialReference)},t.length=function(e){return Math.sqrt(e.x*e.x+e.y*e.y)},t.normalize=function(e){var t=this.length(e);return new esri.geometry.Point(e.x/t,e.y/t)},t.angle=function(e,t){if(!this.spatialRefsAreEqual(e.spatialReference,t.spatialReference,!0))throw new Error("Mismatched spatial references");return Math.acos(this.dotProduct(e,t)/Math.sqrt(this.dotProduct(e,e)*this.dotProduct(t,t)))},t.crossProduct=function(e,t,i){if(!this.spatialRefsAreEqual(e.spatialReference,t.spatialReference,!0))throw new Error("Mismatched spatial references");return i||(i=new esri.geometry.Point(0,0)),(e.x-i.x)*(t.y-i.y)-(e.y-i.y)*(t.x-i.x)},t.crossProductArray=n,t.dotProduct=function(e,t){if(!this.spatialRefsAreEqual(e.spatialReference,t.spatialReference,!0))throw new Error("Mismatched spatial references");return e.x*t.x+e.y*t.y},t.polygonMidpoint=function(e){if(0==e.length)throw new Error("Expected at least one point in polygonMidPoint.");for(var t=0,i=0,r=0;r<e.length;++r){var n=e[r];t+=n.x,i+=n.y}return t/=e.length,i/=e.length,new esri.geometry.Point(t,i,e[0].spatialReference)}})},"geocortex/essentials/GeoprocessingEndpoint":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./AsyncInitializable","./../geocortex","./ServiceHelper"],function(e,i,r,n,s){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var a,o=function(e){function i(t){var i=e.call(this,t)||this;return i.displayName=null,i.extensions=[],i.id=null,i.properties={},i.geoprocessorType=null,i.geoprocessorUrl=null,i.site=null,i}return t(i,e),i.prototype._configureObject=function(e){if(void 0===e.id||void 0===e.displayName||void 0===e.connectionString)throw new Error("Incorrect geoprocessing endpoint object returned from initialization");this.id=e.id,this.displayName=e.displayName,this.geoprocessorType=e.geoprocessorType||e.serviceType,this._processConnectionString(e.connectionString),this.properties=n._getProperties(e.properties),this.extensions=n._getExtensions(e.extensions)},i.prototype._processConnectionString=function(e){var t=s.ServiceHelper.extractConnectionStringValue;if(this.geoprocessorType!==a.ARCGIS_GEOPROCESSOR)throw new Error("Unknown geoprocessor type '"+this.geoprocessorType+"'");var i=t(e,"url");i&&i.length>0&&(this.geoprocessorUrl=i)},i}(r.AsyncInitializable);i.GeoprocessingEndpoint=o,(a=i.GeoprocessingEndpointType||(i.GeoprocessingEndpointType={})).ARCGIS_GEOPROCESSOR="ArcGisGeoprocessor"})},"geocortex/essentials/GeoRssLayerService":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./MapService","./RestHelper","./XmlUtils","./RestHelperHTTPService"],function(e,i,r,n,s,a){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var o=function(e){function i(t){var i=e.call(this,t)||this;return i._colorSet=!1,i._layerLoadCompleted=null,i.color=null,i.feedUrl=null,i.feedImageUri=null,i.updateInterval=null,i.pictureSymbol=null,i.markerSymbol=null,i.geoRssLayer=null,i.mapSpatialReference=null,i.geometryService=null,i}return t(i,e),i.prototype._configureObject=function(t,r){if(void 0===t)throw new Error("Incorrect map service object returned from initialization");i.webMercatorSref=new esri.SpatialReference({wkid:102100}),i.wgs84Sref=new esri.SpatialReference({wkid:4326}),this.feedImageUri=t.feedImageUri,this.updateInterval=t.updateInterval,this.geoRssLayer=new esri.layers.GraphicsLayer({opacity:t.opacity,id:t.id,visible:t.visible}),dojo.connect(this.geoRssLayer,"onError",this,this._layerLoadErrorHandler),t.color&&(this.color=t.color,this._colorSet=!0,this.color.length>3&&(this.color[3]=this.color[3]/255)),e.prototype._configureObject.call(this,t,r),this.attributionDataUrl&&""!==this.attributionDataUrl?(this.geoRssLayer.attributionDataUrl=this.attributionDataUrl,this.geoRssLayer.hasAttributionData=!0):this.hasAttributionData&&(this.geoRssLayer.attributionDataUrl=this.url+"/Attribution",this.geoRssLayer.hasAttributionData=!0)},i.prototype._createServiceLayer=function(){var e=this,t=null;if(this.essentialsMap&&(t=this.essentialsMap.site,this.mapSpatialReference=this.essentialsMap.initialExtent.spatialReference),this.feedImageUri?(this.feedImageUri=n.RestHelper.processClientSideTokens(t,this.feedImageUri),this.pictureSymbol=new esri.symbol.PictureMarkerSymbol(this.feedImageUri,25,25)):this.markerSymbol=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,15,new esri.symbol.SimpleLineSymbol,new esri.Color(this.color)),this.feedUrl=this.serviceUrl,this._loadFeed(),this.updateInterval&&!isNaN(this.updateInterval)){this._layerLoadCompleted=!1;var i=setInterval(function(){e._layerLoadCompleted&&e._loadFeed(),e._layerLoadCompleted=!1},1e3*this.updateInterval);dojo.connect(window,"onunload",function(){clearInterval(i)})}this.serviceLayer=this.geoRssLayer},i.prototype._loadFeed=function(){esri.config.defaults.io.proxyUrl&&esri.request({url:this.serviceUrl,content:{},handleAs:"xml",load:dojo.hitch(this,this._handleFeed),error:function(e){e&&e.message&&"string"==typeof e.message&&alert(e.message)}})},i.prototype._handleFeed=function(e){var t="http://www.georss.org/georss",i=this._getFeedRoot(e);if(i){var r=i.nodeName,n=s.getAttribute(i,"xml:base"),a=[],o=null;if("feed"===r?o=s.getNodes("feed","entry",e):"rdf"===r?o=s.getNodes("rdf","item",e):"rss"===r&&(o=s.getNodes("channel","item",e)),o){var l=this.pictureSymbol||this.markerSymbol;o.forEach(dojo.hitch(this,function(e,i,o){var u,c,p,h=null;if(s.getAllNodes(e).forEach(dojo.hitch(this,function(e,i,a){e.nodeName&&("title"===e.nodeName&&(u=e.firstChild.nodeValue),"feed"===r?"summary"===e.nodeName&&(p=e.firstChild.nodeValue):"description"===e.nodeName&&(p=e.firstChild.nodeValue),"link"===e.nodeName&&(c="feed"===r?(n||"")+s.getAttribute(e,"href"):(n||"")+e.firstChild.nodeValue),("georss:where"===e.nodeName||"where"===e.nodeName&&e.namespaceURI===t)&&(h=this._getGMLGRSSPoint(e)),("georss:point"===e.nodeName||"point"===e.nodeName&&e.namespaceURI===t)&&(h=this._getSimpleGRSSPoint(e)),("geo:lat"===e.nodeName||"lat"===e.nodeName&&"http://www.w3.org/2003/01/geo/wgs84_pos#"===e.namespaceURI)&&(h=this._getW3CGRSSPoint(e)))})),h){var d={title:u,content:p,link:c};a.push(new esri.Graphic(h,l,d,null))}})),this.mapSpatialReference&&this._projectShapes(a,this.mapSpatialReference)}}},i.prototype._projectShapes=function(e,t){if(e&&t){for(var r=!1,n=i.webMercatorSref.wkid,s=i.wgs84Sref.wkid,o=0;o<e.length;o++){var l=e[o],u=null;l.geometry&&l.geometry.spatialReference.wkid!==t.wkid&&(t.wkid===n&&l.geometry.spatialReference.wkid===s?u=esri.geometry.geographicToWebMercator(l.geometry):t.wkid===s&&l.geometry.spatialReference.wkid===n?u=esri.geometry.webMercatorToGeographic(l.geometry):(u=esri.geometry.geographicToWebMercator(l.geometry),r=!0),l.geometry=u)}if(r){var c=[],p=this.geometryServiceUrl||this._getDefaultGeometryServiceUrl(),h=this.geometryServiceUrl?null:this._getDefaultGeometryServiceToken();null!==h&&(p=a.RestHelperHTTPService.appendTokenToUrl(p,h)),this.geometryService=new esri.tasks.GeometryService(p),dojo.forEach(e,function(e){c.push(e.geometry)});var d=new esri.tasks.ProjectParameters;return d.geometries=c,d.outSR=t,void this.geometryService.project(d,dojo.hitch(this,function(t){for(var i=0;i<t.length;i++)e[i].geometry=t[i];this._publishLayer(e)}),this._projectionError)}}this._publishLayer(e)},i.prototype._publishLayer=function(e){if(this.geoRssLayer){this.geoRssLayer.clear(),dojo.forEach(e,dojo.hitch(this,function(e){this.geoRssLayer.add(e)})),this.geoRssLayer.redraw();var t={esriLayer:this.geoRssLayer};dojo.publish("geoRssLayerLoaded",[t]),this._layerLoadCompleted=!0}},i.prototype._projectionError=function(e){},i.prototype._getSimpleGRSSPoint=function(e){var t=e.firstChild.nodeValue.split(" ");return new esri.geometry.Point(parseFloat(t[1]),parseFloat(t[0]),i.wgs84Sref)},i.prototype._getGMLGRSSPoint=function(e){var t=this._getNonTextNodeChild(e),r=this._getNonTextNodeChild(t).firstChild.nodeValue.split(" ");return new esri.geometry.Point(parseFloat(r[1]),parseFloat(r[0]),i.wgs84Sref)},i.prototype._getNonTextNodeChild=function(e){for(var t=e.childNodes,i=0;i<t.length;i++)if(3!==t[i].nodeType)return t[i]},i.prototype._getW3CGRSSPoint=function(e){if(!e.nextSibling)return null;var t=e.nextSibling;"#text"===e.nextSibling.nodeName&&(t=e.nextSibling.nextSibling);var r=e.firstChild.nodeValue,n=t.firstChild.nodeValue;return new esri.geometry.Point(parseFloat(n),parseFloat(r),i.wgs84Sref)},i.prototype._getFeedRoot=function(e){if(!e)throw new Error("The GeoRSS service at "+this.feedUrl+" returned an invalid response.");for(var t=e.childNodes,i=0;i<t.length;i++)if(t[i]&&"xml"!==t[i].nodeName.substring(0,3))return t[i];return null},i}(r.MapService);o.webMercatorSref=null,o.wgs84Sref=null,i.GeoRssLayerService=o})},"geocortex/essentials/KmlService":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./MapService"],function(e,i,r){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=function(e){function i(){var t=null!==e&&e.apply(this,arguments)||this;return t.updateInterval=null,t.serviceLayer=null,t.mapSpatialReference=null,t}return t(i,e),i.prototype._configureObject=function(t,i){if(void 0===t)throw new Error("Incorrect map service object returned from initialization");this.updateInterval=t.updateInterval,e.prototype._configureObject.call(this,t,i)},i.prototype._createServiceLayer=function(){var e=this;this.essentialsMap&&(this.essentialsMap.site,this.mapSpatialReference=this.essentialsMap.initialExtent.spatialReference);var t={id:this.id,outSR:this.mapSpatialReference};this.serviceLayer=new esri.layers.KMLLayer(this.serviceUrl,t),this._initiallyVisible?this.serviceLayer.show():this.serviceLayer.hide(),this.serviceLayer._options=t,this.attributionDataUrl&&""!==this.attributionDataUrl?(this.serviceLayer.attributionDataUrl=this.attributionDataUrl,this.serviceLayer.hasAttributionData=!0):this.hasAttributionData&&(this.serviceLayer.attributionDataUrl=this.url+"/Attribution",this.serviceLayer.hasAttributionData=!0);var i=this.serviceLayer.on("load",function(t){i.remove(),e.serviceLayer.setOpacity(e.configuredOpacity),e._initializeKmlLayers()});this.serviceLayer.on("error",function(t){return e._layerLoadErrorHandler(t)}),this.serviceLayer.setOpacity(this.configuredOpacity),this.updateInterval&&!isNaN(this.updateInterval)&&this.serviceLayer.setRefreshInterval(this.updateInterval)},i.prototype._updateStartHandler=function(){this._initializeKmlLayers()},i.prototype._initializeKmlLayers=function(){for(var e=this.serviceLayer.getLayers(),t=0;t<e.length;t++)if(e[t]instanceof esri.layers.FeatureLayer){var i=e[t];i.layerId=+this.id,i.name=this.displayName,i.displayField="name",e[t].spatialReference=this.mapSpatialReference}},i}(r.MapService);i.KmlService=n})},"geocortex/essentials/Layer":function(){var __extends=this&&this.__extends||(xj=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(e,t){function i(){this.constructor=e}xj(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}),xj;define(["require","exports","./AsyncInitializable","./LayerChart","./DataLink","./Field","./FeatureHyperlink","./LayerHyperlink","./Report","./LayerStyle","./LayerQuery","./LayerType","./RefreshVisibility","./LayerThemeSetting","./TimeInfo","./../geocortex","./RestHelperHTTPService","./MapServiceConstants","./utilities/SiteResourceIdComparer","./RestHelper"],function(require,exports,AsyncInitializable_1,LayerChart_1,DataLink_1,Field_1,FeatureHyperlink_1,LayerHyperlink_1,Report_1,LayerStyle_1,LayerQuery_1,LayerType_1,RefreshVisibility_1,LayerThemeSetting_1,TimeInfo_1,geocortex_1,RestHelperHTTPService_1,MapServiceConstants_1,SiteResourceIdComparer_1,RestHelper_1){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Layer=function(_super){function Layer(e){var t=_super.call(this,e)||this;return t.allowSymbolization=!1,t.canToggleLabels=!1,t.charts=[],t.configuredVisible=!1,t.dataLinks=[],t.dataProvider=null,t.defaultVisibility=!1,t.displayField=null,t.displayName=null,t.defaultDateFormat=null,t.defaultNumberFormat=null,t.description=null,t.drawIndex=null,t.dynamicDefinition=null,t.extensions=[],t.featureBorderColor=null,t.featureBorderWidth=null,t.featureDescription=null,t.featureFillColor=null,t.featureHyperlinks=[],t.featureLabel=null,t.featureLongDescription=null,t.featureType="None",t.featureZoomFactor=null,t.featureZoomScale=null,t.fields=[],t.fullExtent=null,t.hasAttachments=!1,t.hasDataLinks=!1,t.hasReports=!1,t.iconUri=null,t.id=null,t.identifiable=!1,t.identifiableAtAllScales=!1,t.includeInLayerList=!0,t.includeInLegend=!0,t.isDynamic=!1,t.isExpanded=!1,t.isUserCreated=!1,t.userLayerType=null,t.catalogId=null,t.layerHyperlinks=[],t.legendUrl=null,t.mapService=null,t.maxScale=0,t.minScale=0,t.name=null,t.parentLayerId=null,t.primaryKeyField=null,t.properties={},t.queryable=!1,t.queries=[],t.relationships=[],t.reports=[],t.searchable=!1,t.showFeatureHyperlinks="ShowAll",t.showLabels=!0,t.showMapTips=!1,t.snappable=!1,t.snappingEnabled=!1,t.supportsIdentify=!1,t.supportsQuery=!1,t.styleName=null,t.styles=[],t.subLayerIds=[],t.timeZoneId=null,t.type=LayerType_1.LayerType.UNKNOWN,t.visibleStateForRefresh=RefreshVisibility_1.RefreshVisibility.DEFAULT,t.wmsLayerName=null,t.wfsLayerName=null,t.inActiveTheme=!0,t.layerThemeSettings=[],t._visible=!1,t._featureLayerPromise=null,t._timeInfo=null,t._gcxTimeInfo=null,t.setInActiveTheme(!0),t}return __extends(Layer,_super),Layer.prototype.getFeatureLayer=function(){var e=this;if(!this._featureLayerPromise)if(this.mapService.serviceUrl&&this.mapService.serviceUrl.endsWith("/MapServer"))this._featureLayerPromise=new Promise(function(t,i){e.mapService._getLayersInfo(e.id).then(function(r){var n=null;if(r){if(r.layers&&r.layers.forEach(function(t){e.id!==t.id.toString()||(n=new esri.layers.FeatureLayer({layerDefinition:t}))}),!n&&r.tables&&r.tables.forEach(function(t){e.id!==t.id.toString()||(n=new esri.layers.FeatureLayer({layerDefinition:t}))}),n)return void t(n);if(e.isDynamic)if(e.mapService&&e.mapService.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var s=e.mapService.serviceLayer;if(s.dynamicLayerInfos){var a=null;for(var o in s.dynamicLayerInfos)if(s.dynamicLayerInfos.hasOwnProperty(o)&&s.dynamicLayerInfos[o].id==parseInt(e.id)){a=s.dynamicLayerInfos[o].source;break}if(a){var l=e.mapService.serviceUrl+"/dynamicLayer";e.mapService.serviceToken&&(l=RestHelperHTTPService_1.RestHelperHTTPService.appendTokenToUrl(l,e.mapService.serviceToken));var u=(n=new esri.layers.FeatureLayer(l,{source:a})).on("load",function(e){u.remove(),c.remove(),t(n)}),c=n.on("error",function(e){u.remove(),c.remove();var t=e.error&&e.error.message?e.error.message:"Could not determine underlying error.";i(new Error("Could not create a Feature Layer from the given dynamic layer source. Reason: {0}".format(t)))})}else i(new Error("Could not find LayerSource for the given dynamic layer."))}else i(new Error("No dynamicLayerInfos on the service layer."))}else i(new Error("The service layer is not an instance of esri.layers.ArcGISDynamicMapServiceLayer."));else i(new Error("The Essentials layer is not a dynamic layer."))}else i(new Error("The Essentials map service did not return information related to the service's layers."))}).catch(function(e){return i(e)})});else{var t;if(this.mapService.serviceLayer instanceof esri.layers.FeatureLayer)t=this.mapService.serviceLayer;else{var i=this.getLayerUrl();if(!i)return this._featureLayerPromise=Promise.reject(new Error("Cound not get layerUrl for creating feature layer")),this._featureLayerPromise;t=new esri.layers.FeatureLayer(i)}t.loaded?this._featureLayerPromise=Promise.resolve(t):this._featureLayerPromise=new Promise(function(i,r){var n=t.on("load",function(){if(n.remove(),s.remove(),e.wmsLayerName||e.wfsLayerName)for(var r=e.fields,a=t.fields.length-1;a>=0;a--){var o=t.fields[a];"gml:id"===o.name&&t.fields.splice(a,1),o.type=Field_1.Field.convertToEsriFieldType(r[a].dataType)}i(t)}),s=t.on("error",function(e){n.remove(),s.remove(),r(e)})})}return this._featureLayerPromise},Layer.prototype.getRelatedFeatureLayer=function(e,t,i){var r=new dojo.Deferred,n=function(e){geocortex_1.deferredResolve(r,e),"function"==typeof t&&t(e)},s=this._getRelation(e),a=this.getLayerUrl();if(!s||!a){var o=new Error("getRelatedFeatureLayer - Relation not found for: "+e+" or layerUrl is null");return r&&-1==r.fired&&r.resolve(o),"function"==typeof i&&i(o),r}var l=a.substring(0,a.lastIndexOf("/")+1)+s.relatedTableId;this.mapService&&this.mapService.serviceToken&&(l=RestHelperHTTPService_1.RestHelperHTTPService.appendTokenToUrl(l,this.mapService.serviceToken)),void 0===esri.getProxyRule(l)&&null!==this.mapService.proxyUrl&&esri.addProxyRule({urlPrefix:l,proxyUrl:this.mapService.proxyUrl});var u=new esri.layers.FeatureLayer(l,{mode:esri.layers.FeatureLayer.MODE_SELECTION,outFields:["*"]});return u.loaded?n(u):dojo.connect(u,"onLoad",dojo.hitch(this,n)),dojo.connect(u,"onError",dojo.hitch(this,function(e){r&&-1==r.fired&&r.resolve(e),"function"==typeof i&&i(e)})),r},Layer.prototype.areAllAncestorsVisible=function(){for(var e=this.mapService.findLayerById(this.parentLayerId);null!==e&&void 0!==e;){if(!e.isVisible())return!1;e=this.mapService.findLayerById(e.parentLayerId)}return!0},Layer.prototype.getLayerUrl=function(){if(this.mapService&&this.mapService.serviceUrl){if("FeatureLayer"===this.mapService.drawingBehavior)return this.mapService.serviceUrl;if(this.mapService.mapServiceType===MapServiceConstants_1.MapServiceType.WMS||this.mapService.mapServiceType===MapServiceConstants_1.MapServiceType.WFS){if(this.mapService.userLayerType===MapServiceConstants_1.UserLayerType.LAYER_ADDITION)return null;var e=this.mapService.url+"/layers/"+this.id,t=RestHelperHTTPService_1.RestHelperHTTPService.getTokenForScope(this.mapService.url);return t&&(e=RestHelperHTTPService_1.RestHelperHTTPService.appendTokenToUrl(e,t)),e}return this.mapService.serviceUrl+"/"+this.id}return null},Layer.prototype.getFieldByName=function(e){if(this.fields&&this.fields.length>0){if(!this._fieldLookup){this._fieldLookup={};for(var t=0;t<this.fields.length;t++){var i=this.fields[t];this._fieldLookup[i.name]=i}}return this._fieldLookup[e]}return null},Layer.prototype.isVisible=function(){return this._visible},Layer.prototype.setVisibility=function(e,t){if(this.mapService){switch(this.mapService.mapServiceType){case MapServiceConstants_1.MapServiceType.DYNAMIC:case MapServiceConstants_1.MapServiceType.FEATURE:case MapServiceConstants_1.MapServiceType.WMS:case MapServiceConstants_1.MapServiceType.WFS:case MapServiceConstants_1.MapServiceType.WMTS:case MapServiceConstants_1.MapServiceType.GEORSS:case MapServiceConstants_1.MapServiceType.KML:case MapServiceConstants_1.MapServiceType.TILED:case MapServiceConstants_1.MapServiceType.STREAM:this._visible=e;break;default:this._visible=!0}this.mapService._setVisibility(this.id,this._visible,t)}},Layer.prototype.setInActiveTheme=function(e){this.inActiveTheme=e,dojo.publish("LayerInActiveThemeChangedEvent",this)},Layer.prototype.findReportById=function(e){return SiteResourceIdComparer_1.SiteResourceIdComparer.lookUp(this.reports,e)},Layer.prototype.withinScaleRange=function(e){return!!(0==this.maxScale&&this.minScale==1/0||isNaN(this.maxScale)&&isNaN(this.minScale))||(null==e&&(e=this.mapService.essentialsMap.calculateScale()),this.maxScale<e&&e<this.minScale)},Layer.prototype._configureDataLinks=function(e,t,i){for(var r=0;e&&r<e.length;r++){var n=this.dataLinks[r]=new DataLink_1.DataLink(this.url+"/datalinks/"+e[r].id);n.layer=this,n._configureObject(e[r],t)}},Layer.prototype._idIsUnique=function(e){if(this.mapService&&e){var t=[];if(dojo.forEach(this.mapService.layers,function(e){t.push(e.id)}),t.indexOf(e)<0)return!0}return!1},Layer.prototype._getUniqueId=function(){if(this.mapService){var e=[];if(dojo.forEach(this.mapService.layers,function(t){e.push(t.id)}),e.length>0){var t=Math.max.apply(null,e);return(++t).toString()}}return"0"},Layer.prototype.createFromDefinition=function(e){this._createFrom(e)},Layer.prototype._createFrom=function(e){if(this.defaultVisibility=e.defaultVisibility,this.configuredVisible=e.visible,this.displayName=e.displayName||e.name,this.description=e.description,this.featureDescription=e.featureDescription,e.hasOwnProperty("featureLongDescription")?this.featureLongDescription=e.featureLongDescription:this.featureLongDescription=e.featureDescription,this.featureLabel=e.featureLabel,this.featureType=e.featureType,this.featureZoomScale=e.featureZoomScale,this.featureZoomFactor=e.featureZoomFactor,this.hasDataLinks=e.hasDataLinks,this.hasReports=e.hasReports,this.hasAttachments=e.hasAttachments,e.hasOwnProperty("id")?this.id=e.id:this.id=this._getUniqueId(),this.name=e.name,e.nativeID&&(this.mapService&&this.mapService.mapServiceType===MapServiceConstants_1.MapServiceType.WFS?this.wfsLayerName=e.nativeID:this.wmsLayerName=e.nativeID),this.parentLayerId=e.parentLayerId,this.subLayerIds=e.subLayerIds,this._visible=e.visible,this.styleName=e.styleName,this.legendUrl=e.legendUrl,this.isUserCreated=void 0==e.isUserCreated?this.isUserCreated:e.isUserCreated,this.userLayerType=void 0==e.userLayerType?this.userLayerType:e.userLayerType,this.isDynamic=e.isDynamic,this.dynamicDefinition=e.dynamicDefinition,this.dataProvider=e.dataProvider,this.defaultDateFormat=e.defaultDateFormat,this.defaultNumberFormat=e.defaultNumberFormat,this.timeZoneId=e.timeZoneId,e.fullExtent&&(this.fullExtent=new esri.geometry.Extent(e.fullExtent)),e.hasOwnProperty("drawIndex")&&(this.drawIndex=e.drawIndex),e.hasOwnProperty("identifiable")&&(this.identifiable=e.identifiable),e.hasOwnProperty("includeInLayerList")&&(this.includeInLayerList=e.includeInLayerList),e.hasOwnProperty("includeInLegend")&&(this.includeInLegend=e.includeInLegend),e.hasOwnProperty("featureBorderColor")&&(this.featureBorderColor=e.featureBorderColor,this.featureBorderColor&&this.featureBorderColor.length>=4&&this.featureBorderColor[3]>=1&&(this.featureBorderColor[3]/=255)),e.hasOwnProperty("featureBorderWidth")&&(this.featureBorderWidth=e.featureBorderWidth),e.hasOwnProperty("featureFillColor")&&(this.featureFillColor=e.featureFillColor,this.featureFillColor&&this.featureFillColor.length>=4&&this.featureFillColor[3]>=1&&(this.featureFillColor[3]/=255)),e.hasOwnProperty("minScale")&&!isNaN(e.minScale)&&0!=e.minScale?this.minScale=e.minScale:this.minScale=1/0,e.hasOwnProperty("maxScale")&&!isNaN(e.maxScale)?this.maxScale=e.maxScale:this.maxScale=0,this.mapService&&null!=this.mapService.minScale&&!isNaN(this.mapService.minScale)&&(this.minScale=Math.min(this.minScale,this.mapService.minScale)),this.mapService&&null!=this.mapService.maxScale&&!isNaN(this.mapService.maxScale)&&(this.maxScale=Math.max(this.maxScale,this.mapService.maxScale)),e.hasOwnProperty("queryable")&&(this.queryable=e.queryable),e.hasOwnProperty("searchable")&&(this.searchable=e.searchable),e.hasOwnProperty("snappable")&&(this.snappable=e.snappable),e.hasOwnProperty("snappingEnabled")&&(this.snappingEnabled=e.snappingEnabled),e.hasOwnProperty("showFeatureHyperlinks")&&(this.showFeatureHyperlinks=e.showFeatureHyperlinks),e.hasOwnProperty("canToggleLabels")&&(this.canToggleLabels=e.canToggleLabels),e.hasOwnProperty("showLabels")&&(this.showLabels=e.showLabels),e.hasOwnProperty("showMapTips")&&(this.showMapTips=e.showMapTips),e.hasOwnProperty("supportsIdentify")&&(this.supportsIdentify=e.supportsIdentify),e.hasOwnProperty("supportsQuery")&&(this.supportsQuery=e.supportsQuery),e.hasOwnProperty("layerHyperlinks"))for(t=0;t<e.layerHyperlinks.length;t++)this.layerHyperlinks[t]=new LayerHyperlink_1.LayerHyperlink(e.layerHyperlinks[t],this);if(void 0!==e.type&&(this.type=this._layerTypeStringToEssentialsLayerType(e.type)),e.fields)for(var t=0;t<e.fields.length;t++){var i=e.fields[t],r={layer:this,dataType:Field_1.Field.convertFromEsriType(i.type||i.dataType),alias:i.alias,displayName:i.displayName||i.alias||i.name,name:i.name,searchable:!0,visible:!0,focusField:!1,hyperlinkLabel:null,format:i.format};i.hasOwnProperty("searchable")&&(r.searchable=i.searchable),i.hasOwnProperty("visible")&&(r.visible=i.visible),this.fields[t]=new Field_1.Field(r)}this.primaryKeyField=this.getFieldByName(e.primaryKeyField),this.displayField=this.getFieldByName(e.displayField),e.properties&&(this.properties=geocortex_1._getProperties(e.properties),this.catalogId=this.properties.layerCatalogLookupId),e.extensions&&(this.extensions=geocortex_1._getExtensions(e.extensions)),this.isInitialized=!0},Layer.prototype._configureObject=function(results,deepInitialize){if(void 0===results||void 0===results.name||void 0===results.id)throw new Error("Incorrect layer object returned from initialization");this.allowSymbolization=results.allowSymbolization,this.defaultVisibility=results.defaultVisibility,this.configuredVisible=results.visible,this.displayName=results.displayName,this.description=results.description,this.featureDescription=results.featureDescription,results.hasOwnProperty("featureLongDescription")?this.featureLongDescription=results.featureLongDescription:this.featureLongDescription=results.featureDescription,this.featureLabel=results.featureLabel,this.featureType=void 0===results.featureType?this.featureType:results.featureType,this.featureZoomScale=void 0===results.featureZoomScale?this.featureZoomScale:results.featureZoomScale,this.featureZoomFactor=void 0===results.featureZoomFactor?this.featureZoomFactor:results.featureZoomFactor,this.hasDataLinks=void 0==results.hasDataLinks?this.hasDataLinks:results.hasDataLinks,this.hasReports=void 0==results.hasReports?this.hasReports:results.hasReports,this.hasAttachments=results.hasAttachments,this.id=results.id,this.name=results.name,results.nativeID&&(this.mapService&&this.mapService.mapServiceType===MapServiceConstants_1.MapServiceType.WFS?this.wfsLayerName=results.nativeID:this.wmsLayerName=results.nativeID),this.parentLayerId=results.parentLayerId,this.subLayerIds=results.subLayerIds,this.styleName=results.styleName,this.legendUrl=results.legendUrl,this.catalogId=void 0==results.catalogId?this.catalogId:results.catalogId,this.isUserCreated=void 0==results.isUserCreated?this.isUserCreated:results.isUserCreated,this.userLayerType=void 0==results.userLayerType?this.userLayerType:results.userLayerType,this.isDynamic=void 0===results.isDynamic?this.isDynamic:results.isDynamic,this.dynamicDefinition=results.dynamicDefinition,this.dataProvider=results.dataProvider,this.defaultDateFormat=results.defaultDateFormat,this.defaultNumberFormat=results.defaultNumberFormat,this.timeZoneId=results.timeZoneId,this._timeInfo=results.timeInfo?results.timeInfo:null,this.queries=[],results.fullExtent&&(this.fullExtent=new esri.geometry.Extent(results.fullExtent));var site=null,i;if(this.mapService&&this.mapService.essentialsMap&&(site=this.mapService.essentialsMap.site),this.iconUri=RestHelper_1.RestHelper.processClientSideTokens(site,results.iconUri),results.hasOwnProperty("includeInLayerList")&&(this.includeInLayerList=results.includeInLayerList),this.isUserCreated)this._visible=void 0===results.initiallyVisible?!!results.visible:!!results.initiallyVisible;else if(null!=this.mapService.essentialsMap.layerThemesInfo.startupThemeId&&this.includeInLayerList?this._visible=!1:this._visible=void 0===results.initiallyVisible?!!results.visible:!!results.initiallyVisible,results.themeSettings&&results.themeSettings.length)for(var x=0;x<results.themeSettings.length;x++){var themeSetting=results.themeSettings[x],layerTheme=this.mapService.essentialsMap.layerThemesInfo.getTheme(themeSetting.themeID);if(layerTheme){var isVisible=void 0==themeSetting.visible?this.configuredVisible:themeSetting.visible;this.layerThemeSettings.push(new LayerThemeSetting_1.LayerThemeSetting(layerTheme,isVisible)),layerTheme.id===this.mapService.essentialsMap.layerThemesInfo.startupThemeId&&this.includeInLayerList&&(this._visible=void 0===themeSetting.initiallyVisible?isVisible:themeSetting.initiallyVisible)}}if(results.hasOwnProperty("drawIndex")&&(this.drawIndex=results.drawIndex),results.hasOwnProperty("featureBorderColor")&&(this.featureBorderColor=results.featureBorderColor,this.featureBorderColor&&this.featureBorderColor.length>=4&&this.featureBorderColor[3]>=1&&(this.featureBorderColor[3]/=255)),results.hasOwnProperty("featureBorderWidth")&&(this.featureBorderWidth=results.featureBorderWidth),results.hasOwnProperty("featureFillColor")&&(this.featureFillColor=results.featureFillColor,this.featureFillColor&&this.featureFillColor.length>=4&&this.featureFillColor[3]>=1&&(this.featureFillColor[3]/=255)),results.hasOwnProperty("identifiable")&&(this.identifiable=results.identifiable),results.hasOwnProperty("includeInLegend")&&(this.includeInLegend=results.includeInLegend),results.hasOwnProperty("minScale")&&!isNaN(results.minScale)&&0!=results.minScale?this.minScale=results.minScale:this.minScale=1/0,results.hasOwnProperty("maxScale")&&!isNaN(results.maxScale)?this.maxScale=results.maxScale:this.maxScale=0,this.mapService&&null!=this.mapService.minScale&&!isNaN(this.mapService.minScale)&&(this.minScale=Math.min(this.minScale,this.mapService.minScale)),this.mapService&&null!=this.mapService.maxScale&&!isNaN(this.mapService.maxScale)&&(this.maxScale=Math.max(this.maxScale,this.mapService.maxScale)),results.hasOwnProperty("queryable")&&(this.queryable=results.queryable),results.hasOwnProperty("searchable")&&(this.searchable=results.searchable),results.hasOwnProperty("showFeatureHyperlinks")&&(this.showFeatureHyperlinks=results.showFeatureHyperlinks),results.hasOwnProperty("canToggleLabels")&&(this.canToggleLabels=results.canToggleLabels),results.hasOwnProperty("showLabels")&&(this.showLabels=results.showLabels),results.hasOwnProperty("showMapTips")&&(this.showMapTips=results.showMapTips),results.hasOwnProperty("snappable")&&(this.snappable=results.snappable),results.hasOwnProperty("snappingEnabled")&&(this.snappingEnabled=results.snappingEnabled),results.hasOwnProperty("supportsIdentify")&&(this.supportsIdentify=results.supportsIdentify),results.hasOwnProperty("supportsQuery")&&(this.supportsQuery=results.supportsQuery),void 0!==results.type&&(this.type=this._layerTypeStringToEssentialsLayerType(results.type)),this.type==LayerType_1.LayerType.GROUP_LAYER&&results.hasOwnProperty("isExpanded")&&(this.isExpanded=results.isExpanded),results.featureHyperlinks)for(i=0;i<results.featureHyperlinks.length;i++)this.featureHyperlinks[i]=new FeatureHyperlink_1.FeatureHyperlink(results.featureHyperlinks[i],this);if(results.fields)for(i=0;i<results.fields.length;i++)results.fields[i].layer=this,this.fields[i]=new Field_1.Field(results.fields[i]);if(results.relationships)for(i=0;i<results.relationships.length;i++)results.relationships[i].displayName&&(results.relationships[i].name=results.relationships[i].displayName),results.relationships[i].id=parseInt(results.relationships[i].id),results.relationships[i].relatedTableId=parseInt(results.relationships[i].relatedTableId),this.relationships.push(results.relationships[i]);if(results.hasOwnProperty("layerHyperlinks"))for(i=0;i<results.layerHyperlinks.length;i++)this.layerHyperlinks[i]=new LayerHyperlink_1.LayerHyperlink(results.layerHyperlinks[i],this);if(results.hasOwnProperty("charts")&&dojo.isObject(eval("geocortex.charting.configuration.ChartDefinition")))for(i=0;i<results.charts.length;i++)this.charts.push(new LayerChart_1.LayerChart(results.charts[i],this));if(results.styles&&results.styles.length)for(i=0;i<results.styles.length;i++){var style=results.styles[i],rendererJson=style.definition;rendererJson&&this.styles.push(new LayerStyle_1.LayerStyle(rendererJson,style.displayName,style.id))}if(results.queries&&results.queries.length)for(i=0;i<results.queries.length;i++)this.queries.push(new LayerQuery_1.LayerQuery(results.queries[i]));this.primaryKeyField=this.getFieldByName(results.primaryKeyField),this.displayField=this.getFieldByName(results.displayField),this._configureDataLinks(results.dataLinks,deepInitialize,site),this._configureReports(results.reports,deepInitialize),deepInitialize&&(this.isInitialized=!0),this.properties=geocortex_1._getProperties(results.properties),this.extensions=geocortex_1._getExtensions(results.extensions)},Layer.prototype.toJson=function(){return{id:this.id,name:this.name,url:this.url,defaultVisibility:this.defaultVisibility,visible:this.configuredVisible,displayName:this.displayName,description:this.description,featureDescription:this.featureDescription,featureLongDescription:this.featureLongDescription,featureLabel:this.featureLabel,featureType:this.featureType,featureZoomScale:this.featureZoomScale,featureZoomFactor:this.featureZoomFactor,hasDataLinks:this.hasDataLinks,hasReports:this.hasReports,hasAttachments:this.hasAttachments,nativeID:this.wmsLayerName||this.wfsLayerName,parentLayerId:this.parentLayerId,subLayerIds:(this.subLayerIds||[]).slice(),styleName:this.styleName,legendUrl:this.legendUrl,isDynamic:this.isDynamic,dynamicDefinition:this.dynamicDefinition,dataProvider:this.dataProvider,defaultDateFormat:this.defaultDateFormat,defaultNumberFormat:this.defaultNumberFormat,timeZoneId:this.timeZoneId,fullExtent:this.fullExtent?this.fullExtent.toJson():void 0,drawIndex:this.drawIndex,identifiable:this.identifiable,isExpanded:this.isExpanded,includeInLayerList:this.includeInLayerList,includeInLegend:this.includeInLegend,featureBorderColor:this.featureBorderColor,featureBorderWidth:this.featureBorderWidth,featureFillColor:this.featureFillColor,minScale:this.minScale===1/0?0:this.minScale,maxScale:this.maxScale,queryable:this.queryable,searchable:this.searchable,snappable:this.snappable,snappingEnabled:this.snappingEnabled,showFeatureHyperlinks:this.showFeatureHyperlinks,canToggleLabels:this.canToggleLabels,showLabels:this.showLabels,showMapTips:this.showMapTips,supportsIdentify:this.supportsIdentify,supportsQuery:this.supportsQuery,layerHyperlinks:this.layerHyperlinks.map(function(e){return e.toJson()}),type:this._essentialsLayerTypeToLayerTypeString(this.type),fields:this.fields.map(function(e){return e.toJson()}),primaryKeyField:this.primaryKeyField?this.primaryKeyField.name:void 0,displayField:this.displayField?this.displayField.name:void 0,catalogId:this.catalogId?this.catalogId:void 0,isUserCreated:this.isUserCreated,userLayerType:this.userLayerType,properties:geocortex_1._propertiesToJson(this.properties),extensions:geocortex_1._extensionsToJson(this.extensions)}},Layer.prototype._configureReports=function(e,t){for(var i=0;e&&i<e.length;i++)this.reports[i]=new Report_1.Report(this.url+"/reports/"+e[i].id),this.reports[i].layer=this,this.mapService&&this.mapService.essentialsMap&&this.mapService.essentialsMap.site&&(this.reports[i].site=this.mapService.essentialsMap.site),this.reports[i]._configureObject(e[i],t)},Layer.prototype.getLayerTimeInfo=function(){var e=this;if(!this.mapService||!this.mapService.isTimeAware)return null;if(this._gcxTimeInfo)return this._gcxTimeInfo;var t=function(t){if(t)return e._timeInfo=t,e._gcxTimeInfo=TimeInfo_1.getGcxTimeInfo(e._timeInfo),e._gcxTimeInfo};this._timeInfo?t(this._timeInfo):function(){if(e.mapService.serviceLayer&&e.mapService.serviceLayer.url){var i=e.mapService.serviceLayer.url+"/"+e.id;geocortex_1.request({url:i,content:{f:"json"},load:function(e){return t(e.timeInfo)},error:function(e){console.log((e.message,e.message))},callbackParamName:"CallBack"})}}()},Layer.prototype.getObjectIdFieldName=function(){var e=null;return this.primaryKeyField&&(e=this.primaryKeyField.name),e},Layer.prototype._layerTypeStringToEssentialsLayerType=function(e){return"FeatureLayer"==e||"DynamicFeatureLayer"==e?LayerType_1.LayerType.FEATURE_LAYER:"GroupLayer"==e||"AnnotationLayer"==e?LayerType_1.LayerType.GROUP_LAYER:"RasterLayer"==e?LayerType_1.LayerType.RASTER_LAYER:"GeoRssLayer"==e?LayerType_1.LayerType.GEO_RSS_LAYER:"TableLayer"==e?LayerType_1.LayerType.TABLE_LAYER:LayerType_1.LayerType.UNKNOWN},Layer.prototype._essentialsLayerTypeToLayerTypeString=function(e){switch(e){case LayerType_1.LayerType.FEATURE_LAYER:return"FeatureLayer";case LayerType_1.LayerType.GROUP_LAYER:return"GroupLayer";case LayerType_1.LayerType.RASTER_LAYER:return"RasterLayer";case LayerType_1.LayerType.GEO_RSS_LAYER:return"GeoRssLayer";default:return"Unknown"}},Layer.prototype._getRelation=function(e){"string"==typeof e&&(e=parseInt(e));for(var t=0;t<this.relationships.length;t++)if(this.relationships[t].id==e)return this.relationships[t];return null},Layer.prototype.getDefinitionExpression=function(e){var t=null,i=parseInt(this.id);if(e)if(e instanceof esri.layers.ArcGISDynamicMapServiceLayer){var r=e.layerDefinitions;r&&r[i]&&(t=r[i])}else if(e instanceof esri.layers.FeatureLayer){var n=e.getDefinitionExpression();n&&(t=n)}return t||this.dynamicDefinition&&(t=RestHelper_1.RestHelper.getDynamicExpressionFromJson(this.dynamicDefinition)),t},Layer.prototype._createDynamicLayerInfo=function(){var e=null;return this.isDynamic&&(e=RestHelper_1.RestHelper.getDynamicLayerInfoFromJson(this.dynamicDefinition,this.id),this.minScale<1/0&&(e.minScale=this.minScale),this.maxScale>0&&(e.maxScale=this.maxScale)),e},Layer.prototype.getLayerDrawingOptions=function(){var e=null;return this.isDynamic&&(e=RestHelper_1.RestHelper.getLayerDrawingOptionsFromJson(this.dynamicDefinition)),e},Layer.prototype.getLayerThemeSettings=function(e){for(var t=0;t<this.layerThemeSettings.length;t++){var i=this.layerThemeSettings[t];if(i.theme===e||i.theme.id===e)return i}return null},Layer.prototype._syncProgramaticallyChangedLayerVisibility=function(e){this._visible=e},Layer}(AsyncInitializable_1.AsyncInitializable);exports.Layer=Layer})},"geocortex/essentials/LayerCatalog":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(e){this.siteId=e};t.LayerCatalog=i})},"geocortex/essentials/LayerChart":function(){define(["require","exports","geocortex/charting/infrastructure/Enums","geocortex/charting/infrastructure/configuration/ChartDefinition"],function(require,exports,Enums_1,ChartDefinition_1){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var LayerChart=function(){function LayerChart(restLayerChart,layer){this.layer=null,dojo.isObject(eval("geocortex.charting.configuration.ChartDefinition"))&&(restLayerChart&&(this.id=restLayerChart.id,this.displayName=restLayerChart.displayName,this.defaultChart=restLayerChart.defaultChart,this.chartFeatureType=restLayerChart.chartFeatureType,this.chartDefinition=new ChartDefinition_1.ChartDefinition(restLayerChart.chartDefinition),this.chartDefinition.id=this.id,this.chartDefinition.displayName=this.displayName),layer&&(this.layer=layer,this._setFieldDisplayNames(this.chartDefinition,layer)))}return LayerChart.prototype._setFieldDisplayNames=function(e,t){if(t&&e){for(var i={},r=0;r<t.fields.length;r++){var n=t.fields[r];n&&(i[n.name]=n.displayName)}e.category.field.sourceType==Enums_1.ChartFieldSourceType.Field&&(e.category.field.displayName=i[e.category.field.name]||e.category.field.name);for(var s=0;s<e.series.length;s++){var a=e.series[s];a&&a.field.sourceType==Enums_1.ChartFieldSourceType.Field&&(a.field.displayName=i[a.field.name]||a.field.name)}}},LayerChart}();exports.LayerChart=LayerChart})},"geocortex/essentials/LayerHyperlink":function(){define(["require","exports","./RestHelper"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){this.encodeUriReplacementValues=e.encodeUriReplacementValues,this.target=e.target,this.text=e.text,this.toolTip=e.toolTip;var r=null;null!=t.mapServiceType?this.mapService=t:(this.layer=t,this.layer.mapService&&(this.mapService=this.layer.mapService)),this.mapService&&this.mapService.essentialsMap&&(r=this.mapService.essentialsMap.site),this.uri=i.RestHelper.processClientSideTokens(r,e.uri),this.iconUri=i.RestHelper.processClientSideTokens(r,e.iconUri)}return e.prototype.toJson=function(){return{encodeUriReplacementValues:this.encodeUriReplacementValues,iconUri:this.iconUri,target:this.target,text:this.text,toolTip:this.toolTip,uri:this.uri}},e}();t.LayerHyperlink=r})},"geocortex/essentials/LayerQuery":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(e){e&&(this.id=e.id,this.displayName=e.displayName,this.query=e.query)};t.LayerQuery=i})},"geocortex/essentials/LayerStyle":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t,i,r){void 0===r&&(r=!1),this.rendererJson=e,this.displayName=t,this.id=i,this.enabled=r}return e.prototype.getRenderer=function(){var e=esri.renderer.fromJson(JSON.parse(this.rendererJson));return e instanceof esri.renderer.Renderer||console.error("Layer Style: '{0}'. Could not create a valid renderer from the stored JSON string: '{1}'".format(this.displayName,this.rendererJson)),e},e.prototype.setRenderer=function(e){e instanceof esri.renderer.Renderer?this.rendererJson=JSON.stringify(e.toJson()):esri.renderer.fromJson(JSON.parse(e))instanceof esri.renderer.Renderer?this.rendererJson=e:console.error("Layer Style: '{0}'. Supplied JSON string could not be used to create a valid renderer: '{1}'".format(this.displayName,e))},e.prototype.isSimple=function(){return"simple"===JSON.parse(this.rendererJson).type},e}();t.LayerStyle=i})},"geocortex/essentials/LayerTheme":function(){define(["require","exports","./../geocortex","./Layer","./LayerType"],function(e,t,i,r,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t,i){this.layerThemesInfo=e;var r="object"==typeof t?t:null;this._configureLayerTheme(r,t,i)}return e.prototype._configureLayerTheme=function(e,t,r){this.id=e?e.id:t,this.isDefaultTheme=null===this.id,this.isActive=!1,this.displayName=e?e.displayName:r,this.extensions=i._getExtensions(e?e.extensions:null),this.properties=e?e.properties:null},e.prototype.applyToMap=function(){var e=this;if(void 0==this.layerThemesInfo)throw new Error("Could not apply theme '{0}' to the map because the LayerThemesInfo property is not set on this LayerTheme.".format(this.displayName));var t=this.layerThemesInfo,i=t.map;if(void 0==i)throw new Error("Failed to apply theme '{0}' to map because the Map property is not set on the LayerThemesInfo object.".format(this.displayName));this.isActive=!0,(t.activeTheme&&t.activeTheme!==this||!t.activeTheme)&&(t.activeTheme&&(t.previousTheme=t.activeTheme,t.previousTheme.isActive=!1),t.activeTheme=this),t.themeChangeInProgress=!0,t.layerThemeChangingEvent({currTheme:t.activeTheme,prevTheme:t.previousTheme});for(var s=function(e,t){void 0===t&&(t=!1),e.setInActiveTheme(!0),o(e,e.configuredVisible,t)},a=function(t,i){void 0===i&&(i=!1);var r=t.getLayerThemeSettings(e.id);t.setInActiveTheme(null!=r);var n=!1;null!=r&&(n=void 0!=r.visible?r.visible:t.configuredVisible),o(t,n,i)},o=function(e,t,i){if(void 0===i&&(i=!1),e instanceof r.Layer){var s=e;if(s.mapService.supportsLayerVisibility())s.mapService.essentialsMap.site.getEssentialsVersion()>=4.02&&s.type===n.LayerType.GROUP_LAYER&&(t=!0);else if(1!==s.mapService.layers.length||!s.inActiveTheme||s.mapService.includeInLayerList)return}e.isUserCreated||e.setVisibility(t,i)},l=0;l<i.mapServices.length;l++){var u=i.mapServices[l],c=u.supportsLayerVisibility();this.isDefaultTheme?s(u):a(u);for(var p=0;p<u.layers.length;p++){var h=u.layers[p];this.isDefaultTheme?s(h,c):a(h,c)}c&&u.refresh()}i.refreshFilteredCollections(),t.themeChangeInProgress=!1,t.layerThemeChangedEvent({currTheme:t.activeTheme,prevTheme:t.previousTheme})},e}();t.LayerTheme=s})},"geocortex/essentials/LayerThemeEventArgs":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/LayerThemeSetting":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(e,t){this.theme=e,this.visible=t};t.LayerThemeSetting=i})},"geocortex/essentials/LayerThemesInfo":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e){this.layerThemeChangedEvent=function(e){},this.themeChangeInProgress=!1,this.layerThemeChangingEvent=function(e){},this.layerThemesConfigured=!1,this.allowDefault=!1,this.themes=[],this.map=e}return e.prototype.applyTheme=function(e){if(this.layerThemesConfigured){var t=this.getTheme(e);t?t.applyToMap():console.log("Error: Theme with ID '{0}' could not be found and was not activated.".format(e))}else console.log("Warning: No layer themes have been configured by the essentials administrator.")},e.prototype.getTheme=function(e,t){if(void 0===t&&(t=!1),this.layerThemesConfigured)for(var i=0;i<this.themes.length;i++){if(this.themes[i].id===e)return this.themes[i];if(t&&this.themes[i].displayName.toLowerCase()===e.toLowerCase())return this.themes[i]}return null},e}();t.LayerThemesInfo=i})},"geocortex/essentials/LayerTimeOptions":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/LayerType":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){};i.UNKNOWN=0,i.FEATURE_LAYER=1,i.RASTER_LAYER=2,i.GROUP_LAYER=3,i.GEO_RSS_LAYER=4,i.TABLE_LAYER=5,t.LayerType=i})},"geocortex/essentials/LayerVisibilityEventManager":function(){define(["require","exports","./MapServiceConstants"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){if(this._mapService=null,this._mapService=e,this._mapService.mapServiceType!=i.MapServiceType.WMS&&this._mapService.mapServiceType!=i.MapServiceType.DYNAMIC)throw new Error("LayerVisibilityEventManager: Only Dynamic and WMS Layer types supported.");var r=this;dojo.aspect.before(t,"setVisibleLayers",function(e,t){return r.beforeESRIsetVisibleLayers(e,t)}),dojo.aspect.after(t,"setVisibleLayers",function(e,t,i){r.afterESRIsetVisibleLayers(e,t,i)},!0)}return e.prototype.beforeESRIsetVisibleLayers=function(e,t){var r=[],n=[];if(void 0===t&&(t=!1),e.InternallyChangedLayer){var s=e.InternallyChangedLayer;return void 0!=s.mapServiceId&&void 0!=s.layerId&&void 0!=s.visibility&&r.push(s),[e,t,r]}if(this._mapService.mapServiceType==i.MapServiceType.DYNAMIC)n=dojo.clone(e);else if(this._mapService.mapServiceType==i.MapServiceType.WMS)for(var a=0;e&&a<e.length;a++){var o=this._findWmsLayerIdFromName(e[a]);if(!o||null===o){var l=[e,t,r];return console.error("WARNING: LayerVisibilityEventManager could not find layer corresponding to WMS name ["+e[a]+"] Possible Invalid configuration"),l}n.push(o.toString())}if(e&&this._mapService.mapServiceType==i.MapServiceType.DYNAMIC&&1===e.length&&"-1"==e[0]){for(var u=0;u<this._mapService.layers.length;u++)h=this._mapService.layers[u].id,r.push({mapServiceId:this._mapService.id,layerId:h.toString(),visibility:!1}),this._mapService.findLayerById(h)._syncProgramaticallyChangedLayerVisibility(!1);return[e,t,r]}(e&&0===e.length||this._mapService.mapServiceType==i.MapServiceType.DYNAMIC&&1===e.length&&""===e[0])&&(n=this._mapService.getDefaultVisibleLayers());for(var c=this._getAllCurrentlyVisibleLayers(),p=0;c&&p<c.length;p++){var h=c[p];n&&n.indexOf(h.toString())<0&&(y=this._mapService.findLayerById(h))&&(r.push({mapServiceId:this._mapService.id,layerId:h.toString(),visibility:!1}),y._syncProgramaticallyChangedLayerVisibility(!1))}var d=this._mapService.getVisibleLayers();if(n&&n.length>0)for(var f=0;f<n.length;f++)if(this._mapService.mapServiceType==i.MapServiceType.DYNAMIC&&isNaN(parseInt(n[f]))&&(n[f]="0"),d&&d.indexOf(n[f].toString())<0){var y=this._mapService.findLayerById(n[f]);y&&(y.subLayerIds&&y.subLayerIds.length>0&&(this._deleteItemWithId(n[f],r),this._recursivelyUpdateSublayerVisibility(y,!0,r)),r.push({mapServiceId:this._mapService.id,layerId:n[f].toString(),visibility:!0}),y._syncProgramaticallyChangedLayerVisibility(!0),y.parentLayerId&&null!==y.parentLayerId&&void 0!==y.parentLayerId&&this._recursivelyUpdateAncestorVisibility(y,n,r))}return[e,t,r]},e.prototype.afterESRIsetVisibleLayers=function(e,t,i){i&&i.length>0&&dojo.publish("LayerVisibilityChange",new Array(i))},e.prototype._recursivelyUpdateAncestorVisibility=function(e,t,i){if(e&&e.parentLayerId&&null!==e.parentLayerId&&void 0!==e.parentLayerId){var r=this._mapService.findLayerById(e.parentLayerId);r.isVisible()||(this._deleteItemWithId(e.parentLayerId,i),r._syncProgramaticallyChangedLayerVisibility(!0),i.push({mapServiceId:this._mapService.id,layerId:e.parentLayerId.toString(),visibility:!0})),this._recursivelyUpdateAncestorVisibility(r,t,i)}},e.prototype._recursivelyUpdateSublayerVisibility=function(e,t,i){if(e.subLayerIds&&e.subLayerIds.length>0)for(var r=0;r<e.subLayerIds.length;r++){var n=this._mapService.findLayerById(e.subLayerIds[r]),s=n.id;n._syncProgramaticallyChangedLayerVisibility(t),this._deleteItemWithId(s,i),i.push({mapServiceId:this._mapService.id,layerId:s.toString(),visibility:t}),n.subLayerIds&&n.subLayerIds.length>0&&this._recursivelyUpdateSublayerVisibility(n,t,i)}},e.prototype._getAllCurrentlyVisibleLayers=function(){for(var e=[],t=0;t<this._mapService.layers.length;t++){var i=this._mapService.layers[t];i.isVisible()&&e.push(i.id.toString())}return e},e.prototype._findWmsLayerIdFromName=function(e){for(var t=0;t<this._mapService.layers.length;t++){var i=this._mapService.layers[t];if(e==i.wmsLayerName)return i.id}return null},e.prototype._deleteItemWithId=function(e,t){for(var i=0;i<t.length;i++)t[i].layerId==e&&t.splice(i,1)},e}();t.LayerVisibilityEventManager=r})},"geocortex/essentials/Map":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./AsyncInitializable","./BaseMap","./MapService","./LayerThemesInfo","./ExportMapImageOptions","./DistanceUnit","./ExtentManager","./utilities/UrlUtilities","./MapServiceConstants","./FeatureLayerService","geocortex/framework/utils/utils","./GeoRssLayerService","./KmlService","./StreamLayerService","./WFSLayerService","./exportMap/ExportMapTask","./exportMap/ExportMapParameters","./catalog/LayerCatalogDetail","./LayerTheme","./RestHelper","./../geocortex","./BaseMapService","./RestHelperHTTPService"],function(e,i,r,n,s,a,o,l,u,c,p,h,d,f,y,m,v,g,_,S,b,I,w,x,E){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var L=function(e){function i(t){var i=e.call(this,t)||this;return i.baseMaps=[],i.fullExtent=null,i.initialExtent=null,i.fitTiledMapsToExtent=!1,i.mapServices=[],i.mapServicesFilteredView=[],i.layerThemesInfo=null,i.primaryMapService=null,i.supportedExportFormats=["BMP","JPEG","PNG","TIFF","GeoTIFF","PDF"],i.exportMapImageOptions=null,i.units=null,i.serviceLayersAdded=!1,i.extentManager=null,i.spatialReference=null,i.setExtentOnLoad=!0,i._esriMap=null,i._onExportComplete=null,i._onExportError=null,i._suspendedLayers=[],i.originalUrl=t,i.url=c.UrlUtilities.simplify(t),i.layerThemesInfo=new a.LayerThemesInfo(i),i}return t(i,e),i.prototype.getMap=function(){return this._esriMap},i.prototype.allLayers=function(){for(var e=[],t=0;t<this.mapServices.length;t++)for(var i=this.mapServices[t],r=0;r<i.layers.length;r++)e.push(i.layers[r]);return e},i.prototype.allTables=function(){for(var e=[],t=0;t<this.mapServices.length;t++)for(var i=this.mapServices[t],r=0;r<i.tables.length;r++)e.push(i.tables[r]);return e},i.prototype.allLayersAndTables=function(){var e=[];return e=this.allLayers(),this.allTables().reduce(function(e,t){return e.push(t),e},e)},i.prototype.filteredLayers=function(){for(var e=[],t=0;t<this.mapServices.length;t++){var i=this.mapServices[t];this._layerThemeMapServiceFilter(i)&&(e=e.concat(i.layers))}return e},i.prototype.loadServiceLayersInMap=function(e){if(!e)throw new Error("Must supply a map");this._esriMap=e,this.fitTiledMapsToExtent=!!e._fitTiledMapsToExtent,this.extentManager=new u.ExtentManager(e,this.fitTiledMapsToExtent);for(var t=0;t<this.mapServices.length;t++){var i=this.mapServices[t],r=i.serviceLayer;r&&(this.extentManager.registerLayer(r),r.loaded||i.failureTimeoutThresholdExceeded?(this._layerLoadedUpdate(e),i._handleServiceLayerLoaded(r),i._handleDynamicLayers(r)):(dojo.connect(i,"onFailureTimeoutThresholdExceeded",dojo.hitch(this,this._layerLoadedUpdate,e)),dojo.connect(r,"onLoad",dojo.hitch(this,this._layerLoadedUpdate,e)),dojo.connect(r,"onError",dojo.hitch(this,this._layerLoadedUpdate,e))))}},i.prototype.calculateScale=function(){return esri.geometry.getScale(this.site.getMap())},i.prototype._addServiceLayers=function(e){for(var t=this.site&&this.site.suspendLayersOnLoad,i=this.mapServices.length-1;i>=0;i--){var r=this.mapServices[i].serviceLayer;t&&(r.suspend(),this._suspendedLayers.push(r));try{e.addLayer(r)}catch(e){this.site.onLayerLoadError(e),this.mapServices[i].initializationFailure=e}}this.setExtentOnLoad&&this.initialExtent&&this.extentManager.setInitialExtent(this.initialExtent),this.site&&dojo.isObject(this.site)&&(this.site.serviceLayersLoaded=!0,dojo.isFunction(this.site.onServiceLayersLoaded)&&this.site.onServiceLayersLoaded(this.site))},i.prototype.addServiceLayers=function(e,t){var i=this,r=this;if(e||e.length){for(var n=[],a=function(e){var i=null,a=!1,o=p.MapServiceType.FEATURE;switch(e.opacity=e.opacity||1,e.type){case"Feature Layer":i=new h.FeatureLayerService(e.url);break;default:switch(e.declaredClass){case"esri.layers.WebTiledLayer":i=new s.MapService(e.tileServers[0]),o=p.MapServiceType.WEBTILED,a=!0}}if(i){i.serviceLayer=e,i.essentialsMap=r;var l=e.layerId||d.alphaNumericToken(),u={id:l,isExpanded:!0,includeInLayerList:a,serviceFunction:t,serviceType:o,layerOptions:null};u.layerOptions={id:l,name:e.name,description:e.description,displayField:e.displayField,includeInLayerList:!0,identifiable:!0,fullExtent:e.fullExtent,primaryKeyField:e.objectIdField,visible:e.visible},i._createFrom(u),n.push(i),dojo.connect(e,"onClick",function(e){dojo.publish("FeatureClickedEvent",dojo.mixin(e,{layer:i.layers[0],useFeaturePresenter:!0}))})}},o=0;o<e.length;++o){var l=e[o];if(l.getFeatureLayers){var u=l,c=u.getFeatureLayers();if(c&&c.length>0){dojo.forEach(c,function(e){e.name=e.name||u.name,a(e)});continue}}a(l)}this.mapServices=this.mapServices.concat(n),dojo.forEach(n,function(e){return i._addToFilteredView(e)}),this._addServiceLayers(this.getMap()),dojo.forEach(n,function(e){dojo.publish("MapServiceAddedEvent",e)})}},i.prototype.removeServiceLayer=function(e){if(e&&this.mapServices.length)for(var t=0;t<this.mapServices.length;t++){var i=this.mapServices[t];if(i&&i.serviceLayer&&i.serviceLayer===e){this.mapServices.splice(t,1),dojo.publish("MapServiceRemovedEvent",i);break}}},i.prototype.resumeSuspendedLayers=function(){this._suspendedLayers.forEach(function(e){e.resume()}),this._suspendedLayers=[]},i.prototype.addMapService=function(e){var t=this.getMap(),i=this.site;e.isUserCreated=!0,e.includeInLayerList=!(e instanceof h.FeatureLayerService||e instanceof v.WFSLayerService||e instanceof m.StreamLayerService),e.opacity=1;for(var r=0,n=e.layers;r<n.length;r++){var s=n[r];s.isUserCreated=!0,s.includeInLayerList=!0,s.includeInLegend=!0,s.site=i,s.configuredVisible=!0,e.supportsLayerVisibility()?s.setVisibility(!0):s._visible=!0}e.essentialsMap=this,this.mapServices.push(e),t.addLayer(e.serviceLayer),dojo.publish("MapServiceAddedEvent",e),e.setVisibility(!0)},i.prototype.removeMapService=function(e){if(e){var t=this.mapServices.indexOf(e);t>=0&&(this.mapServices.splice(t,1),dojo.publish("MapServiceRemovedEvent",e)),this._esriMap&&e.serviceLayer&&this._esriMap.removeLayer(e.serviceLayer)}},i.prototype._configureMapServices=function(e,t){for(var i=0;e&&i<e.length;i++){var r=e[i],n=this.originalUrl+"/mapservices/"+r.id;if(r.drawingBehavior==p.DrawingBehavior.FEATURE_LAYER){if(!dojo.isObject(esri.layers.FeatureLayer))throw new Error("This Javascript application must require the esri.layers.FeatureLayer package in order to use a site with feature layers");this.mapServices[i]=new h.FeatureLayerService(n)}else if(r.drawingBehavior==p.DrawingBehavior.GEORSS_LAYER){if(!dojo.isObject(esri.layers.GraphicsLayer))throw new Error("This Javascript application must require the esri.layers.GraphicsLayer package in order to use a site with GeoRSS layers");this.mapServices[i]=new f.GeoRssLayerService(n)}else if(r.drawingBehavior==p.DrawingBehavior.KML_SERVICE){if(!dojo.isObject(esri.layers.KMLLayer))throw new Error("This Javascript application must require the esri.layers.KMLLayer package in order to use a site with KML layers");this.mapServices[i]=new y.KmlService(n)}else if(r.drawingBehavior==p.DrawingBehavior.STREAM_LAYER){if(!dojo.isObject(esri.layers.StreamLayer))throw new Error("This Javascript application must require the esri.layers.StreamLayer package in order to use a site with stream layers");this.mapServices[i]=new m.StreamLayerService(n)}else if(r.drawingBehavior==p.DrawingBehavior.WFS_LAYER){if(!dojo.isObject(esri.layers.WFSLayer))throw new Error("This Javascript application must require the esri.layers.WFSLayer package in order to use a site with WFS layers");this.mapServices[i]=new v.WFSLayerService(n),this.mapServices[i].mapServiceType=p.MapServiceType.WFS}else this.mapServices[i]=new s.MapService(n);this.mapServices[i].essentialsMap=this,this.mapServices[i].initialize(r),dojo.publish("ServiceLayerInitializedEvent",this.mapServices[i].serviceLayer),this._addToFilteredView(this.mapServices[i])}},i.prototype._configureObject=function(e,t){if(void 0===e||void 0===e.mapServices)throw new Error("Incorrect map object returned from initialization");e.initialExtent&&(this.initialExtent=new esri.geometry.Extent(e.initialExtent)),e.fullExtent&&(this.fullExtent=new esri.geometry.Extent(e.fullExtent)),e.units&&(this.units=new l.DistanceUnit(e.units.name,e.units.type)),e.exportOptions&&(this.exportMapImageOptions=new o.ExportMapImageOptions(e.exportOptions.allowIncludeGeoreferenceData,e.exportOptions.defaultOutputFormat)),e.layerThemes&&(e.layerThemes.items&&e.layerThemes.items.length||e.layerThemes.allowDefault)&&this._configureLayerThemesInfo(e.layerThemes),this._configureMapServices(e.mapServices,t),dojo.isArray(e.baseMaps)&&this._configureBaseMaps(e.baseMaps),t&&(this.isInitialized=!0),this.primaryMapService=this.findMapServiceById(e.primaryMapServiceID)},i.prototype.findMapServiceById=function(e){for(var t=0;t<this.mapServices.length;t++)if(this.mapServices[t].id==e)return this.mapServices[t];return null},i.prototype.setFeatureLayerExclusivelyVisible=function(e){for(var t=this.site.getFeatureServices(),i=0;i<t.length;i++){var r=t[i];r.setVisibility(r.serviceLayer.id===e.id)}},i.prototype.exportMap=function(e,t,i){var r=this;this._onExportComplete=t,this._onExportError=i;var n=new g.ExportMapTask(this),s=new _.ExportMapParameters;s.reportParameters=e,n.generateMapImageUrl(s).then(function(e){return r._exportRestComplete(e)},function(e){return r._exportRestError(e)})},i.prototype.findLayerFromMatchingEsriFeatureLayer=function(e){if(e){for(n=0;n<this.mapServices.length;n++)if((u=this.mapServices[n]).serviceLayer instanceof esri.layers.FeatureLayer){var t=u.serviceLayer;if(t.layerId==e.layerId&&t.name==e.name&&u.layers.length>0)return u.layers[0]}for(var i=function(e,t){var i=e.serviceUrl;return e.serviceToken&&t.search(/token=.[^&]*/g)>0&&(i=E.RestHelperHTTPService.appendTokenToUrl(i,e.serviceToken)),i},r=e.url.match(/.[^?]*/g)[0],n=0;n<this.mapServices.length;n++)if((c=i(u=this.mapServices[n],r))===r&&u.layers.length>0)return u.layers[0];var s=new RegExp("[^/]*.$"),a=Number(r.match(s)),o=new RegExp("/[^/]*.$"),l=r.replace(o,"");for(n=0;n<this.mapServices.length;n++){var u=this.mapServices[n],c=i(u,l);if(c===l){var p=u.findLayerOrTableById(a.toString());if(p)return p;if(u.layers.length>=a)return u.layers[a]}}return null}},i.prototype._exportRestComplete=function(e){var t=null;e?e.error&&(t=e.error):t=new Error("No results"),t&&this._onExportComplete&&this._onExportError(t),e&&this._onExportComplete&&this._onExportComplete(e)},i.prototype._exportRestError=function(e){this._onExportError&&this._onExportError(e)},i.prototype._layerLoadedUpdate=function(e){if(!this.serviceLayersAdded){for(var t=0;t<this.mapServices.length;t++){var i=this.mapServices[t],r=i.serviceLayer;if(!i.initializationFailure&&i.failureTimeoutThresholdExceeded&&(i.initializationFailure=new Error("Map Service - {0}: Failure timeout threshold exceeded.".format(i.id))),!r.loaded&&!i.initializationFailure&&!i.failureTimeoutThresholdExceeded)return}this.serviceLayersAdded=!0,this.spatialReference=this.primaryMapService.serviceLayer.spatialReference,this.spatialReference&&this.spatialReference.wkt&&this._switchSpatialReferenceGlobally(this.spatialReference),this._esriMap.spatialReference||(this._esriMap.spatialReference=this.spatialReference||this.initialExtent.spatialReference||this.fullExtent.spatialReference),!this._esriMap.extent&&this.initialExtent&&this._esriMap.setExtent(new esri.geometry.Extent(this.initialExtent.toJson())),this._addServiceLayers(e)}},i.prototype.applyCatalogLayersChange=function(e){e&&(this._applyCatalogChangesToDynamicLayers(e),this._applyCatalogChangesToWmsLayers(e))},i.prototype.applyStartupTheme=function(){this.layerThemesInfo.layerThemesConfigured&&this.layerThemesInfo.applyTheme(this.layerThemesInfo.startupThemeId||this.layerThemesInfo.themes[0].id)},i.prototype.refreshFilteredCollections=function(){var e=this;this.mapServicesFilteredView.length=0,dojo.forEach(this.mapServices,function(t){return e._addToFilteredView(t)});for(var t=0;t<this.mapServices.length;t++)this.mapServices[t].refreshFilteredCollections()},i.prototype._switchSpatialReferenceGlobally=function(e){if(this.initialExtent&&(this.initialExtent=new esri.geometry.Extent(this.initialExtent.xmin,this.initialExtent.ymin,this.initialExtent.xmax,this.initialExtent.ymax,e)),this.fullExtent&&(this.fullExtent=new esri.geometry.Extent(this.fullExtent.xmin,this.fullExtent.ymin,this.fullExtent.xmax,this.fullExtent.ymax,e)),this.site.hasNamedExtents&&this.site.namedExtents&&this.site.namedExtents.length)for(var t=0;t<this.site.namedExtents.length;t++){var i=this.site.namedExtents[t];i.extent=new esri.geometry.Extent(i.extent.xmin,i.extent.ymin,i.extent.xmax,i.extent.ymax,e)}this._esriMap.spatialReference=e},i.prototype._applyCatalogChangesToWmsLayers=function(e){},i.prototype._applyCatalogChangesToDynamicLayers=function(e){var t=e.mapServiceId,i=[],r=new S.LayerCatalogDetail;r.mapServiceId=t;for(var n=0;n<e.entries.length;n++)e.entries[n].isDynamic&&i.push(e.entries[n]);r.entries=i;var s=this.findMapServiceById(t);s&&s.applyCatalogLayersChange(r)},i.prototype._configureLayerThemesInfo=function(e){var t=this;if(!e)throw new Error("RestLayerThemesInfo object not defined. Cannot configure layer themes.");this.layerThemesInfo.layerThemesConfigured=!0,this.layerThemesInfo.allowDefault=void 0==e.allowDefault||e.allowDefault,this.layerThemesInfo.startupThemeId=e.startupThemeID,this.layerThemesInfo.allowDefault&&this.layerThemesInfo.themes.push(new b.LayerTheme(this.layerThemesInfo,null,e.defaultThemeDisplayName||"")),e.items&&e.items.length&&dojo.forEach(e.items,function(e){t.layerThemesInfo.themes.push(new b.LayerTheme(t.layerThemesInfo,e))})},i.prototype._addToFilteredView=function(e){e&&this._layerThemeMapServiceFilter(e)&&this.mapServicesFilteredView.push(e)},i.prototype._layerThemeMapServiceFilter=function(e){return!e.essentialsMap.layerThemesInfo.layerThemesConfigured||e.inActiveTheme},i.prototype._configureBaseMaps=function(e){var t=this;e.forEach(function(e){var i=new n.BaseMap(t);i.displayName=e.displayName,i.id=e.id,e.iconUri&&(i.iconUri=I.RestHelper.processClientSideTokens(t.site,e.iconUri)),e.exportTilesMapServiceUri&&(i.exportTilesMapServiceUri=I.RestHelper.processClientSideTokens(t.site,e.exportTilesMapServiceUri)),i.properties=w._getProperties(e.properties),i.extensions=w._getExtensions(e.extensions),dojo.isArray(e.mapServices)&&e.mapServices.forEach(function(e){var r=t.findMapServiceById(e.id);r&&i.services.push(new x.BaseMapService(r))}),t.baseMaps.push(i)})},i}(r.AsyncInitializable);i.Map=L})},"geocortex/essentials/MapGrid":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){};t.MapGrid=i})},"geocortex/essentials/MapService":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./AsyncInitializable","./MapServiceConstants","./Layer","./LayerThemeSetting","./LayerHyperlink","./TimeInfo","./LayerVisibilityEventManager","./utilities/UrlUtilities","./../geocortex","./RestHelper","./../hasProxy","./RestHelperHTTPService","./RefreshVisibility","./ServiceHelper","geocortex/framework/SimplePromise"],function(e,i,r,n,s,a,o,l,u,c,p,h,d,f,y,m,v){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var g=function(i){function r(e){var t=i.call(this,e)||this;return t.bingProperties=null,t.baseMapGroup=null,t.configuredOpacity=1,t.configuredVisible=!1,t.copyright=null,t.attributionDataUrl=null,t.hasAttributionData=!1,t.dataProvider=null,t.description=null,t.defaultDateFormat=null,t.defaultNumberFormat=null,t.disableClientCaching=!1,t.displayName=null,t.drawingBehavior=null,t.essentialsMap=null,t.extensions=[],t.failureAction=n.FailureAction.WARN,t.failureTimeout=null,t.failureTimeoutThresholdExceeded=!1,t.onFailureTimeoutThresholdExceeded=function(){},t.featureClustering=null,t.geometryServiceUrl=null,t.hasLayerCatalog=!1,t.iconUri=null,t.id=null,t.catalogId=null,t.originalUrl=null,t.imageFormat=null,t.initializationFailure=null,t.includeInLayerList=!0,t.isExpanded=!0,t.isServiceLayerLoaded=!1,t.isUserCreated=!1,t.userLayerType=null,t.layers=[],t.tables=[],t.layersFilteredView=[],t.mapServiceFunction=null,t.mapServiceType=null,t.mapUrl=null,t.maxScale=null,t.minScale=null,t.opacity=1,t.opacityFilter=1,t.operationalSpatialReference=null,t.inActiveTheme=!0,t.layerThemeSettings=[],t.layerHyperlinks=[],t.properties={},t.proxyUrl=null,t.requestEncoding=null,t.instantSearch=!1,t.serverVersion=null,t.serviceLayer=null,t.serviceToken=null,t.serviceUrl=null,t.shortDisplayName=null,t.subDomains=[],t.supportsDynamicLayers=!1,t.tileMatrixSet=null,t.tileInfo=null,t.tileRestUrl=null,t.isTimeAware=!1,t.timeInfo=null,t.timeZoneId=null,t.updateInterval=null,t.heatMap=null,t.identifiable=!1,t.includeMosaicDatasetValues=!1,t.includeCatalogItems=!1,t._needsProxy=!1,t.layerVisibilityEventManager=null,t._updateIntervalId=null,t._delayedRefreshToken=null,t._layerInfoPromises={},t._styleUrl=null,t._tileScheme=null,t._restStartTimeOverrideString=null,t._restEndTimeOverrideString=null,t._layerSecurityProxy=!1,t._featureLayerPromise=null,t._initiallyVisible=!1,t.originalUrl=e,t.url&&(t.url=c.UrlUtilities.simplify(e)),t.setInActiveTheme(!0),t}return t(r,i),r.prototype._getLayersInfo=function(e){var t=this,i=this.findLayerById(e);if(this._layerInfoPromises.all&&this._layerInfoPromises.all.isRejected()&&e&&this._layerInfoPromises[e]&&this._layerInfoPromises[e].isRejected())return this._layerInfoPromises[e];if(e&&this._layerInfoPromises[e]&&!this._layerInfoPromises[e].isRejected())return this._layerInfoPromises[e];if(this._layerInfoPromises.all&&!this._layerInfoPromises.all.isRejected())return this._layerInfoPromises.all;if(this.serviceUrl.endsWith("/MapServer")){var r=[];this.serviceLayer instanceof esri.layers.FeatureLayer?this._layerInfoPromises.all||r.push({layerId:"all",url:this.serviceUrl}):(e&&!this._layerInfoPromises[e]&&i&&!i.isDynamic&&r.push({layerId:e,url:this.serviceUrl+"/"+e}),this._layerInfoPromises.all||r.push({layerId:"all",url:this.serviceUrl+"/layers"})),r.forEach(function(e){var i;t._layerInfoPromises[e.layerId]=new Promise((i=e.url,function(e,r){t.doWhenInitialized(function(n){var s={url:i,content:{f:"json"},load:function(i){if(t.serviceLayer instanceof esri.layers.FeatureLayer&&!i.layers||i.type){var r={},n=[i];r[i.type&&"table"===i.type.toLowerCase()?"tables":"layers"]=n,i=r}e(i)},error:function(e){return r(e)},callbackParamName:"CallBack",preventCache:!1};null!==t.serviceToken&&(s.content.token=t.serviceToken),esri.request(s,{gcx:{preventCache:!1}})})}))})}else this._layerInfoPromises.all||this._layerInfoPromises.all.isRejected()||(this._layerInfoPromises.all=Promise.resolve(null));return this._layerInfoPromises[e]||this._layerInfoPromises.all},r.prototype.getConfiguredVisibleLayers=function(){return this._getVisibleLayersOfType("configuredVisible")},r.prototype.getDefaultVisibleLayers=function(){return this._getVisibleLayersOfType("defaultVisibility")},r.prototype.getVisibleLayers=function(){return this._getVisibleLayersOfType("_visible")},r.prototype._getVisibleLayersOfType=function(e){for(var t=[],i=0,r=0;r<this.layers.length;r++){var n=this.layers[r];n[e]&&null==n.parentLayerId&&(null==n.subLayerIds||0===n.subLayerIds.length?t[i++]=n.id:i=this._getVisibleGroupLayersOfType(e,n,t,i))}return t},r.prototype.isVisible=function(){var e=!1;return this.serviceLayer&&"boolean"==typeof this.serviceLayer.visible&&(e=this.serviceLayer.visible),e},r.prototype.isTiled=function(){return!!this.serviceLayer&&this.serviceLayer instanceof esri.layers.TiledMapServiceLayer},r.prototype.setVisibility=function(e){if(null!==this.serviceLayer){if(!this.supportsLayerVisibility()&&this.layers.length)for(var t=0;t<this.layers.length;t++){var i=this.layers[t];i&&(i._visible=e)}e?this.serviceLayer.show():this.serviceLayer.hide()}},r.prototype.setOpacity=function(e){(null==e||isNaN(e))&&(e=1),e=Math.min(1,Math.max(0,e)),this.opacity=e,this.serviceLayer&&this.serviceLayer.setOpacity&&this.serviceLayer.setOpacity(e*this.opacityFilter)},r.prototype.setOpacityFilter=function(e){isNaN(e)&&(e=1),e=Math.min(1,Math.max(0,e)),this.opacityFilter=e,this.serviceLayer&&this.serviceLayer.setOpacity&&this.serviceLayer.setOpacity(e*this.opacity)},r.prototype.setInActiveTheme=function(e){this.inActiveTheme=e,dojo.publish("MapServiceInActiveThemeChangedEvent",this)},r.prototype.findServiceToken=function(){return this.serviceToken?this.serviceToken:this.essentialsMap&&this.essentialsMap.site&&this.essentialsMap.site.arcGisPortalSecurityContext?this.essentialsMap.site.arcGisPortalSecurityContext.getToken(this.serviceUrl):null},r.prototype._findById=function(e,t){for(var i=0;i<t.length;i++){var r=t[i];if(r.id==e)return r}return null},r.prototype._findByName=function(e,t){for(var i=0;i<t.length;i++){var r=t[i];if(r.name==e||r.displayName==e)return r}return null},r.prototype.findLayerByName=function(e){return this._findByName(e,this.layers)},r.prototype.findLayerById=function(e){return this._findById(e,this.layers)},r.prototype.findTableByName=function(e){return this._findByName(e,this.tables)},r.prototype.findTableById=function(e){return this._findById(e,this.tables)},r.prototype.findLayerOrTableByName=function(e){var t=this.findLayerByName(e);return t||(t=this.findTableByName(e)),t},r.prototype.findLayerOrTableById=function(e){var t=this.findLayerById(e);return t||(t=this.findTableById(e)),t},r.prototype.refresh=function(e,t){var i=this,r=this.serviceLayer;if(r&&"function"==typeof r.refresh){var n=function(){if(i._delayedRefreshToken=null,!0===e&&"function"==typeof r.setDisableClientCaching){var e=r.disableClientCaching;r.setDisableClientCaching(!0),r.refresh(),r.setDisableClientCaching(e)}else r.refresh()};this._delayedRefreshToken&&clearTimeout(this._delayedRefreshToken),"number"!=typeof e?n():this._delayedRefreshToken=setTimeout(n,e)}},r.prototype.refreshFilteredCollections=function(){var e=this;this.layersFilteredView.length=0,dojo.forEach(this.layers,function(t){return e._addToFilteredView(t)})},r.prototype._configureLayers=function(e,t){for(var i=0;e&&i<e.length;i++)this.layers[i]=new s.Layer(this.url+"/layers/"+e[i].id),this.layers[i].mapService=this,this.layers[i]._configureObject(e[i],t);this._createServiceLayer(),this.minScale&&this.serviceLayer.setMinScale(this.minScale),this.maxScale&&this.serviceLayer.setMaxScale(this.maxScale),this.disableClientCaching&&this.serviceLayer&&this.serviceLayer.setDisableClientCaching&&this.serviceLayer.setDisableClientCaching(!0)},r.prototype._configureTimeInfo=function(){if(!this.serviceLayer)throw new Error("_configureTimeInfo: The esri service layer must be created before attempting to populate time information.");var e=this.serviceLayer.timeInfo;e?(this.isTimeAware=!0,this.timeInfo=l.getGcxTimeInfo(e,this._restStartTimeOverrideString,this._restEndTimeOverrideString)):this.isTimeAware=!1},r.getGcxTimeInfo=function(e,t,i){return l.getGcxTimeInfo.apply(this,arguments)},r.prototype._configureTables=function(e,t){for(var i=0;e&&i<e.length;i++)this.tables[i]=new s.Layer(this.url+"/tables/"+e[i].id),this.tables[i].mapService=this,this.tables[i]._configureObject(e[i],t)},r.prototype._createFrom=function(e){var t=this;if(this.id=e.id,this.serviceUrl=e.serviceUrl,this.tileRestUrl=e.tileRestUrl,this.mapUrl=e.mapUrl,this.subDomains=(e.subDomains||[]).slice(),this.mapServiceType=e.serviceType,this.mapServiceFunction=e.serviceFunction,this.displayName=e.displayName||e.name,this.shortDisplayName=e.shortDisplayName,this.baseMapGroup=e.baseMapGroup,this.baseMapGroupIndex=e.baseMapGroupIndex,this.baseMapGroupIsMutuallyExclusive=e.baseMapGroupIsMutuallyExclusive,this.description=e.description,this.copyright=e.copyright,this.attributionDataUrl=e.attributionDataUrl,this.hasAttributionData=e.hasAttributionData,this.configuredVisible=!!e.visible,this._initiallyVisible=this.configuredVisible,this.disableClientCaching=!!e.disableClientCaching,this.instantSearch=!!e.instantSearch,this.configuredOpacity=e.opacity,this.opacity=this.configuredOpacity,this.imageFormat=e.format,this.isExpanded=e.isExpanded,this.isUserCreated=void 0==e.isUserCreated?this.isUserCreated:e.isUserCreated,this.userLayerType=void 0==e.userLayerType?this.userLayerType:e.userLayerType,this.serverVersion=e.serverVersion,this.failureAction=e.failureAction,this.failureTimeout=e.failureTimeout,this.tileMatrixSet=e.tileMatrixSet,this.requestEncoding=e.requestEncoding,this.operationalSpatialReference=e.operationalSpatialReference,this.dataProvider=e.dataProvider,this.minScale=e.minScale,this.maxScale=e.maxScale,this.identifiable=!!e.identifiable,this.includeCatalogItems=!!e.includeCatalogItems,this.includeMosaicDatasetValues=!!e.includeMosaicDatasetValues,this.defaultDateFormat=e.defaultDateFormat,this.defaultNumberFormat=e.defaultNumberFormat,this.timeZoneId=e.timeZoneId,this.serviceTag=e.serviceTag,e.tileInfo&&(this.tileInfo=dojo.clone(e.tileInfo),this.tileInfo.spatialReference&&(this.tileInfo.spatialReference.wkid?this.tileInfo.spatialReference=new esri.SpatialReference(this.tileInfo.spatialReference.wkid):this.tileInfo.spatialReference=new esri.SpatialReference(this.tileInfo.spatialReference.wkt))),this.supportsDynamicLayers=!1,this.includeInLayerList=e.includeInLayerList,this.drawingBehavior=e.drawingBehavior||n.DrawingBehavior.FEATURE_LAYER,e.layerOptions){var i=new s.Layer;i.mapService=this,i._createFrom(e.layerOptions),this.layers.push(i)}e.hasOwnProperty("layerHyperlinks")&&e.layerHyperlinks.forEach(function(e){t.layerHyperlinks.push(new o.LayerHyperlink(e,t))}),e.featureClustering&&(this.featureClustering={enabled:e.featureClustering.enabled,userCanToggle:e.featureClustering.userCanToggle,radius:e.featureClustering.radius,maximumFeatures:e.featureClustering.clusterSize,backgroundColor:e.featureClustering.backgroundColor,labelColor:e.featureClustering.labelColor}),e.featureHeatMap&&(this.heatMap={enabled:e.featureHeatMap.enabled,userCanToggle:e.featureHeatMap.userCanToggle,respectScaleRange:e.featureHeatMap.respectScaleRange,gradient:(e.featureHeatMap.gradient||[]).slice(),offset:(e.featureHeatMap.offset||[]).slice(),intensity:e.featureHeatMap.intensity,field:e.featureHeatMap.field,defaultRenderer:e.featureHeatMap.defaultRenderer?esri.renderer.fromJson(e.featureHeatMap.defaultRenderer):null,defaultMinScale:e.featureHeatMap.defaultMinScale,defaultMaxScale:e.featureHeatMap.defaultMaxScale,includeInLegend:e.featureHeatMap.includeInLegend}),e.properties&&(this.catalogId=p._getProperties(e.properties).layerCatalogLookupId),this.isInitialized=!0},r.prototype.createFromDefinition=function(e){this._createFrom(e)},r.prototype.toJson=function(){var e={id:this.id,url:this.url,serviceUrl:this.serviceUrl,mapUrl:this.mapUrl,tileRestUrl:this.tileRestUrl,subDomains:(this.subDomains||[]).slice(),serviceType:this.mapServiceType,serviceFunction:this.mapServiceFunction,displayName:this.displayName,shortDisplayName:this.shortDisplayName,baseMapGroup:this.baseMapGroup,baseMapGroupIndex:this.baseMapGroupIndex,baseMapGroupIsMutuallyExclusive:this.baseMapGroupIsMutuallyExclusive,description:this.description,copyright:this.copyright,attributionDataUrl:this.attributionDataUrl,hasAttributionData:this.hasAttributionData,visible:this.isVisible(),disableClientCaching:this.disableClientCaching,opacity:this.opacity,instantSearch:this.instantSearch,format:this.imageFormat,updateInterval:this.updateInterval,isExpanded:this.isExpanded,serverVersion:this.serverVersion,failureAction:this.failureAction,failureTimeout:this.failureTimeout,tileMatrixSet:this.tileMatrixSet,requestEncoding:this.requestEncoding,operationalSpatialReference:this.operationalSpatialReference,dataProvider:this.dataProvider,minScale:this.minScale,maxScale:this.maxScale,identifiable:this.identifiable,includeCatalogItems:this.includeCatalogItems,includeMosaicDatasetValues:this.includeMosaicDatasetValues,defaultDateFormat:this.defaultDateFormat,defaultNumberFormat:this.defaultNumberFormat,timeZoneId:this.timeZoneId,serviceTag:this.serviceTag,startTime:this._restStartTimeOverrideString,endTime:this._restEndTimeOverrideString,tileInfo:this.tileInfo&&"function"==typeof this.tileInfo.toJson?this.tileInfo.toJson():void 0,supportsDynamicLayers:this.supportsDynamicLayers,hasLayerCatalog:this.hasLayerCatalog,includeInLayerList:this.includeInLayerList,drawingBehavior:this.drawingBehavior,layerOptions:this.layers.map(function(e){return e.toJson()}),catalogId:this.catalogId,isUserCreated:this.isUserCreated,userLayerType:this.userLayerType,tables:this.tables.map(function(e){return e.toJson()}),layerHyperlinks:this.layerHyperlinks.map(function(e){return e.toJson()}),properties:p._propertiesToJson(this.properties),extensions:p._extensionsToJson(this.extensions)};return this.featureClustering&&(e.featureClustering=dojo.clone(this.featureClustering)),this.heatMap&&(e.featureHeatMap=dojo.clone(this.heatMap),e.featureHeatMap.defaultRenderer instanceof esri.renderer.Renderer&&(e.featureHeatMap.defaultRenderer=e.featureHeatMap.defaultRenderer.toJson())),e},r.prototype._configureObject=function(e,t){var i=this;if(void 0===e||void 0===e.id||void 0===e.displayName||void 0===e.serviceType||void 0==e.connectionString)throw new Error("Incorrect map service object returned from initialization");if(this.id=e.id,this.mapServiceType=e.serviceType,this.mapServiceFunction=void 0===e.serviceFunction?this.mapServiceFunction:e.serviceFunction,this.displayName=e.displayName,this.shortDisplayName=e.shortDisplayName,this.baseMapGroup=e.baseMapGroup,this.baseMapGroupIndex=e.baseMapGroupIndex,this.baseMapGroupIsMutuallyExclusive=e.baseMapGroupIsMutuallyExclusive,this.description=void 0===e.description?this.description:e.description,this.copyright=e.copyright,this.attributionDataUrl=e.attributionDataUrl,this.hasAttributionData=e.hasAttributionData,this.configuredVisible=!!e.visible,this.disableClientCaching=!!e.disableClientCaching,this.instantSearch=!!e.instantSearch,this.configuredOpacity=void 0===e.opacity||null===e.opacity?this.configuredOpacity:e.opacity,this.opacity=this.configuredOpacity,this.imageFormat=void 0===e.format?this.imageFormat:e.format,void 0!==e.updateInterval&&null!==e.updateInterval){var r=e.updateInterval;r&&r<10&&0!==r&&(r=10),this.updateInterval=r,this._resetUpdateTimer()}if(this.tileRestUrl=e.tileRestUrl,this.mapUrl=e.mapUrl,this.subDomains=(e.subDomains||[]).slice(),this.isExpanded=void 0==e.isExpanded?this.isExpanded:e.isExpanded,this.isUserCreated=void 0==e.isUserCreated?this.isUserCreated:e.isUserCreated,this.userLayerType=void 0==e.userLayerType?this.userLayerType:e.userLayerType,this.catalogId=void 0==e.catalogId?this.catalogId:e.catalogId,this.serverVersion=e.serverVersion,this.failureAction=e.failureAction,this.failureTimeout=e.failureTimeout,this.tileMatrixSet=e.tileMatrixSet,this.requestEncoding=e.requestEncoding,this.operationalSpatialReference=e.operationalSpatialReference,this.dataProvider=e.dataProvider,this.minScale=e.minScale,this.maxScale=e.maxScale,this.identifiable=!!e.identifiable,this.includeCatalogItems=!!e.includeCatalogItems,this.includeMosaicDatasetValues=!!e.includeMosaicDatasetValues,this.defaultDateFormat=e.defaultDateFormat,this.defaultNumberFormat=e.defaultNumberFormat,this.timeZoneId=e.timeZoneId,this.serviceTag=e.serviceTag,this._restStartTimeOverrideString=e.startTime||null,this._restEndTimeOverrideString=e.endTime||null,e.tileInfo&&(this.tileInfo=dojo.clone(e.tileInfo),this.tileInfo.spatialReference&&(this.tileInfo.spatialReference.wkid?this.tileInfo.spatialReference=new esri.SpatialReference(this.tileInfo.spatialReference.wkid):this.tileInfo.spatialReference=new esri.SpatialReference(this.tileInfo.spatialReference.wkt))),"boolean"==typeof e.includeInLayerList&&(this.includeInLayerList=e.includeInLayerList),this.isUserCreated)this._initiallyVisible=void 0===e.initiallyVisible?!!e.visible:!!e.initiallyVisible;else if(null!=this.essentialsMap.layerThemesInfo.startupThemeId&&this.includeInLayerList?this._initiallyVisible=!1:this._initiallyVisible=void 0===e.initiallyVisible?!!e.visible:!!e.initiallyVisible,e.themeSettings&&e.themeSettings.length)for(var n=0;n<e.themeSettings.length;n++){var s=e.themeSettings[n],l=this.essentialsMap.layerThemesInfo.getTheme(s.themeID);if(l){var u=void 0==s.visible?this.configuredVisible:s.visible;this.layerThemeSettings.push(new a.LayerThemeSetting(l,u)),l.id===this.essentialsMap.layerThemesInfo.startupThemeId&&this.includeInLayerList&&(this._initiallyVisible=void 0===s.initiallyVisible?u:s.initiallyVisible)}}if(this.supportsDynamicLayers=void 0===e.supportsDynamicLayers?this.supportsDynamicLayers:e.supportsDynamicLayers,this.hasLayerCatalog=void 0===e.hasLayerCatalog?this.hasLayerCatalog:e.hasLayerCatalog,e.iconUri){var c=null;this.essentialsMap&&(c=this.essentialsMap.site),this.iconUri=h.RestHelper.processClientSideTokens(c,e.iconUri)}e.featureClustering&&(this.featureClustering={enabled:e.featureClustering.enabled,userCanToggle:e.featureClustering.userCanToggle,radius:e.featureClustering.radius,maximumFeatures:e.featureClustering.clusterSize,backgroundColor:e.featureClustering.backgroundColor,labelColor:e.featureClustering.labelColor}),e.featureHeatMap&&(this.heatMap={enabled:e.featureHeatMap.enabled,userCanToggle:e.featureHeatMap.userCanToggle,respectScaleRange:e.featureHeatMap.respectScaleRange,gradient:(e.featureHeatMap.gradient||[]).slice(),offset:(e.featureHeatMap.offset||[]).slice(),intensity:e.featureHeatMap.intensity,field:e.featureHeatMap.field,defaultRenderer:e.featureHeatMap.defaultRenderer?esri.renderer.fromJson(e.featureHeatMap.defaultRenderer):null,defaultMinScale:e.featureHeatMap.defaultMinScale,defaultMaxScale:e.featureHeatMap.defaultMaxScale,includeInLegend:e.featureHeatMap.includeInLegend}),this.drawingBehavior=void 0===e.drawingBehavior?this.drawingBehavior:e.drawingBehavior,this._processConnectionString(e.connectionString,e),this._processProxyInfo(e.proxyInfo);var d=e.layers||e.layerOptions;this._configureLayers(d,t),this._configureTables(e.tables,t),e.hasOwnProperty("layerHyperlinks")&&e.layerHyperlinks.forEach(function(e){i.layerHyperlinks.push(new o.LayerHyperlink(e,i))}),t&&(this.isInitialized=!0),this.properties=p._getProperties(e.properties),this.extensions=p._getExtensions(e.extensions),this.setOpacity(this.configuredOpacity)},r.prototype._updateServiceToken=function(e){if(this.serviceToken=e,this.serviceLayer&&this.serviceLayer._url){var t=this.serviceLayer._url;if(t.query){t.query.token=e;var i=dojo.objectToQuery(t.query);this.serviceLayer.url=t.path+(i?"?"+i:"")}}this._updateCredentialForLayer(),dojo.publish("ServiceTokenRefreshed",{serviceUrl:this.serviceUrl,token:e})},r.prototype._addDefinitionExpression=function(e,t){if(!e)throw new Error("Expecting a layer");if((t=t||this.serviceLayer)instanceof esri.layers.ArcGISDynamicMapServiceLayer){var i=e.getDefinitionExpression(null);if(i){var r=parseInt(e.id),n=t.layerDefinitions||[];if(!r)throw new Error("Failed to add definition expression for "+e.displayName);n[r]=i,t.setLayerDefinitions(n)}}},r.prototype._removeDefinitionExpression=function(e,t){if(e&&(t=t||this.serviceLayer)&&t instanceof esri.layers.ArcGISDynamicMapServiceLayer){var i=parseInt(e.id);if(i&&t.layerDefinitions){var r=t.layerDefinitions;r[i]&&(r.splice(i,1),t.setLayerDefinitions(r))}}},r.prototype._createServiceLayer=function(){var t=this;if(null==this.serviceLayer){var i=this.serviceUrl;if(null!=this.serviceToken&&(i=f.RestHelperHTTPService.appendTokenToUrl(i,this.serviceToken)),"MapService"===this.drawingBehavior){var s;switch(this.mapServiceType){case n.MapServiceType.DYNAMIC:this._needsProxy&&(esri.config.defaults.io.alwaysUseProxy=!0);var a=new esri.layers.ArcGISDynamicMapServiceLayer(i,{id:this.id});this._applyAttributionUrl(a);var o=this.getVisibleLayers();for(0===o.length?a.setVisibleLayers&&(0===this.layers.length?a.setVisibleLayers(o,!1):a.setVisibleLayers(["-1"],!1)):a.setVisibleLayers&&a.setVisibleLayers(o,!1),y=0;y<this.layers.length;y++)this._addDefinitionExpression(this.layers[y],a);this.layerVisibilityEventManager=new u.LayerVisibilityEventManager(this,a),a.setImageFormat(this._getAgsDynamicImageFormat(this.imageFormat)),dojo.connect(a,"onError",this,this._layerLoadErrorHandler),dojo.connect(a,"onLoad",this,function(){this._handleServiceLayerLoaded(a),this._handleDynamicLayers(a)}),this._initiallyVisible?a.show():a.hide(),this.serviceLayer=a;break;case n.MapServiceType.TILED:var l=new esri.layers.ArcGISTiledMapServiceLayer(i,{id:this.id});this._applyAttributionUrl(l),dojo.connect(l,"onError",dojo.hitch(this,this._layerLoadErrorHandler)),dojo.connect(l,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),this._initiallyVisible?l.show():l.hide(),this.serviceLayer=l;break;case n.MapServiceType.IMAGE:var c=null;this._hasTileLevels()?c=new esri.layers.ArcGISTiledMapServiceLayer(i,{id:this.id}):(c=new esri.layers.ArcGISImageServiceLayer(i,{id:this.id})).setImageFormat(this._getAgsImageServiceImageFormat(this.imageFormat)),this._applyAttributionUrl(c),dojo.connect(c,"onError",this,this._layerLoadErrorHandler),dojo.connect(c,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),this._initiallyVisible?c.show():c.hide(),this.serviceLayer=c;break;case n.MapServiceType.BING:var p=new esri.virtualearth.VETiledLayer(this.bingProperties);dojo.connect(p,"onError",this,this._layerLoadErrorHandler),dojo.connect(p,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),this._initiallyVisible?p.show():p.hide(),this.serviceLayer=p;break;case n.MapServiceType.WMS:if(!dojo.isObject(esri.layers.WMSLayer))throw new Error("This Javascript application must require the esri.layers.wms package in order to use a site with a WMS service.");this._extendWms();for(var h=!1,y=0;y<this.layers.length;y++)if(this.layers[y].wmsLayerName){h=!0;break}var m;if(h){if(s={extent:this.essentialsMap.initialExtent,layerInfos:this._constructWmsLayerInfos(),version:this.serverVersion},m=new esri.layers.WMSLayer(i,{resourceInfo:s,visibleLayers:this._getWmsVisibleLayers()}),null!=this.operationalSpatialReference){var v=parseInt(this.operationalSpatialReference.replace(/^.*:/,""));m.spatialReferences.push(v),m.preferredSpatialReference=v}dojo.connect(m,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded))}else m=new esri.layers.WMSLayer(i),dojo.connect(m,"onLoad",dojo.hitch(this,this._finishWmsLayerConfiguration));if(this._restStartTimeOverrideString&&this._restEndTimeOverrideString&&!m.timeInfo){var g=r.getGcxTimeInfo(null,this._restStartTimeOverrideString,this._restEndTimeOverrideString);if(g){var _={timeExtent:new esri.TimeExtent(g.timeExtent.startTime,g.timeExtent.endTime)};m.timeInfo=_}}m.id=this.id,this._applyAttributionUrl(m),this.layerVisibilityEventManager=new u.LayerVisibilityEventManager(this,m),m.setImageFormat(this._getEsriWmsImageFormat()),m.__gcxWmsImageFormat=this.imageFormat,dojo.connect(m,"onError",this,this._layerLoadErrorHandler),this._initiallyVisible?m.show():m.hide(),this.serviceLayer=m,this._corsRequest(this._prefixProxy(i)).then(function(){m.refresh()},function(e){m.refresh()});break;case n.MapServiceType.WMTS:if(!dojo.isObject(esri.layers.WMTSLayer))throw new Error("This JavaScript application must require the esri.layers.wmts package in order to use a site with WMTS service.");if(0==this.layers.length)throw new Error("You must include at least one layer in your WMTS. Service "+this.displayName+" has 0 layers.");var S=this.layers[0].fullExtent||this.essentialsMap.fullExtent;if(this.tileInfo){var b={900913:102100,3857:102100};if(b[this.tileInfo.spatialReference.wkid]){var I=new esri.SpatialReference(b[this.tileInfo.spatialReference.wkid]);this.tileInfo.spatialReference=I,b[S.spatialReference.wkid]&&(S.spatialReference=I)}}var w=new esri.layers.WMTSLayerInfo({tileInfo:this.tileInfo,fullExtent:S,initialExtent:S,identifier:this.layers.length>0?this.layers[0].name:null,tileMatrixSet:this.tileMatrixSet,format:this._getEsriOgcImageFormat(),style:this.layers[0].styleName?this.layers[0].styleName:""}),x={serviceMode:"KVP",resourceInfo:s={version:this.serverVersion,layerInfos:[w],getTileUrl:this._prefixProxy(this.mapUrl)},layerInfo:w};if((T=new esri.layers.WMTSLayer(i,x)).id=this.id,this._applyAttributionUrl(T),T._url){var E=0,L=d.hasProxy()?2:1;T._url=T._url.replace(/\?/g,function(e){return++E<=L?"?":""})}dojo.connect(T,"onError",this,this._layerLoadErrorHandler),dojo.connect(T,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),this._initiallyVisible?T.show():T.hide(),this.serviceLayer=T;break;case n.MapServiceType.WEBTILED:var T=i.replace(/([^$])({[^}]*})/g,function(e,t,i){return t+"$"+i});E={copyright:this.copyright,id:this.id,subDomains:null,tileInfo:this._tileScheme?this.tileInfo:null};T.indexOf("${subDomain}")>=0&&(E.subDomains=this.subDomains),(L=new esri.layers.WebTiledLayer(T,E)).id=this.id,this._applyAttributionUrl(L),this._initiallyVisible?L.show():L.hide(),dojo.connect(L,"onError",this,this._layerLoadErrorHandler),dojo.connect(L,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),this.serviceLayer=L;break;case n.MapServiceType.VECTORTILE:var M=i;if(this._styleUrl&&(M=this._styleUrl,this.essentialsMap&&this.essentialsMap.site)){var D=this.essentialsMap.site.getTokenFromPrincipal(this._styleUrl,this.mapServiceType);D&&(M=f.RestHelperHTTPService.appendTokenToUrl(this._styleUrl,D))}e(["esri/layers/VectorTileLayer"],function(e){t._layerSecurityProxy&&t._addCredentialForLayer();var i=new e(M);i.id=t.id,i.loadError&&t._layerLoadErrorHandler(i.loadError),dojo.aspect.before(i,"_frame",dojo.hitch(i,function(){this._frameRequested&&this.spatialReference&&this._viewState&&!this._viewState.spatialReference&&(this._viewState.spatialReference=this.spatialReference)})),t._initiallyVisible?i.show():i.hide(),dojo.connect(i,"onError",t,t._layerLoadErrorHandler),dojo.connect(i,"onLoad",dojo.hitch(t,t._handleServiceLayerLoaded)),t._applyAttributionUrl(i),t.serviceLayer=i})}this.initiateServiceFailureTimer()}}},r.prototype.initiateServiceFailureTimer=function(){var e=this;this.failureTimeout&&!isNaN(this.failureTimeout)&&setTimeout(function(){e.serviceLayer&&(!e.serviceLayer||e.serviceLayer.loaded)||e.initializationFailure||(e.failureTimeoutThresholdExceeded=!0,e.onFailureTimeoutThresholdExceeded())},1e3*this.failureTimeout)},r.prototype._addCredentialForLayer=function(){var e=esri.id,t=this.findServiceToken(),i=e.credentials;if(t&&e&&i instanceof Array){for(var r=0;r<i.length;r++)if(i[r].server===this.url){i.splice(r,1);break}var n=new esri.Credential;n.token=t,n.server=this.url,n.resources=[this.serviceUrl],n.scope="server",this.url.startsWith("https")?n.ssl=!0:n.ssl=!1,i.push(n)}},r.prototype._updateCredentialForLayer=function(){var e=esri.id,t=this.findServiceToken(),i=e.credentials;if(t&&e&&i instanceof Array)for(var r=0;r<i.length;r++)if(i[r].server===this.url){i[r].token=this.serviceToken;break}},r.prototype._applyAttributionUrl=function(e){if(this.attributionDataUrl&&""!==this.attributionDataUrl)e.attributionDataUrl=this.attributionDataUrl,e.hasAttributionData=!0;else if(this.hasAttributionData){e.attributionDataUrl=this.url+"/attribution",e.hasAttributionData=!0;var t=f.RestHelperHTTPService.getTokenForScope(e.attributionDataUrl);t&&(e.attributionDataUrl=f.RestHelperHTTPService.appendTokenToUrl(e.attributionDataUrl,t))}},r.prototype._prefixProxy=function(e){return this.proxyUrl?this.proxyUrl+"?"+e:e},r.prototype._constructWmsLayerInfos=function(){for(var e=[],t=0;t<this.layers.length;t++){var i=this.layers[t];if(null!=i.wmsLayerName){var r=new esri.layers.WMSLayerInfo({name:i.wmsLayerName,title:i.name});r.styleName=i.styleName,e.push(r)}}return e},r.prototype._getWmsVisibleLayers=function(){for(var e=[],t=0;t<this.layers.length;t++){var i=this.layers[t];i.isVisible()&&i.areAllAncestorsVisible()&&null!=i.wmsLayerName&&0==i.subLayerIds.length&&e.push(i.wmsLayerName)}return e},r.prototype._applyWmsLayerVisibility=function(){var e=this._getWmsVisibleLayers();this.serviceLayer.setVisibleLayers(e)},r.prototype._getEsriWmsImageFormat=function(){var e=this._getEsriOgcImageFormat();return"jpeg"==e&&(e="jpg"),e},r.prototype._getEsriOgcImageFormat=function(){return null!=this.imageFormat?this.imageFormat.replace(/^image\//,""):null},r.prototype._findWMSLayerName=function(e,t){for(var i in e){var r=e[i];if(r.title===t)return r.name;if(null!==r.subLayers&&r.subLayers.length>0){var n=this._findWMSLayerName(r.subLayers,t);if(null!==n)return n}}return null},r.prototype._finishWmsLayerConfiguration=function(e){for(var t,i=[],r=0,n=0;n<this.layers.length;n++){var s=this.layers[n];!s.configuredVisible||null!==s.subLayerIds&&0!==s.subLayerIds.length||(null!==s.parentLayerId?this.findLayerById(s.parentLayerId).configuredVisible&&(t=this._getWMSLayerNameFromTitle(s.name),s.wmsLayerName=t,null!==t&&""!==t&&(i[r]=t,r++)):(t=this._getWMSLayerNameFromTitle(s.name),s.wmsLayerName=t,null!==t&&""!==t&&(i[r]=t,r++)))}this.serviceLayer.setVisibleLayers(i),this._handleServiceLayerLoaded(e)},r.prototype._handleServiceLayerLoaded=function(e){this._configureTimeInfo(),this.isServiceLayerLoaded=!0,this.essentialsMap&&this.essentialsMap.site&&dojo.isFunction(this.essentialsMap.site.onLayerLoad)&&this.essentialsMap.site.onLayerLoad(e)},r.prototype.convertToDynamicLayers=function(){var e=this.serviceLayer;e&&e instanceof esri.layers.ArcGISDynamicMapServiceLayer&&(e.dynamicLayerInfos||e.setDynamicLayerInfos(this._createDynamicLayerInfos(e)),e.layerDrawingOptions||(e.layerDrawingOptions=[]))},r.prototype._layerLoadErrorHandler=function(e){e&&e.message&&0==e.message.indexOf("Unable to load tile")||(this.initializationFailure=e,this.essentialsMap&&this.essentialsMap.site&&dojo.isFunction(this.essentialsMap.site.onLayerLoadError)&&(this._layerLoadErrorHandler=this.essentialsMap.site.onLayerLoadError))},r.prototype.remove=function(e){if(!e)throw new Error("Expecting a layer.");var t=this.serviceLayer;if(!(e.isDynamic&&this.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer&&this.serviceLayer))throw"MapService - remove() - Unsupported Layer Type.";this.convertToDynamicLayers();var i=parseInt(e.id,10),r=this.findLayerById(e.id);null!=r&&(u=this.layers.indexOf(r))>-1&&(r.setInActiveTheme(!1),this.layers.splice(u,1),dojo.publish("CatalogLayerRemovedEvent",r));var n=this.getVisibleLayers();if(null==i)throw"Could not convert Layer ID '"+e.id+"' into an integer!";var s=[];t.dynamicLayerInfos&&(s=dojo.clone(this.serviceLayer.dynamicLayerInfos));var a=[];if(t.layerDrawingOptions&&(a=this.serviceLayer.layerDrawingOptions),e.isDynamic){for(var o=null,l=0;l<s.length;l++)if(s[l].id===i){o=s[l];break}if(o){var u=s.indexOf(o);u>-1&&(s.splice(u,1),t.setDynamicLayerInfos(s,!0))}var c=[];for(var p in a)a.hasOwnProperty(p)&&p!==e.id&&(c[p]=dojo.clone(a[p]));this._removeDefinitionExpression(e,t),t.setLayerDrawingOptions(c)}n.indexOf(e.id)>-1&&n.splice(n.indexOf(e.id),1),this._syncLayerVisibilities(n)},r.prototype.add=function(e){if(!e)throw new Error("Expecting a layer");var t=this.serviceLayer;if(!(e.isDynamic&&t instanceof esri.layers.ArcGISDynamicMapServiceLayer))throw"MapService - add() - Unsupported layer type..";this.convertToDynamicLayers();var i=this.getVisibleLayers();e.mapService=this;var r=[];t.dynamicLayerInfos&&(r=t.dynamicLayerInfos);var n=[];t.layerDrawingOptions&&(n=t.layerDrawingOptions);var s,a,o=parseInt(e.id,10);if(null==o)throw"Could not convert Layer ID '"+e.id+"' into an integer!";(s=e._createDynamicLayerInfo()).name||(s.name=e.displayName),null!=s&&r.push(s),null!=(a=e.getLayerDrawingOptions())&&(n[o]=a),n.length>0&&t.setLayerDrawingOptions(n,!0),this._addDefinitionExpression(e,t),t.setDynamicLayerInfos(r),i.push(e.id),this._syncLayerVisibilities(i),this.layers.push(e),dojo.publish("CatalogLayerAddedEvent",e)},r.prototype.getDynamicLayerInfoById=function(e){var t=null;if(this.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var i=parseInt(e,10);if(!isNaN(i)){var r=this.serviceLayer.dynamicLayerInfos;if(r)for(var n=0;n<r.length;n++)r[n].id===i&&(t=r[n])}}return t},r.prototype._syncLayerVisibilities=function(e){for(var t=0;t<this.layers.length;t++)e.indexOf(this.layers[t].id)>-1?this.layers[t].visibleStateForRefresh=y.RefreshVisibility.SHOW:this.layers[t].visibleStateForRefresh=y.RefreshVisibility.HIDE;0==e.length&&e.push("-1"),this.serviceLayer.setVisibleLayers(e)},r.prototype._handleDynamicLayers=function(e){var t=this;if(this.supportsDynamicLayers){var i=dojo.some(this.layers,function(e){return e.isDynamic}),r=dojo.some(this.layers,function(e){return null!=e.drawIndex}),n=dojo.some(this.layers,function(e){return e.canToggleLabels&&!e.showLabels});if(i||r||n||this.hasLayerCatalog){var s=this.essentialsMap.getMap();if(s&&(s.spatialReference&&(s.spatialReference.wkid&&!(s.spatialReference.wkid<=0)||s.spatialReference.wkt&&s.spatialReference.wkt.trim())||null!=e.spatialReference&&e.spatialReference.wkt&&e.spatialReference.wkt.trim()&&(s.spatialReference=e.spatialReference),s.extent&&(!s.extent.spatialReference||(!s.extent.spatialReference.wkid||s.extent.spatialReference.wkid<=0)&&(!s.extent.spatialReference.wkt||!s.extent.spatialReference.wkt.trim()))&&null!=e.spatialReference&&e.spatialReference.wkt&&e.spatialReference.wkt.trim())){var a=new esri.geometry.Extent(s.extent);a.spatialReference=e.spatialReference,this.essentialsMap.extentManager.setExtentWithPriority(a,2)}var o=this._createDynamicLayerInfos(e),l=[];if(e.layerDrawingOptions&&(l=dojo.mixin([],e.layerDrawingOptions)),n&&dojo.forEach(this.layers,function(e,t){if(e.canToggleLabels){var i=e.getLayerDrawingOptions();if(null==i){i=new esri.layers.LayerDrawingOptions;var r=parseInt(e.id,10);l[r]=i}i.showLabels=e.showLabels}}),dojo.forEach(this.layers,function(e,t){if(e.isDynamic){var i,r,n=parseInt(e.id,10);if(!n)throw"Could not convert Layer ID '"+e.id+"' into an integer!";(i=e._createDynamicLayerInfo()).name||(i.name=e.name),i&&o.splice(t,0,i),(r=e.getLayerDrawingOptions())&&(l[n]=r,null!=e.showLabels&&(r.showLabels=e.showLabels))}}),r){var u=dojo.clone(o),c=[];dojo.forEach(this.layers,function(e,t){null!=e&&null!=e.drawIndex&&c.push(e)}),c.sort(function(e,t){return e.drawIndex-t.drawIndex}),dojo.forEach(c,function(e,t){for(var i=null,r=null,n=0;n<u.length;n++){var s=u[n];if(s.id.toString()==e.id){i=s,r=n;break}}null!=i&&null!=r&&(u.splice(r,1),u.push(i))}),o=[],dojo.forEach(u,function(e,t){o.push(e)})}setTimeout(function(){e.visibleLayers,l.length>0&&e.setLayerDrawingOptions(l,!0),o.length>0&&e.setDynamicLayerInfos(o,!0);var i=t.getVisibleLayers();i.InternallyChangedLayer={},i.length>0?e.setVisibleLayers(i):(i.push("-1"),e.setVisibleLayers(i))},0)}}},r.prototype._createDynamicLayerInfos=function(e,t){void 0==t&&(t=!0);var i=null;if(null!=e&&(i=e.createDynamicLayerInfosFromLayerInfos(),t))for(var r=i.length-1;r>=0;r--){var n=this.findLayerById(i[r].id.toString());(null==n||n.isDynamic)&&i.splice(r,1)}return i},r.prototype._getAgsDynamicImageFormat=function(e){if(void 0===e||null===e||e.length<1)return"png8";var t=e.toLowerCase();switch(t){case"png":case"png8":case"png24":case"png32":case"jpeg":case"jpg":case"gif":case"bmp":case"svg":case"svgz":case"emf":case"ps":case"pdf":return t;default:return"png8"}},r.prototype._getAgsImageServiceImageFormat=function(e){if(void 0===e||null===e||e.length<1)return null;var t=e.toLowerCase();switch(t){case"jpgpng":case"png":case"png8":case"png24":case"png32":case"jpeg":case"jpg":case"gif":case"bmp":case"tiff":return t;default:return null}},r.prototype._getVisibleGroupLayersOfType=function(e,t,i,r){if(t[e])for(var n=0;n<t.subLayerIds.length;n++){var s=this.findLayerById(t.subLayerIds[n]);s[e]&&(null!==s.subLayerIds&&s.subLayerIds.length>0?r=this._getVisibleGroupLayersOfType(e,s,i,r):dojo.indexOf(i,s.id)<0&&(i[r]=s.id,r++))}return r},r.prototype._getWMSLayerNameFromTitle=function(e){return this.serviceLayer instanceof esri.layers.WMSLayer?this._findWMSLayerName(this.serviceLayer.layerInfos,e):null},r.prototype._getPrincipalResult=function(e){if(this.essentialsMap&&this.essentialsMap.site&&this.essentialsMap.site.principal)return e(this.essentialsMap.site.principal)},r.prototype._processConnectionString=function(e,t){var i=m.ServiceHelper.extractConnectionStringValue;if(this.mapServiceType==n.MapServiceType.BING){var r;this.bingProperties={},(r=i(e,"mapStyle"))&&r.length>0&&(this.bingProperties.mapStyle=r),(r=i(e,"culture"))&&r.length>0&&(this.bingProperties.culture=r),(r=i(e,"key"))&&r.length>0&&(this.bingProperties.bingMapsKey=r)}else{var s=i(e,"url");if(s.length>0)this.serviceUrl=s.replace(/%3d/g,"=").replace(/%3D/g,"=").replace(/%3a/g,":").replace(/%3A/g,":");else if((this.mapServiceType===n.MapServiceType.DYNAMIC||this.mapServiceType===n.MapServiceType.TILED)&&this.essentialsMap.site.getEssentialsVersion()>=3.912||(this.mapServiceType===n.MapServiceType.FEATURE||this.mapServiceType===n.MapServiceType.IMAGE||this.mapServiceType===n.MapServiceType.STREAM||this.mapServiceType===n.MapServiceType.VECTORTILE)&&this.essentialsMap.site.getEssentialsVersion()>=4.01){if(this._layerSecurityProxy=!0,this.essentialsMap.site.getEssentialsVersion()<4.03)this.serviceUrl=this.url+"/MapServer";else{var a=this.essentialsMap.site.getEssentialsVersion()<4.05?"/GeoREST":"/rest/services/x";if(this.mapServiceType===n.MapServiceType.FEATURE){if(!(t&&t.layers&&t.layers.length>0&&t.layers[0]))throw new Error("Unable to configure FeatureLayer connection string. No child layer is specified.");this.serviceUrl=this.url+a+"/FeatureServer/"+t.layers[0].id}else this.mapServiceType===n.MapServiceType.IMAGE?this.serviceUrl=this.url+a+"/ImageServer":this.mapServiceType===n.MapServiceType.STREAM?this.serviceUrl=this.url+a+"/StreamServer":this.mapServiceType===n.MapServiceType.VECTORTILE?this.serviceUrl=this.url+a+"/VectorTileServer":this.serviceUrl=this.url+a+"/MapServer"}this._getPrincipalResult(function(e){return e.isAuthenticated})&&(this.serviceToken=this._getPrincipalResult(function(e){return e.tokens.site})),"3.912"===this.essentialsMap.site.currentVersion&&(this._needsProxy=!0)}var o=i(e,"geometryServiceUrl");o.length>0&&(this.geometryServiceUrl=o),this.mapServiceType===n.MapServiceType.VECTORTILE&&(this._styleUrl=i(e,"styleUrl")),this.mapServiceType===n.MapServiceType.WEBTILED&&(this._tileScheme=i(e,"tileScheme")),this.essentialsMap&&this.essentialsMap.site&&!this.serviceToken&&(this.serviceToken=this.essentialsMap.site.getTokenFromPrincipal(this.serviceUrl,this.mapServiceType));var l=i(e,"token"),u=this.essentialsMap&&this.essentialsMap.site?this.essentialsMap.site.arcGisPortalSecurityContext:null;l.length>0?this.serviceToken=l:u&&u.appliesTo(this.serviceUrl)&&u.tokenResult&&(this.serviceToken=u.tokenResult.token);var c=i(e,"proxy");c.length>0&&(this.proxyUrl=c,esri.addProxyRule({urlPrefix:this.serviceUrl,proxyUrl:c}),this.serviceUrl.indexOf("services.arcgis")>-1&&esri.addProxyRule({urlPrefix:this.serviceUrl.replace("services.arcgis","server.arcgis"),proxyUrl:c}));var p=i(e,"mapUrl");p.length>0&&(this.mapUrl=p.replace(/%3d/g,"=").replace(/%3D/g,"="));var h=i(e,"tileRestUrl");h.length>0&&(this.tileRestUrl=h.replace(/%3d/g,"=").replace(/%3D/g,"="));var d=i(e,"subDomains");d&&(this.subDomains=d.split(","))}},r.prototype._isLocalProxyInfo=function(e){return!!e&&"local-reverse-proxy"==e.type&&!!e.address},r.prototype._processProxyInfo=function(e){if(this._isLocalProxyInfo(e)){for(var t=(this.url+"/../../../../../"+e.address).split("/"),i=t.indexOf("..");i>0;i=t.indexOf(".."))t.splice(i-1,2);this.serviceUrl=t.join("/")}},r.prototype.supportsLayerVisibility=function(){switch(this.mapServiceType){case n.MapServiceType.WMS:return!0;case n.MapServiceType.DYNAMIC:return null!==this.serviceLayer&&!!this.serviceLayer.visibleLayers;case n.MapServiceType.GRAPHICS:case n.MapServiceType.FEATURE:case n.MapServiceType.CSV:case n.MapServiceType.LABEL:case n.MapServiceType.STREAM:case n.MapServiceType.GEORSS:case n.MapServiceType.KML:case n.MapServiceType.BING:case n.MapServiceType.TILED:case n.MapServiceType.WMTS:case n.MapServiceType.IMAGE:case n.MapServiceType.WEBTILED:case n.MapServiceType.VECTORTILE:case n.MapServiceType.MAPIMAGE:case n.MapServiceType.UNKNOWN:default:return!1}},r.prototype._setVisibility=function(e,t,i){var r,s,a,o={mapServiceId:this.id,layerId:e,visibility:t};switch(void 0===i&&(i=!1),this.mapServiceType){case n.MapServiceType.DYNAMIC:if(null!==this.serviceLayer){if(!this.serviceLayer.visibleLayers){t?this.serviceLayer.show():this.serviceLayer.hide(),dojo.publish("LayerVisibilityChange",[new Array(o)]);break}var l=this.getVisibleLayers();l.InternallyChangedLayer=o,0===l.length&&l.push("-1"),this.serviceLayer.setVisibleLayers&&this.serviceLayer.setVisibleLayers(l,i)}break;case n.MapServiceType.WMS:if(null!==this.serviceLayer){var u=[];for(u.InternallyChangedLayer=o,r=0,s=0;s<this.layers.length;s++)if((a=this.layers[s]).isVisible()&&(null===a.subLayerIds||0===a.subLayerIds.length)&&a.areAllAncestorsVisible()){var c=a.wmsLayerName;null!==c&&""!==c&&(u[r]=c,r++)}i?(this.serviceLayer.visibleLayers=u.slice(0),dojo.publish("LayerVisibilityChange",[new Array(o)])):this.serviceLayer.setVisibleLayers(u)}break;case n.MapServiceType.GRAPHICS:case n.MapServiceType.FEATURE:case n.MapServiceType.CSV:case n.MapServiceType.LABEL:case n.MapServiceType.STREAM:case n.MapServiceType.GEORSS:case n.MapServiceType.KML:case n.MapServiceType.BING:case n.MapServiceType.TILED:case n.MapServiceType.WMTS:case n.MapServiceType.IMAGE:case n.MapServiceType.WEBTILED:case n.MapServiceType.VECTORTILE:case n.MapServiceType.MAPIMAGE:case n.MapServiceType.WFS:if(null!==this.serviceLayer){if(1!==this.layers.length)throw new Error("Visibility of individual layers cannot be set for this Map Service: {0}".format(this.displayName));t?this.serviceLayer.show():this.serviceLayer.hide(),dojo.publish("LayerVisibilityChange",[new Array(o)])}break;default:throw new Error("Cannot set layer visibility. Unknown MapService type.")}},r.prototype._extendWms=function(){if(!r._wmsExtended){var e=esri.layers.WMSLayer._meta.hidden.getImageUrl,t=/.*images\/pixel.png$/;esri.layers.WMSLayer.extend({getImageUrl:function(i,r,n,s){var a=this;e.apply(this,[i,r,n,function(e){if(t.test(e))s(e);else{for(var i={},r=0;r<a.layerInfos.length;r++)i[a.layerInfos[r].name]=a.layerInfos[r].styleName;var n=[];for(r=0;r<a.visibleLayers.length;r++)n.push(i[a.visibleLayers[r]]);var o=n.join(","),l=e.substring(e.lastIndexOf("?")+1,e.length),u=dojo.queryToObject(l);u.STYLES=o,a.preferredSpatialReference&&(u[u.CRS?"CRS":"SRS"]="EPSG:"+a.preferredSpatialReference),a.__gcxWmsImageFormat&&(u.FORMAT=a.__gcxWmsImageFormat);var c=a.getMap(),p=c&&c.timeExtent?c.timeExtent.startTime:a.timeInfo&&a.timeInfo.timeExtent&&a.timeInfo.timeExtent.startTime,h=c&&c.timeExtent?c.timeExtent.endTime:a.timeInfo&&a.timeInfo.timeExtent&&a.timeInfo.timeExtent.endTime;if(p&&h){var d=new Date(p.getTime()-60*p.getTimezoneOffset()*1e3).toISOString(),f=new Date(h.getTime()-60*h.getTimezoneOffset()*1e3).toISOString();u.TIME=d+"/"+f}var y=e.substring(0,e.lastIndexOf("?")+1)+dojo.objectToQuery(u);s(y)}}])}}),r._wmsExtended=!0}},r.prototype._hasTileLevels=function(){return!!this.tileInfo&&!!this.tileInfo.lods&&this.tileInfo.lods.length>0},r.prototype.applyCatalogLayersChange=function(e){var t=this,i=!1,r=[];if(this.id==e.mapServiceId){for(var n=0;n<e.entries.length;n++){var a=e.entries[n],o=this.findLayerById(a.id);o||(o=new s.Layer(this.url+"/layers/"+e.entries[n].id),e.entries[n].visible=!0,o.createFromDefinition(e.entries[n]),o.isUserCreated=!0,o.includeInLayerList=!0,o.setInActiveTheme(!0)),r.push(o)}var l=this.layers.filter(function(e){return e.isUserCreated&&r.indexOf(e)<0}),u=r.filter(function(e){return t.layers.indexOf(e)<0});return l.forEach(function(e){t.remove(e),i=!0}),u.forEach(function(e){t.add(e),i=!0}),i?(dojo.publish("MapServiceLayersChangedWithResultEvent",{mapService:this,newItems:[].concat(u),oldItems:[].concat(l)}),dojo.publish("CatalogLayersChangedEvent",this),u):[]}},r.prototype.getLayerThemeSettings=function(e){for(var t=0;t<this.layerThemeSettings.length;t++){var i=this.layerThemeSettings[t];if(i.theme===e||i.theme.id===e)return i}return null},r.prototype.getFeatureLayer=function(){var e,t=this;if(this._featureLayerPromise)return this._featureLayerPromise;if(this.serviceLayer instanceof esri.layers.FeatureLayer)e=this.serviceLayer;else{if(this.mapServiceType!==n.MapServiceType.IMAGE)return Promise.resolve(null);var i=this.serviceUrl;this.serviceToken&&(i=f.RestHelperHTTPService.appendTokenToUrl(i,this.serviceToken)),e=new esri.layers.FeatureLayer(i)}return e.loaded?this._featureLayerPromise=Promise.resolve(e):this._featureLayerPromise=new Promise(function(i,r){var n=e.on("load",function(){n.remove(),s.remove(),i(e)}),s=e.on("error",function(e){n.remove(),s.remove(),t._featureLayerPromise=null,r(e)})}),this._featureLayerPromise},r.prototype._resetUpdateTimer=function(){if(void 0!=this.updateInterval&&0!=this.updateInterval){void 0!=this._updateIntervalId&&window.clearInterval(this._updateIntervalId);var e=this;this._updateIntervalId=setInterval(function(){e._onUpdateIntervalTick()},1e3*this.updateInterval)}else window.clearInterval(this._updateIntervalId),this._updateIntervalId=null},r.prototype._onUpdateIntervalTick=function(){if(this.serviceLayer&&this.serviceLayer.refresh){var e=this;e.serviceLayer.setDisableClientCaching?(e.serviceLayer.setDisableClientCaching(!0),e.serviceLayer.refresh(),e.serviceLayer.setDisableClientCaching(e.disableClientCaching)):e.serviceLayer.refresh()}},r.prototype._addToFilteredView=function(e){e&&this._layerThemeLayerFilter(e)&&this.layersFilteredView.push(e)},r.prototype._layerThemeLayerFilter=function(e){return!e.mapService.essentialsMap.layerThemesInfo.layerThemesConfigured||e.inActiveTheme},r.prototype._getDefaultGeometryServiceUrl=function(){var e=this.essentialsMap?this.essentialsMap.site:null;return e&&e.geometryEndpoints&&e.geometryEndpoints.length>0?e.geometryEndpoints[0].geometryServiceUrl:null},r.prototype._getDefaultGeometryServiceToken=function(){var e=this.essentialsMap?this.essentialsMap.site:null;return e&&e.geometryEndpoints&&e.geometryEndpoints.length>0?e.geometryEndpoints[0].geometryServiceToken:null},r.prototype._corsRequest=function(t,i,r){var n=this;return new v.SimplePromise(function(s,a){try{e(["dojo/request"],function(e){return r=!!r,e(t,{headers:{"X-Requested-With":null},withCredentials:i=!!i}).response.then(function(e){return s()},function(e){return r?a(e):s(n._corsRequest(t,!i,!0))})})}catch(e){return console.log("Error in initializing WMS layer: "+e),a(e)}})},r}(r.AsyncInitializable);g._wmsExtended=!1,i.MapService=g})},"geocortex/essentials/MapServiceConstants":function(){define(["require","exports"],function(e,t){"use strict";var i,r,n,s,a;Object.defineProperty(t,"__esModule",{value:!0}),(i=t.MapServiceType||(t.MapServiceType={})).DYNAMIC="Dynamic",i.TILED="Tiled",i.IMAGE="Image",i.BING="Bing",i.FEATURE="Feature",i.WMS="WMS",i.WFS="WFS",i.WMTS="WMTS",i.GEORSS="GeoRss",i.WEBTILED="WebTiled",i.VECTORTILE="VectorTile",i.KML="Kml",i.GRAPHICS="Graphics",i.LABEL="Label",i.STREAM="Stream",i.CSV="Csv",i.MAPIMAGE="MapImage",i.UNKNOWN="Unknown",(r=t.MapServiceFunction||(t.MapServiceFunction={})).OPERATIONAL="Operational",r.BASE="Base",(n=t.DrawingBehavior||(t.DrawingBehavior={})).MAP_SERVICE="MapService",n.FEATURE_LAYER="FeatureLayer",n.WFS_LAYER="WfsService",n.GEORSS_LAYER="GeoRssLayer",n.KML_SERVICE="KmlService",n.STREAM_LAYER="StreamLayer",n.GeoRSS_LAYER=n.GEORSS_LAYER,(s=t.FailureAction||(t.FailureAction={})).IGNORE="Ignore",s.WARN="Warn",s.ERROR="Error",(a=t.UserLayerType||(t.UserLayerType={})).LAYER_ADDITION="LayerAddition",a.LAYER_CATALOG="LayerCatalog",a.UPLOAD="Upload"})},"geocortex/essentials/NamedExtent":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./AsyncInitializable","./../geocortex"],function(e,i,r,n){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var s=function(e){function i(t){var i=e.call(this,t)||this;return i.displayName=null,i.extensions=[],i.extent=null,i.id=null,i.properties={},i.site=null,i}return t(i,e),i.prototype.navigateTo=function(){if(this.site){var e=this.site.essentialsMap;e&&e.extentManager.setExtentWithPriority(this.extent,10)}},i.prototype._configureObject=function(e,t){if(void 0===e||void 0===e.id||void 0==e.displayName||void 0===e.extent)throw new Error("Incorrect named extent object returned from initialization");this.id=e.id,this.displayName=e.displayName,this.extent=new esri.geometry.Extent(e.extent),this.properties=n._getProperties(e.properties),this.extensions=n._getExtensions(e.extensions)},i}(r.AsyncInitializable);i.NamedExtent=s})},"geocortex/essentials/OAuth2Client":function(){define(["require","exports","./TokenResult","./utilities/DecomposedUri"],function(e,t,i,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){}return e.getTokenFromImplicitGrant=function(){var e=window.location.href;if(e.indexOf("#")>0){var t=e.substring(e.indexOf("#")+1,e.length),r=dojo.queryToObject(t);if(!r.access_token)return null;var n=new i.TokenResult;n.token=r.access_token,n.userName=r.username;var s=parseInt(r.expires_in);return s&&(n.expiresOn=new Date((new Date).getTime()+1e3*s)),n}return null},e.getErrorFromImplicitGrant=function(){var e=window.location.href;if(e.indexOf("#")>0){var t=e.substring(e.indexOf("#")+1,e.length),i=dojo.queryToObject(t);if(i.error){var r=new s;return r.code=i.error,r.description=i.error_description,r}}return null},e.applicationHasImplicitGrant=function(){return e.hasFragmentParameter("access_token")},e.applicationHasImplicitGrantError=function(){return e.hasFragmentParameter("error")},e.hasFragmentParameter=function(e){var t=window.location.href;if(t.indexOf("#")<0)return!1;var i=(t=window.location.href).substring(t.indexOf("#")+1,t.length);return!!dojo.queryToObject(i)[e]},e.redirectToLogOnPage=function(t,i){var n=new r.DecomposedUri(window.location.href);e.removeImplicitGrantParams(n);var s=t+"?client_id="+encodeURIComponent(i)+"&response_type=token&redirect_uri="+encodeURIComponent(n.recompose())+"&expiration=20160";window.location.href=s},e.removeImplicitGrantParamsAndUpdateUrlHash=function(){var t=new r.DecomposedUri(window.location.href);e.removeImplicitGrantParams(t),window.location.hash=dojo.objectToQuery(t.fragment)},e.removeImplicitGrantParams=function(e){return delete e.fragment.access_token,delete e.fragment.username,delete e.fragment.expires_in,delete e.fragment.error,delete e.fragment.error_description,e},e}();t.OAuth2Client=n;var s=function(){};s.ACCESS_DENIED_ERROR_CODE="access_denied",t.OAuth2Error=s})},"geocortex/essentials/OfflineBasemap":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/Principal":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/PrintTemplate":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./AsyncInitializable","./Report","./exportMap/ExportMapParameters","./exportMap/ExportMapTask","./../geocortex"],function(e,i,r,n,s,a,o){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var l=function(e){function i(t){var i=e.call(this,t)||this;return i.description=null,i.displayName=null,i.extensions=[],i.id=null,i.visible=null,i.maximumResolution=300,i.properties=null,i.site=null,i.supportedMapScales=[],i.supportedOutputFormats=[],i.supportedResolutions=[],i.supportsEmailNotification=!1,i.textFields=[],i.grids=[],i.type=n.ReportType.MAP_TEMPLATE_REPORT,i.isDefault=!1,i.defaultMapScale=null,i.defaultMapScaleName=null,i.defaultResolution=null,i.defaultGrid=null,i.defaultOutputFormat=null,i._printing=!1,i._onPrintComplete=null,i._onPrintError=null,i.extensions=[],i.properties=[],i.supportedMapScales=[],i.supportedOutputFormats=[],i.supportedResolutions=[],i.textFields=[],i}return t(i,e),i.prototype.isPrinting=function(){return this._printing},i.prototype.print=function(e,t,i){var r=this;if(this.isPrinting())i&&i(new Error("Template already printing"));else{this._onPrintComplete=t,this._onPrintError=i,this._printing=!0;var n=new s.ExportMapParameters;n.reportParameters=e,new a.ExportMapTask(this).generateMapImageUrl(n).then(function(e){return r._printRestComplete(e)},function(e){return r._printRestError(e)})}},i.prototype._configureObject=function(e,t){if(void 0===e||void 0===e.id||void 0===e.displayName)throw new Error("Incorrect print template object returned from initialization");if(this.description=void 0===e.description?this.description:e.description,this.displayName=e.displayName,this.id=e.id,this.visible=void 0===e.visible||e.visible,this.mainMapWidth=e.mainMapWidth,this.mainMapHeight=e.mainMapHeight,this.maximumResolution=void 0===e.maximumResolution?this.maximumResolution:e.maximumResolution,this.supportedMapScales=void 0===e.supportedScales?this.supportedMapScales:e.supportedScales,this.supportedOutputFormats=void 0===e.supportedOutputFormats?this.supportedOutputFormats:e.supportedOutputFormats,this.supportedResolutions=void 0===e.supportedResolutions?this.supportedResolutions:e.supportedResolutions,this.supportsEmailNotification=!!e.supportsEmailNotification,this.textFields=void 0===e.textFields?this.textFields:e.textFields,this.grids=void 0===e.grids?this.grids:e.grids,t&&(this.isInitialized=!0),this.properties=o._getProperties(e.properties),this.extensions=o._getExtensions(e.extensions),this.isDefault=void 0===e.isDefault?this.isDefault:e.isDefault,this.defaultMapScaleName=void 0===e.defaultMapScale?null:e.defaultMapScale,this.defaultMapScaleName)for(n=0;n<this.supportedMapScales.length;n++)this.defaultMapScaleName===this.supportedMapScales[n].displayName&&(this.defaultMapScale=this.supportedMapScales[n]);var i=void 0===e.defaultResolution?null:e.defaultResolution;if(i)for(n=0;n<this.supportedResolutions.length;n++)i===this.supportedResolutions[n].displayName&&(this.defaultResolution=this.supportedResolutions[n]);var r=void 0===e.defaultGrid?null:e.defaultGrid;if(r)for(var n=0;n<this.grids.length;n++)r===this.grids[n].displayName&&(this.defaultGrid=this.grids[n]);this.defaultOutputFormat=void 0===e.defaultOutputFormat?this.defaultOutputFormat:e.defaultOutputFormat},i.prototype._printRestComplete=function(e){this._printing=!1;var t=null;e?e.error&&(t=e.error):t=new Error("Unexpected Error"),t?this._onPrintError&&this._onPrintError(t):this._onPrintComplete&&this._onPrintComplete(e)},i.prototype._printRestError=function(e){this._printing=!1,this._onPrintError&&this._onPrintError(e)},i}(r.AsyncInitializable);i.PrintTemplate=l})},"geocortex/essentials/RefreshVisibility":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){};i.DEFAULT="Default",i.SHOW="Show",i.HIDE="Hide",t.RefreshVisibility=i})},"geocortex/essentials/Report":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./AsyncInitializable","./exportMap/ExportMapTask","./exportMap/ExportMapParameters","./RestHelper","./../geocortex"],function(e,i,r,n,s,a,o){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var l,u=function(e){function i(t){var i=e.call(this,t)||this;return i.description=null,i.displayName=null,i.extensions=[],i.id=null,i.visible=!1,i.layer=null,i.properties={},i.supportedMapScales=[],i.supportedOutputFormats=[],i.supportedResolutions=[],i.textFields=[],i._running=!1,i._onRunReportComplete=null,i._onRunReportError=null,i}return t(i,e),i.prototype.isRunning=function(){return this._running},i.prototype.run=function(e,t,i,r){var o=this;if(this.isRunning()){if(r){var l=new Error("Report already running");l.name="ReportAlreadyRunning",r(l)}}else{this._running=!0;try{this._onRunReportComplete=i,this._onRunReportError=r;var u=new n.ExportMapTask(this),c=new s.ExportMapParameters;c.reportParameters=t,e&&(c.queryParameters=a.RestHelper._createRestParametersFromQuery(e)),u.generateMapImageUrl(c).then(function(e){return o._runRestComplete(e)},function(e){return o._runRestError(e)})}catch(l){if(this._running=!1,!this._onRunReportError)throw l;this._onRunReportError(l)}}},i.prototype._configureObject=function(e,t){if(void 0===e.id||void 0===e.displayName)throw new Error("Incorrect report object returned from initialization");this.id=e.id,this.visible=void 0===e.visible||e.visible,this.supportedOutputFormats=e.supportedOutputFormats,this.supportedResolutions=e.supportedResolutions,this.supportedMapScales=e.supportedScales,this.textFields=e.textFields,this.description=e.description,this.displayName=e.displayName,t&&(this.isInitialized=!0),this.properties=o._getProperties(e.properties),this.extensions=o._getExtensions(e.extensions)},i.prototype._runRestComplete=function(e){this._running=!1;var t=null;e?e.error&&(t=e.error):t=new Error("No results"),t&&this._onRunReportError&&this._onRunReportError(t),e&&this._onRunReportComplete&&this._onRunReportComplete(e)},i.prototype._runRestError=function(e){this._running=!1,this._onRunReportError&&this._onRunReportError(e)},i}(r.AsyncInitializable);i.Report=u,(l=i.ReportType||(i.ReportType={})).LAYER_TEMPLATE_REPORT="Layer Template Report",l.MAP_TEMPLATE_REPORT="Map Template Report"})},"geocortex/essentials/ReportParameters":function(){define(["require","exports","./MapServiceConstants","./utilities/PrintUtilities"],function(e,t,i,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){this.customExtent=null,this.extentType="currentExtent",this.fields=[],this.grid=null,this.imageHeight=null,this.imageWidth=null,this.notificationEmailAddress=null,this.outputFormat=null,this.featureIds=null,this.resolution=null,this.scale=null}return e.prototype.toJson=function(t,r){if(!t||!r)throw new Error("Reporting parameter creation is missing a main map.");var n,s,a,o={},l=this.scale&&void 0!=this.scale.scale&&!isNaN(parseFloat(this.scale.scale))?parseFloat(this.scale.scale):t.getScale();this.scale&&void 0!=this.scale.scale&&(o.scale=this.scale.scale),this.extentType==e.CURRENT_EXTENT&&null!==t?n=t.extent:this.extentType==e.FULL_EXTENT&&null!==r?n=r.fullExtent:this.extentType==e.INITIAL_EXTENT&&null!==r?n=r.initialExtent:this.extentType==e.CUSTOM_EXTENT&&null!==this.customExtent&&(n=this.customExtent),n&&(n.spatialReference&&(s=n.spatialReference.toJson())&&(s.wkid&&s.wkid>0?o.bboxSR=s.wkid:s.wkt&&(o.bboxSR=s.wkt)),o.bbox=n.xmin+","+n.ymin+","+n.xmax+","+n.ymax),this.targetSpatialReference&&(s=this.targetSpatialReference.toJson())&&(s.wkid&&s.wkid>0?o.targetSR=s.wkid:s.wkt&&(o.targetSR=s.wkt)),this.notificationEmailAddress&&(o.emailAddress=this.notificationEmailAddress),this.imageHeight&&this.imageHeight>0&&(o.imageHeight=this.imageHeight),this.imageWidth&&this.imageWidth>0&&(o.imageWidth=this.imageWidth),t.timeExtent&&(o.time="",t.timeExtent.startTime?o.time+=t.timeExtent.startTime.getTime():o.time+="null",o.time+=",",t.timeExtent.endTime?o.time+=t.timeExtent.endTime.getTime():o.time+="null");var u=[];if(null!==r){var c="",p="",h="";for(a=0;a<r.mapServices.length;a++){var d,f=r.mapServices[a],y="",m=f.serviceLayer,v="";if(m)if(!0===m.visible&&(p+=(""===p?"":";")+f.id+":"+m.opacity),f.mapServiceType===i.MapServiceType.DYNAMIC){d=m.layerDefinitions;var g=0;for(var _ in d)g>0&&(v+=","),v+='"'+_+'":"'+d[_].replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"',g++;if(g>0&&(h.length>1&&(h+=","),h+='"'+f.id+'":{',h+=v,h+="}"),!0===m.visible&&!0===m.isVisibleAtScale(l))if(m instanceof esri.layers.ArcGISDynamicMapServiceLayer){var S=m;S.visibleLayers&&"-1"!==S.visibleLayers.toString()&&(y=S.visibleLayers.toString())}else if(f.layers&&0!==f.layers.length){if(f.layers&&f.layers.length>0)for(b=0;b<f.layers.length;b++)(I=f.layers[b]).isVisible()&&I.areAllAncestorsVisible()&&(y+=(0===y.length?"":",")+I.id)}else y="*"}else if(!0===m.visible&&!0===m.isVisibleAtScale(l))if(f.layers&&0!==f.layers.length){if(f.layers&&f.layers.length>0)for(var b=0;b<f.layers.length;b++){var I=f.layers[b];I.isVisible()&&I.areAllAncestorsVisible()&&(y+=(0===y.length?"":",")+I.id)}}else y="*";var w=f.id;if(0===y.length?w+="(hide:*)":w+="(show:"+y+")",c+=(0===c.length?"":";")+w,f.hasOwnProperty("onDemandCacheSize")){var x={};x.id=f.id;var E=m.getSelectionSymbol();if(E&&E.color){var L=E.color.toRgba();x.selectionColor={r:L[0],g:L[1],b:L[2],a:L[3]}}x.mode=f.queryMode;var T=m.getDefinitionExpression();T&&(x.where=T),m.renderer&&(x.renderer=m.renderer.toJson()),x.selectedFeatures=[];var M=m.getSelectedFeatures();if(M&&M.length>0){var D=m.objectIdField;if(D)for(var C=0;C<M.length;C++){var O=M[C];if(O.attributes){var R=O.attributes[D];R&&x.selectedFeatures.push(R)}}}u.push(x)}}h.length>0&&(h="{"+h+"}",o.layerDefinitions=h),c.length>0&&(o.layers=c),p.length>0&&(o.opacity=p)}u.length>0&&(o.featureLayerOptions=u),this.outputFormat&&(o.outputFormat=this.outputFormat),this.featureIds&&(o.featureIds=this.featureIds),this.resolution&&(o.dpi=this.resolution.dpi),this.mapGraphicsLayers&&(o.graphics=this.mapGraphicsLayers.layers,o.symbols=this.mapGraphicsLayers.symbols),this.includeData&&(o.of=o.of?o.of+",includeData":"includeData"),this.includeGeoreferenceData&&(o.georef=this.includeGeoreferenceData),this.useTransparentBackground&&(o.useTransparentBackground=this.useTransparentBackground);for(var F=0;F<this.fields.length;F++){var A=this.fields[F];o[A.id]=A.value}return this.grid&&(o.grid=this.grid.id),o},e.prototype.populateMapGraphicsLayers=function(e){this.mapGraphicsLayers={layers:[],symbols:[]},this._extractGraphicInformation(e.graphics,this.mapGraphicsLayers.layers,this.mapGraphicsLayers.symbols);for(var t=0;t<e.graphicsLayerIds.length;t++){var i=e.getLayer(e.graphicsLayerIds[t]);!i.visible||i instanceof esri.layers.FeatureLayer&&i.url||this._extractGraphicInformation(i,this.mapGraphicsLayers.layers,this.mapGraphicsLayers.symbols)}},e.prototype._extractGraphicInformation=function(e,t,i){for(var n=0;n<e.graphics.length;n++){var s=e.graphics[n];if(s.visible){var a={},o=null;if(s.symbol?o=s.symbol:e.renderer&&e.renderer.getSymbol&&(o=e.renderer.getSymbol(s),s.symbol=o),!o)continue;i.push(o);for(var l=0;l<i.length-1;l++)if(i[l]==o){a.symbolID=i[l].id,o.id=a.symbolID,i.pop();break}if(void 0==a.symbolID){var u=i.length-1;i[u]instanceof esri.symbol.TextSymbol?i[u]=r.PrintUtilities.adjustTextSymbol(s,e.id):i[u]instanceof esri.symbol.PictureMarkerSymbol&&(i[u]=r.PrintUtilities.adjustPictureMarkerSymbol(s)),a.symbolID=(i.length-1).toString(),i[a.symbolID].id=a.symbolID}a.geometry=s.geometry,t.push({elements:[a],opacity:e.opacity})}}},e}();n.CURRENT_EXTENT="currentExtent",n.CUSTOM_EXTENT="customExtent",n.FULL_EXTENT="fullExtent",n.INITIAL_EXTENT="initialExtent",t.ReportParameters=n})},"geocortex/essentials/Resolution":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(e,t){void 0!==e&&(this.displayName=e),void 0!==t&&(this.dpi=t)};t.Resolution=i})},"geocortex/essentials/RestEndpointResult":function(){define(["require","exports","./../geocortex"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(e,t){this.error=t,this.resultObject=e,e&&(this.rawJson=i.encodeJson(e))};t.RestEndpointResult=r})},"geocortex/essentials/RestHelper":function(){define(["require","exports","./RestHelperHTTPService"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){}return e.processClientSideTokens=function(t,r){var n="";if(""!==r){var s="";t&&t.url&&(s=t.url),n=e._replaceToken("SiteRestUrl",r,s),n=e._replaceToken("VirtualDirectoryUrl",n,s+"/virtualdirectory");var a=window.location.href.substring(0,window.location.href.lastIndexOf("/"));n=e._replaceToken("HostUri",n,a);var o=s.substring(0,s.lastIndexOf("/sites/"))+"/virtualdirectory";n=e._replaceToken("RestVirtualDirectoryUrl",n,o);var l=i.RestHelperHTTPService.token;n=e._replaceToken("RestToken",n,l)}return n},e.validateDynamicDefinition=function(t){if(!t||!t.trim())throw new Error("The JSON string cannot be null, empty nor merely whitespace!");var i=e.getJsonObjectFromJsonString(t);if(i){if(null==i.source)throw"The source is required!";if(null==i.source.type)throw"The type is required!";if("mapLayer"==i.source.type){if(null==i.source.mapLayerId)throw"The mapLayerId is required for the mapLayer type!"}else{if("dataLayer"!=i.source.type)throw"The type '"+i.source.type.toString()+"' is not supported!";if(null==i.source.dataSource)throw"The dataSource is required for the dataLayer type!"}}},e.getJsonObjectFromJsonString=function(e){return JSON.parse(e)},e.getLayerSourceFromJsonObject=function(e){if("mapLayer"==e.type)return new esri.layers.LayerMapSource(e);var t=new esri.layers.LayerDataSource;switch(e.dataSource.type){case"table":t.dataSource=new esri.layers.TableDataSource(e.dataSource);break;case"queryTable":t.dataSource=new esri.layers.QueryDataSource(e.dataSource);break;case"raster":t.dataSource=new esri.layers.RasterDataSource(e.dataSource);break;case"joinTable":t.dataSource=new esri.layers.JoinDataSource(e.dataSource);break;default:throw"The type '"+e.type.toString()+"' not supported!"}return t},e.getDynamicLayerInfoFromJson=function(t,i){var r;e.validateDynamicDefinition(t);var n=e.getJsonObjectFromJsonString(t);if(n){if(r=new esri.layers.DynamicLayerInfo,n.id)r.id=n.id;else{if(null==i)throw"The Layer's ID is missing or invalid!";r.id=parseInt(i,10)}r.source=this.getLayerSourceFromJsonObject(n.source),null!=n.minScale&&(r.minScale=n.minScale),r.minScale<=0&&(r.minScale=1/0),null!=n.maxScale&&(r.maxScale=n.maxScale)}return r},e.getDynamicExpressionFromJson=function(t){var i;e.validateDynamicDefinition(t);var r=e.getJsonObjectFromJsonString(t);return r&&r.definitionExpression&&(i=r.definitionExpression),i},e.getLayerDrawingOptionsFromJson=function(t){var i;e.validateDynamicDefinition(t);var r,n=e.getJsonObjectFromJsonString(t);if(n&&n.drawingInfo){switch(r=dojo.clone(n.drawingInfo),i=new esri.layers.LayerDrawingOptions,r.renderer.type){case"simple":i.renderer=new esri.renderer.SimpleRenderer(r.renderer);break;case"uniqueValue":i.renderer=new esri.renderer.UniqueValueRenderer(r.renderer);break;case"classBreaks":i.renderer=new esri.renderer.ClassBreaksRenderer(r.renderer);break;default:throw"The type '"+r.renderer.type.toString()+"' not supported!"}if(r.labelingInfo&&r.labelingInfo instanceof Array){var s=r.labelingInfo;void 0===r.showLabels&&(r.showLabels=!0);for(var a=0;a<s.length;a++){var o=new esri.layers.LabelClass(s[a]);i.labelingInfo||(i.labelingInfo=[]),i.labelingInfo.push(o)}}i.transparency=r.transparency,i.scaleSymbols=r.scaleSymbols,i.showLabels=r.showLabels}return i},e._replaceToken=function(e,t,i){return t?t.replace("{"+e+"}",i):t},e._createRestParametersFromQuery=function(t){var i={};return t&&((i=t.toJson()).spatialRel=e._convertSpatialRelationshipToDotnet(i.spatialRel)),i},e._convertSpatialRelationshipToDotnet=function(e){switch(e){case esri.tasks.Query.SPATIAL_REL_CONTAINS:return"esriSpatialRelContains";case esri.tasks.Query.SPATIAL_REL_CROSSES:return"esriSpatialRelCrosses";case esri.tasks.Query.SPATIAL_REL_ENVELOPEINTERSECTS:return"esriSpatialRelEnvelopeIntersects";case esri.tasks.Query.SPATIAL_REL_INDEXINTERSECTS:return"esriSpatialRelIndexIntersects";case esri.tasks.Query.SPATIAL_REL_INTERSECTS:return"esriSpatialRelIntersects";case esri.tasks.Query.SPATIAL_REL_OVERLAPS:return"esriSpatialRelOverlaps";case esri.tasks.Query.SPATIAL_REL_RELATION:return"esriSpatialRelRelation";case esri.tasks.Query.SPATIAL_REL_TOUCHES:return"esriSpatialRelTouches";case esri.tasks.Query.SPATIAL_REL_WITHIN:return"esriSpatialRelWithin"}throw new Error("Unknown rel: "+e)},e._convertSpatialRelationshipFromDotnetIndex=function(e){switch(e){case 1:return esri.tasks.Query.SPATIAL_REL_CONTAINS;case 2:return esri.tasks.Query.SPATIAL_REL_CROSSES;case 3:return esri.tasks.Query.SPATIAL_REL_ENVELOPEINTERSECTS;case 4:return esri.tasks.Query.SPATIAL_REL_INDEXINTERSECTS;case 0:return esri.tasks.Query.SPATIAL_REL_INTERSECTS;case 5:return esri.tasks.Query.SPATIAL_REL_OVERLAPS;case 8:return esri.tasks.Query.SPATIAL_REL_RELATION;case 6:return esri.tasks.Query.SPATIAL_REL_TOUCHES;case 7:return esri.tasks.Query.SPATIAL_REL_WITHIN}throw new Error("Unknown rel: "+e)},e}();r.tokenDurationMinutes=20,t.RestHelper=r})},"geocortex/essentials/RestHelperHTTPService":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){this.requestObject=null,this.optionsObject=null,this._handle=null,this._error=null,this._deferred=new dojo.Deferred,void 0!==e&&(this.requestObject=e,dojo.isFunction(this.requestObject.error)&&(this._error=this.requestObject.error,this.requestObject.error=null),dojo.isFunction(this.requestObject.handle)&&(this._handle=this.requestObject.handle),this.requestObject.handle=dojo.hitch(this,this._handleProxy)),void 0!==t&&(this.optionsObject=t)}return e.getTokenForScope=function(e){var t=this._anchorScratch||(this._anchorScratch=document.createElement("a")),i=this._pathCleaner||(this._pathCleaner=/\/+/g);t.href=e;var r=t.hostname.toLowerCase(),n=("/"+t.pathname+"/").replace(i,"/").toLowerCase(),s=void 0,a=this.tokenScopes;for(var o in a){t.href=o;var l=t.hostname.toLowerCase(),u=("/"+t.pathname+"/").replace(i,"/").toLowerCase();if(r===l&&n.startsWith(u)){var c=a[o];s="string"==typeof c?c:!0===c?this.token:void 0}}return s},e.setDefaultToken=function(e,t){"string"==typeof e&&(this.token=e,this.tokenScopes[t]=!0)},e.appendTokenToUrl=function(t,i){var r=t;return t&&!e.urlHasToken(t)&&(r=e._appendParameter(t,"token",i)),r},e.urlHasToken=function(e){return/[?&]token=/.test(e)},e.getAuthenticationControlBlockStore=function(){return console.warn("RestHelperHTTPService.getAuthenticationControlBlockStore() is no longer supported."),null},e.prototype._handleProxy=function(e,t){!1===this._isUnauthorizedResponse(e)&&dojo.isFunction(this._handle)&&(console.log("Invoking original handle delegate"),this._handle(e,t))},e.prototype._requestCallback=function(e){this._deferred.resolve(e)},e.prototype._requestErrback=function(e){dojo.isFunction(this._error)&&this._error(e),this._deferred.reject(e)},e.prototype._isUnauthorizedResponse=function(e){return!(!e||401!==e.code)},e.prototype.send=function(){var t=e.getTokenForScope(this.requestObject.url);return void 0!==t&&(this.requestObject.content||(this.requestObject.content={}),this.requestObject.content.token=t),esri.request(this.requestObject,this.optionsObject).then(dojo.hitch(this,this._requestCallback),dojo.hitch(this,this._requestErrback)),this._deferred.promise},e._appendParameter=function(e,t,i){var r=e;return e&&t&&i&&(e.indexOf("?")>=0?r+="&":r+="?",r+=encodeURIComponent(t)+"="+encodeURIComponent(i)),r},e}();i.tokenScopes={},t.RestHelperHTTPService=i})},"geocortex/essentials/RestUtility":function(){define(["require","exports","./RestEndpointResult","./../geocortex"],function(e,t,i,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){this._activeEndpointRequest=!1,this._onRequestComplete=null,this._onRequestError=null}return e.prototype.getCustomRestEndpoint=function(e,t,i,n,s){this._activeEndpointRequest?this._onEndpointRequestError(new Error("An operation is already in progress.")):(this._activeEndpointRequest=!0,this._onRequestComplete=i,this._onRequestError=n,r.request({url:e,content:t,load:dojo.hitch(this,this._onEndpointRequestComplete),error:dojo.hitch(this,this._onEndpointRequestError),callbackParamName:"CallBack"},s))},e.prototype._onEndpointRequestComplete=function(e){this._activeEndpointRequest=!1;try{e||(e={error:new Error("Expected results")}),e.error&&this._onRequestError&&this._onRequestError(e.error)}finally{this._onRequestComplete&&this._onRequestComplete(new i.RestEndpointResult(e,e.error))}},e.prototype._onEndpointRequestError=function(e){this._activeEndpointRequest=!1;try{this._onRequestError&&this._onRequestError(e)}finally{this._onRequestComplete&&this._onRequestComplete(new i.RestEndpointResult(null,e))}},e}();t.RestUtility=n})},"geocortex/essentials/Rx.light":function(){define(["require","exports"],function(e,t){"use strict";function i(){}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){}return e.prototype.select=function(t){var i=this,r=new e;return r._subscribe=function(e){var r=!0,n={onNext:function(i){if(r)try{e.onNext(t(i))}catch(t){r=!1,e.onError(t)}},onError:function(t){r&&(r=!1,e.onError(t))},onCompleted:function(){r&&(r=!1,e.onCompleted())}},s=i._subscribe(n);return r?s:(s.dispose(),{dispose:function(){}})},r},e.prototype._subscribe=function(e){return{dispose:i}},e.prototype.subscribe=function(e,t,r){if(arguments.length>1)return n={onNext:e||i,onError:t||i,onCompleted:r||i},this._subscribe(n);if(e instanceof Function){if(e.length>1)return n={onNext:function(t){return e(t)},onError:function(t){return e(void 0,t)},onCompleted:function(){return e()}},this._subscribe(n);var n={onNext:e,onError:t||i,onCompleted:r||i};return this._subscribe(n)}return e?this._subscribe(e):this._subscribe({onNext:i,onError:i,onCompleted:i})},e}();t.AnonymousObservable=r})},"geocortex/essentials/Scale":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(e,t){this.displayName=e,this.scale=t};t.Scale=i})},"geocortex/essentials/SearchQuery":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){this.extent=null,this.maxResults=50,this.contains=!0,this.returnGeometry=!1,this.returnHighlights=!1,this.returnIdsOnly=!1,this.returnCountOnly=!1,this.searchText=null,this.outSpatialReference=null}return e.prototype.toJson=function(e,t){if(!e||!t)throw new Error("Search query parameter creation is missing a main map.");var i={searchText:this.searchText,contains:this.contains,returnGeometry:this.returnGeometry,returnHighlights:this.returnHighlights,returnIdsOnly:this.returnIdsOnly,returnCountOnly:this.returnCountOnly};this.extent&&(i.envelope="{0},{1},{2},{3}".format(this.extent.xmin,this.extent.ymin,this.extent.xmax,this.extent.ymax)),(this.returnGeometry||this.extent)&&this.outSpatialReference&&(i.outSR=this.outSpatialReference.toJson()),this.maxResults>0&&(i.maxResults=this.maxResults);var r=this.searchLayers;return r&&0!=r.length||(r=t.allLayers()),i.layers=this._getServiceStrings(r),i},e.prototype._getServiceStrings=function(e){for(var t="",i={},r=0;r<e.length;r++){var n=e[r];if(n&&n.searchable&&n.mapService&&n.mapService.instantSearch){var s=n.mapService.id;i.hasOwnProperty(s)||(i[s]=[]),i[s].push(n.id)}}for(var a in i)i.hasOwnProperty(a)&&(t+=0===t.length?"":";",t+="{0}(include:{1})".format(a,i[a].join(",")));return t},e}();t.SearchQuery=i})},"geocortex/essentials/SearchResultFeature":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(e,t){this.esriFeature=null,this.layer=null,this.highlights={},this.esriFeature=e,this.layer=t};t.SearchResultFeature=i})},"geocortex/essentials/SearchResults":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){this.error=null,this.results=[],this.queryParams=null};t.SearchResults=i})},"geocortex/essentials/SearchResultSet":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(e){this.features=[],this.layer=null,e&&e.hasOwnProperty("features")&&(this.features=e.features),e&&e.hasOwnProperty("layer")&&(this.layer=e.layer)};t.SearchResultSet=i})},"geocortex/essentials/SearchTable":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./AsyncInitializable","./RestHelper","./../geocortex"],function(e,i,r,n,s){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var a=function(e){function i(t){var i=e.call(this,t)||this;return i.displayName=null,i.parameters=[],i.id=null,i.site=null,i.featureDescription=null,i.featureLabel=null,i.featureLongDescription=null,i.iconUri=null,i.includeInGlobalSearch=!1,i._searching=!1,i._onSearchingComplete=null,i._onSearchingError=null,i}return t(i,e),i.prototype._configureObject=function(e,t){if(void 0===e||void 0===e.id||void 0==e.displayName)throw new Error("Incorrect search table object returned from initialization");this.id=e.id,this.displayName=e.displayName,this.parameters=e.parameters,this.featureDescription=e.featureDescription,this.featureLabel=e.featureLabel,this.featureLongDescription=e.featureLongDescription,this.iconUri=n.RestHelper.processClientSideTokens(this.site,e.iconUri),this.includeInGlobalSearch=e.includeInGlobalSearch},i.prototype.isSearching=function(){return this._searching},i.prototype.performSearch=function(e,t,i){var r=this,n=function(e){r._searching=!1,i&&i(new Error(e))};e||n("No searchParameters provided"),this.isSearching()&&n("Currently performing a search"),this._searching=!0,this._onSearchingComplete=dojo.hitch(this,t),this._onSearchingError=dojo.hitch(this,i);var a=this.url+"/search",o="";for(var l in e)e.hasOwnProperty(l)&&(o+=(o?"&":"")+encodeURIComponent(l)+"="+encodeURIComponent(e[l]));a+="?"+o,s.request({url:a,content:{f:"json"},handleAs:"json",load:dojo.hitch(this,this._searchRestComplete),error:dojo.hitch(this,this._searchRestError),callbackParamName:"CallBack"})},i.prototype._searchRestComplete=function(e){this._searching=!1,!e&&this._onSearchingError&&this._onSearchingError(new Error("No results")),e.error&&this._onSearchingError&&this._onSearchingError(e.error),this._onSearchingComplete&&this._onSearchingComplete(new esri.tasks.FeatureSet(e))},i.prototype._searchRestError=function(e){this._searching=!1,this._onSearchingError&&this._onSearchingError(e)},i}(r.AsyncInitializable);i.SearchTable=a})},"geocortex/essentials/SearchTableParameter":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){this.name=null,this.type=null};t.SearchTableParameter=i})},"geocortex/essentials/SecurityHelper":function(){define(["require","exports","../geocortex"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){var e=this;this.finished=!1,this.id=(new Date).valueOf().toString(),this.scripts=[],this._refreshPromise=new Promise(function(t,i){e._refreshPromiseResolve=t,e._refreshPromiseReject=i})}return e.getCurrent=function(){var e=window.security;return e&&!e.finished?e:null},e.beginRefresh=function(t){if(null!=e.getCurrent())return!1;var i=new e;return i.site=t,!!i.getExpirationNoticeUrl()&&!!i.getRefreshUrl()&&(window.security=i,i.openFrame(),!0)},e.waitForSignIn=function(){var t=e.getCurrent();return t?t._refreshPromise:Promise.resolve()},e.cancel=function(){var t=e.getCurrent();return t&&(t._refreshPromise.isFulfilled||t._refreshPromiseReject("Canceled")),t&&t.finish()},e.prototype.openSystemBrowser=function(){var e=this,t=this.getRefreshUrl()+"&app="+this.site.signInRedirectUri+"&token_type=fragment&openSystemBrowser=true",i=/GeocortexApp\.iOS/.test(navigator.userAgent)?"_system":"_blank",r=function(){var t=location.hash;if(t.length>0&&t.startsWith("#gcx-")){window.removeEventListener?window.removeEventListener("popstate",r,!1):window.detachEvent&&window.detachEvent("onpopstate",r);var i=t.substring(5);e.sendRequest(e.site.url+"?f=json&callback=security.updateSitePrincipal&token="+i)}};window.addEventListener?window.addEventListener("popstate",r,!1):window.attachEvent&&window.attachEvent("onpopstate",r),window.open(t,i)},e.prototype.openFrame=function(){var e=this;this.frame=document.createElement("iframe"),this.frame.name="SignInHelper",this.frame.style.display="none",document.body.appendChild(this.frame),i.isNative()?(this.frame.src="SignInHelper.html",window.setTimeout(function(){e.finished||e.openSystemBrowser()},1e4)):(window.open("SignInHelper.html","SignInHelper"),window.setTimeout(function(){return e.openPopup()},15e3))},e.prototype.openPopup=function(){this.finished||(this.sendRequest(this.getExpirationNoticeUrl()+"?f=json&part=_html&callback=security.showContent"),window.open("SignInHelper.html","_blank"))},e.prototype.getExpirationNoticeUrl=function(){return this.site.principal&&this.site.principal.urls?this.site.principal.urls.expirationNotice:null},e.prototype.getRefreshUrl=function(){return this.site.principal&&this.site.principal.urls?this.site.principal.urls.refresh:null},e.prototype.sendRequest=function(e){if(!this.finished){var t=document.createElement("script");t.style.display="none",document.body.appendChild(t),this.scripts.push(t),t.type="text/javascript",t.src=e+"&rid="+this.id}},e.prototype.showContent=function(e){return!this.finished&&e.rid==this.id&&(this.dialog&&this.dialog.parentNode&&this.dialog.parentNode.removeChild(this.dialog),this.dialog=document.createElement("div"),this.dialog.innerHTML=e.content,document.body.appendChild(this.dialog),!0)},e.prototype.handleSignIn=function(e,t){if(this.finished)return null;if(!(e.length>0&&e.startsWith("#gcx-"))){var i="";return null==this.site.principal.urls.referrer&&(i="&app="+encodeURIComponent(t)),this.getRefreshUrl()+i+"&token_type=fragment"}var r=e.substring(5);return this.sendRequest(this.site.url+"?f=json&callback=security.updateSitePrincipal&token="+r),null},e.prototype.finish=function(){if(this.finished)return!1;for(this.finished=!0;this.scripts.length>0;){var e=this.scripts.pop();e.parentNode.removeChild(e)}return this.dialog&&this.dialog.parentNode&&this.dialog.parentNode.removeChild(this.dialog),this.frame&&this.frame.parentNode&&this.frame.parentNode.removeChild(this.frame),!0},e.prototype.updateSitePrincipal=function(e){return this.finished?(this._refreshPromise.isResolved||this._refreshPromiseResolve(),!1):e.rid==this.id&&(this.finish(),this.site.updatePrincipal(e.principal),this._refreshPromiseResolve(),console.log("Updated Principal (Refresh Successful)"),!0)},e.prototype.useSystemBrowser=function(){return!1},e.prototype.waitForSignIn=function(){return this._refreshPromise},e}();t.SecurityHelper=r})},"geocortex/essentials/ServiceHelper":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){}return e.extractConnectionStringValue=function(e,t){if(e.length>0){var i=e.match("(^|;)[s]*"+t+"=([^;]*)");return null!==i?i[2]:""}return""},e}();t.ServiceHelper=i})},"geocortex/essentials/ServicePoint":function(){var t,i=this&&this.__extends||(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(e,i){function r(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./Rx.light","./../geocortex"],function(t,r,n,s){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(){}return e.prototype.toString=function(){return this.message},e}();r.ServiceRequestError=a,a.prototype.message="An error occurred while performing the operation.",a.prototype.details=new Array,a.prototype.name="ServiceRequestError";var o=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t}(a);r.ServiceRequestAbortedError=o,o.prototype.message="The request was aborted.",o.prototype.name="ServiceRequestAbortedError";var l=function(){function t(){}return t.prototype.start=function(){try{this.promise=s.request(this),this.valid?this.registration=this.servicePoint.cancellationToken.register(this.error.bind(this)):this.promise.cancel()}catch(e){this.error(e)}},t.prototype.load=function(e){try{if(this.member){var t=e[this.member];if(t)for(var i=0;i<t.length&&this.valid;i++)this.observer.onNext(t[i])}else this.valid&&this.observer.onNext(e);this.complete()}catch(e){this.error(e)}},t.prototype.error=function(t){this.valid&&(this.valid=!1,this.promise.cancel(),this.registration.dispose(),this.observer.onError(e||new o))},t.prototype.complete=function(){this.valid&&(this.valid=!1,this.promise.cancel(),this.registration.dispose(),this.observer.onCompleted())},t.prototype.dispose=function(){this.valid&&(this.valid=!1,this.promise.cancel(),this.registration.dispose())},t}();l.prototype.handleAs="json",l.prototype.valid=!0,l.prototype.registration={dispose:function(){}};var u,c,p=function(){function e(){}return e.prototype.formatQuery=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];var r,n,s=(r=e.format.apply(e,t),n=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];for(var r=e.length,n=0;n<t.length;n++){var s=e.indexOf(t[n]);s>=0&&s<r&&(r=s)}return s}(r,"?","!","#"),{query:r.substring(0,n),tail:r.substring(n)});return function(e,t){c||((u=document.head.getElementsByTagName("base")[0])||((u=document.createElement("base")).setAttribute("href",window.location.href),document.head.appendChild(u)),c=document.createElement("a"));try{var i=u.getAttribute("href");u.setAttribute("href",e),c.setAttribute("href",t),t=c.href}finally{u.setAttribute("href",i)}return t}(this.baseAddress,s.query)+s.tail},e.prototype.getRequest=function(e,t){var i=function(e){this.observer=e,this.start()};(i.prototype=new l).servicePoint=this,i.prototype.query=e,i.prototype.member=t;var r=new n.AnonymousObservable;return r._subscribe=function(e){return new i(e)},r},e}();r.ServicePoint=p,p.prototype.baseAddress=window.location.href,p.prototype.cancellationToken={dispose:function(){},register:function(e){return this}}})},"geocortex/essentials/Site":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./AsyncInitializable","./ArcGisPortalSecurityContext","./documents/DocumentStore","./Map","./GeocodingEndpoint","./GeometryEndpoint","./GeoprocessingEndpoint","./NamedExtent","./PrintTemplate","./TimeSliderProfile","./LayerCatalog","./Workflow","./SearchTable","./utilities/UrlUtilities","./utilities/SiteResourceIdComparer","./FeatureLayerService","geocortex/framework/utils/ArrayUtils","./SearchResults","./../geocortex","./SearchResultSet","./SearchResultFeature","./ServiceHelper","./MapServiceConstants","./RestHelperHTTPService","./SecurityHelper","geocortex/framework/utils/utils","./OAuth2Client","./WebMapReference","../geocortex"],function(e,i,r,n,s,a,o,l,u,c,p,h,d,f,y,m,v,g,_,S,b,I,w,x,E,L,T,M,D,C,O){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var R=function(e){function i(t,i){var r=e.call(this,t)||this;return r.currentVersion=null,r.dataProvider=null,r.deepInitialize=!1,r.displayName=null,r.documentStore=new s.DocumentStore,r.updateInterval=null,r.essentialsMap=null,r.extensions=[],r.geocodingEndpoints=[],r.geometryEndpoints=[],r.geoprocessingEndpoints=[],r.layerListRestEndpoint=null,r.hasGeocodingEndpoints=!1,r.hasGeometryEndpoints=!1,r.hasGeoprocessingEndpoints=!1,r.hasNamedExtents=!1,r.hasNorthArrow=!1,r.hasTimeSliders=!1,r.hasOverviewMap=!1,r.hasPrintTemplates=!1,r.hasViewers=!1,r.hasVirtualDirectory=!1,r.hasWorkflows=!1,r.hasSearchTables=!1,r.hasWebMaps=!1,r.id=null,r.namedExtents=[],r.overviewMap=null,r.printTemplates=[],r.properties={},r.timeSliders=[],r.trustedUrls=[],r.layerCatalogs=[],r.serviceLayersLoaded=!1,r.url=null,r.workflows=[],r.searchTables=[],r.timeZoneId=null,r.displayTimeZoneId=null,r.webMapsInfo={layerTypes:null,webMaps:[]},r.configPreprocessor=null,r.onLayerLoad=null,r.onLayerLoadError=null,r.onServiceLayersLoaded=function(){},r.onSignIn=null,r.onSignOut=null,r.onUserSignInCancelled=null,r.onPrincipalUpdated=null,r.principal={isAuthenticated:!1,label:null,identities:[],policy:{},urls:{},tokens:{arcgis:{},geocortex:{},site:null}},r.suspendLayersOnLoad=!0,r._geocodingEndpointsInitialized=!1,r._geometryEndpointsInitialized=!1,r._geoprocessingEndpointsInitialized=!1,r._kmlServiceInitialized=!1,r._mapInitialized=!1,r._namedExtentsInitialized=!1,r._overviewMapInitialized=!1,r._printTemplatesInitialized=!1,r._workflowsInitialized=!1,r._searchTablesInitialized=!1,r._timeSlidersInitialized=!1,r._webMapsInitialized=!1,r._initializedHandlerCalled=!1,r._signInEnabled=!1,r._signOutEnabled=!1,r._tokenIntervalHandle=null,r._serviceTokenRefresh=null,r._serviceTokensStale=!1,r._allDeferredDojosForUpdatingTokens=new Array,r.originalUrl=t,r.url=m.UrlUtilities.simplify(t),r._esriMap=i,r}return t(i,e),i.prototype.initialize=function(){var e=this;this._detectAndConfigureCors().then(function(){e._initialize()})},i.prototype.getResourceById=function(e,t){return v.SiteResourceIdComparer.lookUp(e,t)},i.prototype.findWorkflowById=function(e){return this.getResourceById(this.workflows,e)},i.prototype.findPrintTemplateById=function(e){return this.getResourceById(this.printTemplates,e)},i.prototype.getFeatureServices=function(){var e=[];if(!this.essentialsMap)return e;for(var t=0;t<this.essentialsMap.mapServices.length;t++){var i=this.essentialsMap.mapServices[t];i instanceof g.FeatureLayerService&&e.push(i)}return e},i.prototype.getMap=function(){return this._esriMap},i.prototype.getEssentialsVersion=function(){var e=3;if(this.currentVersion){var t=this.currentVersion.split(".");if(t.length>=2){var i=t[0]+"."+t[1];e=parseFloat(i)}}return e},i.prototype.getDefaultBatchGeocoder=function(){var e=_.firstOrDefault(this.geocodingEndpoints,function(e){return e.isDefaultBatchGeocoder});return!e&&this.geocodingEndpoints.length>0&&(e=this.geocodingEndpoints[0]),e},i.prototype.search=function(e,t,i,r){var n=this;t&&t(e);try{var s=this.url+"/search",a={};e&&e.toJson&&(a=e.toJson(this.getMap(),this.essentialsMap));var o=b.encodeJson(dojo.mixin({f:"json"},a))}catch(e){return void(r&&r(e))}o.hasOwnProperty("layers")&&o.layers&&b.request({url:s,content:o,load:function(t){var s=new S.SearchResults;s.queryParams=e,t?n._parseSearchResponse(s,t):s.error=new Error("Unexpected Error"),s.error&&r&&r(s.error),i&&i(s)},error:function(e){r&&r(e)},callbackParamName:"CallBack"})},i.prototype._parseSearchResponse=function(e,t){if(!t)throw new Error("_parseSearchResponse: required jsonObject argument was not supplied.");if(t.hasOwnProperty("error")&&t.error&&t.error.message)e.error=new Error(t.error.message);else if(t.hasOwnProperty("ResponseStatus")&&t.ResponseStatus&&t.ResponseStatus.ErrorCode)e.error=new Error(t.ResponseStatus.Message),e.error.name=t.ResponseStatus.ErrorCode;else if(t.hasOwnProperty("features")){var i=this._createFeatureSets(t.features,e.queryParams.returnHighlights);for(var r in i)i.hasOwnProperty(r)&&e.results.push(i[r])}},i.prototype._createFeatureSets=function(e,t){for(var i={},r=0;r<e.length;r++){var n=e[r],s=n.hasOwnProperty("mapServiceId")?n.mapServiceId:null,a=n.hasOwnProperty("layerId")?n.layerId:null,o=this.essentialsMap.findMapServiceById(s),l=o?o.findLayerOrTableById(a):null;if(l){var u=this._createFeature(n,l,t);i.hasOwnProperty(l.url)||(i[l.url]=new I.SearchResultSet({layer:l})),i[l.url].features.push(u)}}return i},i.prototype._createFeature=function(e,t,i){if(!e)throw new Error("_createSearchFeature: required jsonFeature argument was not supplied.");var r=this._jObjectToGraphic(e),n=new w.SearchResultFeature(r,t);return i&&this._assignHighlights(n,e),n},i.prototype._jObjectToGraphic=function(e){if(!e)throw new Error("_jObjectToGraphic: required jobject argument was not supplied.");var t=null;e.hasOwnProperty("geometry")&&e.geometry&&(t=esri.geometry.fromJson(e.geometry))&&t.spatialReference&&!e.geometry.spatialReference&&(t.spatialReference=new esri.SpatialReference(4326));var i={};return e.hasOwnProperty("attributes")&&e.attributes&&(i=JSON.parse(JSON.stringify(e.attributes))),new esri.Graphic(t,null,i,null)},i.prototype._assignHighlights=function(e,t){if(!e)throw new Error("_assignHighlights: required feature argument was not supplied.");if(!t)throw new Error("_assignHighlights: required jobject argument was not supplied.");var i={};t.hasOwnProperty("highlights")&&t.highlights&&(i=JSON.parse(JSON.stringify(t.highlights))),e.highlights=i},i.prototype._initAsyncCollection=function(e,t,i,r){if(e&&i&&r)for(var n=0;e&&n<e.length;n++)i[n]=new r(this.url+"/"+t+"/"+e[n].id),i[n].site=this,i[n]._configureObject(e[n]),!0===this.deepInitialize&&r!==f.Workflow&&(i[n].isInitialized=!0);this._siteInitializeUpdate()},i.prototype._initAsyncCollectionErrorHandler=function(e,t){e(),this._initializationFailedHandler(t),this._siteInitializeUpdate()},i.prototype._initGeocodingEndpointsHandler=function(e){this._geocodingEndpointsInitialized=!0,e&&this._initAsyncCollection(e.geocodingEndpoints,"geocoding",this.geocodingEndpoints,o.GeocodingEndpoint)},i.prototype._initGeometryEndpointsHandler=function(e){this._geometryEndpointsInitialized=!0,e&&this._initAsyncCollection(e.geometryEndpoints,"geometry",this.geometryEndpoints,l.GeometryEndpoint)},i.prototype._initKmlEndpointHandler=function(e){if(this._kmlServiceInitialized=!0,e&&e.connectionString){var t=x.ServiceHelper.extractConnectionStringValue(e.connectionString,"url");t&&(esri.config.defaults.kmlService=t)}},i.prototype.getLayerCatalog=function(e,t,i,r){var n=this.url+"/catalog/layercatalog/getcatalog";t(),b.request({url:n,content:{f:"json"},load:function(e){i(e)},error:r,callbackParamName:"CallBack"})},i.prototype.getLayerCatalogDetails=function(e,t,i,r){var n=this.url+"/catalog/layercatalog/getcatalogdetails",s={};s.ids=e.ids.join(),s.f="json",t(),b.request({url:n,content:s,load:function(e){i(e)},error:r,callbackParamName:"CallBack"})},i.prototype.getOfflineBasemaps=function(e,t){void 0===t&&(t=function(){});var i=this.url+"/offlinebasemaps";if("function"!=typeof e)throw new Error("loadComplete must be a function.");b.request({url:i,content:{f:"json"},load:function(i){i.error?t(new Error(i.error.message)):i.basemaps?e(i.basemaps):t(new Error("Unexpected result: "+JSON.stringify(i)))},error:t,callbackParamName:"CallBack"})},i.prototype._initGeoprocessingEndpointsHandler=function(e){this._geoprocessingEndpointsInitialized=!0,e&&this._initAsyncCollection(e.geoprocessingEndpoints,"geoprocessing",this.geoprocessingEndpoints,u.GeoprocessingEndpoint)},i._getTokenFromFragment=function(){var e=window.location.href,t=e.indexOf("#gcx-");if(t>=0){var i=e.substring(t+5);return window.location.replace("#"),i}return null},i._addQueryParameter=function(e,t){var i=e.split("#",2);e=i[0];var r=i.length>1?i[1]:"";return e+(e.indexOf("?")>-1?"&":"?")+t+r},i.prototype.canSignIn=function(){return this._signInEnabled&&!!this.principal&&!!this.principal.urls.signIn&&!this.principal.isAuthenticated&&!!this.principal.policy&&this.principal.policy.issuers.length>0},i.prototype._signIn=function(e,t){e||(e=this.principal),t||(t=e.urls.signIn),void 0===e.policy&&(e.policy={});var r=e.policy.hints;r&&(t=i._addQueryParameter(t,r)),t=i._addQueryParameter(t,"token_type=fragment"),this.signInRedirectUri&&t.indexOf("app=")<0?t=i._addQueryParameter(t,"app="+encodeURIComponent(this.signInRedirectUri)):!e.urls.referrer&&t.indexOf("app=")<0&&(t=i._addQueryParameter(t,"app="+encodeURIComponent(window.location.toString()))),this.onSignIn&&this.onSignIn({url:t}),window.addEventListener&&window.addEventListener("popstate",function(){location.hash.startsWith("#gcx-")&&location.reload()},!1),window.location.assign(t)},i.prototype.signIn=function(e){this._signIn(this.principal,e)},i.prototype.canSignOut=function(){return this._signOutEnabled&&!!this.principal&&this.principal.isAuthenticated&&!!this.principal.urls.signOut},i.prototype.signOut=function(){this.onSignOut&&this.onSignOut();var e=this.principal.urls.signOut;this.signOutRedirectUri?e=i._addQueryParameter(e,"app="+encodeURIComponent(this.signOutRedirectUri)):this._signOutRedirectUrl&&(e=i._addQueryParameter(e,"app="+encodeURIComponent(this._signOutRedirectUrl))),window.location.assign(e)},i.prototype.getTokenFromPrincipal=function(e,t){var r=this,n=null;if(t===E.MapServiceType.DYNAMIC?n=this.principal.tokens.arcgis:t===E.MapServiceType.FEATURE?n=this.principal.tokens.arcgis:t===E.MapServiceType.IMAGE?n=this.principal.tokens.arcgis:t===E.MapServiceType.TILED?n=this.principal.tokens.arcgis:t===E.MapServiceType.WEBTILED?n=this.principal.tokens.arcgis:t===E.MapServiceType.VECTORTILE?n=this.principal.tokens.arcgis:t===esri.IdentityManagerBase?n=this.principal.tokens.arcgis:t===i&&((a={})[this.url]=this.principal.tokens.site,n=a,this.layerCatalogs.forEach(function(e){var t=r.url.replace(r.id,e.siteId);n[t]=r.principal.tokens.site})),!n)return null;e=e.toLowerCase();var s=document.createElement("a");s.href=e.toLowerCase();var a,o=s.protocol,l=s.hostname,u=s.port;e=s.href;for(var c in n){var p=c.toLowerCase();if(l==p)return n[c];if(l.endsWith("."+p))return n[c];try{if(s.href=o+"://"+p,s.port=u,e.startsWith(s.href))return n[c]}catch(e){}try{if(s.href=p,e.startsWith(s.href))return n[c]}catch(e){}}return null},i.prototype._updateDefaultToken=function(e){if("string"==typeof e){var t=this.url,i=Math.max(t.indexOf("?"),t.indexOf("#"));i>=0&&(t=t.substr(0,i)),t=/^(.*?)\/*$/.exec(t)[1],L.RestHelperHTTPService.setDefaultToken(e,t+"/../../")}},i.prototype._detectAndConfigureCors=function(){var e=new dojo.Deferred;if(window.geocortexDisableEssentialsCorsDetection)return e.resolve(),e;var t=m.UrlUtilities.getUrlComponents(this.url),i=m.UrlUtilities.getUrlComponents(window.location.href);if(t.origin===i.origin)return e.resolve(),e;var r=(/(.*\/+)sites\/+[^\/]*\/?$/i.exec(this.url)||[])[1];if(r){var n=r+"info?f=json";dojo.xhrGet({url:n}).then(function(i){esri.config.defaults.io.corsEnabledServers.push(t.host),e.resolve()},function(t){e.resolve()})}else e.resolve();return e},i.prototype._initialize=function(){var e=this;if(!this.isInitialized&&!this._initializing){var t=i._getTokenFromFragment();if(this._updateDefaultToken(t),!t){var r=function(){if(window.removeEventListener?window.removeEventListener("popstate",r,!1):window.detachEvent&&window.detachEvent("onpopstate",r),!e.isInitialized&&e._initializing){var t=i._getTokenFromFragment();t&&(e._updateDefaultToken(t),b.request({url:e.url,content:{f:"json",deep:e.deepInitialize},load:dojo.hitch(e,e._verifySiteDependencies),error:dojo.hitch(e,e._initSiteErrorHandler),callbackParamName:"CallBack"}))}};window.addEventListener?window.addEventListener("popstate",r,!1):window.attachEvent&&window.attachEvent("onpopstate",r)}this._initializedHandlerCalled=!1,this._initializing=!0,b.request({url:this.url,content:{f:"json",deep:this.deepInitialize},load:dojo.hitch(this,this._verifySiteDependencies),error:dojo.hitch(this,this._initSiteErrorHandler),callbackParamName:"CallBack"})}},i.prototype._initMapHandler=function(e){this._mapInitialized=!0,null!==e&&null!==e.site&&e.loadServiceLayersInMap(e.site.getMap()),this._siteInitializeUpdate()},i.prototype._initMapErrorHandler=function(e){this._mapInitialized=!0,this._initializationFailedHandler(e),this._siteInitializeUpdate()},i.prototype._initNamedExtentsHandler=function(e){this._namedExtentsInitialized=!0,e&&this._initAsyncCollection(e.namedExtents,"namedextents",this.namedExtents,c.NamedExtent)},i.prototype._initTimeSlidersHandler=function(e){this._timeSlidersInitialized=!0,e&&this._initAsyncCollection(e.timeSliders,"timesliders",this.timeSliders,h.TimeSliderProfile)},i.prototype._initOverviewMapHandler=function(){this._overviewMapInitialized=!0,this._siteInitializeUpdate()},i.prototype._initOverviewMapErrorHandler=function(e){this._overviewMapInitialized=!0,this._initializationFailedHandler(e),this._siteInitializeUpdate()},i.prototype._initPrintTemplatesHandler=function(e){var t=this,i=0;this._printTemplatesInitialized=!0,e.printTemplates.length>0&&null!=e.printTemplates[0].visible?this._initAsyncCollection(e.printTemplates,"printtemplates",this.printTemplates,p.PrintTemplate):e.printTemplates.forEach(function(r){b.request({url:t.url+"/printtemplates/"+r.id,content:{f:"json"},load:function(r){i++,e.printTemplates.forEach(function(e){e.id===r.id&&(e.visible=r.visible)}),i===e.printTemplates.length&&t._initAsyncCollection(e.printTemplates,"printtemplates",t.printTemplates,p.PrintTemplate)},callbackParamName:"CallBack"})})},i.prototype.updateServiceTokensIfStale=function(){if(!this._serviceTokensStale){var e=new dojo.Deferred;return e.resolve(),e}return this._getUpdatedServiceTokens()},i.prototype._getUpdatedServiceTokens=function(){var e=this;if(0===this.updateInterval){var t=new dojo.Deferred;return t.resolve(),t}return this._serviceTokenRefresh?this._serviceTokenRefresh:(this._serviceTokenRefresh=new dojo.Deferred,this._updateServiceTokensOfAllSites(),new dojo.DeferredList(this._allDeferredDojosForUpdatingTokens).then(function(t){e._serviceTokensStale=!1;for(var i=0;i<t.length;i++)if(!t[i][0]){e._serviceTokensStale=!0,e._serviceTokenRefresh.reject(new Error("One or more service tokens failed to update")),e._serviceTokenRefresh=null;break}e._serviceTokenRefresh&&(e._serviceTokenRefresh.resolve(),e._serviceTokenRefresh=null),e._allDeferredDojosForUpdatingTokens=[]},function(t){e._allDeferredDojosForUpdatingTokens=[],e._serviceTokensStale=!0,e._serviceTokenRefresh.reject(t),e._serviceTokenRefresh=null}),this._serviceTokenRefresh)},i.prototype._updateServiceTokensBySendingRestRequest=function(e,t){var i=this.url;e&&(i=this.url.replace(this.id,e)),this._isTokenUpdateRequired(e)?b.request({url:i+"/update",content:{f:"json"},load:dojo.hitch(this,this._processServiceTokensHandler,e,t),error:dojo.hitch(this,this._processServiceTokensErrorHandler,t),callbackParamName:"CallBack"}):t.resolve()},i.prototype._isTokenUpdateRequired=function(e){if(!e)return!0;var t=this.essentialsMap.mapServices;if(t.length>0)for(var i=0;i<t.length;i++){var r=t[i];if(r.catalogId&&r.catalogId.split(".")[0]==e)return!0}return!1},i.prototype._processServiceTokensHandler=function(e,t,i){var r=this;i&&i.mapServiceTokens&&this._updateServiceTokens(this.essentialsMap,i.mapServiceTokens,e),e||(i&&i.overviewMapServiceTokens&&this._updateServiceTokens(this.overviewMap,i.overviewMapServiceTokens,e),i.geocodingServiceTokens&&i.geocodingServiceTokens.forEach(function(e){var t=r.geocodingEndpoints.filter(function(t){return t.id===e.id})[0];t&&(t.geocoderToken=e.token,dojo.publish("ServiceTokenRefreshed",{serviceUrl:t.geocoderUrl,token:e.token}))}),i.geometryServiceTokens&&i.geometryServiceTokens.forEach(function(e){var t=r.geometryEndpoints.filter(function(t){return t.id===e.id})[0];t&&(t.geometryServiceToken=e.token,dojo.publish("ServiceTokenRefreshed",{serviceUrl:t.geometryServiceUrl,token:e.token}))})),t.resolve()},i.prototype._processServiceTokensErrorHandler=function(e,t){this._serviceTokensStale=!0,e.reject(t),dojo.publish("ServiceTokenRefreshError",{error:t})},i.prototype._updateServiceTokens=function(e,t,i){if(e&&t)for(var r=0;t&&r<t.length;r++){var n;(n=i?e.findMapServiceById(i+"-"+t[r].id):e.findMapServiceById(t[r].id))&&n._updateServiceToken(t[r].token)}},i.prototype._updateServiceTokensFromPrincipal=function(e){if(e&&e.mapServices)for(var t=0;t<e.mapServices.length;t++){var r=e.mapServices[t];if(r&&r.serviceUrl){var n=this.getTokenFromPrincipal(r.serviceUrl,esri.IdentityManagerBase)||this.getTokenFromPrincipal(r.serviceUrl,i);n&&r._updateServiceToken(n)}}},i.prototype.refreshPrincipal=function(){return this._refreshPrincipal(),T.SecurityHelper.waitForSignIn()},i.prototype._refreshPrincipal=function(){var e=this,t={site:this,handled:!1,resumeRefresh:function(){return T.SecurityHelper.beginRefresh(e)},suspendRefresh:function(){return T.SecurityHelper.cancel()}};dojo.publish("geocortex_sessionExpiring",t),t.handled||t.resumeRefresh()},i.prototype._refreshPrincipalAt=function(e,t){var i=this;if(!e)return!1;var r=new Date(e).valueOf();isNaN(r)&&(console.log("_refreshPrincipalAt: Date parse failed, most likely due to ECMAScript 5 support only. Using alternate method."),r=Date.parse(e),console.log("_refreshPrincipalAt: Parsed '"+e+"' as raw value '"+r.toString()+"'."));var n=r-(new Date).valueOf()-t;return n=Math.max(1e4,n),window.setTimeout(function(){return i._refreshPrincipal()},n),!0},i.prototype.updatePrincipal=function(e){this.principal=e,this._refreshPrincipalAt(e.expiry,3e5),this._updateDefaultToken(this.principal.tokens.site),this.principal.tokens&&this.principal.tokens.arcgis&&(this._updateServiceTokensFromPrincipal(this.essentialsMap),this._updateServiceTokensFromPrincipal(this.overviewMap)),this.onPrincipalUpdated&&this.onPrincipalUpdated()},i.prototype._getCredential=function(e,t){var r=this.getTokenFromPrincipal(e,esri.IdentityManagerBase)||this.getTokenFromPrincipal(e,i),n=new dojo.Deferred;if(r){var s=new esri.Credential;s.token=r,s.server=this._getCredentialServer(e),n.resolve(s)}else n.reject(new Error("No token available for service {0}".format(e)));return n},i.prototype._getCredentialServer=function(e){var t=e.toLowerCase(),i=t.indexOf("/rest/services");return-1===i&&(i=t.indexOf("/sharing")),-1===i&&"/"===t.substr(-1)&&(i=t.length-1),i>-1?e.substring(0,i):e},i.prototype._hookGetCredential=function(){var e=this;esri.IdentityManagerBase.prototype.getCredential=function(t,i){try{return e._getCredential(t,i)}catch(e){console.log("Error getting site credential: "+e);var r=new dojo.Deferred;return r.reject(e),r}}},i.prototype._initSiteHandler=function(e){var t=this;if(this._hookGetCredential(),!e)throw new Error("Incorrect site object returned from initialization");if(this.configPreprocessor&&(this.configPreprocessor(e),this.configPreprocessor=null),e.__loadedOffline&&(this._serviceTokensStale=!0),e.contentPolicy&&(M.isNullOrUndefined(e.contentPolicy.trustedUrls)?this.trustedUrls=[]:this.trustedUrls=e.contentPolicy.trustedUrls),e.layerCatalogs)if(0==e.layerCatalogs.length)this.layerCatalogs=[];else for(var i=0;i<e.layerCatalogs.length;i++)this.layerCatalogs[i]=new d.LayerCatalog(e.layerCatalogs[i].siteId);if(e.principal){var r=e.principal;if(void 0===r.policy&&(r.policy={}),r.policy.authenticate&&!r.isAuthenticated)return void this._signIn(r);this.updatePrincipal(e.principal),r.isAuthenticated&&dojo.publish("geocortex_authenticationSucceeded",[{username:r.label,token:r.tokens.site}])}else if(e.arcGisPortalAuthentication&&e.arcGisPortalAuthentication.clientID){var s=e.arcGisPortalAuthentication;if(this.arcGisPortalSecurityContext=new n.ArcGisPortalSecurityContext(s.url,s.domains,s.clientID),!this.arcGisPortalSecurityContext.initiate()){if(this.arcGisPortalSecurityContext.error)if(this.arcGisPortalSecurityContext.error.code==D.OAuth2Error.ACCESS_DENIED_ERROR_CODE)this.onUserSignInCancelled&&this.onUserSignInCancelled({tryAgainAction:dojo.hitch(this,function(){D.OAuth2Client.redirectToLogOnPage(this.arcGisPortalSecurityContext.getLogOnUrl(),this.arcGisPortalSecurityContext.clientId)})});else{var o=new Error;o.name=this.arcGisPortalSecurityContext.error.code,o.message=this.arcGisPortalSecurityContext.error.description,this._initializationFailedHandler(o)}return}L.RestHelperHTTPService.arcGisPortalToken=this.arcGisPortalSecurityContext.tokenResult}this.hasGeocodingEndpoints=!!e.hasGeocodingEndpoints,this.hasGeometryEndpoints=!!e.hasGeometryEndpoints,this.hasGeoprocessingEndpoints=!!e.hasGeoprocessingEndpoints,this.hasNamedExtents=!!e.hasNamedExtents,this.hasNorthArrow=!!e.hasNorthArrow,this.hasTimeSliders=!!e.hasTimeSliders,this.hasOverviewMap=!!e.hasOverviewMap,this.hasPrintTemplates=!!e.hasPrintTemplates,this.hasViewers=!!e.hasViewers,this.hasVirtualDirectory=!!e.hasVirtualDirectory,this.hasWorkflows=!!e.hasWorkflows,this.hasSearchTables=!!e.hasSearchTables,this.hasWebMaps=!!e.hasWebMaps,this.dataProvider=e.dataProvider,this.displayName=e.displayName,this.id=e.id,this._signInEnabled=!!e.signInEnabled,this._signOutEnabled=!!e.signOutEnabled,this._signOutRedirectUrl=e.signOutRedirectUrl,this.timeZoneId=e.timeZoneId,this.displayTimeZoneId=e.displayTimeZoneId,void 0===e.currentVersion?this.currentVersion="3.0":this.currentVersion=e.currentVersion,e.hasOwnProperty("updateInterval")?(this.updateInterval=parseInt(e.updateInterval),isNaN(this.updateInterval)&&(this.updateInterval=0)):this.updateInterval=0,this.updateInterval>0&&(this._tokenIntervalHandle=setInterval(function(){t._getUpdatedServiceTokens()},Math.max(60,1e3*this.updateInterval))),this.properties=b._getProperties(e.properties),this.extensions=b._getExtensions(e.extensions),this.essentialsMap=new a.Map(this.originalUrl+"/map"),this.essentialsMap.site=this,dojo.connect(this.essentialsMap,"onInitialized",dojo.hitch(this,this._initMapHandler)),dojo.connect(this.essentialsMap,"onInitializationFailed",dojo.hitch(this,this._initMapErrorHandler)),this.hasOverviewMap&&(this.overviewMap=new a.Map(this.originalUrl+"/overviewmap"),this.overviewMap.site=this,dojo.connect(this.overviewMap,"onInitialized",dojo.hitch(this,this._initOverviewMapHandler)),dojo.connect(this.overviewMap,"onInitializationFailed",dojo.hitch(this,this._initOverviewMapErrorHandler))),e.map&&e.map.layerList&&(this.layerListRestEndpoint=e.map.layerList),!this.deepInitialize||this.getEssentialsVersion()<3.3||void 0===e.map?(this.essentialsMap.initialize(),this.hasOverviewMap?this.overviewMap.initialize():this._overviewMapInitialized=!0,e.hasKmlServiceEndpoint?b.request({url:this.url+"/kmlService",content:{f:"json"},load:dojo.hitch(this,this._initKmlEndpointHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._kmlServiceInitialized=!0})),callbackParamName:"CallBack"}):this._kmlServiceInitialized=!0,this.hasGeocodingEndpoints?b.request({url:this.url+"/geocoding",content:{f:"json"},load:dojo.hitch(this,this._initGeocodingEndpointsHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._geocodingEndpointsInitialized=!0})),callbackParamName:"CallBack"}):this._geocodingEndpointsInitialized=!0,this.hasGeometryEndpoints?b.request({url:this.url+"/geometry",content:{f:"json"},load:dojo.hitch(this,this._initGeometryEndpointsHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._geometryEndpointsInitialized=!0})),callbackParamName:"CallBack"}):this._geometryEndpointsInitialized=!0,this.hasGeoprocessingEndpoints?b.request({url:this.url+"/geoprocessing",content:{f:"json"},load:dojo.hitch(this,this._initGeoprocessingEndpointsHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._geoprocessingEndpointsInitialized=!0})),callbackParamName:"CallBack"}):this._geoprocessingEndpointsInitialized=!0,this.hasNamedExtents?b.request({url:this.url+"/namedextents",content:{f:"json"},load:dojo.hitch(this,this._initNamedExtentsHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._namedExtentsInitialized=!0})),callbackParamName:"CallBack"}):this._namedExtentsInitialized=!0,this.hasPrintTemplates?b.request({url:this.url+"/printtemplates",content:{f:"json"},load:dojo.hitch(this,this._initPrintTemplatesHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._printTemplatesInitialized=!0})),callbackParamName:"CallBack"}):this._printTemplatesInitialized=!0,this.hasSearchTables?b.request({url:this.url+"/searchtables",content:{f:"json"},load:dojo.hitch(this,this._initSearchTablesHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._searchTablesInitialized=!0})),callbackParamName:"CallBack"}):this._searchTablesInitialized=!0,this.hasTimeSliders?b.request({url:this.url+"/timesliders",content:{f:"json"},load:dojo.hitch(this,this._initTimeSlidersHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._timeSlidersInitialized=!0})),callbackParamName:"CallBack"}):this._timeSlidersInitialized=!0,this.hasWorkflows?b.request({url:this.url+"/workflows",content:{f:"json"},load:dojo.hitch(this,this._initWorkflowsHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._workflowsInitialized=!0})),callbackParamName:"CallBack"}):this._workflowsInitialized=!0,this.hasWebMaps?b.request({url:this.url+"/webmaps",content:{f:"json"},load:dojo.hitch(this,this._initWebMapHandler),error:dojo.hitch(this,this._initAsyncCollectionErrorHandler,dojo.hitch(this,function(){this._webMapsInitialized=!0})),callbackParamName:"CallBack"}):this._webMapsInitialized=!0):(this._initGeocodingEndpointsHandler(e),this._initGeometryEndpointsHandler(e),this._initGeoprocessingEndpointsHandler(e),this._initTimeSlidersHandler(e),this._initKmlEndpointHandler(e.kmlServiceEndpoint),this.essentialsMap.initialize(e.map),this._initNamedExtentsHandler(e),e.overviewMap?this.overviewMap.initialize(e.overviewMap):(this._overviewMapInitialized=!0,this._siteInitializeUpdate()),this._initPrintTemplatesHandler(e),this._initWorkflowsHandler(e),this._initSearchTablesHandler(e),this._initWebMapHandler(e)),this.documentStore.initialize(this),this._siteInitializeUpdate()},i.prototype._updateServiceTokensOfAllSites=function(){var e=this;this.layerCatalogs&&this.layerCatalogs.length>0&&this.layerCatalogs.forEach(function(t){var i=new dojo.Deferred;e._allDeferredDojosForUpdatingTokens.push(i),e._updateServiceTokensBySendingRestRequest(t.siteId,i)});var t=new dojo.Deferred;this._allDeferredDojosForUpdatingTokens.push(t),this._updateServiceTokensBySendingRestRequest(null,t)},i.prototype._initSiteErrorHandler=function(e){var t=this,i=e,r=i.principal;!r||r.isAuthenticated||403!=i.code?(r&&r.isAuthenticated&&403==i.code&&r.urls.signOut&&(this._signOutEnabled=!0,this.principal=r),this._geocodingEndpointsInitialized=!0,this._geometryEndpointsInitialized=!0,this._geoprocessingEndpointsInitialized=!0,this._kmlServiceInitialized=!0,this._namedExtentsInitialized=!0,this._printTemplatesInitialized=!0,this._workflowsInitialized=!0,this._searchTablesInitialized=!0,this._timeSlidersInitialized=!0,this._initializationFailedHandler(e),this._siteInitializeUpdate()):O.isNative()?dojo.publish("SiteSignInRequired",{error:i.code,callback:function(){return t._signIn(r)}}):this._signIn(r)},i.prototype._initWorkflowsHandler=function(e){this._workflowsInitialized=!0,e&&this._initAsyncCollection(e.workflows,"workflows",this.workflows,f.Workflow)},i.prototype._initSearchTablesHandler=function(e){this._searchTablesInitialized=!0,e&&this._initAsyncCollection(e.searchTables,"searchTables",this.searchTables,y.SearchTable)},i.prototype._initWebMapHandler=function(e){this._webMapsInitialized=!0,e&&e.webMapsInfo&&(this.webMapsInfo.layerTypes=e.webMapsInfo.layerTypes,this._initAsyncCollection(e.webMapsInfo.webMaps,"webmaps",this.webMapsInfo.webMaps,C.WebMapReference))},i.prototype._siteInitializeUpdate=function(){this._geocodingEndpointsInitialized&&this._geometryEndpointsInitialized&&this._geoprocessingEndpointsInitialized&&this._kmlServiceInitialized&&this._mapInitialized&&this._namedExtentsInitialized&&this._overviewMapInitialized&&this._printTemplatesInitialized&&this._workflowsInitialized&&this._searchTablesInitialized&&this._timeSlidersInitialized&&this._webMapsInitialized&&(this._initializedHandlerCalled||(this._initializedHandlerCalled=!0,this._initializedHandler(this)))},i.prototype._verifySiteDependencies=function(e){e&&e.hasFeatureLayers?dojo.addOnLoad(dojo.hitch(this,function(){this._initSiteHandler(e)})):this._initSiteHandler(e)},i}(r.AsyncInitializable);i.Site=R})},"geocortex/essentials/StreamLayerService":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./MapService","./RestHelperHTTPService"],function(e,i,r,n){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var s=function(e){function i(){var t=null!==e&&e.apply(this,arguments)||this;return t._streamLayerOptions=null,t}return t(i,e),i.prototype._configureStreamSettings=function(e){if(e){var t={purgeOptions:{displayCount:1e4}};null!=e.maxDisplayCount&&(t.purgeOptions.displayCount=e.maxDisplayCount),null!=e.maxAge&&(t.purgeOptions.maxAge=e.maxAge),null!=e.maxTrackPoints&&(t.maximumTrackPoints=e.maxTrackPoints),e.definitionExpression&&(t.definitionExpression=e.definitionExpression),e.geometryDefinition&&(t.geometryDefinition=new esri.geometry.Extent(e.geometryDefinition)),this._streamLayerOptions=t}},i.prototype._configureObject=function(t,i){if(void 0===t)throw new Error("Incorrect map service object returned from initialization");this._configureStreamSettings(t.streamSettings),e.prototype._configureObject.call(this,t,i)},i.prototype._createServiceLayer=function(){var t=this.serviceUrl;this.serviceToken&&(t=n.RestHelperHTTPService.appendTokenToUrl(t,this.serviceToken));var i=new esri.layers.StreamLayer(t,this._streamLayerOptions);i.id=this.id,i.loadError&&this._layerLoadErrorHandler(i.loadError),this._initiallyVisible?i.show():i.hide(),dojo.connect(i,"onError",this,this._layerLoadErrorHandler),dojo.connect(i,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),this.attributionDataUrl&&""!==this.attributionDataUrl?(i.attributionDataUrl=this.attributionDataUrl,i.hasAttributionData=!0):this.hasAttributionData&&(i.attributionDataUrl=this.url+"/Attribution",i.hasAttributionData=!0),this.serviceLayer=i,e.prototype.initiateServiceFailureTimer.call(this)},i}(r.MapService);i.StreamLayerService=s})},"geocortex/essentials/TextField":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(e,t,i,r){this.id=e,this.displayName=t,this.value=i,this.multiline=r};t.TextField=i})},"geocortex/essentials/TimeExtent":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/TimeInfo":function(){define(["require","exports","./utilities/StringUtilities"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getGcxTimeInfo=function(e,t,r){var n=null,s=null;if(e&&e.timeExtent&&(n=e.timeExtent&&e.timeExtent.startTime instanceof Date?e.timeExtent.startTime.valueOf():parseInt(e.timeExtent[0],10),s=e.timeExtent&&e.timeExtent.endTime instanceof Date?e.timeExtent.endTime.valueOf():parseInt(e.timeExtent[1],10)),(!n||isNaN(n))&&!t||(!s||isNaN(s))&&!r)return null;var a=t?i.StringUtilities.getDateFromRestDateString(t):new Date(n),o=r?i.StringUtilities.getDateFromRestDateString(r):new Date(s),l={};return l.timeExtent={startTime:a,endTime:o},e&&(e.startTimeField&&(l.startTimeField=e.startTimeField),e.endTimeField&&(l.endTimeField=e.endTimeField),e.trackIdField&&(l.trackIdField=e.trackIdField),e.timeReference&&(l.timeReference={},void 0!=e.timeReference.respectsDaylightSaving&&(l.timeReference.respectsDaylightSavings=e.timeReference.respectsDaylightSaving),void 0!=e.timeReference.timeZone&&(l.timeReference.timeZone=e.timeReference.timeZone)),e.exportOptions&&(l.exportOptions={},void 0!=e.exportOptions.timeDataCumulative&&(l.exportOptions.timeDataCumulative=e.exportOptions.timeDataCumulative),void 0!=e.exportOptions.timeOffset&&(l.exportOptions.timeOffset=e.exportOptions.timeOffset),void 0!=e.exportOptions.timeOffsetUnits&&(l.exportOptions.timeOffsetUnits=e.exportOptions.timeOffsetUnits),void 0!=e.exportOptions.useTime&&(l.exportOptions.useTime=e.exportOptions.useTime))),l}})},"geocortex/essentials/TimeReference":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/TimeSliderMode":function(){define(["require","exports"],function(e,t){"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),(i=t.TimeSliderMode||(t.TimeSliderMode={}))[i.Extent=0]="Extent",i[i.Cumulative=1]="Cumulative",i[i.Instant=2]="Instant"})},"geocortex/essentials/TimeSliderProfile":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./AsyncInitializable","./TimeSliderMode","./TimeUnits","./utilities/StringUtilities","./../geocortex"],function(e,i,r,n,s,a,o){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var l=function(e){function i(t){return e.call(this,t)||this}return t(i,e),i.prototype._configureObject=function(e,t){this.id=e.id,this.displayName=e.displayName,this.description=e.description,this.mode=n.TimeSliderMode[e.mode],this.displayFormat=e.displayFormat,this.timeExtent={startTime:a.StringUtilities.getDateFromRestDateString(e.startTime),endTime:a.StringUtilities.getDateFromRestDateString(e.endTime)},this.initialTimeExtent={startTime:a.StringUtilities.getDateFromRestDateString(e.initialStartTime),endTime:a.StringUtilities.getDateFromRestDateString(e.initialEndTime)},this.timeInterval=e.timeInterval,this.timeIntervalUnit=s.EssentialsTimeUnits[e.timeIntervalUnit],this.snapToTimeIntervals=e.snapToTimeIntervals,this.properties=o._getProperties(e.properties),this.extensions=o._getExtensions(e.extensions)},i}(r.AsyncInitializable);i.TimeSliderProfile=l})},"geocortex/essentials/TimeUnits":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){};i.UNIT_CENTURIES="esriTimeUnitsCenturies",i.UNIT_DAYS="esriTimeUnitsDays",i.UNIT_DECADES="esriTimeUnitsDecades",i.UNIT_HOURS="esriTimeUnitsHours",i.UNIT_MILLISECONDS="esriTimeUnitsMilliseconds",i.UNIT_MINUTES="esriTimeUnitsMinutes",i.UNIT_MONTHS="esriTimeUnitsMonths",i.UNIT_SECONDS="esriTimeUnitsSeconds",i.UNIT_WEEKS="esriTimeUnitsWeeks",i.UNIT_YEARS="esriTimeUnitsYears",i.UNIT_UNKNOWN="esriTimeUnitsUnknown",t.TimeUnits=i;var r=function(){};r.Century=i.UNIT_CENTURIES,r.Day=i.UNIT_DAYS,r.Decade=i.UNIT_DECADES,r.Hour=i.UNIT_HOURS,r.MilliSecond=i.UNIT_MILLISECONDS,r.Minute=i.UNIT_MINUTES,r.Month=i.UNIT_MONTHS,r.Second=i.UNIT_SECONDS,r.Week=i.UNIT_WEEKS,r.Year=i.UNIT_YEARS,t.EssentialsTimeUnits=r})},"geocortex/essentials/TokenResult":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){};t.TokenResult=i})},"geocortex/essentials/WebMapReference":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./AsyncInitializable","./utilities/LayerUtilities","./GeoRssLayerService","./MapServiceConstants","geocortex/framework/utils/utils"],function(e,i,r,n,s,a,o){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var l=function(e){function i(t){var i=e.call(this,t)||this;return i.displayName=null,i.id=null,i._isLoading=!1,i._onLoadingComplete=null,i._onLoadingError=null,i._layerTypes=null,i._arcgisSharingRegularExpressions=[new RegExp("(https?://.*?/)home/item.html\\?id=(\\w*)"),new RegExp("(https?://.*?/)home/webmap/viewer.html\\?webmap=(\\w*)"),new RegExp("(https?://.*?/)explorer/\\?open=(\\w*)"),new RegExp("(https?://.*?/sharing)/content/items/(\\w*)/data"),new RegExp("(https?://.*?/sharing)/content/items/(\\w*)")],i.site=null,i}return t(i,e),i.prototype.isLoading=function(){return this._isLoading},i.prototype._getUrlPortions=function(e){for(var t={id:null,path:null},i=0;i<this._arcgisSharingRegularExpressions.length;++i){var r=this._arcgisSharingRegularExpressions[i],n=e.match(r);if(n&&n.length>0){t.id=n[2],t.path=n[1];break}}return t},i.prototype._loadWebMap=function(e,t,i){var r=this;if(e&&e.path){if(!esri.arcgis||!esri.arcgis.Portal)return;new esri.arcgis.Portal(e.path).on("ready",function(t){if(t){var n={q:"id:"+e.id};t.queryItems(n).then(function(e){if(e){var t=e.results[0];esri.request({url:t.itemDataUrl}).then(function(e){r._processItemData(e),i.resolve(!1)})}})}})}else{var n="Web map with address "+t+" cannot be loaded.",s=esri.urlToObject(t);if(s.query=s.query||{},s.query&&(s.query.webmap||s.query.id)){var a,o=s.query.webmap||s.query.id;esri.arcgis&&esri.arcgis.utils?a=esri.arcgis.utils.getItem:esri.arcgis.getItem&&(a=esri.arcgis.getItem),a&&a(o).then(function(e){e?this._processItemData(e.itemData):this._onLoadingError(new Error(n)),i.resolve(!1)})}else this._onLoadingError(new Error(n)),i.resolve(!1)}},i.prototype._initializeWebMap=function(e,t,i,r){var n=this;if(this.isLoading())r&&r(new Error("Currently loading web map."));else{this._isLoading=!0;var s=new dojo.Deferred;this._onLoadingComplete=dojo.hitch(this,i),this._onLoadingError=dojo.hitch(this,r),this._layerTypes=this.site.webMapsInfo.layerTypes;var a=this._getUrlPortions(e.url);this._loadWebMap(a,e.url,s),s.then(function(e){n._isLoading=e})}},i.prototype._processItemData=function(e){if(e){var t=e.operationalLayers;t&&this._processLayerCollection(t,"Operational");var i=e.baseMap.baseMapLayers;i&&this._processLayerCollection(i,"Base")}},i.prototype._processLayerCollection=function(e,t){var i=this;if(e){for(var r=[],n=0;n<e.length;++n){var s=e[n];if(!this._layerTypes||!(!s.type&&this._layerTypes.indexOf("Null")>=0||s.type&&this._layerTypes.indexOf(s.type)>=0)){var a=this._addLayerToMap(s);r.push(a)}}new dojo.DeferredList(r).then(function(e){if(e){for(var r=[],n=0;n<e.length;++n){var s=e[n][1];s&&(s.length>0?r=r.concat(s):r.push(s))}r.length>0&&i.site.essentialsMap.addServiceLayers(r,t)}},function(e){i._onLoadingError(new Error("There was an error loading a layer: "+e))})}},i.prototype._addLayerToMap=function(e){var t=new dojo.Deferred,i=null;switch(this.site.getMap(),e.type){case"CSV":var r=new dojo._Url(window.location.href),l=new dojo._Url(e.url);r.host===l.host&&r.port===l.port&&r.scheme===l.scheme||(e.url=esri.config.defaults.io.proxyUrl+e.url),n.LayerUtilities.createFeatureLayerFromCsv(e,null).then(function(i){i&&i.setVisibility&&i.setVisibility(e.visibility),t.resolve(i)},function(e){t.reject(e)});break;case"GeoRSS":var u=new s.GeoRssLayerService(e.url);u.essentialsMap=this.site.essentialsMap;var c={displayName:e.title,serviceType:a.MapServiceType.GEORSS,connectionString:"url="+e.url,feedImageUri:e.pointSymbol?e.pointSymbol.url:null,opacity:e.opacity,id:e.id||o.alphaNumericToken(),visible:e.visibility};u._configureObject(c),t.resolve(u);break;case"WebTiledLayer":if(!e.wmtsInfo&&esri.layers&&esri.layers.WebTiledLayer){var p={id:e.id,subDomains:e.subDomains,copyright:e.copyright};i=new esri.layers.WebTiledLayer(e.templateUrl,p),e.title&&(i.name=e.title)}t.resolve(i);break;case"WMS":t.resolve(null);break;default:var h=null;e.url||e.featureCollection&&(h=this._addFeatureCollectionToMap(e.featureCollection)),t.resolve(h)}return t.promise},i.prototype._addFeatureCollectionToMap=function(e){var t=this.site.getMap(),i=[];return dojo.forEach(e.layers,function(e){var r=new esri.layers.FeatureLayer(e,{outSR:t.spatialReference});r.layerId=o.alphaNumericToken(),i.push(r)}),i},i.prototype._loadingRestComplete=function(e){this._isLoading=!1,!e&&this._onLoadingError&&this._onLoadingError(new Error("No results")),e.error&&this._onLoadingError&&this._onLoadingError(e.error),this._onLoadingComplete&&this._onLoadingComplete(e.results)},i.prototype._loadingRestError=function(e){this._isLoading=!1,this._onLoadingError&&this._onLoadingError(e)},i.prototype._configureObject=function(e,t){if(void 0===e||void 0===e.id)throw new Error("Incorrect Web Map reference object returned from initialization");this.displayName=e.displayName,this.id=e.id,t&&(this.isInitialized=!0),this._initializeWebMap(e,this.site,function(e){},function(e){throw e})},i}(r.AsyncInitializable);i.WebMapReference=l})},"geocortex/essentials/WFSLayerService":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./MapService","./RestHelperHTTPService"],function(e,i,r,n){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var s=function(e){function i(){var t=null!==e&&e.apply(this,arguments)||this;return t._WFSLayerOptions=null,t._defaultMaxFeaturesInOnDemandMode=500,t._defaultMaxFeaturesInSnapshotMode=1e3,t._defaultWFSLayerMode="snapshot",t}return t(i,e),i.prototype._configureWFSSettings=function(e){var t=this.serviceUrl.indexOf("?");if(this.baseUrl=t>-1?this.serviceUrl.substring(0,t):this.serviceUrl,this.layers.length<1||!this.layers[0].wfsLayerName)throw new Error("Failed to initialize WFS layer. Layer name or layer not defined.");var i=this.layers[0].wfsLayerName.split(":")[1],r={url:this.baseUrl,name:i,layerName:i,mode:this._defaultWFSLayerMode,swapXY:!1,swapXYFilter:!1,version:"1.0.0"};e&&(e.version&&(r.version=e.version),e.spatialReference?r.wkid=this.operationalSpatialReference=e.spatialReference.wkid:e.operationalSpatialReference&&(r.wkid=this.operationalSpatialReference=e.operationalSpatialReference),e.mode&&(r.mode=e.mode),e.customParameters&&(r.customParameters=e.customParameters),e.infoTemplate&&(r.infoTemplate=e.infoTemplate));var n=e.properties&&e.properties.filter(function(e){return"maxFeatures"===e.name})[0]||null,s=e.maxFeatures||n&&n.value||null;(s=parseInt(s,10))&&!isNaN(s)?r.maxFeatures=s:r.maxFeatures=r.mode===this._defaultWFSLayerMode?this._defaultMaxFeaturesInSnapshotMode:this._defaultMaxFeaturesInOnDemandMode,this._WFSLayerOptions=r},i.prototype._configureObject=function(t,i){if(void 0===t)throw new Error("Incorrect map service object returned from initialization");this._restWFSConfigObject=t,e.prototype._configureObject.call(this,t,i)},i.prototype._createServiceLayer=function(){var t=this;this._configureWFSSettings(this._restWFSConfigObject),this.serviceToken&&(this._WFSLayerOptions.url=n.RestHelperHTTPService.appendTokenToUrl(this.serviceUrl,this.serviceToken));var i=new esri.layers.WFSLayer(this._WFSLayerOptions);i.id=this.id,this.serviceLayer=i,dojo.connect(i,"onError",dojo.hitch(this,this._layerLoadErrorHandler)),dojo.connect(i,"onLoad",dojo.hitch(this,this._handleServiceLayerLoaded)),i.initialize(this._WFSLayerOptions,function(e){i.selectLayer(t._WFSLayerOptions,function(e){t._initiallyVisible&&t.layers[0].configuredVisible?i.show():i.hide(),t.attributionDataUrl&&""!==t.attributionDataUrl?(i.attributionDataUrl=t.attributionDataUrl,i.hasAttributionData=!0):t.hasAttributionData&&(i.attributionDataUrl=t.url+"/Attribution",i.hasAttributionData=!0),i.onLoad(i)})}),e.prototype.initiateServiceFailureTimer.call(this)},i}(r.MapService);i.WFSLayerService=s})},"geocortex/essentials/Workflow":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./AsyncInitializable","./../workflow/ArgumentInfo","./../workflow/ExternalActivityInfo","./../geocortex"],function(e,i,r,n,s,a){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var o=function(e){function i(t){var i=e.call(this,t)||this;return i.displayName=null,i.error=null,i.extensions=[],i.externalActivities={},i.id=null,i.properties={},i.site=null,i._inputs=[],i._outputs=[],i}return t(i,e),i.prototype.getInputs=function(){return this._cloneArgumentInfoCollection(this._inputs)},i.prototype.getOutputsMetadata=function(){return this._cloneArgumentInfoCollection(this._outputs)},i.prototype._cloneArgumentInfoCollection=function(e){var t=null;if(null!==e){t=[];for(var i=0;i<e.length;i++)t.push(e[i]._internalClone())}return t},i.prototype._configureObject=function(e,t){if(void 0===e.id||void 0===e.displayName)throw new Error("Incorrect workflow object returned from initialization");var i,r;if(this.id=e.id,this.displayName=e.displayName,this.runOnStartup=!!e.runOnStartup,this.error=e.error,this._inputs=[],this._outputs=[],this.externalActivities=[],e.inputs)for(var o=0;o<e.inputs.length;o++)i=e.inputs[o],(r=new n.ArgumentInfo)._configureObject(i),this._inputs[o]=r;if(e.outputs)for(o=0;o<e.outputs.length;o++)i=e.outputs[o],(r=new n.ArgumentInfo)._configureObject(i),this._outputs[o]=r;if(e.externalActivities)for(o=0;o<e.externalActivities.length;o++){var l=e.externalActivities[o],u=new s.ExternalActivityInfo;u._configureObject(l),this.externalActivities[o]=u}this.properties=a._getProperties(e.properties),this.extensions=a._getExtensions(e.extensions)},i}(r.AsyncInitializable);i.Workflow=o})},"geocortex/essentials/XmlUtils":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseObject=function e(t){if(t)try{if(3===t.nodeType||4===t.nodeType){var i=String.prototype.trim?t.nodeValue.trim():dojo.string.trim(t.nodeValue);return 0===i.length?null:i}if(1===t.nodeType){var r={},n=0;dojo.forEach(t.attributes,function(e){r[e.nodeName]=e.nodeValue});var s=t.childNodes;return dojo.forEach(s,function(t){var i=e(t);i&&(n++,r[t.nodeName]?(!1===dojo.isArray(r[t.nodeName])&&(r[t.nodeName]=[r[t.nodeName]]),r[t.nodeName].push(i)):r[t.nodeName]=i)}),1===n&&r["#text"]?r["#text"]:1===n&&r["#cdata-section"]?r["#cdata-section"]:r}}catch(t){throw new Error("Unable to parse XML object: "+t.toString())}return null},t.getAllNodes=function(e){var t=new dojo.NodeList;if(dojo.isIE)for(var i=e.childNodes,r=0;r<i.length;r++)t.push(i[r]);else t=dojo.query("*",e);return t},t.getNodes=function(e,t,i){var r=new dojo.NodeList;if(dojo.isIE){var n=i.getElementsByTagName(e);dojo.forEach(n,function(e,i,n){var s=e.getElementsByTagName(t);dojo.forEach(s,function(e,t,i){r.push(e)})})}else r=dojo.query(e+" > "+t,i);return r},t.getValue=function(e,t){if(e){var i=e;if(dojo.isString(e)){var r=e.split(" > ");i=this.getNodes(r[0],r[1],t)[0]}return i.firstChild&&i.firstChild.nodeValue?i.firstChild.nodeValue:"Node not valid"}return"No Value"},t.getAttribute=function(e,t){if(e){if(dojo.isIE){for(var i=0;i<e.attributes.length;i++)if(e.attributes[i].nodeName==t)return e.attributes[i].nodeValue;return null}return e.getAttribute(t)}return"No Value"}})},"geocortex/essentials/catalog/CatalogEntry":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){this.id=null,this.displayName=null,this.entries=null,this.type=null,this.entries=[]};t.CatalogEntry=i})},"geocortex/essentials/catalog/LayerCatalogDetail":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){this.mapServiceId=null,this.entries=null,this.entries=[]};t.LayerCatalogDetail=i})},"geocortex/essentials/catalog/LayerCatalogDetailEntry":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/catalog/LayerCatalogDetailsParams":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){this.ids=null,this.ids=[]};t.LayerCatalogDetailsParams=i})},"geocortex/essentials/catalog/LayerCatalogParams":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){};t.LayerCatalogParams=i})},"geocortex/essentials/documents/BatchRequestBuilder":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.cloneDocument=function(e,t,i){return{action:"cloneDocument",id:e,document:t,createOnly:i}},t.createDocument=function(e,t){return{action:"createDocument",document:e,streamId:t}},t.createMoniker=function(e,t){return{action:"createMoniker",moniker:e,createOnly:t}},t.deleteDocument=function(e){return{action:"deleteDocument",id:e}},t.deleteMoniker=function(e){return{action:"deleteMoniker",id:e}},t.describe=function(e){return{action:"describe",streamId:e}},t.generateLinks=function(e){return{action:"generateLinks",count:e}},t.modifyDocument=function(e,t){return{action:"modifyDocument",document:e,streamId:t}},t.openDocument=function(e,t,i){return{action:"openDocument",id:e,streamId:t,startPosition:i}},t.peekDocument=function(e,t){return void 0===t&&(t=!1),{action:"peekDocument",id:e,throwIfMissing:t}},t.peekDocumentAccess=function(e){return{action:"peekDocumentAccess",id:e}},t.peekMoniker=function(e,t){return{action:"peekMoniker",id:e,throwIfMissing:t}},t.peekMonikerAccess=function(e){return{action:"peekMonikerAccess",id:e}},t.previewDocument=function(e,t){return{action:"previewDocument",id:e,streamId:t}},t.previewMoniker=function(e,t){return{action:"previewMoniker",id:e,streamId:t}},t.readDocument=function(e,t){return{action:"readDocument",id:e,format:t}},t.restoreDocument=function(e){return{action:"restoreDocument",globalId:e}},t.restoreMoniker=function(e){return{action:"restoreMoniker",globalId:e}},t.resumeDocument=function(e,t){return{action:"resumeDocument",globalId:e,streamId:t}},t.scrub=function(e){return{action:"scrub",scrubOptions:e}},t.searchDocuments=function(e){return{action:"searchDocuments",documentQuery:e}},t.searchMonikers=function(e){return{action:"searchMonikers",monikerQuery:e}},t.searchRoles=function(e){return{action:"searchRoles",searchClause:e}},t.searchUsers=function(e){return{action:"searchUsers",searchClause:e}},t.self=function(){return{action:"self"}},t.touchDocument=function(e,t,i){return{action:"touchDocument",id:e,modify:t,throwIfMissing:i}},t.updateDocument=function(e){return{action:"updateDocument",document:e}},t.updateMoniker=function(e){return{action:"updateMoniker",moniker:e}},t.writeDocument=function(e){return{action:"writeDocument",content:e}}})},"geocortex/essentials/documents/Document":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/documents/DocumentConstants":function(){define(["require","exports"],function(e,t){"use strict";var i,r,n,s,a,o,l,u;Object.defineProperty(t,"__esModule",{value:!0}),(i=t.DocumentField||(t.DocumentField={})).AUTHOR_DESCRIPTION="author.description",i.AUTHOR_ISSUER_TITLE="author.issuerTitle",i.AUTHOR_TITLE="author.title",i.DESCRIPTION="description",i.EDITOR_DESCRIPTION="editor.description",i.EDITOR_ISSUER_TITLE="editor.issuerTitle",i.EDITOR_TITLE="editor.title",i.FILE_TYPE="fileType",i.GRANT_TOKEN="grants.token",i.ISSUER_TITLE="issuerTitle",i.TAGS="tags",i.TIME_CREATION="timeOfCreation",i.TIME_LAST_ACCESS="timeOfLastAccess",i.TIME_LAST_MODIFICATION="timeOfLastModification",i.TITLE="title",(r=t.ContentType||(t.ContentType={})).BLOB="application/octet-stream",r.JSON="application/json",r.TEXT="text/plain",r.XML="application/xml",(n=t.DocumentFormat||(t.DocumentFormat={})).BLOB="blob",n.JSON="json",n.TEXT="text",n.XML="xml",(s=t.GrantKind||(t.GrantKind={})).FROZEN="frozen",s.OWNER="owner",s.READER="reader",s.WRITER="writer",s.READER_LINK="readerLink",s.WRITER_LINK="writerLink",s.GLOBAL_CREATE="global_create",s.GLOBAL_READER="global_reader",s.GLOBAL_WRITER="global_writer",(a=t.GrantID||(t.GrantID={})).PUBLIC="public",a.USER="user",(o=t.MonikerKind||(t.MonikerKind={})).LINK="link",o.ROLE="role",o.USER="user",o.POLICY="policy",(l=t.FilterMethod||(t.FilterMethod={})).RANGES="ranges",l.SPATIAL_DISJOINT="spatialDisjoint",l.SPATIAL_INTERSECTS="spatialIntersects",l.SPATIAL_WITHIN="spatialWithin",l.MATCHES="matches",l.VALUES="values",(u=t.FilterType||(t.FilterType={})).REQUIRE="require",u.EXCLUDE="exclude",u.INCLUDE="include"})},"geocortex/essentials/documents/DocumentStore":function(){define(["require","exports","./DocumentConstants","./../utilities/UrlUtilities","./../../geocortex","./BatchRequestBuilder"],function(e,t,i,r,n,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LINK_QUERY_STRING_KEY="link";var a=function(){function e(){this._initializeDeferred=new dojo.Deferred,this.supported=!1,this.isInitialized=!1,this.self=[],this.userMonikers=[],this.policyMonikers=[],this.userFilter={}}return e.prototype.initialize=function(e){this._site=e;var t=/^(.*?)(\/*)$/.exec(e.originalUrl)[1];return this._rootUrl=r.UrlUtilities.simplify(t+"/../../documents"),this.supported=e.getEssentialsVersion()>=4.05,this.onInitializeAttempt()},e.prototype.onInitialized=function(){return this._initializeDeferred.promise},e.prototype.onInitializeAttempt=function(){var t=this;if(this._initializeAttemptThenable)return this._initializeAttemptThenable;if(!this.supported){var i=new Error("The Document Store is not supported in the current version of Essentials.");return this._initializeDeferred.reject(i),this._initializeAttemptThenable=(new dojo.Deferred).reject(i)}return this._initializeAttemptThenable=n.request({url:this._rootUrl+"/self",content:{f:"json"},handleAs:"json"},{usePost:!1}).then(e._processError).then(function(e){t._processSelf(e),t.isInitialized=!0,t._initializeDeferred.resolve()}).then(null,function(e){throw t._initializeAttemptThenable=null,e})},e.prototype.getRootUrl=function(){return this._verifySupported(),this._rootUrl+"/"},e.prototype.canCreate=function(){return this.userMonikers.length>0},e.prototype.hasPolicyGrant=function(e){return this.policyMonikers.some(function(t){return t.grants.some(e)})},e.prototype.add=function(e){var t=this,i={document:dojo.mixin({},e)};void 0!==e.content&&(i.json=e.content,delete i.document.content);var r=s.writeDocument(i);return this.perform(r,!0).then(function(e){return e.document}).then(function(e){return t._processDocument(e)})},e.prototype.addFromFormData=function(e){throw new Error("Not implemented.")},e.prototype.addFromForm=function(e){throw new Error("Not implemented.")},e.prototype.getById=function(t,r,n){var a=this;if(void 0===r&&(r=!1),void 0===n&&(n=i.DocumentFormat.JSON),this._verifyDocId(t),r){var o=s.readDocument(t,n);return this.perform(o).then(function(t){return e._processReadDocumentResponse(t,n)}).then(function(e){return a._processDocument(e)})}var l=s.peekDocument(t);return this.perform(l).then(function(e){return e.document}).then(function(e){return a._processDocument(e)})},e.prototype.getContentUrl=function(e){throw new Error("Not implemented.")},e.prototype.updateById=function(e,t){var i=this;this._verifyDocId(e),t.timeOfLastModification||(t.timeOfLastModification=null),t.editor||(t.editor=null);var r=[];for(var n in t)t.hasOwnProperty(n)&&r.push(n);if(void 0!==t.content){var a={json:t.content};delete t.content,a.document=dojo.mixin({id:e,updates:r},t);var o=s.writeDocument(a);return this.perform(o,!0).then(function(e){return e.document}).then(function(e){return i._processDocument(e)})}var l=dojo.mixin({id:e,updates:r},t),u=s.updateDocument(l);return this.perform(u,!0).then(function(e){return e.document}).then(function(e){return i._processDocument(e)})},e.prototype.deleteById=function(e){var t=this;this._verifyDocId(e);var i=s.deleteDocument(e);return this.perform(i,!0).then(function(e){return e.document}).then(function(e){return t._processDocument(e)})},e.prototype.query=function(t){var i=this,r=dojo.mixin({},t);r.sort&&r.sort.forEach(function(t,i,r){e.matchesFilterFields.some(function(e){return e===t})&&(r[i]="{0}_exact".format(t))}),r.sortDescending&&r.sortDescending.forEach(function(t,i,r){e.matchesFilterFields.some(function(e){return e===t})&&(r[i]="{0}_exact".format(t))});var n=s.searchDocuments(r);return this.perform(n).then(function(e){return Array.isArray(e.matchingDocuments.results)&&e.matchingDocuments.results.forEach(function(e){return i._processDocument(e.entity)}),e.matchingDocuments})},e.prototype.perform=function(t,i){var r=this;if(void 0===i&&(i=!1),!t.action)throw new Error("The Document Store batch request does not contain an action");var s=t.action;return"perform"!==s&&delete t.action,this._guestLink&&(t.link=this._guestLink),t.f="json",this.onInitializeAttempt().then(function(){return r._verifySupported()}).then(function(){return n.request({url:r._rootUrl+"/"+s,content:n.encodeJson(t),handleAs:"json"},{usePost:i})}).then(e._processError)},e.prototype.isOwner=function(e){return!e||!e.access||e.access.change},e.prototype.isReadOnly=function(e){return!(!e||!e.access||!e.access.view||e.access.edit||e.access.change)},e.prototype.isPublic=function(e){return!!(e&&e.id&&e.grants)&&e.grants.some(function(e){return e.globalId===i.GrantID.PUBLIC&&(!1===e.revoke||!0===e.assert)})},e.prototype.setGuestLink=function(e){this._guestLink=e},e._processError=function(e){if(e.error)throw e.error;return e},e.prototype._processDocument=function(e){return e.timeOfCreation&&(e.timeOfCreation=new Date(e.timeOfCreation)),e.timeOfLastAccess&&(e.timeOfLastAccess=new Date(e.timeOfLastAccess)),e.timeOfLastModification&&(e.timeOfLastModification=new Date(e.timeOfLastModification)),e.timeOfDeletion&&(e.timeOfDeletion=new Date(e.timeOfDeletion)),e.timeOfExpiration&&(e.timeOfExpiration=new Date(e.timeOfExpiration)),e.access&&!e.access.monikerIds&&(e.access.monikerIds=this.userMonikers.map(function(e){return e.id})),e},e._processReadDocumentResponse=function(e,t){var i=e.content.document;return i.content=e.content[t],i},e.prototype._processSelf=function(e){if(this.self=e.monikers,this.userMonikers=e.monikers.filter(function(e){return e.kind===i.MonikerKind.USER}),this.policyMonikers=e.monikers.filter(function(e){return e.kind===i.MonikerKind.POLICY}),this.userMonikers.length>0){var t=this.userMonikers.map(function(e){return{string:"{0}|{1}".format(i.GrantKind.OWNER,e.globalId)}});this.userFilter={field:i.DocumentField.GRANT_TOKEN,method:i.FilterMethod.VALUES,range:t}}},e.prototype._verifyDocId=function(e){if(!e)throw new Error("The Document ID must be set.");if(/[/?#\s]/.test(e))throw new Error("The Document ID '{0}' contains illegal characters.".format(e))},e.prototype._verifySupported=function(){if(!this.supported)throw new Error("The Document Store is not supported in the current version of Essentials.")},e}();a.matchesFilterFields=[i.DocumentField.TITLE,i.DocumentField.DESCRIPTION,i.DocumentField.ISSUER_TITLE,i.DocumentField.AUTHOR_TITLE,i.DocumentField.AUTHOR_DESCRIPTION,i.DocumentField.AUTHOR_ISSUER_TITLE,i.DocumentField.EDITOR_TITLE,i.DocumentField.EDITOR_DESCRIPTION,i.DocumentField.EDITOR_ISSUER_TITLE],t.DocumentStore=a})},"geocortex/essentials/documents/Parameters":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/BingEnvironment":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PRODUCTION="Production"})},"geocortex/essentials/exportMap/ExportContext":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportDynamicMapLayerDefinition":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportFeature":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportFeatureCollection":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportLayer":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportLayerFeatureSet":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportLayoutOptions":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportMapLayerDefinition":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportMapOptions":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportMapParameters":function(){define(["require","exports","./../ReportParameters"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){this.operationParameters=null,this.reportParameters=null,this.queryParameters=null,this.operationParameters={},this.reportParameters=new i.ReportParameters};t.ExportMapParameters=r})},"geocortex/essentials/exportMap/ExportMapService":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportMapTask":function(){define(["require","exports","./../../geocortex","./../utilities/UrlUtilities","./../utilities/PrintUtilities","./../utilities/PromiseUtilities","./ExportMapTypes","./BingEnvironment","./../ReportParameters","./../utilities/GraphicsLayerUtilities"],function(e,t,i,r,n,s,a,o,l,u){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var c=function(){function e(e){if(this.resource=null,this._esriMap=null,this._essentialsRestUrl=null,this._site=null,this._populateFromResource(e),!this._esriMap||!this._essentialsRestUrl)throw new Error("Unable to create ExportMapTask from the resource.")}return e.prototype._populateFromResource=function(e){e.hasOwnProperty("extentManager")?(this._esriMap=e.getMap(),this._essentialsRestUrl=e.url+"/export",this._site=e.site):e.hasOwnProperty("maximumResolution")?(this._esriMap=e.site.getMap(),this._essentialsRestUrl=e.url+"/print",this._site=e.site):e&&(this._esriMap=e.site.getMap(),this._essentialsRestUrl=e.url+"/run",this._site=e.site)},e.prototype.generateMapImageUrl=function(e){var t=this,r=new dojo.Deferred;return this._marshalContent(e).then(function(e){var n={url:t._essentialsRestUrl,content:e,load:r.resolve,error:r.reject,callbackParamName:"CallBack"};i.request(n)}),r},e.prototype._getWebMap=function(e,t,i){var r=new esri.tasks.PrintTemplate;r.outScale=i;for(var n=[],s=0,a=t.graphicsLayerIds;s<a.length;s++){var o=a[s];1===(c=t.getLayer(o)).opacity&&(c.setOpacity(.999),n.push(c))}try{return e._getPrintDefinition(t,r)}finally{for(var l=0,u=n;l<u.length;l++){var c=u[l];c.setOpacity(1)}}},e.prototype._getPrintingObjectForEssentials=function(e){var t=new dojo.Deferred,i=new esri.tasks.PrintTask("http://3275ec4b-ad36-465e-97e9-a20acaae8d53/",{async:!1}),r=null;try{r=this._getWebMap(i,this._esriMap,e)}catch(e){t.reject(new Error("Could not create ExportContext definition. {0} Verify that subroutines have not changed.".format(e&&e.message?e.message:"Unable to determine cause.")))}return r?(this._removeInternalLayers(r),this._handleFeatureLayers(r),this._handleDynamicLayerDefs(r),this._cleanOutVisibility(r),this._handleWebTiledLayers(r),this._handleLayersAttribution(r,this._esriMap),this._handleHeatmapRenderer(r,this._esriMap),this._handleClusters(r,this._esriMap),this._adjustMeasurementsMarkup(r),this._adjustPlotCoordinatesMarkup(r),this._removeAttributes(r),this._adjustText(r),this._setServiceVisibilities(r),this._adjustPlotCoordinatesMarkupOrder(r),this._finalizePrintingContext(r),this._convertSymbolsToBase64(r).then(function(e){return t.resolve(e)},function(e){return t.reject(new Error("Converting symbols to base64 failed: {0}".format(e&&e.message?e.message:"Unable to determine cause")))})):t.reject(new Error("ExportContext definition was empty")),t},e.prototype._removeInternalLayers=function(e){for(var t=e.operationalLayers.length-1;t>=0;t--){var i=e.operationalLayers[t].id;i&&u.getGraphicsLayerIdsToExclude([u.excludeFromExportMapTaskName]).indexOf(i)>-1&&e.operationalLayers.splice(t,1)}},e.prototype._convertSymbolsToBase64=function(e){for(var t=new dojo.Deferred,i=[],a={},o=0;o<e.operationalLayers.length;o++){var l=e.operationalLayers[o];if(l.featureCollection&&l.featureCollection.layers)for(var u=0;u<l.featureCollection.layers.length;u++){var c=l.featureCollection.layers[u];if(c.featureSet&&c.featureSet.features)for(var p=0;p<c.featureSet.features.length;p++){var h=c.featureSet.features[p];if(h&&h.symbol&&"esriPMS"===h.symbol.type){var d=h.symbol;d.url&&i.push(d)}}}}if(Modernizr&&Modernizr.canvas){var f=[];for(o=0;o<i.length;o++){var y=i[o].url;if(y&&!a.hasOwnProperty(y)&&!i[o].imageData){a[y]={url:null,data:null};var m=n.PrintUtilities.getImageAsBase64(y);f.push(m)}}s.PromiseUtilities.settle(f).then(function(n){n.forEach(function(e){if(e.isFulfilled()){var t=e.value();t&&t.url&&t.data&&(a[t.url]={data:t.data})}else{var n=e.reason();n&&n.url&&(a[n.url]={url:r.UrlUtilities.simplify(y)})}for(var s=0;s<i.length;s++){var o=i[s],l=a[o.url];l&&(l.data?(o.imageData=l.data,delete o.url):l.url&&(o.url=l.url)),o.yoffset&&(o.yoffset=-1*o.yoffset)}}),t.resolve(e)})}else{for(o=0;o<i.length;o++)(y=i[o].url)&&(i[o].url=r.UrlUtilities.simplify(y));t.resolve(e)}return t},e.prototype._adjustMeasurementsMarkup=function(e){var t=this._getLayer(e,"_measurement");t&&t.id&&this._adjustSvgSymbols(t)},e.prototype._adjustPlotCoordinatesMarkup=function(e){var t=this._getLayer(e,"_coordinates");t&&t.id&&this._adjustSvgSymbols(t)},e.prototype._adjustPlotCoordinatesMarkupOrder=function(e){var t=this._getLayer(e,"_coordinates");if(t&&t.featureCollection&&t.featureCollection.layers)for(var i=null,r=null,n=0;n<t.featureCollection.layers.length;n++){var s=t.featureCollection.layers[n];if(s.layerDefinition&&("pointLayer"===s.layerDefinition.name?i=s:"textLayer"===s.layerDefinition.name&&(r=s)),i&&r){if(i.featureSet&&i.featureSet.features&&i.featureSet.features.length>0&&r.featureSet&&r.featureSet.features&&r.featureSet.features.length>0&&r.featureSet.features.length/i.featureSet.features.length==1.5){for(var a=[];i.featureSet.features.length>0;)a.push(r.featureSet.features.pop()),a.push(r.featureSet.features.pop()),a.push(r.featureSet.features.pop()),a.push(i.featureSet.features.pop()),a.push(i.featureSet.features.pop());i.featureSet.features=a.reverse()}break}}},e.prototype._getLayer=function(e,t){for(var i=0;i<e.operationalLayers.length;i++){var r=e.operationalLayers[i];if(r&&r.id&&r.id.indexOf(t)>-1&&r.featureCollection&&r.featureCollection.layers)return r}},e.prototype._adjustSvgSymbols=function(e){for(var t=e.id,i=[],r=this._esriMap.getLayer(t).graphics.filter(function(e){return!("simplemarkersymbol"!=e.symbol.type||!e.visible)}),n=0;n<r.length;n++)i.push(r[n].toJson());for(n=0;n<e.featureCollection.layers.length;n++)if("pointLayer"===e.featureCollection.layers[n].layerDefinition.name){e.featureCollection.layers[n].featureSet.features=i;break}},e.prototype._adjustText=function(e){for(var t=0;t<e.operationalLayers.length;t++){var i=e.operationalLayers[t];if(i&&i.id&&i.featureCollection&&i.featureCollection.layers){for(var r=!1,s=0;s<i.featureCollection.layers.length;s++){var a=i.featureCollection.layers[s];if(a&&a.layerDefinition&&"textLayer"===a.layerDefinition.name){r=!0;break}}if(!r)continue;var o=i.id,l=[],u=this._esriMap.getLayer(o);if(u&&u.graphics){for(var c=u.graphics.filter(function(e){return!(!("textsymbol"==e.symbol.type||e.symbol instanceof esri.symbol.TextSymbol)||!e.visible)}),p=0;p<c.length;p++){var h=c[p],d=n.PrintUtilities.adjustTextSymbol(h,u.id);if(d){var f=new esri.Graphic(h.toJson());f.symbol=d,l.push(f.toJson())}}for(p=0;p<i.featureCollection.layers.length;p++)"textLayer"===i.featureCollection.layers[p].layerDefinition.name&&(i.featureCollection.layers[p].featureSet.features=l)}}}},e.prototype._setServiceVisibilities=function(e){if(e.operationalLayers)for(var t=e.operationalLayers,i=0;i<t.length;i++){var r=t[i],n=this._esriMap.getLayer(r.id);r&&(r.visibility=!n||n.visible)}},e.prototype._handleDynamicLayerDefs=function(e){if(this._site&&e.operationalLayers)for(var t=e.operationalLayers,i=0;i<t.length;i++){var r=t[i].id,n=this._site.essentialsMap.findMapServiceById(r);if(n&&n.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var s=t[i],a=n.serviceLayer;if(!s)continue;if(s.layers){for(var o=[],l=s.layers,u=0;u<l.length;u++){var c=l[u];if(c&&(c.id||0===c.id)){var p=c.id,h={id:p,name:c.name,geometryType:c.geometryType?c.geometryType:null};if(c.layerDefinition&&((c.layerDefinition.drawingInfo||c.layerDefinition.source)&&(h.layerDefinition||(h.layerDefinition={}),h.layerDefinition.drawingInfo=c.layerDefinition.drawingInfo,h.layerDefinition.source=c.layerDefinition.source),c.layerDefinition.definitionExpression&&(h.layerDefinition?h.layerDefinition.definitionExpression=c.layerDefinition.definitionExpression:h.layerDef=c.layerDefinition.definitionExpression)),p||0===p){var d=n.findLayerById(p.toString());d&&d.displayName&&h.layerDefinition&&(h.layerDefinition.displayName=d.displayName)}o.push(h)}}s.layers=o}a.gdbVersion&&(s.gdbVersion=a.gdbVersion),s.visibleLayers=n.serviceLayer.visibleLayers,s.visibility=!0}}},e.prototype._handleFeatureLayers=function(e){if(this._site&&e.operationalLayers)for(var t=e.operationalLayers,i=0;i<t.length;i++){var r=t[i].id,n=this._site.essentialsMap.findMapServiceById(r);if(n&&n.serviceLayer instanceof esri.layers.FeatureLayer){var s=n.serviceLayer,a=t[i],o={id:r,opacity:a.opacity,visibility:!0,url:a.url,minScale:a.minScale?a.minScale:0,maxScale:a.maxScale?a.maxScale:0};s.gdbVersion&&(o.gdbVersion=s.gdbVersion),a.layerDefinition?(a.layerDefinition.drawingInfo&&(o.drawingInfo=a.layerDefinition.drawingInfo),a.layerDefinition.definitionExpression&&(o.where=a.layerDefinition.definitionExpression)):o.where=s.getDefinitionExpression(),o.featureCollection=a.featureCollection,t[i]=o}}},e.prototype._cleanOutVisibility=function(e){if(e.operationalLayers)for(var t=e.operationalLayers,i=0;i<t.length;i++)if(t[i].visibleLayers)for(var r=0;r<t[i].visibleLayers.length;r++)if(-1==t[i].visibleLayers[r]){t[i].visibleLayers.splice(r,1);break}},e.prototype._handleWebTiledLayers=function(e){if(e.operationalLayers)for(var t=e.operationalLayers,i=0;i<t.length;i++)t[i].type===a.WEBTILED?t[i]={id:t[i].id,opacity:t[i].opacity,visibility:!0}:t[i].type!==a.BINGAERIAL&&t[i].type!==a.BINGAERIALLABELS&&t[i].type!==a.BINGHYBRID&&t[i].type!==a.BINGROADS||(t[i].type===a.BINGAERIALLABELS&&(t[i].type=a.BINGHYBRID),t[i]={id:t[i].id,opacity:t[i].opacity,visibility:!0,type:t[i].type,token:t[i].key,serverType:o.PRODUCTION})},e.prototype._handleLayersAttribution=function(e,t){var i=t.layerIds.concat(t.graphicsLayerIds),r=new RegExp(".*mapservices/([^/]*)/Attribution[^/]*");e.operationalLayers.forEach(function(e){for(var n in i)if(i.hasOwnProperty(n)){var s=i[n];if(e.id===s){var a=t.getLayer(s);if(a.hasAttributionData&&a.attributionDataUrl){var o=r.exec(a.attributionDataUrl);if(o&&o.length>1){var l=o[1];e.mapServiceId=l}}else!a.layerId||e.id.indexOf("-")>-1||(e.mapServiceId=a.layerId);break}}})},e.prototype._handleHeatmapRenderer=function(e,t){t.layerIds.concat(t.graphicsLayerIds).forEach(function(i){var r=t.getLayer(i);if(r.visible&&void 0!==r.renderer&&r.renderer instanceof esri.renderer.HeatmapRenderer)for(var n=r.minScale?r.minScale:0,s=r.maxScale?r.maxScale:0,a=r.getDefinitionExpression()?r.getDefinitionExpression():"",o=r.gdbVersion?r.gdbVersion:"",l=r.renderer.toJson(),u=r.url,c=r.renderer.field?r.renderer.field:"",p={renderer:l},h={type:"HeatMap",id:i,opacity:1,minScale:n,maxScale:s,where:a,gdbVersion:o,url:u,layerDefinition:{name:r.name,geometryType:"esriGeometryPoint",displayField:c},drawingInfo:p},d=0;d<e.operationalLayers.length;d++)if(e.operationalLayers[d].id.startsWith("null_image")){e.operationalLayers[d]=h;break}})},e.prototype._handleClusters=function(e,t){var i=t.layerIds.concat(t.graphicsLayerIds),r=[];e.operationalLayers.forEach(function(e,t,i){e.id.endsWith("-cluster")&&r.push(e.id)}),r.forEach(function(t){for(var i=0;i<e.operationalLayers.length;++i)if(e.operationalLayers[i].id===t){e.operationalLayers.splice(i,1);break}}),i.forEach(function(i){var r=t.getLayer(i);if(r.id.endsWith("-cluster")&&r.visible&&void 0!==r.renderer&&r.renderer instanceof esri.renderer.ClassBreaksRenderer&&r.featureLayer&&r.singleFeatureLayer){for(var n=r.featureLayer,s=n.id,a=r.url,o=r.renderer.attributeField,l=r.clusterRadius.get(),u=r.maxFeaturesInCluster.get(),c=r._clusterLabelColor,p=r.singleFeatureLayer.renderer.toJson(),h=r.renderer.toJson(),d=n.name,f=n.minScale?n.minScale:0,y=n.maxScale?n.maxScale:0,m=n.getDefinitionExpression()?n.getDefinitionExpression():"",v=n.gdbVersion?n.gdbVersion:"",g=0;g<e.operationalLayers.length;++g)if(e.operationalLayers[g].id===s){null===n.renderer&&e.operationalLayers.splice(g,1);break}if(0==r.singleFeatureLayer.graphics.length){var _={type:"Cluster",id:i,opacity:1,minScale:f,maxScale:y,where:m,gdbVersion:v,url:a,layerDefinition:{name:d,geometryType:"esriGeometryPoint",displayField:o},drawingInfo:{renderer:h,singleSymbolRenderer:p,labelColor:c,distance:l,maxFeaturesInCluster:u}};e.operationalLayers.splice(g,0,_)}}})},e.prototype._removeAttributes=function(e){if(e.operationalLayers)for(var t=0;t<e.operationalLayers.length;t++){var i=e.operationalLayers[t];if(i&&i.featureCollection&&i.featureCollection.layers)for(var r=0;r<i.featureCollection.layers.length;r++){var n=i.featureCollection.layers[r];if((!(n&&n.layerDefinition&&n.layerDefinition.drawingInfo&&n.layerDefinition.drawingInfo.renderer)||"uniqueValue"!==n.layerDefinition.drawingInfo.renderer.type&&"classBreaks"!==n.layerDefinition.drawingInfo.renderer.type)&&n&&n.featureSet&&n.featureSet.features)for(var s=0;s<n.featureSet.features.length;s++){var a=n.featureSet.features[s];a&&a.attributes&&delete a.attributes}}}},e.prototype._finalizePrintingContext=function(e){this._fixMapServiceIds(e,this._esriMap,this._site)},e.prototype._fixMapServiceIds=function(e,t,i){if(e.operationalLayers&&t&&i)for(var r=e.operationalLayers,n=0;n<r.length;n++){var s=r[n].id,a=t.getLayer(s);if(a&&(a instanceof esri.layers.WMSLayer||a instanceof esri.layers.TiledMapServiceLayer)){for(var o=null,l=0;l<i.essentialsMap.mapServices.length;l++)if(i.essentialsMap.mapServices[l].serviceLayer==a){o=i.essentialsMap.mapServices[l];break}o&&(r[n].id=o.id)}}},e.prototype._marshalContent=function(e){var t,i=this,r=new dojo.Deferred;return e.reportParameters&&e.reportParameters.scale&&(t=parseFloat(e.reportParameters.scale.scale)),this._getPrintingObjectForEssentials(t).then(function(t){var n={f:"json",if:"WebMap,blankMap"};if(i._site&&(t.product="Geocortex Essentials "+i._site.currentVersion,i._site.displayTimeZoneId&&(n.displayTimeZoneId=i._site.displayTimeZoneId)),e.reportParameters){var s=e.reportParameters;if(t.mapOptions||(t.mapOptions={extent:null}),delete t.mapOptions.scale,s.scale){var a=parseFloat(s.scale.scale);a&&!isNaN(a)&&(t.mapOptions.scale=a)}s.targetSpatialReference&&(t.mapOptions.spatialReference=s.targetSpatialReference),s.extentType==l.ReportParameters.CURRENT_EXTENT&&i._esriMap?t.mapOptions.extent=i._esriMap.extent:s.extentType==l.ReportParameters.FULL_EXTENT&&i._site&&i._site.essentialsMap?t.mapOptions.extent=i._site.essentialsMap.fullExtent:s.extentType==l.ReportParameters.INITIAL_EXTENT&&i._site&&i._site.essentialsMap?t.mapOptions.extent=i._site.essentialsMap.initialExtent:s.extentType==l.ReportParameters.CUSTOM_EXTENT&&s.customExtent&&(t.mapOptions.extent=s.customExtent);var o={dpi:null,outputSize:[]};if(s.imageWidth?o.outputSize[0]=s.imageWidth:o.outputSize[0]=i._esriMap.width,s.imageHeight?o.outputSize[1]=s.imageHeight:o.outputSize[1]=i._esriMap.height,s.resolution?o.dpi=s.resolution.dpi:o.dpi=96,t.exportOptions=o,s.grid&&s.grid.id){var u={grid:s.grid.id};t.layoutOptions=u}if(s.fields&&s.fields.length>0)for(var c=0;c<s.fields.length;c++)n[s.fields[c].id]=s.fields[c].value;s.outputFormat&&(n.outputFormat=s.outputFormat),s.featureIds&&(n.featureIDs=s.featureIds.join(",")),s.includeGeoreferenceData&&(n.georef=s.includeGeoreferenceData),s.includeData&&(n.of=n.of?n.of+",includeData":"includeData")}e.queryParameters&&(n=dojo.mixin(e.queryParameters,n)).geometry&&(n.geometry=JSON.stringify(n.geometry)),e.operationParameters&&(n=dojo.mixin(e.operationParameters,n)),s.notificationEmailAddress&&(n.emailAddress=s.notificationEmailAddress),n.data=JSON.stringify(t),r.resolve(n)},function(e){return r.reject(new Error("Failed to serialize ExportContext content: {0}".format(e&&e.message?e.message:"Unable to determine cause")))}),r},e}();t.ExportMapTask=c})},"geocortex/essentials/exportMap/ExportMapTypes":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WEBTILED="WebTiledLayer",t.BINGAERIAL="BingMapsAerial",t.BINGAERIALLABELS="BingMapsAerialWithLabels",t.BINGROADS="BingMapsRoad",t.BINGHYBRID="BingMapsHybrid"})},"geocortex/essentials/exportMap/ExportOptions":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/exportMap/ExportSymbol":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/serviceDiscovery/ResultItem":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/serviceDiscovery/ServiceDiscoveryProvider":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/serviceDiscovery/serviceDiscoveryServicePoint":function(){define(["require","exports","./../MapService","./../FeatureLayerService"],function(e,t,i,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){this.service=e}return e.prototype.postProcess=function(e){e.thumbnailUrl||(e.thumbnailUrl=this.service.formatQuery("connections/{0}/preview?f=json&providerName={1}&url={2}",e.connection.id,e.serviceProviderName,e.url));for(var t in e.children)this.postProcess(e.children[t]);return e},e.prototype.findServices=function(e){var t=this.postProcess.bind(this.postProcess),i=this.service.formatQuery("connections/find?f=json&term={0}",e);return this.service.getRequest(i,"results").select(t)},e.prototype.expandService=function(e,t,i){if(1==arguments.length){var r=e;e=r.connection.id,t=r.serviceProviderName,i=r.url}var n=this.postProcess.bind(this.postProcess),s=this.service.formatQuery("connections/{0}/expand?f=json&providerName={1}&url={2}",e,t,i);return this.service.getRequest(s,null).select(n)},e.prototype.suggestHints=function(e){var t=this.service.formatQuery("connections/suggest?f=json&term={0}",e);return this.service.getRequest(t,"hints")},e.prototype.realizeMapService=function(e,t,n,s){if(1==arguments.length){var a=e;e=a.connection.id,t=a.serviceProviderName,n=a.url}var o=this.service.formatQuery("connections/{0}/realize?f=json&providerName={1}&url={2}&sr={3}",e,t,n,s);return this.service.getRequest(o,null).select(function(e){if(e.serviceType.indexOf("FeatureLayer")>=0){var t=new r.FeatureLayerService(n);return t._configureObject(e,!0),t}var s=new i.MapService(n);return s._configureObject(e,!0),s})},e}();t.ServiceDiscoveryServicePoint=n})},"geocortex/essentials/serviceDiscovery/SiteServiceDiscoveryProvider":function(){define(["require","exports","./../utilities/UrlUtilities","geocortex/framework/SimplePromise","./../../geocortex","./../ServiceHelper","./../utilities/ServiceDiscoveryUtilities"],function(e,t,i,r,n,s,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(){this.initialized=!1,this.supported=!1}return e.prototype.initialize=function(e){this._site=e,this._rootUrl=i.UrlUtilities.resolveUrl(e.url,"/../../../connections",!0),this.supported=e.getEssentialsVersion()>=4.05,this.initialized=!0},e.prototype.getRootUrl=function(){return this._rootUrl},e.prototype.suggestHints=function(e){var t={f:"json",term:e};return this.sendRequest("suggest",t).then(function(e){return e.hints})},e.prototype.findServices=function(e,t){var i=this,r={f:"json",term:e,whitelistOnly:!0};return t&&(r=dojo.mixin(r,t)),this.sendRequest("find",r).then(function(e){return Array.isArray(e.results)&&e.results.forEach(function(e){return i._processItem(e)}),e.results})},e.prototype.expandService=function(e){var t=this,i=this._getConnectionId(e),r={f:"json",providerName:e.serviceProviderName,url:e.url};return this.sendRequest(i+"/expand",r).then(function(e){return t._processItem(e)})},e.prototype.realizeMapService=function(e,t){var i=this,r=this._getConnectionId(e),n={f:"json",providerName:e.serviceProviderName,url:e.url,sr:t,itemId:e.id||"null"};return this.sendRequest(r+"/realize",n).then(function(t){return i._createMapService(e,t)})},e.prototype.sendRequest=function(e,t){var s=this;return r.SimplePromise.resolve(null).then(function(){return s._verifyInitialized()}).then(function(){return s._verifySupported()}).then(function(){return t.f=t.f||"json",n.request({url:i.UrlUtilities.resolveUrl(s._rootUrl,e),content:n.encodeJson(t),handleAs:"json"})}).then(this._processError)},e.prototype._getConnectionId=function(e){return e.connection&&null!=e.connection.id?e.connection.id:"none"},e.prototype._processError=function(e){if(e&&e.error)throw e.error;return e},e.prototype._processItem=function(e){var t=e;if(t.connection&&null!=t.connection.id?t.isWhitelisted=!0:t.isWhitelisted=!1,!t.thumbnailUrl){var r=this._getConnectionId(t)+"/preview?f=json&providerName="+t.serviceProviderName+"&url="+t.url;t.thumbnailUrl=i.UrlUtilities.resolveUrl(this._rootUrl,r)}if(t.children)for(var n=0,s=t.children;n<s.length;n++){var a=s[n];this._processItem(a)}return t},e.prototype._createMapService=function(e,t){return t.serviceUrl||(t.serviceUrl=e.url),!t.serviceUrl&&t.connectionString&&(t.serviceUrl=s.ServiceHelper.extractConnectionStringValue(t.connectionString,"url")),t.serviceUrl?a.ServiceDiscoveryUtilities.buildMapService(this._site.essentialsMap,t):r.SimplePromise.reject(new Error("SiteServiceDiscoveryProvider._createMapService: Cannot create map service, the service URL is required."))},e.prototype._verifySupported=function(){if(!this.supported)throw new Error("Service Discovery is not supported in the current version of Geocortex Essentials.")},e.prototype._verifyInitialized=function(){if(!this.initialized)throw new Error("The Service Discovery client is not initialized yet.")},e}();t.SiteServiceDiscoveryProvider=o})},"geocortex/essentials/utilities/DecomposedUri":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e){this.originalUri=e,this.schemeHostAndPath=e.match(/[^?|^#]*/)[0];var t=e.match(/\?([^#]*)/);this.query={},t&&t.length>1&&(this.query=dojo.queryToObject(t[1])),this.fragment=dojo.queryToObject(e.indexOf("#")>=0?e.substring(e.indexOf("#")+1,e.length):"")}return e.prototype.recompose=function(){var e=this.schemeHostAndPath;return this.query&&this.anyProperties(this.query)&&(e+="?"+dojo.objectToQuery(this.query)),this.fragment&&this.anyProperties(this.fragment)&&(e+="#"+dojo.objectToQuery(this.fragment)),e},e.prototype.anyProperties=function(e){for(var t in e)return!0;return!1},e.getHost=function(e){if(!e)return null;var t=e.match(/^http[s]?:\/\/([^\/]*)/);return t.length>1?t[1]:null},e.appendToPath=function(t,i){var r=new e(t);return r.schemeHostAndPath+=i,r.recompose()},e.removeQueryParameters=function(t){for(var i=[],r=1;r<arguments.length;r++)i[r-1]=arguments[r];for(var n=new e(t),s=0,a=i;s<a.length;s++){var o=a[s];delete n.query[o]}return n.recompose()},e}();t.DecomposedUri=i})},"geocortex/essentials/utilities/EncodeImageError":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/utilities/EncodeImageResult":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/utilities/ExifUtilities":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){}return e.getPointFromExif=function(t){if(!t||!dojo.isArray(t.GPSLatitude)||!dojo.isArray(t.GPSLongitude))return null;var i=e.dmsToDecimal(t.GPSLatitude),r=e.dmsToDecimal(t.GPSLongitude);return"S"===t.GPSLatitudeRef&&(i*=-1),"W"===t.GPSLongitudeRef&&(r*=-1),new esri.geometry.Point(r,i)},e.dmsToDecimal=function(e){return e.length>2?e[0]+e[1]/60+e[2]/3600:e.length>1?e[0]+e[1]/60:e[0]},e.getExifTagsFromImageBytes=function(t){if(0==t.byteLength)return{};var i=t.byteLength,r=new DataView(t);if(i<2||65496!=r.getUint16(0))return{};for(var n=2;n+4<i;n+=a+2){if(255!==r.getUint8(n))throw new Error("Expected start of a JPEG marker.");var s=r.getUint8(n+1),a=r.getUint16(n+2);if(n+a+2>i)throw new Error("Unexpected end of file.");if(225===s)return e.getExifTags(r,n+4,a-2)}return{}},e.base64ToArrayBuffer=function(e,t){t=t||e.match(/^data\:([^\;]+)\;base64,/im)[1]||"",e=e.replace(/^data\:([^\;]+)\;base64,/gim,"");for(var i=atob(e),r=i.length,n=new ArrayBuffer(r),s=new Uint8Array(n),a=0;a<r;a++)s[a]=i.charCodeAt(a);return n},e.getExifTags=function(t,i,r){if(r<6||1165519206!==t.getUint32(i)||0!==t.getUint16(i+4))throw new Error("EXIF header corrupted.");var n,s=t.getInt16(i+6);if(18761===s)n=!0;else{if(19789!==s)throw new Error("Unknown endian marker.");n=!1}if(42!==t.getUint16(i+8,n)){if(10752===t.getUint16(i+8,n))throw new Error("Endian marker test is backwards.");throw new Error("Endian marker test magic value is corrupted.")}var a,o=t.getUint32(i+10,n),l=e.readTags(t,i+6,i+6+o,e.TiffTags,n);if(l.ExifIFDPointer){var u=e.readTags(t,i+6,i+6+l.ExifIFDPointer,e.ExifTags,n);for(a in u)if(u.hasOwnProperty(a)){switch(a){case"ExifVersion":case"FlashpixVersion":u[a]=String.fromCharCode(u[a][0],u[a][1],u[a][2],u[a][3])}l[a]=u[a]}}if(l.GPSInfoIFDPointer){var c=e.readTags(t,i+6,i+6+l.GPSInfoIFDPointer,e.GPSTags,n);for(a in c)if(c.hasOwnProperty(a)){switch(a){case"GPSVersionID":c[a]=c[a][0]+"."+c[a][1]+"."+c[a][2]+"."+c[a][3]}l[a]=c[a]}}return l},e.readTags=function(t,i,r,n,s){for(var a={},o=t.getUint16(r,s),l=0;l<o;l++){var u=r+12*l+2,c=t.getUint16(u,s),p=n[c];p||(p=c.toString(16)),a[p]=e.readTagValue(t,u,i,r,s)}return a},e.readTagValue=function(t,i,r,n,s){var a,o,l,u,c,p=t.getUint16(i+2,s),h=t.getUint32(i+4,s),d=t.getUint32(i+8,s)+r;switch(p){case 1:case 7:if(1==h)return t.getUint8(i+8);for(a=h>4?d:i+8,o=[],l=0;l<h;l++)o[l]=t.getUint8(a+l);return o;case 2:return a=h>4?d:i+8,e.getStringFromBytes(t,a,h-1);case 3:if(1==h)return t.getUint16(i+8,s);for(a=h>2?d:i+8,o=[],l=0;l<h;l++)o[l]=t.getUint16(a+2*l,s);return o;case 4:if(1==h)return t.getUint32(i+8,s);for(o=[],l=0;l<h;l++)o[l]=t.getUint32(d+4*l,s);return o;case 5:if(1==h)return u=t.getUint32(d,s),c=t.getUint32(d+4,s),u/c;for(o=[],l=0;l<h;l++)u=t.getUint32(d+8*l,s),c=t.getUint32(d+4+8*l,s),o[l]=u/c;return o;case 9:if(1==h)return t.getInt32(i+8,s);for(o=[],l=0;l<h;l++)o[l]=t.getInt32(d+4*l,s);return o;case 10:if(1==h)return t.getInt32(d,s)/t.getInt32(d+4,s);for(o=[],l=0;l<h;l++)o[l]=t.getInt32(d+8*l,s)/t.getInt32(d+4+8*l,s);return o}return""},e.getStringFromBytes=function(e,t,i){for(var r="",n=t;n<t+i;n++)r+=String.fromCharCode(e.getUint8(n));return r},e}();i.ExifTags={36864:"ExifVersion",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37500:"MakerNote",37510:"UserComment",40964:"RelatedSoundFile",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBias",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37396:"SubjectArea",37386:"FocalLength",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRation",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",40965:"InteroperabilityIFDPointer",42016:"ImageUniqueID"},i.TiffTags={256:"ImageWidth",257:"ImageHeight",34665:"ExifIFDPointer",34853:"GPSInfoIFDPointer",40965:"InteroperabilityIFDPointer",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",274:"Orientation",277:"SamplesPerPixel",284:"PlanarConfiguration",530:"YCbCrSubSampling",531:"YCbCrPositioning",282:"XResolution",283:"YResolution",296:"ResolutionUnit",273:"StripOffsets",278:"RowsPerStrip",279:"StripByteCounts",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",301:"TransferFunction",318:"WhitePoint",319:"PrimaryChromaticities",529:"YCbCrCoefficients",532:"ReferenceBlackWhite",306:"DateTime",270:"ImageDescription",271:"Make",272:"Model",305:"Software",315:"Artist",33432:"Copyright"},i.GPSTags={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential"},t.ExifUtilities=i})},"geocortex/essentials/utilities/GraphicsLayerUtilities":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.excludeFromExportMapTaskName="ExportMapTask";var i={};t.getGraphicsLayerIdsToExclude=function(e){var t=[];return e.forEach(function(e){i[e]&&i[e].forEach(function(e){t.indexOf(e)<0&&t.push(e)})}),t},t.addToGraphicsLayerIdsToExclude=function(e,t){t&&t.length>0&&e.forEach(function(e){i[e]||(i[e]=[]),i[e].indexOf(t)<0&&i[e].push(t)})},t.removeFromGraphicsLayerIdsToExclude=function(e,t){t&&t.length>0&&e.forEach(function(e){if(i[e]){var r=i[e].indexOf(t);r>=0&&i[e].splice(r,1)}})}})},"geocortex/essentials/utilities/ImageUtilities":function(){define(["require","exports"],function(e,t){"use strict";function i(e,t,i,r){if(e<i&&t<r)return{width:e,height:t};var n=Math.min(i/e,r/t);return{width:e*n,height:t*n}}function r(t,i,r){return new Promise(function(s,a){e(["pica"],function(e){n(t).then(function(t){var n,a,o=document.createElement("canvas");o.width=i,o.height=r,((a=window.navigator.userAgent).indexOf("MSIE ")>0||a.indexOf("Trident/")>0)&&(n={features:["js"]}),e(n).resize(t,o,{alpha:!0}).then(function(e){return s(o.toDataURL("image/png"))})})})})}function n(e){return new Promise(function(t,i){if("string"==typeof e){var r=new Image;r.onload=function(){t(r)},r.src=e}else t(e)})}Object.defineProperty(t,"__esModule",{value:!0}),t.calculateAspectRatioFit=i,t.resizeImage=r,t.resizeImageToMaxDimensions=function(e,t,s){return n(e).then(function(e){var n=i(e.width,e.height,t,s);return r(e,n.width,n.height)}).then(function(e){return e})},t.getRawByteDataFromDataUri=function(e){return decodeURIComponent(e.substring(e.indexOf("base64,")+7))}})},"geocortex/essentials/utilities/LayerUtilities":function(){define(["require","exports","geocortex/framework/utils/utils"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){}return e.createFeatureLayerFromCsv=function(e,t){var r=new dojo.Deferred;if(!e)return r.resolve(null),r;var n=new dojox.data.CsvStore({url:e.url,separator:e.columnDelimiter||","});return n.fetch({onComplete:function(s,a){var o,l,u=0,c=e.layerDefinition,p={layerDefinition:c,featureSet:{features:[],geometryType:"esriGeometryPoint"}},h=null,d=null;t&&(h=t.lowerBound||0,d=t.upperBound||s.length),(h||d)&&(s=s.slice(h,d)),dojo.forEach(s,function(t,i){0===i&&e.locationInfo&&(o=e.locationInfo.latitudeFieldName,l=e.locationInfo.longitudeFieldName),n.getIdentity(t);var r=n.getAttributes(t),s={};dojo.forEach(r,function(e){var i=Number(n.getValue(t,e));isNaN(i)?s[e]=n.getValue(t,e):s[e]=i}),s.__OBJECTID=u,u++;var a=parseFloat(s[o]),c=parseFloat(s[l]);if(!isNaN(a)&&!isNaN(c)){var h={geometry:new esri.geometry.Point(c,a).toJson(),attributes:s};p.featureSet.features.push(h)}});var f=new esri.layers.FeatureLayer(p),y=null;c&&c.drawingInfo&&c.drawingInfo.renderer&&c.drawingInfo.renderer.symbol&&"esriPMS"===c.drawingInfo.renderer.symbol.type&&(y=c.drawingInfo.renderer.symbol),null!=y&&(f.renderer.symbol.imageData=y.imageData,f.renderer.symbol.url=y.url),e.title&&(f.name=e.title),f.layerId=e.id||i.alphaNumericToken(),r.resolve(f)}}),r},e.decomposeFeatureLayerUrl=function(e){var t=/(.+?)\/([0-9]*)(\?.*)?$/g.exec(e);return{serviceUrl:t[1],layerId:parseInt(t[2]),queryString:t[3]}},e}();t.LayerUtilities=r})},"geocortex/essentials/utilities/PrintUtilities":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){}return e.adjustTextSymbol=function(e,t){if(e&&e.symbol instanceof esri.symbol.TextSymbol){var i=function(e,t){t.font.size=void 0!=e.font.size&&"number"==typeof e.font.size?Math.round(e.font.size)+"px":e.font.size,t.x=e.x,t.y=e.y,t.xoffset=e.xoffset,t.yoffset=e.yoffset,t.align=e.align,t.angle=e.angle,t.color.hasOwnProperty("a")&&(t.color.a=e.color.a>=0&&e.color.a<=1?255*e.color.a:e.color.a)},r=new esri.symbol.TextSymbol(e.symbol.toJson());if(r.color=new esri.Color({r:e.symbol.color.r,g:e.symbol.color.g,b:e.symbol.color.b,a:e.symbol.color.a}),i(e.symbol,r),r.toJson&&"function"==typeof r.toJson){var n=r.toJson;r.toJson=function(){var e=n.call(r);return i(r,e),e}}var s=null,a=null;if(t){var o=document.getElementById(t+"_layer"),l=null;(l=document.createElementNS("http://www.w3.org/2000/svg","text")).setAttributeNS(null,"font-size",r.font.size.toString()),l.setAttributeNS(null,"font-family",r.font.family),l.setAttributeNS(null,"visibility","hidden"),l.textContent=r.text,o.appendChild(l);var u=l.getBBox();a=null===a?u.height:a,s=null===s?l.getComputedTextLength():s,o.removeChild(l)}else{var c=document.body,p=document.createElement("div"),h={fontFamily:r.font.family,fontSize:r.font.size,fontWeight:r.font.weight,padding:"0",position:"absolute",lineHeight:"1",visibility:"hidden"};for(var d in h)p.style[d]=h[d];p.appendChild(document.createTextNode(r.text)),c.appendChild(p),s=p.clientWidth,a=p.clientHeight,c.removeChild(p)}if(r.xoffset=0===r.angle?r.xoffset:0,r.yoffset=0===r.angle?r.yoffset:0,(e.measurementId||e.coordinateId)&&e.attributes&&e.attributes.numberOfLines){if(e.measurementId?r.xoffset=-(s/2+a/4):r.xoffset=-(s/4+a/2),r.yoffset=e.attributes.numberOfLines&&1==e.attributes.numberOfLines?a/2:r.yoffset,"start"==r.verticalAlignment&&e.attributes.numberOfLines&&e.attributes.numberOfLines>1){var f=e.attributes.numberOfLines;r.yoffset=r.yoffset-.5*a/2+a*f/2}}else{switch(r.verticalAlignment){case"top":break;case"middle":r.yoffset+=a/2;break;default:r.yoffset+=.75*a}e.attributes&&e.attributes.customVerticalAlignment&&"middle"===e.attributes.customVerticalAlignment&&(r.xoffset=0,r.yoffset=0,r.yoffset+=Math.ceil(a/2));var y=r.horizontalAlignment||r.align||null;if(y)switch(y){case esri.symbol.TextSymbol.ALIGN_MIDDLE:case"center":case"justify":r.xoffset-=Math.ceil(s/2),e.coordinateId||(r.xoffset-=Math.ceil(a/4));break;case esri.symbol.TextSymbol.ALIGN_END:case"right":r.xoffset-=s}}return r}return null},e.adjustPictureMarkerSymbol=function(e){if(e&&e.symbol instanceof esri.symbol.PictureMarkerSymbol){var t=new esri.symbol.PictureMarkerSymbol(e.symbol.toJson());if(t.toJson&&"function"==typeof t.toJson){var i=t.toJson;t.toJson=function(){var e,r,n=i.call(t);return n.color=[0,0,0,255],isNaN(e=parseInt(t.width,10))||isNaN(r=parseInt(t.height,10))||(n.width=e,n.height=r,n.xoffset=isNaN(parseInt(n.xoffset))?e/2:n.xoffset+e/2,n.yoffset=isNaN(parseInt(n.yoffset))?r/2:n.yoffset-r/2),n}}return t}return null},e.getImageAsBase64=function(e,t){void 0===t&&(t="image/png");var i=new dojo.Deferred,r=document.createElement("canvas"),n=r.getContext("2d"),s=new Image;return s.onload=function(){r.height=s.height,r.width=s.width,n.drawImage(s,0,0);try{var a=r.toDataURL(t);i.resolve({url:e,data:a.replace(/^data:image\/(png|jpg);base64,/,"")})}catch(t){i.reject({url:e,error:t})}},s.onerror=function(t){i.reject({url:e,error:new Error("Failed to download image.")})},s.src=e,i},e}();t.PrintUtilities=i})},"geocortex/essentials/utilities/PromiseUtilities":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){this.state={fulfilled:!1,rejected:!1}}return e.prototype.fulfill=function(e){this.state.fulfilled=!0,this.state.value=e},e.prototype.reject=function(e){this.state.rejected=!0,this.state.reason=e},e.prototype.isFulfilled=function(){return this.state.fulfilled},e.prototype.isRejected=function(){return this.state.rejected},e.prototype.isPending=function(){return!this.state.fulfilled&&!this.state.rejected},e.prototype.value=function(){return this.state.value},e.prototype.reason=function(){return this.state.reason},e}(),r=function(){function e(){}return e.settle=function(t){if(dojo.isArray(t))return e._settleImpl(t);if(t.then)return t.then(function(t){return e._settleImpl(t)});throw new Error("Unknown parameter type.  Must be an array of promises or a promise of array of promises.")},e._settleImpl=function(e){var t,r=new dojo.Deferred,n=e.map(function(e){var r=new i;return e&&"function"==typeof e.then?e.then(function(e){r.fulfill(e),t&&t()},function(e){r.reject(e),t&&t()}):r.fulfill(e),r});return(t=function(){n.every(function(e){return!e.isPending()})&&r.resolve(n)})(),r.promise},e}();t.PromiseUtilities=r})},"geocortex/essentials/utilities/ServiceDiscoveryUtilities":function(){define(["require","exports","./../MapService","./../FeatureLayerService","./../WFSLayerService","./../StreamLayerService","./../MapServiceConstants","geocortex/framework/SimplePromise","geocortex/framework/utils/utils"],function(e,t,i,r,n,s,a,o,l){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(){}return e.buildMapService=function(e,t){return new o.SimplePromise(function(o,u){if(!e)throw new Error('ServiceDiscoveryUtilities.buildMapService: Parameter "essentialsMap" is required.');if(!t)throw new Error('ServiceDiscoveryUtilities.buildMapService: Parameter "serviceDefinition" is required.');var c,p,h,d={id:l.alphaNumericToken(),connectionString:t.serviceUrl?"url="+t.serviceUrl:void 0},f=dojo.mixin(d,t);if(f.drawingBehavior===a.DrawingBehavior.FEATURE_LAYER){if(!dojo.isObject(esri.layers.FeatureLayer))throw new Error("This Javascript application must require the esri.layers.FeatureLayer package in order to use a site with feature layers");c=new r.FeatureLayerService}else if(f.drawingBehavior===a.DrawingBehavior.GEORSS_LAYER){if(!dojo.isObject(esri.layers.GraphicsLayer))throw new Error("This Javascript application must require the esri.layers.GraphicsLayer package in order to use a site with GeoRSS layers");c=new geocortex.essentials.GeoRssLayerService}else if(f.drawingBehavior===a.DrawingBehavior.KML_SERVICE){if(!dojo.isObject(esri.layers.KMLLayer))throw new Error("This Javascript application must require the esri.layers.KMLLayer package in order to use a site with KML layers");c=new geocortex.essentials.KmlService}else if(f.drawingBehavior===a.DrawingBehavior.WFS_LAYER){if(!dojo.isObject(esri.layers.WFSLayer))throw new Error("This Javascript application must require the esri.layers.WFSLayer package in order to use a site with feature WFS layers");c=new n.WFSLayerService}else if(f.drawingBehavior===a.DrawingBehavior.STREAM_LAYER){if(!dojo.isObject(esri.layers.StreamLayer))throw new Error("This Javascript application must require the esri.layers.StreamLayer package in order to use a site with Stream layers");var y=f.layers[0];y&&f.displayName&&(y.displayName=f.displayName),c=new s.StreamLayerService}else c=new i.MapService;c.isUserCreated=!0,c.userLayerType=a.UserLayerType.LAYER_ADDITION,c.essentialsMap=e,c.initialize(f),c instanceof r.FeatureLayerService&&(c.moveEnabled=!0,c.rotateEnabled=!0,c.editVerticesEnabled=!0,c.scaleEnabled=!0);for(var m=0,v=c.layers;m<v.length;m++){var g=v[m];if(g.isUserCreated=!0,g.userLayerType=a.UserLayerType.LAYER_ADDITION,g.includeInLayerList=!0,g.includeInLegend=!0,g.site=e.site,g.configuredVisible=!0,c.supportsLayerVisibility()?g.setVisibility(!0):g._visible=!0,g.subLayerIds&&g.subLayerIds.length>0)g.supportsIdentify=g.supportsQuery=g.identifiable=g.queryable=!1;else{g.identifiable=g.supportsIdentify,g.queryable=g.supportsQuery,g.searchable=!0,g.showMapTips=!0,(c instanceof s.StreamLayerService||c instanceof n.WFSLayerService)&&(g.identifiable=g.supportsIdentify=!0,g.queryable=g.supportsQuery=!1);var _=c.serviceLayer,S=_ instanceof esri.layers.GraphicsLayer||_ instanceof esri.layers.ArcGISDynamicMapServiceLayer;g.snappable=S,g.snappingEnabled=S}}if(c.serviceLayer.loaded)return o(c);p=c.serviceLayer.on("load",function(e){return p&&p.remove(),h&&h.remove(),o(c)}),h=c.serviceLayer.on("error",function(e){return p&&p.remove(),h&&h.remove(),u(e.error)})})},e}();t.ServiceDiscoveryUtilities=u})},"geocortex/essentials/utilities/SiteResourceIdComparer":function(){define(["require","exports","./StringUtilities"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){}return e.equals=function(e,t){return!(!e||!t||e!==t&&!i.StringUtilities.endsWith(e,this.separator+t))},e.lookUp=function(e,t){if(e&&t){var r=0,n=null;for(r=0;r<e.length;++r)if((n=e[r]).id===t)return n;for(r=0;r<e.length;++r)if(n=e[r],i.StringUtilities.endsWith(n.id,this.separator+t))return n}return null},e}();r.separator="-",t.SiteResourceIdComparer=r})},"geocortex/essentials/utilities/StringUtilities":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){}return e.endsWith=function(e,t){return-1!==e.indexOf(t,e.length-t.length)},e.replaceLayerTokens=function(e,t){if(t)switch(e.toLowerCase()){case"layerid":return t.id;case"layername":return t.name;case"layerdisplayname":return t.displayName;case"layerdescription":return t.description}return""},e.replaceMapServicetokens=function(e,t){if(t)switch(e.toLowerCase()){case"mapserviceid":return t.id;case"mapservicedisplayname":return t.displayName;case"mapserviceurl":return t.url;case"mapservicetoken":return t.serviceToken}return""},e.getDateFromRestDateString=function(e){if(!(e=e.trim())||!/^\/Date\(-?\d+\)\/$/.test(e))return null;var t=e.substring(e.indexOf("(")+1,e.indexOf(")"));return isNaN(t)?null:new Date(parseInt(t,10))},e}();t.StringUtilities=i,"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(e){return i.endsWith(this,e)})})},"geocortex/essentials/utilities/Thenable":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/essentials/utilities/UrlUtilities":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){}return e.simplify=function(e){var t=document.createElement("a");t.href=e;var i=t.href,r=i.charAt(i.length-1);return"/"!==r&&"\\"!==r||(i=i.substr(0,i.length-1)),i},e.getUrlComponents=function(e){var t=document.createElement("a");return t.href=e,{host:t.host,hostname:t.hostname,protocol:t.protocol,port:t.port,query:t.search,hash:t.hash,path:t.pathname,origin:t.protocol+"//"+t.host}},e.resolveUrl=function(t,i,r){void 0===r&&(r=!1);var n=t+(t.endsWith("/")?"":"/")+i;return r&&(n=e.simplify(n)),n},e}();t.UrlUtilities=i})}}})}(),require({cache:{"geocortex/essentials":function(){}}}),require({cache:{"geocortex/forms":function(){define(["require","exports"],function(e,t){"use strict";function i(e,t){var i=e.getElementsByTagName(t);if(i.length>=1){for(n=0;n<i.length;n++)if(i[n].parentNode===e)return i[n]}else if(e.childNodes.length>0){var r=e.childNodes[0].prefix;if(""!=r&&(i=e.getElementsByTagName(r+":"+t)).length>=1)for(var n=0;n<i.length;n++)if(i[n].parentNode===e)return i[n]}return null}Object.defineProperty(t,"__esModule",{value:!0}),t.getElement=i,t.getElementText=function(e,t){var r=i(e,t);return r?dojox.xml.parser.textContent(r):null},t.getAttributeValue=function(e,t){if(null!=e)for(var i=0;i<e.attributes.length;i++)if(e.attributes[i].name==t)return e.attributes[i].value;return null},t._parseBoolean=function(e){if(null!=e)switch(e.toLowerCase()){case"true":case"yes":case"1":return!0;case"false":case"no":case"0":case null:return!1;default:return Boolean(e)}return!1},t.renderFormItem=function(e){return geocortex.forms.renderFormItem(e)}})},"geocortex/forms/DataItem":function(){define(["require","exports","./../workflow/WorkflowControllerProxy"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t,i){this.display=e,this.value=t,this.typeName=i}return e.prototype.getValue=function(){var e=this.value;return null!=this.typeName&&(e=i._getObjectFromJsonWithType(e,this.typeName)),null!=this.value&&void 0!==this.value.__type&&delete e.__type,e},e}();t.DataItem=r})},"geocortex/forms/FileItem":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){this.fileName=null,this.fileDataBase64=null,this.fileSize=0,this.fileType=null}return e.prototype.getDataUri=function(){return"data:"+this.fileType+";base64,"+this.fileDataBase64},e}();t.FileItem=i})},"geocortex/forms/FormButton":function(){define(["require","exports","geocortex/framework/observables"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(e,t,r,n){this.label=new i.Observable(e),this.value=new i.Observable(t),this.isDefault=new i.Observable(n||!1),this.causesValidation=new i.Observable(r)};t.FormButton=r})},"geocortex/forms/FormDefinition":function(){define(["require","exports","geocortex/framework/observables","./../forms","./items/ContainerFormItem","./items"],function(e,t,i,r,n,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t,a){this.version=null,this.inputData=null,this.containerFormItem=null,this.inputGeometry=null,this.knownTypes=null,this._formManager=null,this._version=1.1,this._formContainer=null,this._cascadingMap=null,this._controlMap=null,this.knownTypes=[],this.inputData=t,this.version=this._version,this._controlMap={},this._cascadingMap={},this.createElementDelegate=function(e,t){return s._processFormItem(e,t)};var o=null;if(e&&(o=dojox.xml.parser.parse(e)),a&&(this.inputGeometry=a),null!=o){var l=o.documentElement,u=r.getElementText(l,"Version");if(parseFloat(u)>this._version)throw new Error("Form version "+u+" is incompatible with current API version "+this._version);this.title=new i.Observable(r.getElementText(l,"Title")),this.maxWidth=new i.Observable(parseInt(r.getElementText(l,"MaxWidth"))),this.maxHeight=new i.Observable(parseInt(r.getElementText(l,"MaxHeight")));var c=r.getElement(l,"KnownTypes");if(null!=c)for(h=0;h<c.childNodes.length;h++)this.knownTypes.push(c.childNodes[h].firstChild.data);this.containerFormItem=new n.ContainerFormItem(r.getElement(l,"ContainerFormItem"),this)}else this.containerFormItem=new n.ContainerFormItem(null,this),this.containerFormItem.itemID=new i.Observable("Group1"),this.title=new i.Observable(""),this.maxWidth=new i.Observable(NaN),this.maxHeight=new i.Observable(NaN);for(var p in this._cascadingMap)if(this._cascadingMap.hasOwnProperty(p))for(var h=0;h<this._cascadingMap[p].length;++h){var d=this._cascadingMap[p][h];this._controlMap[p].queryTaskRunner.cascadingEvent.subscribe(d.formItem,d.handler)}}return e.prototype.addCascading=function(e,t,i){0==this._cascadingMap.hasOwnProperty(e)&&(this._cascadingMap[e]=[]),this._cascadingMap[e].push({formItem:t,handler:i})},e.prototype.map=function(e){this._controlMap[e.itemID.get()]=e},e.prototype.render=function(e){},e.prototype.validate=function(){return this.containerFormItem.validate()},e.prototype.getResults=function(){return this.containerFormItem._getResults()},e.prototype.destroy=function(){this.containerFormItem._destroy()},e.prototype.getFormItemById=function(e){return this.containerFormItem.getFormItemById(e)},e}();t.FormDefinition=a})},"geocortex/forms/getItemType":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getItemType=function(e){var t="";if(null!=e&&null!=e.attributes)for(var i=0;i<e.attributes.length;i++)if(String(e.attributes[i].nodeName).indexOf("type")>=0){var r=e.attributes[i].nodeValue,n=r.indexOf(":");n>=0&&n+1<r.length&&(r=r.substr(n+1)),t=r;break}return t}})},"geocortex/forms/items":function(){define(["require","exports","./getItemType","./items/AutoCompleteBoxFormItem","./items/CheckBoxFormItem","./items/ContainerFormItem","./items/ComboBoxFormItem","./items/DatePickerFormItem","./items/FilePickerFormItem","./items/GroupBoxFormItem","./items/HyperlinkFormItem","./items/ImageFormItem","./items/ListBoxFormItem","./items/MarkdownFormItem","./items/RadioButtonFormItem","./items/TextAreaFormItem","./items/TextBoxFormItem","./items/TimePickerFormItem"],function(e,t,i,r,n,s,a,o,l,u,c,p,h,d,f,y,m,v){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t._processFormItem=function e(t,g){var _=null;switch(i.getItemType(t)){case"AutoCompleteBoxFormItem":_=new r.AutoCompleteBoxFormItem(t,g);break;case"CheckBoxFormItem":_=new n.CheckBoxFormItem(t,g);break;case"ContainerFormItem":(_=new s.ContainerFormItem(t,g)).createElementDelegate=function(t,i){return e(t,i)};break;case"ComboBoxFormItem":_=new a.ComboBoxFormItem(t,g);break;case"DatePickerFormItem":_=new o.DatePickerFormItem(t,g);break;case"FilePickerFormItem":_=new l.FilePickerFormItem(t,g);break;case"GroupBoxFormItem":_=new u.GroupBoxFormItem(t,g);break;case"HyperlinkFormItem":_=new c.HyperlinkFormItem(t,g);break;case"ImageFormItem":_=new p.ImageFormItem(t,g);break;case"ListBoxFormItem":_=new h.ListBoxFormItem(t,g);break;case"MarkdownFormItem":_=new d.MarkdownFormItem(t,g);break;case"RadioButtonFormItem":_=new f.RadioButtonFormItem(t,g);break;case"TextAreaFormItem":_=new y.TextAreaFormItem(t,g);break;case"TextBoxFormItem":_=new m.TextBoxFormItem(t,g);break;case"TimePickerFormItem":_=new v.TimePickerFormItem(t,g)}return _.dataItems&&null!=g&&null!=g.inputData&&g.inputData.hasOwnProperty(_.itemID)&&_.dataItems.addItems(g.inputData.item(_.itemID)),_}})},"geocortex/forms/items/AutoCompleteBoxFormItem":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./TextBoxFormItem","./QueryTaskFormItem","geocortex/framework/observables","./../../forms","./DataItemsFormItem"],function(e,i,r,n,s,a,o){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var l=function(e){function i(t,i){var r=e.call(this,t,i)||this;return r.isBusy=new s.Observable(!1),r.formItemType="AutoCompleteBoxFormItem",t?(r.minimumPrefixLength=new s.Observable(parseInt(a.getElementText(t,"MinimumPrefixLength"))),r.minimumPopulateDelay=new s.Observable(parseInt(a.getElementText(t,"MinimumPopulateDelay")))):(r.minimumPrefixLength=new s.Observable(3),r.minimumPopulateDelay=new s.Observable(200)),o.initDataItemsFormItem(r,t,i),r.queryTaskRunner=new n.QueryTaskRunner(r,t,i),r}return t(i,e),i.prototype.clearDataItems=function(){this.dataItems.clear()},i}(r.TextBoxFormItem);i.AutoCompleteBoxFormItem=l})},"geocortex/forms/items/CheckBoxFormItem":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./FormItem","geocortex/framework/observables","./../../forms","./FormItemResult"],function(e,i,r,n,s,a){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var o=function(e){function i(t,i){var r=e.call(this,t,i)||this;return r.formItemType="CheckBoxFormItem",t?(r.text=new n.Observable(s.getElementText(t,"Text")),r.checked=new n.Observable(s._parseBoolean(s.getElementText(t,"Checked"))),r.textLocation=new n.Observable(s.getElementText(t,"TextLocation"))):(r.text=new n.Observable(""),r.checked=new n.Observable(!1),r.textLocation=new n.Observable("Right")),r.checked.bind(null,function(e){return r._notifyResultChanged()}),r}return t(i,e),i.prototype.getResult=function(){return new a.FormItemResult(this.argumentName.get(),this.checked.get())},i.prototype._render=function(){return s.renderFormItem(this)},i}(r.AbstractFormItem);i.CheckBoxFormItem=o})},"geocortex/forms/items/ComboBoxFormItem":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./FormItem","./LabelContainer","./QueryTaskFormItem","geocortex/framework/observables","./../DataItem","./DataItemsFormItem","./../../forms","./FormItemResult"],function(e,i,r,n,s,a,o,l,u,c){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var p=function(e){function i(t,i){var r=e.call(this,t,i)||this;if(r._defaultSet=!1,r.selectText=new a.Observable,r.selected=new a.Observable,r.defaultSelectedValue=new a.Observable,r.isBusy=new a.Observable(!1),r.formItemType="ComboBoxFormItem",n.initLabelContainer(r,t,i),l.initDataItemsFormItem(r,t,i),r.queryTaskRunner=new s.QueryTaskRunner(r,t,i),t){var o=u.getElementText(t,"SelectText");o&&r.selectText.set(o);var c=u.getElementText(t,"SelectedValue");c&&r.defaultSelectedValue.set(c)}r.selected.bind(null,function(e){return r._notifyResultChanged()}),r.prepareForResults(),r.queryTaskRunner.isQueryable()||r._selectDefaultValue();var p=r.queryTaskRunner.queryCascadingID.get();return null!=p&&""!=p||r.queryTaskRunner.performQuery(""),r}return t(i,e),i.prototype.clearDataItems=function(){this.dataItems.clear(),this.selected.set(null),this._defaultSet=!1},i.prototype._hasRealDataItem=function(){return null!=this.selected.get()},i.prototype.triggerCascading=function(e){null!=this.selected.get()&&e||this.queryTaskRunner.cascadingEvent.publish(null);var t=this.selected.get();null===t&&(t=e),null===t||void 0===t?this.queryTaskRunner.cascadingEvent.publish(null):this.queryTaskRunner.cascadingEvent.publish(t.value)},i.prototype.prepareForResults=function(){if(this.selectText.get()){var e=this.selectText.get(),t=new o.DataItem(e,"",null);this.dataItems.insertItem(0,t)}},i.prototype.handleResultsComplete=function(){this._defaultSet||(this._selectDefaultValue(),null!=this.selected.get()&&(this._defaultSet=!0,this.triggerCascading(this.selected.get())))},i.prototype.getResult=function(){if(null==this.selected.get())return new c.FormItemResult(this.argumentName.get(),null);var e=this.selected.get();return e?new c.FormItemResult(this.argumentName.get(),e.getValue()):new c.FormItemResult(this.argumentName.get(),null)},i.prototype._addOption=function(e,t){this.dataItems.addItem(new o.DataItem(e,t))},i.prototype._selectDefaultValue=function(){var e=dojo.filter(this.dataItems.getItems(),dojo.hitch(this,function(e){return!!this.defaultSelectedValue.get()&&e.value+""==this.defaultSelectedValue.get()+""}));e.length>0?this.selected.set(e[0]):this.dataItems.length()>0&&this.selected.set(this.dataItems.getAt(0))},i.prototype._render=function(){return u.renderFormItem(this)},i}(r.AbstractFormItem);i.ComboBoxFormItem=p})},"geocortex/forms/items/ContainerFormItem":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./FormItem","geocortex/framework/observables","./../../forms"],function(e,i,r,n,s){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var a=function(e){function i(t,i){var r=e.call(this,t,i)||this;if(r.formItems=new n.ObservableCollection,r.formItemType="ContainerFormItem",r.createElementDelegate=function(e,t){return i.createElementDelegate(e,t)},t){r.orientation=new n.Observable(s.getElementText(t,"Orientation")),r.description=new n.Observable(s.getElementText(t,"Description")),r.maxWidth=new n.Observable(parseInt(s.getElementText(t,"MaxWidth"))),r.visibleControlID=new n.Observable(s.getElementText(t,"VisibleControlID")),r.visibleControlValue=new n.Observable(s.getElementText(t,"VisibleControlValue"));var a=s.getElement(t,"FormItems");if(null!=a)for(var o=0;o<a.childNodes.length;o++){var l=i.createElementDelegate(a.childNodes[o],r.formDefinition);null!=l&&(r.formItems.addItem(l),l.refresh=function(){var e=r.formItems.indexOf(r);e>=0&&(r.formItems.removeAt(e),r.formItems.insertItem(e,r))})}}else r.orientation=new n.Observable("Vertical"),r.description=new n.Observable(""),r.maxWidth=new n.Observable(NaN),r.visibleControlID=new n.Observable(""),r.visibleControlValue=new n.Observable("");return r}return t(i,e),i.prototype.validate=function(){var e=[];if(this.isVisible.get()&&null!=this.formItems)for(var t=0;t<this.formItems.getLength();++t){var i=this.formItems.getAt(t);if(i.isVisible.get())for(var r=i.validate(),n=0;n<r.length;++n)e.push(r[n])}return e},i.prototype._getResults=function(){for(var e=[],t=0;t<this.formItems.getLength();++t){var r=this.formItems.getAt(t);if(r.isVisible.get())if(r instanceof i){var n=r._getResults();if(null!=n)for(var s=0;s<n.length;++s)e.push(n[s])}else{var a=r.getResult();null!=a&&e.push(a)}}return e},i.prototype._destroy=function(){for(var e=this.formItems.length()-1;e>=0;e--)this.formItems.getAt(e)._destroy();this.formItems.clear()},i.prototype._render=function(){return s.renderFormItem(this)},i.prototype.getFormItemById=function(e){for(var t=0,i=this.formItems.length();t<i;t++){var r=this.formItems.getAt(t);if(r.itemID.get()===e)return r;if(r.getFormItemById&&(r=r.getFormItemById(e)))return r}return null},i.prototype.applyVisibility=function(e){if(e){var t=!1,i=e.getResult();if(null!==i&&null!==i.value){var r=this.visibleControlValue.get();if(r)if(i.isList){var n=i.value;if(n)for(var s=0;s<n.length;s++)if(n[s].toString()===r){t=!0;break}}else t=!0===i.value||!1===i.value?i.value.toString().toUpperCase()===r.toUpperCase():i.value.toString()===r;else 1==i.value&&(t=!0)}this.isVisible.set(t)}},i.prototype.getDisplayName=function(){return null},i}(r.AbstractFormItem);i.ContainerFormItem=a})},"geocortex/forms/items/DataItemsFormItem":function(){define(["require","exports","geocortex/framework/observables","./../DataItem","./../../forms"],function(e,t,i,r,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.initDataItemsFormItem=function(e,t,s){if(e.dataItems=new i.ObservableCollection,t){var a=n.getElement(t,"DataItems");if(null!=a)for(var o=0;o<a.childNodes.length;o++){var l=a.childNodes[o],u=new r.DataItem(n.getElementText(l,"Display"),n.getElementText(l,"Value"),n.getElementText(l,"TypeName"));null!=u&&e.dataItems.addItem(u)}}if(s){var c=s.inputData;if(c&&c.hasOwnProperty(e.itemID.get())){var p=c[e.itemID.get()];e.dataItems.addItems(p)}}}})},"geocortex/forms/items/DatePickerFormItem":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./FormItem","./LabelContainer","geocortex/framework/observables","./TimePickerFormItem","./../../forms","geocortex/framework/utils/DateUtils","./FormItemResult"],function(e,i,r,n,s,a,o,l,u){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var c=function(e){function i(t,i){var r=e.call(this,t,i)||this;r.nullable=new s.Observable(!1),r.formItemType="DatePickerFormItem",n.initLabelContainer(r,t,i);var u=!0;if(t){for(var c=!0,p=t.getElementsByTagNameNS?t.getElementsByTagNameNS("http://schemas.datacontract.org/2004/07/Geocortex.Forms.Client.Items.Validation","ValidationItem"):t.getElementsByTagName("ValidationItem"),h=0;h<p.length;h++){var d=p[h].getAttributeNS("http://www.w3.org/2001/XMLSchema-instance","type");if(d&&d.indexOf("RequiredValidationItem")>=0){c=!1;break}}r.nullable.set(c),r.dateFormat=new s.Observable(o.getElementText(t,"DateFormat")),r.includeTimePicker=new s.Observable("true"===o.getElementText(t,"IncludeTimePicker"));var f=null;r.includeTimePicker.get()&&(r.timePickerItem=new a.TimePickerFormItem(o.getElement(t,"TimePickerItem")),f=r.timePickerItem.initialTime.get());var y=o.getElementText(t,"InitialDate");if(u=null===o.getElementText(t,"InitializeWithCurrentDate")?!y:"true"===o.getElementText(t,"InitializeWithCurrentDate"),y){if(l.containsTimezone(y)){var m=Math.max(y.lastIndexOf("Z"),y.lastIndexOf("+"),y.lastIndexOf("-"));m>0&&(y=y.substring(0,m))}y+=l.getTimezoneString()}var v=null;(u||y)&&(v=new Date(y)),v&&!isNaN(v.getTime())?(v.getTimezoneOffset()!=l.getTimezoneOffset()&&v.setTime(v.getTime()-6e4*(l.getTimezoneOffset()-v.getTimezoneOffset())),f&&(v.setHours(f.getHours()),v.setMinutes(f.getMinutes()),v.setSeconds(f.getSeconds())),r.initialDate=new s.Observable(v)):r.initialDate=new s.Observable(f)}else r.dateFormat=new s.Observable,r.initialDate=new s.Observable(null),r.includeTimePicker=new s.Observable(!1);if(u){var g=new Date;r.includeTimePicker.get()||(g.setHours(0),g.setMinutes(0),g.setSeconds(0)),r.date=new s.Observable(g),r.initialDate.set(g)}else r.date=new s.Observable(r.initialDate.get());return r.date.bind(null,function(e){return r._notifyResultChanged()}),r}return t(i,e),i.prototype.getResult=function(){var e=this.date.get(),t=null===e?null:new Date(e.toString());if(t)if(isNaN(t.getTime()))t=this.initialDate.get();else{var i=0,r=!this.attached_pickerType||!this.attached_pickerType.get||this.attached_pickerType.get().toLowerCase().indexOf("native")>-1;e instanceof Date||this.includeTimePicker.get()||!r||(i=6e4*t.getTimezoneOffset()),t="/Date({0})/".format(t.getTime()+i)}return new u.FormItemResult(this.argumentName.get(),t)},i.prototype._render=function(){return o.renderFormItem(this)},i}(r.AbstractFormItem);i.DatePickerFormItem=c})},"geocortex/forms/items/FilePickerFormItem":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./FormItem","./LabelContainer","geocortex/framework/observables","./../../forms","./FormItemResult","./../../workflow/ArgumentValueWrapper"],function(e,i,r,n,s,a,o,l){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var u=function(e){function i(t,i){var r=e.call(this,t,i)||this;return r.files=new s.ObservableCollection,r.formItemType="FilePickerFormItem",r.isSupported=new s.Observable("undefined"!=typeof FileReader&&r._isFileInputSupported()),t?(r.acceptFileTypes=new s.Observable(a.getElementText(t,"AcceptFileTypes")),r.allowMultiple=new s.Observable(a._parseBoolean(a.getElementText(t,"AllowMultiple")))):(r.acceptFileTypes=new s.Observable(null),r.allowMultiple=new s.Observable(!1)),n.initLabelContainer(r,t,i),r.files.bind(null,function(e){return r._notifyResultChanged()}),r}return t(i,e),i.prototype.clear=function(){this.files.clear(),this.refresh()},i.prototype.getResult=function(){for(var e=[],t=0;t<this.files.getLength();++t){var i=this.files.getAt(t);i&&e.push(i)}var r=new l.ArgumentValueWrapper("System.Collections.Generic.List`1[[Geocortex.Forms.Client.FileItem, Geocortex.EssentialsWpfApi]]",e),n=new o.FormItemResult(this.argumentName.get(),r,!0);return n.isList=!0,n},i.prototype._render=function(){return a.renderFormItem(this)},i.prototype._isFileInputSupported=function(){if(navigator.userAgent.match(/(Android (1.0|1.1|1.5|1.6|2.0|2.1))|(Windows Phone (OS 7|8.0))|(XBLWP)|(ZuneWP)|(w(eb)?OSBrowser)|(webOS)|(Kindle\/(1.0|2.0|2.5|3.0))/))return!1;var e=document.createElement("input");return e.type="file",!e.disabled},i}(r.AbstractFormItem);i.FilePickerFormItem=u})},"geocortex/forms/items/FormItem":function(){define(["require","exports","geocortex/framework/observables","./../../forms","./../getItemType","./validation/NumericRangeValidationItem","./validation/RequiredValidationItem","./validation/RegexValidationItem","./validation/FileSizeValidationItem"],function(e,t,i,r,n,s,a,o,l){"use strict";function u(e){var t=null;switch(n.getItemType(e)){case"NumericRangeValidationItem":t=new s.NumericRangeValidationItem(e);break;case"RequiredValidationItem":t=new a.RequiredValidationItem(e);break;case"RegexValidationItem":t=new o.RegexValidationItem(e);break;case"FileSizeValidationItem":t=new l.FileSizeValidationItem(e)}return t}Object.defineProperty(t,"__esModule",{value:!0});var c=function(){function e(e,t){if(this.isRequired=new i.Observable(!1),this.isValid=new i.Observable(!0),this.isVisible=new i.Observable(!0),this.argumentName=null,this.validationItems=[],this.formDefinition=t||null,this.attached_indicatorClass=new i.Observable(""),this.attached_showIndicator=new i.Observable(""),e){this.toolTip=new i.Observable(r.getElementText(e,"ToolTip")),this.itemID=new i.Observable(r.getElementText(e,"ItemID")),this.argumentName=new i.Observable(r.getElementText(e,"ArgumentName"));var n=r.getElementText(e,"IsVisible");n&&this.isVisible.set(r._parseBoolean(n));var s=r.getElement(e,"ValidationItems");if(null!=s)for(var a=0;a<s.childNodes.length;a++){var o=u(s.childNodes[a]);o instanceof geocortex.forms.items.validation.RequiredValidationItem&&this.isRequired.set(!0),null!=o&&this.validationItems.push(o)}}else this.toolTip=new i.Observable(""),this.itemID=new i.Observable(null),this.argumentName=new i.Observable(null)}return e.prototype.getResult=function(){return null},e.prototype._notifyResultChanged=function(){dojo.publish("FormItemResultChangedEvent",[this])},e.prototype.refresh=function(){},e.prototype.validate=function(){var e=[];if(this.isValid.set(!0),null!=this.validationItems)for(var t=0;t<this.validationItems.length;t++){var i=this.getResult();null!=i&&(i=i.value);var r=this.validationItems[t].validate(i);r.isValid||(this.isValid.set(!1),e.push(r))}return e},e.prototype._render=function(){return document.createTextNode(this.itemID.get())},e.prototype._destroy=function(){},e}();t.AbstractFormItem=c})},"geocortex/forms/items/FormItemResult":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(e,t,i){this.isList=!1,this.argumentName=e,this.value=t,this.wasSet=i||!1};t.FormItemResult=i})},"geocortex/forms/items/GroupBoxFormItem":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./ContainerFormItem","geocortex/framework/observables","./../../forms"],function(e,i,r,n,s){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var a=function(e){function i(t,i){var r=e.call(this,t,i)||this;return r.formItemType="GroupBoxFormItem",r.header=t?new n.Observable(s.getElementText(t,"Header")):new n.Observable(null),r}return t(i,e),i.prototype._render=function(){return s.renderFormItem(this)},i.prototype.getDisplayName=function(){return this.header.get()},i}(r.ContainerFormItem);i.GroupBoxFormItem=a})},"geocortex/forms/items/HyperlinkFormItem":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./FormItem","geocortex/framework/observables","./../../forms","./FormItemResult"],function(e,i,r,n,s,a){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var o=function(e){function i(t,i){var r=e.call(this,t,i)||this;return r.wasClicked=new n.Observable(!1),r.formItemType="HyperlinkFormItem",t?(r.hyperlinkText=new n.Observable(s.getElementText(t,"HyperlinkText")),r.target=new n.Observable(s.getElementText(t,"Target")),r.uri=new n.Observable(s.getElementText(t,"Uri"))):(r.hyperlinkText=new n.Observable("Hyperlink"),r.target=new n.Observable("_blank"),r.uri=new n.Observable("")),r.wasClicked.bind(null,function(e){return r._notifyResultChanged()}),r}return t(i,e),i.prototype.getResult=function(){return new a.FormItemResult(this.argumentName.get(),this.wasClicked.get(),this.wasClicked.get())},i.prototype._render=function(){return s.renderFormItem(this)},i}(r.AbstractFormItem);i.HyperlinkFormItem=o})},"geocortex/forms/items/ImageFormItem":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./FormItem","geocortex/framework/observables","./../../forms"],function(e,i,r,n,s){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var a=function(e){function i(t,i){var r=e.call(this,t,i)||this;if(r.formItemType="ImageFormItem",t){r.source=new n.Observable(s.getElementText(t,"Source")),r.width=new n.Observable(s.getElementText(t,"Width")),r.height=new n.Observable(s.getElementText(t,"Height"));var a=r.width.get(),o=r.height.get();a&&o?parseInt(a)>parseInt(o)?r.height.set("auto"):r.width.set("auto"):(r.width=new n.Observable("auto"),r.height=new n.Observable("auto"))}else r.source=new n.Observable(""),r.width=new n.Observable("auto"),r.height=new n.Observable("auto");return r}return t(i,e),i.prototype._render=function(){return s.renderFormItem(this)},i}(r.AbstractFormItem);i.ImageFormItem=a})},"geocortex/forms/items/LabelContainer":function(){define(["require","exports","./LabelFormItem","./../../forms"],function(e,t,i,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.initLabelContainer=function(e,t,n){t?(e.label=new i.LabelFormItem(r.getElement(t,"Label")),""==e.label.toolTip.get()&&null!=e.toolTip&&e.label.toolTip.set(e.toolTip.get())):e.label=new i.LabelFormItem(null)}})},"geocortex/forms/items/LabelFormItem":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./FormItem","geocortex/framework/observables","./../../forms"],function(e,i,r,n,s){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var a=function(e){function i(t,i){var r=e.call(this,t,i)||this;return r.formItemType="LabelFormItem",t?(r.text=new n.Observable(s.getElementText(t,"Text")),r.labelForItemID=new n.Observable(s.getElementText(t,"LabelForItemID"))):(r.text=new n.Observable(null),r.labelForItemID=new n.Observable(null)),r}return t(i,e),i.prototype._render=function(){return s.renderFormItem(this)},i}(r.AbstractFormItem);i.LabelFormItem=a})},"geocortex/forms/items/ListBoxFormItem":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./FormItem","./LabelContainer","./QueryTaskFormItem","./LabelFormItem","geocortex/framework/observables","./DataItemsFormItem","./../../forms","./FormItemResult"],function(e,i,r,n,s,a,o,l,u,c){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var p=function(e){function i(t,i){var r=e.call(this,t,i)||this;if(r.selection=new o.ObservableCollection,r.selectedValues=new o.ObservableCollection,r._selectedValuesLookup=null,r.isBusy=new o.Observable(!1),r.formItemType="ListBoxFormItem",n.initLabelContainer(r,t,i),l.initDataItemsFormItem(r,t,i),r.size=new o.Observable(6),t){r.maxHeight=new o.Observable(parseInt(u.getElementText(t,"MaxHeight"))),r.selectionMode=new o.Observable(u.getElementText(t,"SelectionMode"));var c=u.getElementText(t,"Size");if(c){var p=parseInt(c);p>0&&r.size.set(p)}var h=u.getElement(t,"SelectedValues");if(h){var d;for(r._selectedValuesLookup={},d=0;d<h.childNodes.length;d++){var f=h.childNodes[d].textContent;r.selectedValues.addItem(f),r._selectedValuesLookup[f+""]=!0}r._setDefaults(),0===r.selection.length()&&0!==r.dataItems.getItems().length&&r.selection.addItem(r.dataItems.getAt(0))}}else r.label=new a.LabelFormItem(null,r.formDefinition),r.maxHeight=new o.Observable(NaN),r.selectionMode=new o.Observable("Single");return r.queryTaskRunner=new s.QueryTaskRunner(r,t,i),r.queryTaskRunner.queryCascadingID.get()||r.queryTaskRunner.performQuery(""),r.selection.bind(null,function(e){setTimeout(function(){r._notifyResultChanged()},0)}),r}return t(i,e),i.prototype.clearDataItems=function(){this.dataItems.clear()},i.prototype._setDefaults=function(){for(var e=0;e<this.dataItems.getItems().length;e++){var t=this.dataItems.getAt(e);this._selectedValuesLookup[t.value.toString()]&&this.selection.addItem(t)}},i.prototype.handleResultsComplete=function(){this._setDefaults()},i.prototype.triggerCascading=function(e){null!=this.selection&&e||this.queryTaskRunner.cascadingEvent.publish(null);var t=null;null!=this.selection&&(t=this.selection.getAt(0)),null==t&&null!=e&&(t=e),null==t?this.queryTaskRunner.cascadingEvent.publish(null):this.queryTaskRunner.cascadingEvent.publish(t.value)},i.prototype.getResult=function(){var e=null;if("single"==this.selectionMode.get().toLowerCase())return this.selection.getLength()>0&&(e=(r=this.selection.getAt(0))?r.getValue():null),new c.FormItemResult(this.argumentName.get(),e,!0);for(var t=[],i=0;i<this.selection.getLength();++i){var r=this.selection.getAt(i);(e=r?r.getValue():null)&&t.push(e)}return(e=new c.FormItemResult(this.argumentName.get(),t,!0)).isList=!0,e},i.prototype._render=function(){return u.renderFormItem(this)},i}(r.AbstractFormItem);i.ListBoxFormItem=p})},"geocortex/forms/items/MarkdownFormItem":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./FormItem","geocortex/framework/observables","./../../forms"],function(e,i,r,n,s){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var a=function(e){function i(t,i){var r=e.call(this,t,i)||this;return r.formItemType="MarkdownFormItem",r.plainText=t?new n.Observable(s.getElementText(t,"PlainText")):new n.Observable(""),r}return t(i,e),i.prototype._render=function(){return s.renderFormItem(this)},i}(r.AbstractFormItem);i.MarkdownFormItem=a})},"geocortex/forms/items/QueryTaskFormItem":function(){define(["require","exports","geocortex/framework/observables","geocortex/framework/events/Event","./../../forms","./../../essentials/RestHelper","./../DataItem","./../../essentials/Field","./../../essentials/RestHelperHTTPService"],function(e,t,i,r,n,s,a,o,l){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t,s){if(this.cascadingEvent=new r.Event("cascadingEvent"),this.isBusy=new i.Observable(!1),this._queryId=0,e.queryTaskRunner||(e.queryTaskRunner=this),e.queryTaskRunner!==this)throw new Error("FormItem in the constructor must be the QueryTaskFormItem containing the QueryTaskRunner");this.formItem=e,t?(this.queryDisplayOutputField=new i.Observable(n.getElementText(t,"QueryDisplayOutputField")),this.queryValueOutputField=new i.Observable(n.getElementText(t,"QueryValueOutputField")),this.queryServiceUrl=new i.Observable(n.getElementText(t,"QueryServiceUrl")),this.queryWhereClause=new i.Observable(n.getElementText(t,"QueryWhereClause")),this.filterByInputGeometry=new i.Observable(n._parseBoolean(n.getElementText(t,"FilterByInputGeometry"))),this.queryCascadingID=new i.Observable(n.getElementText(t,"QueryCascadingID")),this.proxyUrl=new i.Observable(n.getElementText(t,"ProxyUrl")),this.token=new i.Observable(n.getElementText(t,"Token")),n.getElementText(t,"LayerSourceJson")&&(this.layerSourceJson=new i.Observable(n.getElementText(t,"LayerSourceJson")))):(this.queryDisplayOutputField=new i.Observable(null),this.queryValueOutputField=new i.Observable(null),this.queryServiceUrl=new i.Observable(null),this.queryWhereClause=new i.Observable(null),this.filterByInputGeometry=new i.Observable(!1),this.queryCascadingID=new i.Observable(null),this.proxyUrl=new i.Observable(null),this.token=new i.Observable(null)),e.formDefinition&&e.formDefinition.map(e);var a=this.queryCascadingID.get();null!=a&&""!=a&&e.formDefinition.addCascading(a,e,function(e){e?this.queryTaskRunner.performQuery(e):(this.clearDataItems(),this.triggerCascading(null))}),e.isBusy||(e.isBusy=new i.Observable(!1)),e.isBusy.sync(this.isBusy)}return e.prototype.triggerCascading=function(e){this.cascadingEvent.publish(e)},e.prototype.isQueryable=function(){return null!=this.queryServiceUrl.get()&&""!==dojo.trim(this.queryServiceUrl.get())&&null!=this.queryWhereClause.get()&&""!==dojo.trim(this.queryWhereClause.get())&&null!=this.queryDisplayOutputField.get()&&""!==dojo.trim(this.queryDisplayOutputField.get())},e.prototype.performQuery=function(e,t){var i,r=this;if(this.isQueryable()&&(this.formItem.dataItems.clear(),null!=e)){var n=null;this.filterByInputGeometry.get()&&null!=this.formItem.formDefinition&&this.formItem.formDefinition.inputGeometry&&(n=this.formItem.formDefinition.inputGeometry);var u,c=this.queryServiceUrl.get();if(this.proxyUrl.get()&&void 0===esri.getProxyRule(c)&&esri.addProxyRule({proxyUrl:this.proxyUrl.get(),urlPrefix:c}),this.token&&this.token.get()&&(c=l.RestHelperHTTPService.appendTokenToUrl(c,this.token.get())),this.layerSourceJson&&this.layerSourceJson.get()){var p=s.RestHelper.getJsonObjectFromJsonString(this.layerSourceJson.get()),h={source:s.RestHelper.getLayerSourceFromJsonObject(p)};u=new esri.tasks.QueryTask(c,h)}else u=new esri.tasks.QueryTask(c);var d=new esri.tasks.Query;d.returnGeometry=!1,d.geometry=n,d.outFields=[],d.where=this._getWhereClause(e),d.outFields.push(this.queryDisplayOutputField.get()),null!=this.queryValueOutputField.get()&&""!=dojo.trim(this.queryValueOutputField.get())&&this.queryValueOutputField.get()!=this.queryDisplayOutputField.get()&&d.outFields.push(this.queryValueOutputField.get()),d.outFields.every(function(e){return-1!==e.indexOf(".")})||(d.returnDistinctValues=!0),this.isBusy.set(!0),++this._queryId,i=r._queryId,u.execute(d,function(e){var n,s=[];if(i==r._queryId){for(var l=0;l<e.features.length;++l){var u,c=e.features[l].attributes,p=null;null!=r.queryDisplayOutputField.get()&&(p=c[r.queryDisplayOutputField.get().trim()]),u=null!=r.queryValueOutputField.get()&&""!=dojo.trim(r.queryValueOutputField.get())&&r.queryValueOutputField.get()!=r.queryDisplayOutputField.get()?c[r.queryValueOutputField.get().trim()]:p,s.push(new a.DataItem(p,u,null))}if(s.sort(function(e,t){return e.display<t.display?-1:1}),r.formatCallback){var h=o.EsriFieldTypes.esriFieldTypeString;if(e.fields){var d=e.fields.filter(function(e){return e.name===r.queryDisplayOutputField.get()})[0];d&&(h=d.type)}s.forEach(function(e){e.display=r.formatCallback(e.display,h)})}r.formItem.prepareForResults&&r.formItem.prepareForResults();for(var f={},y=[],m=0;m<s.length;++m){var v=s[m],g=(n=v).display+"-"+n.value;f.hasOwnProperty(g)||(f[g]=!0,y.push(v))}r.formItem.dataItems.addItems(y),r.isBusy.set(!1);var _=null;r.formItem.dataItems.getLength()>0&&(_=r.formItem.dataItems.getAt(0)),!0===t&&r.triggerCascading(null==_?null:_.value),r.formItem.handleResultsComplete&&r.formItem.handleResultsComplete()}})}},e.prototype._getWhereClause=function(e){var t=this,i=this.queryWhereClause.get();return(i=i.replace(/{1:([a-zA-Z0-9]+)(:[a-zA-Z0-9]+)?}/g,function(e,i,r){var n=t.formItem.formDefinition.getFormItemById(i);if(!n)return"{unknown form item "+i+"}";var s=n.getResult().value;if(!r)return s;if(":SQL"===r)return t._escapeForWhere(s);var a=/:[fF](\d+)/.exec(r);return a?parseFloat(s).toFixed(+a[1]):"{unknown format clause "+r+"}"})).format(this._escapeForWhere(e))},e.prototype._escapeForWhere=function(e){return e&&"number"==typeof e&&(e=e.toString()),(e||"").replace(/\'/g,"''")},e}();t.QueryTaskRunner=u})},"geocortex/forms/items/RadioButtonFormItem":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./FormItem","geocortex/framework/observables","./../../forms","./FormItemResult","./ContainerFormItem"],function(e,i,r,n,s,a,o){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var l=function(e){function i(t,r){var a=e.call(this,t,r)||this;return a.formItemType="RadioButtonFormItem",t?(a.text=new n.Observable(s.getElementText(t,"Text")),a.checked=new n.Observable(s._parseBoolean(s.getElementText(t,"Checked"))),a.textLocation=new n.Observable(s.getElementText(t,"TextLocation")),a.groupName=new n.Observable(s.getElementText(t,"GroupName"))):(a.text=new n.Observable(null),a.checked=new n.Observable(!1),a.textLocation=new n.Observable("Right"),a.groupName=new n.Observable(null)),a.checked.bind(null,function(e){e&&i._findButtonsInGroup(a.groupName.get(),a.formDefinition.containerFormItem).forEach(function(e){e!==a&&e.checked.set(!1)}),a._notifyResultChanged()}),a}return t(i,e),i.prototype.getResult=function(){var e=this.__getRadioValueClosure,t=!!e&&e();return new a.FormItemResult(this.argumentName.get(),t)},i.prototype._render=function(){return s.renderFormItem(this)},i._findButtonsInGroup=function(e,t){var r=[];return t&&t.formItems.get().forEach(function(t){t instanceof i?t.groupName.get()===e&&r.push(t):t instanceof o.ContainerFormItem&&i._findButtonsInGroup(e,t).forEach(function(e){return r.push(e)})}),r},i}(r.AbstractFormItem);i.RadioButtonFormItem=l})},"geocortex/forms/items/TextAreaFormItem":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./TextBoxFormItem","geocortex/framework/observables","./../../forms"],function(e,i,r,n,s){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var a=function(e){function i(t,i){var r=e.call(this,t,i)||this;return r.formItemType="TextAreaFormItem",r.textboxHeight=t?new n.Observable(parseInt(s.getElementText(t,"TextboxHeight"))):new n.Observable(1),r}return t(i,e),i}(r.TextBoxFormItem);i.TextAreaFormItem=a})},"geocortex/forms/items/TextBoxFormItem":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./FormItem","./LabelContainer","geocortex/framework/observables","./../../forms","./FormItemResult"],function(e,i,r,n,s,a,o){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var l=function(e){function i(t,i){var r=e.call(this,t,i)||this;if(r.formItemType="TextBoxFormItem",t){var o=a.getElementText(t,"DefaultText");r.defaultText=new s.Observable(o),r.text=new s.Observable(o),r.inputScope=new s.Observable(a.getElementText(t,"InputScope")),r.textboxWidth=new s.Observable(parseInt(a.getElementText(t,"TextboxWidth"))),r.readOnly=new s.Observable(a._parseBoolean(a.getElementText(t,"ReadOnly")))}else r.defaultText=new s.Observable(""),r.text=new s.Observable(""),r.inputScope=new s.Observable("Default"),r.textboxWidth=new s.Observable(NaN),r.readOnly=new s.Observable(!1);return n.initLabelContainer(r,t,i),r.text.bind(null,function(e){return r._notifyResultChanged()}),r}return t(i,e),i.prototype.getResult=function(){return new o.FormItemResult(this.argumentName.get(),this.text.get())},i.prototype._render=function(){return a.renderFormItem(this)},i}(r.AbstractFormItem);i.TextBoxFormItem=l})},"geocortex/forms/items/TimePickerFormItem":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./FormItem","./LabelContainer","geocortex/framework/observables","./../../forms","geocortex/framework/utils/DateUtils","./FormItemResult"],function(e,i,r,n,s,a,o,l){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var u=function(e){function i(t,i){var r=e.call(this,t,i)||this;if(r.initialTime=new s.Observable,r.nullable=new s.Observable(!1),r.timeFormat=new s.Observable,r.jQueryPickerTimeAsInfoMsg=new s.Observable(!1),r.formItemType="TimePickerFormItem",n.initLabelContainer(r,t,i),t){for(var l=!0,u=t.getElementsByTagNameNS?t.getElementsByTagNameNS("http://schemas.datacontract.org/2004/07/Geocortex.Forms.Client.Items.Validation","ValidationItem"):t.getElementsByTagName("ValidationItem"),c=0;c<u.length;c++){var p=u[c].getAttributeNS("http://www.w3.org/2001/XMLSchema-instance","type");if(p&&p.indexOf("RequiredValidationItem")>=0){l=!1;break}}r.nullable.set(l);var h=a.getElementText(t,"jQueryPickerTimeAsInfoMsg");h&&r.jQueryPickerTimeAsInfoMsg.set("true"===h);var d=a.getElementText(t,"InitialTime");(null===a.getElementText(t,"InitializeWithCurrentTime")?d:"true"!==a.getElementText(t,"InitializeWithCurrentTime"))?d?(o.containsTimezone(d)||(d+=o.getTimezoneString()),r.initialTime.set(Date.fromISO(d))):r.initialTime.set(null):r.initialTime.set(new Date),r.timeFormat.set(a.getElementText(t,"TimeFormat"))}else r.timeFormat.set("LongTime"),r.initialTime.set(new Date);return r.time=new s.Observable(r.initialTime.get()),r.time.bind(null,function(e){return r._notifyResultChanged()}),r}return t(i,e),i.prototype.getResult=function(){var e=this.time.get();return e&&(e=new Date(e.toString()),e="/Date({0})/".format(e.getTime())),new l.FormItemResult(this.argumentName.get(),e)},i.prototype._render=function(){return a.renderFormItem(this)},i}(r.AbstractFormItem);i.TimePickerFormItem=u})},"geocortex/forms/items/validation/FileSizeValidationItem":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./ValidationItem","./../../../forms","./ValidationResult","./../../../workflow/ArgumentValueWrapper","./../../FileItem"],function(e,i,r,n,s,a,o){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var l=function(e){function i(t){var i=e.call(this,t)||this;return i.totalFileSize=parseInt(n.getElementText(t,"TotalFileSize")),i}return t(i,e),i.prototype.validate=function(e){if(e instanceof a.ArgumentValueWrapper&&e.value&&e.value instanceof Array){for(var t=0,i=0;i<e.value.length;++i){var r=e.value[i];r&&r instanceof o.FileItem&&(t+=r.fileSize)}if(t>this.totalFileSize)return new s.ValidationResult(!1,this.message)}return new s.ValidationResult(!0,null)},i}(r.ValidationItem);i.FileSizeValidationItem=l})},"geocortex/forms/items/validation/NumericRangeValidationItem":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./ValidationItem","./../../../forms","./ValidationResult"],function(e,i,r,n,s){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var a=function(e){function i(t){var i=e.call(this,t)||this;return i.minimumValue=parseFloat(n.getElementText(t,"MinimumValue")),i.maximumValue=parseFloat(n.getElementText(t,"MaximumValue")),i}return t(i,e),i.prototype.validate=function(e){if(null===e||void 0===e||""===e)return new s.ValidationResult(!0,null);var t=parseFloat(e);return null==t||isNaN(t)||t<this.minimumValue||t>this.maximumValue?new s.ValidationResult(!1,this.message):new s.ValidationResult(!0,null)},i}(r.ValidationItem);i.NumericRangeValidationItem=a})},"geocortex/forms/items/validation/RegexValidationItem":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./ValidationItem","./../../../forms","./ValidationResult"],function(e,i,r,n,s){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var a=function(e){function i(t){var i=e.call(this,t)||this;return i.expression=n.getElementText(t,"Expression"),i.ignoreCase=n._parseBoolean(n.getElementText(t,"IgnoreCase")),i}return t(i,e),i.prototype.validate=function(e){if(null===e||void 0===e||""===e)return new s.ValidationResult(!0,null);var t="",i=this.expression;this.ignoreCase&&(t+="i"),'^(?(")(".+?"@)|(([0-9a-zA-Z]((\\.(?!\\.))|[-!#\\$%&\'\\*\\+/=\\?\\^`\\{\\}\\|~\\w])*)(?<=[0-9a-zA-Z])@))(?(\\[)(\\[(\\d{1,3}\\.){3}\\d{1,3}\\])|(([0-9a-zA-Z][-\\w]*[0-9a-zA-Z]\\.)+[a-zA-Z]{2,6}))$'==this.expression&&(i="^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,4}$");var r=null;try{r=new RegExp(i,t)}catch(e){}return null==r||r.test(e)?new s.ValidationResult(!0,null):new s.ValidationResult(!1,this.message)},i}(r.ValidationItem);i.RegexValidationItem=a})},"geocortex/forms/items/validation/RequiredValidationItem":function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])},function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)});define(["require","exports","./ValidationItem","./ValidationResult"],function(e,i,r,n){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var s=function(e){function i(t){return e.call(this,t)||this}return t(i,e),i.prototype.validate=function(e){var t=!0,i=null;return(void 0===e||null===e||"string"==typeof e&&""===dojo.trim(e)||void 0!==e.length&&e.length<=0||e.value&&dojo.isArray(e.value)&&0===e.value.length)&&(t=!1,i=this.message),new n.ValidationResult(t,i)},i}(r.ValidationItem);i.RequiredValidationItem=s})},"geocortex/forms/items/validation/ValidationItem":function(){define(["require","exports","./../../../forms"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e){this.message=i.getElementText(e,"Message")}return e.prototype.validate=function(e){throw new Error("Abstract method")},e}();t.ValidationItem=r})},"geocortex/forms/items/validation/ValidationResult":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(e,t){this.isValid=e,this.errorMessage=t};t.ValidationResult=i})}}}),require({cache:{"geocortex/forms":function(){define(["require","exports"],function(e,t){"use strict";function i(e,t){var i=e.getElementsByTagName(t);if(i.length>=1){for(n=0;n<i.length;n++)if(i[n].parentNode===e)return i[n]}else if(e.childNodes.length>0){var r=e.childNodes[0].prefix;if(""!=r&&(i=e.getElementsByTagName(r+":"+t)).length>=1)for(var n=0;n<i.length;n++)if(i[n].parentNode===e)return i[n]}return null}Object.defineProperty(t,"__esModule",{value:!0}),t.getElement=i,t.getElementText=function(e,t){var r=i(e,t);return r?dojox.xml.parser.textContent(r):null},t.getAttributeValue=function(e,t){if(null!=e)for(var i=0;i<e.attributes.length;i++)if(e.attributes[i].name==t)return e.attributes[i].value;return null},t._parseBoolean=function(e){if(null!=e)switch(e.toLowerCase()){case"true":case"yes":case"1":return!0;case"false":case"no":case"0":case null:return!1;default:return Boolean(e)}return!1},t.renderFormItem=function(e){return geocortex.forms.renderFormItem(e)}})}}}),require({cache:{"geocortex/geocortex":function(){define(["require","exports","./config","./hasProxy","./essentials/RestHelperHTTPService","./essentials/Extension"],function(e,t,i,r,n,s){"use strict";function a(e){var t=!1;try{var r=e.url.length;e.content&&(r+=dojo.objectToQuery(e.content).length);var n=new dojo._Url(e.url),s=window.location,a=r>i.config.io.postLength;if(!n.scheme&&!n.host&&!n.port)return!1;if(o()&&"https"===n.scheme)return!1;var l=!(s.protocol+"//"+s.hostname+(s.port?":"+s.port:"")==n.scheme+"://"+n.host+(n.port?":"+n.port:""));t=a&&l}catch(e){}return t}function o(){return/\bGeocortexApp\b/.test(navigator.userAgent)||/http:\/\/127.0.0.1(:[0-9]*)?\/viewerpackages\//gi.test(window.location.href)}Object.defineProperty(t,"__esModule",{value:!0}),t.deferredResolve=function(e,t){e&&-1==e.fired&&e.resolve(t)},t.deferredReject=function(e,t){e&&-1==e.fired&&e.reject(t)},t.encodeJson=function(e){var t=function e(t){var i,r=typeof t;if(null==t||"undefined"===r||"number"===r||"boolean"===r||"string"===r)return t;if("function"==typeof t.toJson&&(i=t.toJson()),dojo.isArray(t))for(i=[],n=0;n<t.length;n++)"function"!=typeof(s=t[n])&&(i[n]=e(s));else if("object"===r){i={};for(var n in t)if(!("declaredClass"==n||n.indexOf("_inherited")>-1||void 0!==i[n])){var s=t[n];"function"!=typeof s&&(i[n]=e(s))}}return i}(e),i={};for(var r in t)dojo.isArray(t[r])||"object"==typeof t[r]?i[r]=JSON.stringify(t[r]):i[r]=t[r];return i},t.request=function(e,t){t||(t={}),t.gcx||(t.gcx={}),void 0===t.gcx.preventCache?e.preventCache=!0:t.gcx.preventCache?e.preventCache=!0:e.preventCache=!1,e.timeout=e.timeout||i.config.io.timeout,e.handleAs=e.handleAs||"json";var s=a(e),o=r.hasProxy();if(s&&!o){var l=new Error("Cross-domain or large requests require a proxy.");dojo.isFunction(e.error)&&e.error(l);var u=new dojo.Deferred;return u.errback(l),u}return delete e.gcx,t.useProxy=s,t.hasOwnProperty("disableIdentityLookup")||(t.disableIdentityLookup=!0),new n.RestHelperHTTPService(e,t).send()},t.requiresProxy=a,t.isNative=o,t.urlToQueryObject=function(e){var t=e.indexOf("?");return-1===t?null:dojo.queryToObject(e.substring(t+1))},t._getExtensions=function(e){var t=[];if(!e)return t;t.length=e.length;for(var i=0;i<e.length;i++)t[i]=new s.Extension(e[i].className,e[i].instance);return t},t._extensionsToJson=function(e){return(e||[]).map(function(e){return{className:e.className,instance:e.instance}})},t._getProperties=function(e){var t={};if(!e)return t;for(var i=0;i<e.length;i++)t[e[i].name]=e[i].value;return t},t._propertiesToJson=function(e){return e?Object.keys(e).map(function(t){return{name:t,value:e[t]}}):[]},Date.now||(Date.now=function(){return+new Date})})}}}),require({cache:{"geocortex/hasProxy":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hasProxy=function(){var e=!1;try{e=esri._getProxyUrl()}catch(e){}return e}})}}}),require({cache:{"geocortex/optimizer/EventRelay":function(){define(["require","exports","geocortex/framework/utils/TimeDelayedOperation"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t,r,n){var s=this;this._timer=null,this._siteId="",this._endpointUrl="",this.userName="",this._extentConnect=null,this._numConsecutiveFailures=0,this._enabled=!0,this._sessionId="",this._previousScale=-1,this._firstExtentLogged=!1,this._map=e,t&&(this._siteId=t),this._endpointUrl=r||window.location.protocol+"//"+window.location.host+"/Geocortex/Optimizer/Rest/DataRelay/LogData.ashx?f=json",n&&(this.userName=n),this._pendingEvents=new Array,this._timer=new i.TimeDelayedAction(3e3,this._flushQueue,this);var a={};a.extent=this._map.extent,e.loaded?(this._logExtentChange(a),this._extentConnect=e.on("extent-change",dojo.hitch(this,"_logExtentChange"))):e.on("load",function(){s._logExtentChange(a),s._extentConnect=e.on("extent-change",dojo.hitch(s,"_logExtentChange"))}),this._sessionId=this._crc32((new Date).getTime()+""+navigator.userAgent)}return e.prototype._logExtentChange=function(e){var t;if(this._enabled)if((t={}).data=[{name:"ArcGISExtents",columns:{}}],t.data[0].columns=[{type:"tinyint",name:"InitialExtent",key:"InitialExtent"},{type:"real",name:"XMinNew",key:"XMinNew"},{type:"real",name:"YMinNew",key:"YMinNew"},{type:"real",name:"XMaxNew",key:"XMaxNew"},{type:"real",name:"YMaxNew",key:"YMaxNew"}],t.data[0].rows=[{InitialExtent:this._firstExtentLogged?0:1,XMinNew:e.extent.xmin,YMinNew:e.extent.ymin,XMaxNew:e.extent.xmax,YMaxNew:e.extent.ymax}],this._queueData(t),this._firstExtentLogged=!0,e.lod)e.levelChange&&this._previousScale>-1&&this._logScaleChange(this._previousScale,e.lod.scale),this._previousScale=e.lod.scale;else{var i=this._map.getScale();null!==i&&(this._previousScale!=i&&this._previousScale>-1&&this._logScaleChange(this._previousScale,i),this._previousScale=i)}},e.prototype._logScaleChange=function(e,t){if(this._enabled){var i={data:[{name:"ArcGISScale",columns:[]}]};i.data[0].columns=[{type:"float",name:"ScaleOld",key:"ScaleOld"},{type:"float",name:"ScaleNew",key:"ScaleNew"}],i.data[0].rows=[{ScaleOld:e,ScaleNew:t}],this._queueData(i)}},e.prototype.logToolUsage=function(e,t){if(this._enabled){var i={data:[{name:"ArcGISTool",columns:[]}]};i.data[0].columns=[{type:"ustr",name:"Tool",key:"Tool"},{type:"ustr",name:"ToolData",key:"ToolData"}],i.data[0].rows=[{Tool:e,ToolData:t}],this._queueData(i)}},e.prototype._queueData=function(e){e.platform="js",e.data[0].columns.push({type:"now",name:"SampleTime",key:"SampleTime"},{type:"origin",name:"UserAddress",key:"UserAddress"},{type:"ustr",name:"SiteId",key:"SiteId"},{type:"ustr",name:"UserAgent",key:"UserAgent"},{type:"ustr",name:"UserName",key:"UserName"},{type:"ustr",name:"LayerList",key:"LayerList"},{type:"int",name:"SessionId",key:"SessionId"},{type:"ustr",name:"ClientType",key:"ClientType"},{type:"host",name:"MachineName",key:"MachineName"}),dojo.mixin(e.data[0].rows[0],{SiteId:this._siteId,UserAgent:navigator.userAgent,UserName:this.userName,LayerList:this._getCurrentLayerList(),SessionId:this._sessionId,ClientType:"JavaScript"}),this._pendingEvents.push(e),this._timer.reset()},e.prototype._flushQueue=function(){for(this._timer.stop();this._pendingEvents.length>0;){var e=this._pendingEvents.shift();this._logData(e)}},e.prototype._logData=function(e){try{dojo.xhrPost({url:this._endpointUrl,postData:JSON.stringify(e),timeout:1e4,load:dojo.hitch(this,this._handleLogSuccessResponse),error:dojo.hitch(this,this._handleLogErrorResponse)})}catch(e){console.log(e.message),this._incrementFailures()}},e.prototype._handleLogSuccessResponse=function(e){this._numConsecutiveFailures=0},e.prototype._handleLogErrorResponse=function(e){console.log(e),this._incrementFailures()},e.prototype._incrementFailures=function(){++this._numConsecutiveFailures>2&&(dojo.disconnect(this._extentConnect),this._enabled=!1)},e.prototype._getCurrentLayerList=function(){for(var e="",t=this._map.layerIds,i=0;i<t.length;i++){var r,n=t[i],s=this._map.getLayer(n);if(null!=s&&s.visible&&s.visibleAtMapScale)if(s instanceof esri.layers.ArcGISDynamicMapServiceLayer){var a=s;for(r=0;r<a.visibleLayers.length;r++)null!=a.visibleLayers[r]&&-1!=a.visibleLayers[r]&&(e+=a.layerInfos.filter(function(e){return e.id==a.visibleLayers[r]})[0].name+"\\t")}else if(s instanceof esri.virtualearth.VETiledLayer)e+="Bing:"+s.mapStyle+"\\t";else if(s instanceof esri.layers.ArcGISImageServiceLayer)e+="Image:"+s.url+"\\t";else if(s instanceof esri.layers.ArcGISTiledMapServiceLayer){var o=s;for(r=0;r<o.layerInfos.length;r++)null!=o.layerInfos[r]&&(e+=o.layerInfos[r].name+"\\t")}}return e.length>3&&(e=e.substring(0,e.length-2)),e},e.prototype._crc32=function(e){e=e.replace(/\r\n/g,"\n");for(var t="",i=0;i<e.length;i++){var r=e.charCodeAt(i);r<128?t+=String.fromCharCode(r):r>127&&r<2048?(t+=String.fromCharCode(r>>6|192),t+=String.fromCharCode(63&r|128)):(t+=String.fromCharCode(r>>12|224),t+=String.fromCharCode(r>>6&63|128),t+=String.fromCharCode(63&r|128))}var n,s=0;s^=-1;for(var a=0,o=(e=t).length;a<o;a++)n=255&(s^e.charCodeAt(a)),s=s>>>8^"0x"+"00000000 77073096 EE0E612C 990951BA 076DC419 706AF48F E963A535 9E6495A3 0EDB8832 79DCB8A4 E0D5E91E 97D2D988 09B64C2B 7EB17CBD E7B82D07 90BF1D91 1DB71064 6AB020F2 F3B97148 84BE41DE 1ADAD47D 6DDDE4EB F4D4B551 83D385C7 136C9856 646BA8C0 FD62F97A 8A65C9EC 14015C4F 63066CD9 FA0F3D63 8D080DF5 3B6E20C8 4C69105E D56041E4 A2677172 3C03E4D1 4B04D447 D20D85FD A50AB56B 35B5A8FA 42B2986C DBBBC9D6 ACBCF940 32D86CE3 45DF5C75 DCD60DCF ABD13D59 26D930AC 51DE003A C8D75180 BFD06116 21B4F4B5 56B3C423 CFBA9599 B8BDA50F 2802B89E 5F058808 C60CD9B2 B10BE924 2F6F7C87 58684C11 C1611DAB B6662D3D 76DC4190 01DB7106 98D220BC EFD5102A 71B18589 06B6B51F 9FBFE4A5 E8B8D433 7807C9A2 0F00F934 9609A88E E10E9818 7F6A0DBB 086D3D2D 91646C97 E6635C01 6B6B51F4 1C6C6162 856530D8 F262004E 6C0695ED 1B01A57B 8208F4C1 F50FC457 65B0D9C6 12B7E950 8BBEB8EA FCB9887C 62DD1DDF 15DA2D49 8CD37CF3 FBD44C65 4DB26158 3AB551CE A3BC0074 D4BB30E2 4ADFA541 3DD895D7 A4D1C46D D3D6F4FB 4369E96A 346ED9FC AD678846 DA60B8D0 44042D73 33031DE5 AA0A4C5F DD0D7CC9 5005713C 270241AA BE0B1010 C90C2086 5768B525 206F85B3 B966D409 CE61E49F 5EDEF90E 29D9C998 B0D09822 C7D7A8B4 59B33D17 2EB40D81 B7BD5C3B C0BA6CAD EDB88320 9ABFB3B6 03B6E20C 74B1D29A EAD54739 9DD277AF 04DB2615 73DC1683 E3630B12 94643B84 0D6D6A3E 7A6A5AA8 E40ECF0B 9309FF9D 0A00AE27 7D079EB1 F00F9344 8708A3D2 1E01F268 6906C2FE F762575D 806567CB 196C3671 6E6B06E7 FED41B76 89D32BE0 10DA7A5A 67DD4ACC F9B9DF6F 8EBEEFF9 17B7BE43 60B08ED5 D6D6A3E8 A1D1937E 38D8C2C4 4FDFF252 D1BB67F1 A6BC5767 3FB506DD 48B2364B D80D2BDA AF0A1B4C 36034AF6 41047A60 DF60EFC3 A867DF55 316E8EEF 4669BE79 CB61B38C BC66831A 256FD2A0 5268E236 CC0C7795 BB0B4703 220216B9 5505262F C5BA3BBE B2BD0B28 2BB45A92 5CB36A04 C2D7FFA7 B5D0CF31 2CD99E8B 5BDEAE1D 9B64C2B0 EC63F226 756AA39C 026D930A 9C0906A9 EB0E363F 72076785 05005713 95BF4A82 E2B87A14 7BB12BAE 0CB61B38 92D28E9B E5D5BE0D 7CDCEFB7 0BDBDF21 86D3D2D4 F1D4E242 68DDB3F8 1FDA836E 81BE16CD F6B9265B 6FB077E1 18B74777 88085AE6 FF0F6A70 66063BCA 11010B5C 8F659EFF F862AE69 616BFFD3 166CCF45 A00AE278 D70DD2EE 4E048354 3903B3C2 A7672661 D06016F7 4969474D 3E6E77DB AED16A4A D9D65ADC 40DF0B66 37D83BF0 A9BCAE53 DEBB9EC5 47B2CF7F 30B5FFE9 BDBDF21C CABAC28A 53B39330 24B4A3A6 BAD03605 CDD70693 54DE5729 23D967BF B3667A2E C4614AB8 5D681B02 2A6F2B94 B40BBE37 C30C8EA1 5A05DF1B 2D02EF8D".substr(9*n,8);return(s^=-1).toString()},e}();t.EventRelay=r})}}}),require({cache:{"geocortex/workflow":function(){},"geocortex/workflow/ActivityContext":function(){define(["require","exports","./ArgumentValueWrapper","./ArgumentInfo","./DefaultActivityHandlers","./WorkflowControllerProxy"],function(e,t,i,r,n,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t,i,r){this.activityComplete=null,this._dispatcher=e,this._pendingIndex=t,this._workflow=i,this._workflowState=r}return e.prototype.dispatcher=function(){return this._dispatcher},e.prototype.workflow=function(){return this._workflow},e.prototype.getDisplayName=function(){return this._workflowState?this._workflowState.pendingExternalActivities[this._pendingIndex].displayName:""},e.prototype.getInputNames=function(){var e=[];if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,i=0;i<t.length;i++)e.push(t[i].name);return e},e.prototype.getInputNamesByType=function(e){var t=[];if(this._workflowState)for(var i=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,r=0;r<i.length;r++)0===i[r].typeName.indexOf(e)&&t.push(i[r].name);return t},e.prototype.getOutputNames=function(){var e=[];if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,i=0;i<t.length;i++)e.push(t[i].name);return e},e.prototype.getOutputNamesByType=function(e){var t=[];if(this._workflowState)for(var i=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,r=0;r<i.length;r++)0===i[r].typeName.indexOf(e)&&t.push(i[r].name);return t},e.prototype.getSite=function(){return null!=this._workflow?this._workflow.site:null},e.prototype.getEsriMap=function(){return null!=this._workflow&&null!=this._workflow.site?this._workflow.site.getMap():null},e.prototype.getValue=function(e){if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,i=0;i<t.length;i++)if(t[i].name==e)return t[i].value;return null},e.prototype.getOutputValue=function(e){if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,i=0;i<t.length;i++)if(t[i].name==e)return t[i].value;return null},e.prototype.getJsonValue=function(e){for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,i=0;i<t.length;i++)if(t[i].name==e)return JSON.stringify(t[i].value);return null},e.prototype.getOutputJsonValue=function(e){if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,i=0;i<t.length;i++)if(t[i].name==e){var r=t[i].value;return r&&1===r.length&&(r=r[0]),JSON.stringify(r)}return null},e.prototype.setValue=function(e,t,n){if(this._workflowState){var s=!1,a=this._workflowState.pendingExternalActivities[this._pendingIndex].outputs,o=this._getRuntimeType(t);t&&t instanceof i.ArgumentValueWrapper&&(o=t.runtimeTypeName,t=t.value);for(var l=0;l<a.length;l++)if(a[l].name==e){s=!0,(u=a[l])&&(u.value=t,null!=o&&(u.runtimeTypeName=o));break}if(!s&&n){o||(o="System.Object");var u=new r.ArgumentInfo;u.isRequired=!1,u.name=e,u.value=t,u.typeName=o,u.runtimeTypeName=o,this._workflowState.pendingExternalActivities[this._pendingIndex].outputs.push(u)}}},e.prototype.getActivityTypeName=function(){var e="";if(this._workflowState&&(e=this._workflowState.pendingExternalActivities[this._pendingIndex].typeName)){var t=e.indexOf("`");t>=0&&(e=e.substring(0,t))}return e},e.prototype.getActivityExternalId=function(){return this._workflowState?this._workflowState.pendingExternalActivities[this._pendingIndex].externalId:""},e.prototype.getInputArgumentTypeName=function(e){if(this._workflowState)for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,i=0;i<t.length;i++)if(t[i].name==e)return t[i].typeName;return""},e.prototype.getInputArgumentRuntimeTypeName=function(e){for(var t=this._workflowState.pendingExternalActivities[this._pendingIndex].inputs,i=0;i<t.length;i++)if(t[i].name==e)return t[i].runtimeTypeName;return""},e.prototype.completeActivity=function(){if(this._workflowState){var e=this._workflowState.pendingExternalActivities[this._pendingIndex];if(e.isComplete)return;var t=this;"debugger"==this.getActivityExternalId()||e&&e.debug?n.showDebug(this,!1,function(){t._completeActivityInternal()}):this._completeActivityInternal()}},e.prototype.abortActivity=function(){if(this._workflowState){var e=this._workflowState.pendingExternalActivities[this._pendingIndex];e.isAborted=!0,this._workflowState.status="Aborted: "+e.displayName}null!=this._dispatcher&&this._dispatcher.activityAbort(this)},e.prototype._completeActivityInternal=function(){if(this._workflowState){var e=this._workflowState.pendingExternalActivities[this._pendingIndex];e.isComplete=!0,null!=this._dispatcher&&this._dispatcher.activityComplete(this),e.inputs=null;var t=this._workflowState.pendingExternalActivities[this._pendingIndex].syncToken,i=!0;if(""!=t)for(var r=this._workflowState.pendingExternalActivities,n=0;n<r.length;n++)if(r[n].syncToken==t&&!r[n].isComplete){i=!1;break}i&&(s._executeWorkflow(this._workflow,this._dispatcher,this._workflowState,null,this),dojo.isFunction(this.activityComplete)&&this.activityComplete(this))}},e.prototype._getRuntimeType=function(e){var t="System.Object";return e&&("function"==typeof e.isInstanceOf?e.isInstanceOf(esri.geometry.Extent)?t="ESRI.ArcGIS.Client.Geometry.Envelope":e.isInstanceOf(esri.geometry.Extent)?t="ESRI.ArcGIS.Client.Geometry.Envelope":e.isInstanceOf(esri.geometry.Point)?t="ESRI.ArcGIS.Client.Geometry.MapPoint":e.isInstanceOf(esri.geometry.Multipoint)?t="ESRI.ArcGIS.Client.Geometry.MultiPoint":e.isInstanceOf(esri.geometry.Polygon)?t="ESRI.ArcGIS.Client.Geometry.Polygon":e.isInstanceOf(esri.geometry.Polyline)?t="ESRI.ArcGIS.Client.Geometry.Polyline":e.isInstanceOf(esri.geometry.Geometry)?t="ESRI.ArcGIS.Client.Geometry.Geometry":e.isInstanceOf(esri.layers.LayerDataSource)?t="ESRI.ArcGIS.Client.LayerDataSource":e.isInstanceOf(esri.layers.LayerMapSource)&&(t="ESRI.ArcGIS.Client.LayerMapSource"):"string"==typeof e?t="System.String":"number"==typeof e?t="System.Double":"boolean"==typeof e?t="System.Boolean":"object"==typeof e&&(t="function"==typeof e.getMonth?"System.DateTime":"System.Object")),t},e}();t.ActivityContext=a})},"geocortex/workflow/ActivityDispatcher":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})})},"geocortex/workflow/ArgumentInfo":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t,i,r){this.runtimeTypeName=null,this.name=e||null,this.typeName=t||null,this.isRequired=!!i,this.value=r||null}return e.prototype._configureObject=function(e){if(void 0===e.name||void 0===e.typeName)throw new Error("Incorrect argument info object returned from initialization");this.name=e.name,this.typeName=e.typeName,this.isRequired=e.isRequired,this.value=e.value,this.runtimeTypeName=e.runtimeTypeName},e.prototype._internalClone=function(){var t=new e(this.name,this.typeName,this.isRequired,dojo.clone(this.value));return t.runtimeTypeName=dojo.clone(this.runtimeTypeName),t},e}();t.ArgumentInfo=i})},"geocortex/workflow/ArgumentValueWrapper":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(e,t){this.runtimeTypeName=null,this.runtimeTypeName=e||null,this.value=t||null};t.ArgumentValueWrapper=i})},"geocortex/workflow/CacheActivityHandlers":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i={};t.handleGetExternalValue=function(e){var t=e.getValue("Key");if(null!=t){var r=i[t];void 0===r&&(r=null),e.setValue("Value",r)}e.completeActivity()},t.handleSetExternalValue=function(e){var t=e.getValue("Key"),r=e.getValue("Value");null!=t&&(i[t]=r),e.completeActivity()}})},"geocortex/workflow/DefaultActivityDispatcher":function(){define(["require","exports","./DialogActivityHandlers","./MapActivityHandlers","./DefaultActivityHandlers","./NativeActivityHandlers","./CacheActivityHandlers","./LayerActivityHandlers","./MapServiceActivityHandlers"],function(e,t,i,r,n,s,a,o,l){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t,i,r,n,s,a){this.isBusy=!1,this._drawObjectContext=null,this._registeredActivityHandlers={},this._registeredExternalIdHandlers={},this.handleUnhandledActivityErrorFunction=null,this.handleOpenReportUrlFunction=null,this.defaultFormContainerId="form-container-outer",this.defaultFormContentId="form-container",this._handleErrorFunction=e||null,this._activityBeginFunction=t||null,this._activityCompleteFunction=i||null,this._workflowAbortFunction=n||null,this._workflowCompleteFunction=r||null,this._webRequestBeginFunction=s||null,this._webRequestCompleteFunction=a||null,this.registerDefaultHandlers()}return e.prototype.registerDefaultHandlers=function(){this.registerActivityHandler("Geocortex.Workflow.Activities.Alert",i.handleAlert),this.registerActivityHandler("Geocortex.Workflow.Activities.CaptureGeometry",r.MapActivityHandlers.handleCaptureGeometry),this.registerActivityHandler("Geocortex.Workflow.Activities.Confirm",i.handleConfirm),this.registerActivityHandler("Geocortex.Workflow.Activities.ExportMap",r.MapActivityHandlers.handleExportMap),this.registerActivityHandler("Geocortex.Workflow.Activities.ExternalDelay",n.handleExternalDelay),this.registerActivityHandler("Geocortex.Workflow.Activities.GetBrowserUrl",n.handleGetBrowserUrl),this.registerActivityHandler("Geocortex.Workflow.Activities.GetCurrentPosition",s.handleGetCurrentPosition),this.registerActivityHandler("Geocortex.Workflow.Activities.GetExternalTimeInfo",n.handleGetExternalTimeInfo),this.registerActivityHandler("Geocortex.Workflow.Activities.GetExternalValue",a.handleGetExternalValue),this.registerActivityHandler("Geocortex.Workflow.Activities.GetGraphicsLayerContent",o.handleGetGraphicsLayerContent),this.registerActivityHandler("Geocortex.Workflow.Activities.GetLayerDefinition",o.handleGetLayerDefinition),this.registerActivityHandler("Geocortex.Workflow.Activities.GetLayerInfoByProperty",n.handleGetLayerInfoByProperty),this.registerActivityHandler("Geocortex.Workflow.Activities.GetLayerProperty",o.handleGetLayerProperty),this.registerActivityHandler("Geocortex.Workflow.Activities.GetLayerVisibility",o.handleGetLayerVisibility),this.registerActivityHandler("Geocortex.Workflow.Activities.GetMapExtent",r.MapActivityHandlers.handleGetMapExtent),this.registerActivityHandler("Geocortex.Workflow.Activities.GetMapInfo",r.MapActivityHandlers.handleGetMapInfo),this.registerActivityHandler("Geocortex.Workflow.Activities.GetMapServiceInfo",l.handleGetMapServiceInfo),this.registerActivityHandler("Geocortex.Workflow.Activities.GetPhoto",s.handleGetPhoto),this.registerActivityHandler("Geocortex.Workflow.Activities.PrintMap",r.MapActivityHandlers.handlePrintMap),this.registerActivityHandler("Geocortex.Workflow.Activities.Prompt",i.handlePrompt),this.registerActivityHandler("Geocortex.Workflow.Activities.RefreshMap",r.MapActivityHandlers.handleRefreshMap),this.registerActivityHandler("Geocortex.Workflow.Activities.RemoveMapService",l.handleRemoveMapService),this.registerActivityHandler("Geocortex.Workflow.Activities.Report",n.handleReport),this.registerActivityHandler("Geocortex.Workflow.Activities.SetExternalValue",a.handleSetExternalValue),this.registerActivityHandler("Geocortex.Workflow.Activities.SetLayerDefinition",o.handleSetLayerDefinition),this.registerActivityHandler("Geocortex.Workflow.Activities.SetLayerProperty",o.handleSetLayerProperty),this.registerActivityHandler("Geocortex.Workflow.Activities.SetLayerVisibility",o.handleSetLayerVisibility),this.registerActivityHandler("Geocortex.Workflow.Activities.SetMapExtent",r.MapActivityHandlers.handleSetMapExtent),this.registerActivityHandler("Geocortex.Workflow.Activities.SetMapServiceVisibility",l.handleSetMapServiceVisibility),this.registerActivityHandler("Geocortex.Workflow.Activities.UpdateGraphicsLayer",o.handleUpdateGraphicsLayer),this.registerActivityHandler("Geocortex.Workflow.Activities.WaitForGeoprocessorJobComplete",n.handleWaitForGeoprocessorJobComplete),this.registerActivityHandler("Geocortex.Workflow.Activities.SetImageServiceInfo",l.handleSetImageServiceInfo),this.registerActivityHandler("Geocortex.Workflow.Activities.SetMapServiceProperty",l.handleSetMapServiceProperty),this.registerExternalIdHandler("IntersectLayers",r.MapActivityHandlers.handleIntersectLayers),this.registerExternalIdHandler("GetPhoto",s.handleGetPhoto)},e.prototype.canHandleActivity=function(e){if(!e){var t=new Error("Null ActivityContext passed to canHandleActivity.");this.handleError(t,e)}if(null!=e.getActivityExternalId()&&null!=this._registeredExternalIdHandlers[e.getActivityExternalId()])return!0;var i=e.getActivityTypeName();return!(null==i||!this._registeredActivityHandlers[i])},e.prototype.registerExternalIdHandler=function(e,t){if(null!=e&&null!=t)this._registeredExternalIdHandlers[e]=t;else{var i=new Error("Null externalId or handler passed to registerExternalIdHandler.");this.handleError(i,null)}},e.prototype.registerActivityHandler=function(e,t){if(null!=e&&null!=t)this._registeredActivityHandlers[e]=t;else{var i=new Error("Null activityTypeName or handler passed to registerActivityHandler.");this.handleError(i,null)}},e.prototype.dispatch=function(e){if(null!=e){var t=e.getActivityTypeName(),i=e.getActivityExternalId();if(this.canHandleActivity(e)){if(null!=i&&null!=this._registeredExternalIdHandlers[i]&&(r=this._registeredExternalIdHandlers[i])(e,this),null!=t&&this._registeredActivityHandlers[t]){var r=this._registeredActivityHandlers[t];r(e,this)}}else n=new Error("Unknown activity type '"+t+"' or external ID '"+i+"' encountered."),this.handleUnhandledActivityErrorFunction(n,e)}else{var n=new Error("Null ActivityContext passed to dispatch.");this.handleError(n,e)}},e.prototype.handleError=function(e,t){null!=this._handleErrorFunction&&this._handleErrorFunction(e,t)},e.prototype.handleUnhandledActivityError=function(e,t){null!=this.handleUnhandledActivityErrorFunction?this.handleUnhandledActivityErrorFunction(e,t):this.handleError(e,t)},e.prototype.handleOpenReportUrl=function(e,t){null!=this.handleOpenReportUrlFunction?this.handleOpenReportUrlFunction(e,t):window.open(e)},e.prototype.webRequestBegin=function(e,t){null!=this._webRequestBeginFunction&&this._webRequestBeginFunction(e,t)},e.prototype.webRequestComplete=function(e,t){null!=this._webRequestCompleteFunction&&this._webRequestCompleteFunction(e,t)},e.prototype.abortMapBasedActivity=function(){if(this._drawObjectContext){if(!this._drawObjectContext.toolbar||!this._drawObjectContext.drawEvent||!this._drawObjectContext.activityContext)return!1;this._drawObjectContext.toolbar.deactivate(),dojo.disconnect(this._drawObjectContext.drawEvent),this._drawObjectContext.activityContext.abortActivity(),this._drawObjectContext=null}return!0},e.prototype.setDrawObjectContext=function(e){this._drawObjectContext=e},e.prototype.activityBegin=function(e){null!=this._activityBeginFunction&&this._activityBeginFunction(e)},e.prototype.activityComplete=function(e){null!=this._activityCompleteFunction&&this._activityCompleteFunction(e)},e.prototype.activityAbort=function(e){this.workflowAbort(e,e.workflow())},e.prototype.workflowComplete=function(e,t){null!=this._workflowCompleteFunction&&this._workflowCompleteFunction(e,t)},e.prototype.workflowAbort=function(e,t){null!=this._workflowAbortFunction&&this._workflowAbortFunction(e,t)},e}();t.DefaultActivityDispatcher=u})},"geocortex/workflow/DefaultActivityHandlers":function(){define(["require","exports","./MapServiceActivityHandlers","./../essentials/ReportParameters","./../essentials/TextField","./../essentials/RestHelper","./../forms/FormDefinition","./../forms/items/TextBoxFormItem","./../forms/items/TextAreaFormItem","./../forms/items/LabelFormItem","./../essentials/MapServiceConstants"],function(e,t,i,r,n,s,a,o,l,u,c){"use strict";function p(e){switch(e){case"esriJobNew":return 0;case"esriJobSubmitted":return 1;case"esriJobWaiting":return 2;case"esriJobExecuting":return 3;case"esriJobSucceeded":return 4;case"esriJobFailed":return 5;case"esriJobTimedOut":return 6;case"esriJobCancelling":return 7;case"esriJobCancelled":return 8;case"esriJobDeleting":return 9;case"esriJobDeleted":return 10;default:return-1}}Object.defineProperty(t,"__esModule",{value:!0}),t.getPropertyIgnoreCase=function(e,t){for(var i in e)if(e.hasOwnProperty(i)&&i.toLowerCase()===t.toLowerCase())return i;return null},t.handleReport=function(e){var t=e.getValue("MapServiceId"),a=e.getValue("LayerId"),o=e.getValue("LayerName"),l=e.getValue("ReportId"),u=null,c=e.getSite();if(c&&t&&(a||o)&&l){var p=i.findMapServiceById(c,t);if(p){var h=null;a?h=p.findLayerById(a):o&&(h=p.findLayerByName(o)),null!=h&&(u=h.findReportById(l))}}if(u){var d=new esri.tasks.Query,f=new r.ReportParameters,y=e.getValue("ShowOpenReport"),m=e.getValue("Geometry"),v=e.getValue("OutSpatialReference"),g=e.getValue("Text"),_=e.getValue("Where"),S=e.getValue("OutputFormat"),b=e.getValue("Resolution"),I=e.getValue("CustomExtent"),w=e.getValue("SpatialRelationship"),x=e.getValue("ReportExtentType"),E=e.getValue("NotificationEmailAddress"),L=e.getValue("TextFields");if(x||(x=r.ReportParameters.CURRENT_EXTENT),f.extentType=x,S&&(f.outputFormat=S),u.textFields)for(var T in u.textFields)if(u.textFields.hasOwnProperty(T)){var M=u.textFields[T],D=function(e){var t=null;if(L&&e)for(var i=0;i<L.length;i++){var r=L[i];if(r.Key===e.displayName||"tf_"+r.Key===e.id||r.Key===e.id){t=r;break}}return t}(M);null!=D?f.fields.push(new n.TextField(M.id,M.displayName,D.Value,M.multiline)):f.fields.push(M)}E&&(f.notificationEmailAddress=E),b&&(f.resolution=b),I&&(f.customExtent=I),d.spatialRelationship=s.RestHelper._convertSpatialRelationshipFromDotnetIndex(w),m&&(d.geometry=m),v&&(d.outSpatialReference=v),g&&(d.text=g),_&&(d.where=_),u.run(d,f,function(t){var i=t?t.href:null;y&&i&&i.length>0&&e.dispatcher().handleOpenReportUrl(i,e),e.setValue("ResultUrl",i),e.completeActivity()},function(t){e.dispatcher().handleError(new Error("Error running report '"+t.message+"'"),e)})}else e.dispatcher().handleError(new Error("Cannot find report '"+l+"'"),e)},t.showDebug=function(e,t,i){var r,n=new a.FormDefinition;if(n.maxHeight.set(600),n.maxWidth.set(500),t?(n.title.set("Debug - Input Arguments for "+e.getDisplayName()),n.containerFormItem.description.set("Input Arguments:"),r=e.getInputNames()):(n.title.set("Debug - Output Arguments for "+e.getDisplayName()),n.containerFormItem.description.set("Output Arguments:"),r=e.getOutputNames()),null!=r&&r.length>0)for(var s=0;s<r.length;s++){var c,p,h=r[s];(c=t?e.getValue(h):e.getOutputValue(h))&&"object"==typeof c&&(c=t?e.getJsonValue(h):e.getOutputJsonValue(h)),!c||String(c).length<100&&-1==String(c).indexOf("\n")?p=new o.TextBoxFormItem(null,n):(p=new l.TextAreaFormItem(null,n)).textboxHeight.set(100),p.label=new u.LabelFormItem(null,n),p.text.set(c),p.textboxWidth.set(300),p.label.text.set(h),p.readOnly.set(!0),n.containerFormItem.formItems.addItem(p)}var d=e.dispatcher();d&&"function"==typeof d._showDebugHandler?d._showDebugHandler(n,i):i&&i()},t.handleGetBrowserUrl=function(e){e.setValue("Url",window.location.href),e.completeActivity()},t.handleExternalDelay=function(e){var t=e.getValue("Milliseconds");if(null==t)throw new Error("External Delay: required Milliseconds argument was not supplied.");setTimeout(function(){e.completeActivity()},t)},t.handleGetExternalTimeInfo=function(e){var t=new Date;e.setValue("UtcOffset",-6e4*t.getTimezoneOffset()),e.completeActivity()},t.handleWaitForGeoprocessorJobComplete=function(e){var t=e.getValue("GeoprocessorUrl"),i=(e.getValue("Token"),e.getValue("ProxyURL"),e.getValue("UpdateDelay")),r=e.getValue("JobId"),n=!1;if(!t)throw new Error("GeoprocessorUrl parameter is missing.");if(!r)throw new Error("JobId parameter is missing.");var s=new esri.tasks.Geoprocessor(t);i>0&&s.setUpdateDelay(i),dojo.connect(s,"onError",function(t){e.setValue("Result",p(esri.tasks.JobInfo.STATUS_FAILED)),e.completeActivity()}),dojo.connect(s,"onStatusUpdate",function(t){if(!n){var a=t.jobStatus;a==esri.tasks.JobInfo.STATUS_CANCELLED||a==esri.tasks.JobInfo.STATUS_DELETED||a==esri.tasks.JobInfo.STATUS_FAILED||a==esri.tasks.JobInfo.STATUS_SUCCEEDED||a==esri.tasks.JobInfo.STATUS_TIMED_OUT?(n=!0,e.setValue("Result",p(a)),e.completeActivity()):window.setTimeout(function(){s.checkJobStatus(r)},i)}}),s.checkJobStatus(r)},t._getJobStatusCode=p,t.handleGetLayerInfoByProperty=function(e){if(!e)throw new Error("Get Map Service Info: required context was not supplied.");var t=e.getValue("PropertyName");if(null==t)throw new Error("Provide a Property Name: No property name available.");var i=e.getSite();if(!i)throw new Error("Set Layer Visibility: No site available.");for(var r=[],n=i.essentialsMap.mapServices,s={mapServiceUrl:"",mapServiceId:"",token:"",isVisible:!1,isDynamic:!1,propertyValue:null,id:"",name:"",displayName:"",layerUrl:""},a=null,o=0;o<n.length;o++)for(var l=n[o].layers.concat(n[o].tables),u=0;u<l.length;u++)if(void 0!=l[u].properties[t]){if(s.mapServiceUrl=n[o].serviceUrl,s.mapServiceId=n[o].id,s.token=n[o].serviceToken,s.isVisible=l[u].isVisible(),s.isDynamic=l[u].isDynamic,s.propertyValue=l[u].properties[t],s.id=l[u].id,s.name=l[u].name,s.displayName=l[u].displayName,n[o].mapServiceType===c.MapServiceType.FEATURE?s.layerUrl=s.mapServiceUrl:s.layerUrl=s.mapServiceUrl+"/"+(s.isDynamic?"dynamicLayer":s.id),s.isDynamic){var p=n[0].serviceLayer;if(p&&p.dynamicLayerInfos)for(var h=0;h<p.dynamicLayerInfos.length;h++)if((a=p.dynamicLayerInfos[h])&&a.id.toString()===s.id){a.source&&(s.layerSourceJson=JSON.stringify(a.source.toJson()));break}}r.push(s),s={mapServiceUrl:"",mapServiceId:"",token:"",isVisible:!1,isDynamic:!1,propertyValue:null,id:"",name:"",displayName:"",layerUrl:""}}e.setValue("LayersInfo",r),e.completeActivity()}})},"geocortex/workflow/DialogActivityHandlers":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleAlert=function(e){e.getValue("Title");var t=e.getValue("Text");alert(t),e.completeActivity()},t.handleConfirm=function(e){var t=e.getValue("Text"),i=confirm(t);null==i&&(i=!1),e.setValue("Result",i),e.completeActivity()},t.handlePrompt=function(e){var t=e.getValue("Description"),i=e.getValue("DefaultText"),r=prompt(t,i);e.setValue("Result",r),e.completeActivity()}})},"geocortex/workflow/ExternalActivityInfo":function(){define(["require","exports","./ArgumentInfo"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t,i,r,n,s,a,o,l){this.debug=!1,this.id=e||null,this.displayName=t||null,this.typeName=i||null,this.instanceId=r||null,this.externalId=n||null,this.syncToken=s||null,this.isComplete=a||!1,this.isAborted=!1,this.inputs=o||[],this.outputs=l||[]}return e.prototype._configureObject=function(e){if(void 0===e.id||void 0===e.displayName||void 0===e.typeName||void 0===e.instanceId)throw new Error("Incorrect external activity info object returned from initialization");var t;if(this.id=e.id,this.displayName=e.displayName,this.typeName=e.typeName,this.instanceId=e.instanceId,this.externalId=e.externalId,this.syncToken=e.syncToken,this.isComplete=e.isComplete,e.debug&&(this.debug=e.debug),this.inputs=[],this.outputs=[],e.inputs)for(t=0;t<e.inputs.length;t++)r=e.inputs[t],(n=new i.ArgumentInfo)._configureObject(r),this.inputs[t]=n;if(e.outputs)for(t=0;t<e.outputs.length;t++){var r=e.outputs[t],n=new i.ArgumentInfo;n._configureObject(r),this.outputs[t]=n}},e}();t.ExternalActivityInfo=r})},"geocortex/workflow/LayerActivityHandlers":function(){define(["require","exports","./MapServiceActivityHandlers","./DefaultActivityHandlers"],function(e,t,i,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleSetLayerProperty=function(e){var t=e.getValue("MapServiceId"),n=e.getValue("LayerId"),s=e.getValue("LayerName"),a=e.getValue("PropertyName"),o=e.getValue("Value");if(!t)throw new Error("Set Layer Property: required MapServiceId argument was not supplied.");if(!n&&!s)throw new Error("Set Layer Property: a LayerId or a LayerName argument must be supplied.");var l=e.getSite();if(!l)throw new Error("Set Layer Property: No site available.");var u=i.findMapServiceById(l,t);if(!u||!u.serviceLayer)throw new Error("Set Layer Property: Unable to find map service with ID '"+t+"'");var c=null;if(!(c=n?u.findLayerById(n):u.findLayerByName(s)))throw new Error("Set Layer Property: Unable to find layer with Name '"+s+"' or ID '"+n+"'.");var p=r.getPropertyIgnoreCase(c,a);if(p)c[p]=o;else{if(!(p=r.getPropertyIgnoreCase(c.properties,a)))throw new Error("Set Layer Property: Layer does not support the property '"+a+"'.");c.properties[p]=o}e.completeActivity()},t.handleGetLayerProperty=function(e){var t=e.getValue("MapServiceId"),n=e.getValue("LayerId"),s=e.getValue("LayerName"),a=e.getValue("PropertyName");if(!t)throw new Error("Get Layer Property: required MapServiceId argument was not supplied.");if(!n&&!s)throw new Error("Get Layer Property: a LayerId or a LayerName argument must be supplied.");var o=e.getSite();if(!o)throw new Error("Get Layer Property: No site available.");var l=i.findMapServiceById(o,t);if(!l||!l.serviceLayer)throw new Error("Get Layer Property: Unable to find map service with ID '"+t+"'");var u;if(!(u=n?l.findLayerById(n):l.findLayerByName(s)))throw new Error("Get Layer Property: Unable to find layer with Name '"+s+"' or ID '"+n+"'.");var c=r.getPropertyIgnoreCase(u,a);if(c)e.setValue("Value",u[c]);else{if(!(c=r.getPropertyIgnoreCase(u.properties,a)))throw new Error("Get Layer Property: Layer does not support the property '"+a+"'.");e.setValue("Value",u.properties[c])}e.completeActivity()},t.handleGetLayerVisibility=function(e){var t=e.getValue("MapServiceId"),r=e.getValue("LayerId"),n=e.getValue("LayerName"),s=e.getValue("EffectiveVisibility");if(!t)throw new Error("Get Layer Visibility: required MapServiceId argument was not supplied.");if(!r&&!n)throw new Error("Get Layer Visibility: a LayerId or a LayerName argument must be supplied.");var a=e.getSite();if(!a)throw new Error("Get Layer Visibility: No site available.");var o=i.findMapServiceById(a,t);if(!o)throw new Error("Get Layer Visibility: Unable to find map service with ID '"+t+"'");var l=null;if(r?l=o.findLayerById(r):n&&(l=o.findLayerByName(n)),!l)throw new Error("Get Layer Visibility: Unable to find layer with ID '"+r+"' in map service with ID '"+t+"'");var u=l.isVisible();if(s&&(u=!1,l.isVisible()&&o.isVisible()&&l.withinScaleRange(null)))for(var c=o.getVisibleLayers(),p=0;p<c.length;p++)if(c[p]==l.id){u=!0;break}e.setValue("Visible",u),e.completeActivity()},t.handleSetLayerVisibility=function(e){var t=e.getValue("MapServiceId"),r=e.getValue("LayerId"),n=e.getValue("LayerName"),s=e.getValue("Visible");if(!t)throw new Error("Set Layer Visibility: required MapServiceId argument was not supplied.");if(!r&&!n)throw new Error("Set Layer Visibility: a LayerId or a LayerName argument must be supplied.");if(null===s)throw new Error("Set Layer Visibility: required Visible argument was not supplied.");var a=e.getSite();if(!a)throw new Error("Set Layer Visibility: No site available.");var o=i.findMapServiceById(a,t);if(!o)throw new Error("Set Layer Visibility: Unable to find map service with ID '"+t+"'");var l=null;if(r){if(!(l=o.findLayerById(r)))throw new Error("Set Layer Visibility: Unable to find layer with ID '"+r+"' in map service with ID '"+t+"'")}else{if(!n)throw new Error("Set Layer Visibility: must define layer ID or name");if(!(l=o.findLayerByName(n)))throw new Error("Set Layer Visibility: Unable to find layer with name '"+n+"' in map service with ID '"+t+"'")}l.setVisibility(s),e.completeActivity()},t.handleGetLayerDefinition=function(e){var t=e.getValue("MapServiceId"),r=e.getValue("LayerId"),n=e.getValue("LayerName");if(!t)throw new Error("Get Layer Definition: required MapServiceId argument was not supplied.");if(!r&&!n)throw new Error("Get Layer Definition: a LayerId or a LayerName argument must be supplied.");var s=null,a=e.getSite();if(a){var o=i.findMapServiceById(a,t);if(o&&o.serviceLayer){if(!r&&n){var l=o.findLayerByName(n);if(!l)throw new Error("Set Layer Definition: Unable to find layer with Name '"+n+"'.");r=l.id}o.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer?o.serviceLayer.layerDefinitions&&(s=o.serviceLayer.layerDefinitions[parseInt(r)]):o.serviceLayer instanceof esri.layers.FeatureLayer&&(s=o.serviceLayer.getDefinitionExpression())}}e.setValue("Definition",s),e.completeActivity()},t.handleSetLayerDefinition=function(e){var t=e.getValue("MapServiceId"),r=e.getValue("LayerId"),n=e.getValue("LayerName"),s=e.getValue("Definition");if(!t)throw new Error("Set Layer Definition: required MapServiceId argument was not supplied.");if(!r&&!n)throw new Error("Set Layer Definition: a LayerId or a LayerName argument must be supplied.");var a=e.getSite();if(!a)throw new Error("Set Layer Visibility: No site available.");var o=i.findMapServiceById(a,t);if(!o||!o.serviceLayer)throw new Error("Set Layer Definition: Unable to find map service with ID '"+t+"'");if(!r&&n){var l=o.findLayerByName(n);if(!l)throw new Error("Set Layer Definition: Unable to find layer with Name '"+n+"'.");r=l.id}if(o.serviceLayer instanceof esri.layers.ArcGISDynamicMapServiceLayer){var u=o.serviceLayer;u.layerDefinitions||(u.layerDefinitions=[]),u.layerDefinitions[parseInt(r)]=s,u.setLayerDefinitions(u.layerDefinitions,!0)}else{if(!(o.serviceLayer instanceof esri.layers.FeatureLayer))throw new Error("Set Layer Definition: Map service type does not support layer definitions.");o.serviceLayer.setDefinitionExpression(s)}e.completeActivity()},t.handleGetGraphicsLayerContent=function(e){var t=e.getValue("GraphicsLayerId"),i=e.getValue("GeometryType"),r=null;null!==i&&(0===i?r="extent":1===i?r="multipoint":2===i?r="point":3===i?r="polygon":4===i&&(r="polyline"));var n=e.getEsriMap();if(null!=n&&null!=n.graphicsLayerIds)for(var s=0;s<n.graphicsLayerIds.length;s++)if(t==n.graphicsLayerIds[s]){var a=n.getLayer(n.graphicsLayerIds[s]);if(null!=a&&null!=a.graphics){for(var o=new esri.tasks.FeatureSet,l=0;l<a.graphics.length;l++){var u=a.graphics[l];if(null!==r){if(null===u.geometry)continue;if(r!==u.geometry.type)continue}var c=new esri.Graphic(u.geometry,null,u.attributes,null);o.features.push(c)}e.setValue("Features",o)}break}e.completeActivity()},t.handleUpdateGraphicsLayer=function(e){var t=e.getValue("GraphicsLayerId"),r=!!e.getValue("RemoveAllFeatures"),n=e.getValue("FeatureSet"),s=e.getValue("RendererJson"),a=e.getEsriMap();if(null==a)throw new Error("Update Graphics Layer: No map available.");var o=!1,l=i.findMapServiceByMap(a,t);if(l){if(!(l instanceof esri.layers.GraphicsLayer))throw new Error("Update Graphics Layer: The layer '"+t+"' is not a GraphicsLayer")}else l=new esri.layers.GraphicsLayer({id:t}),o=!0;try{if(l.suspend(),r&&l.clear(),n&&n.features)for(var u=n.features.length-1;u>=0;--u)l.add(n.features[u]);s&&(l.renderer=esri.renderer.fromJson(JSON.parse(s))),o&&a.addLayer(l)}finally{l.resume()}e.completeActivity()}})},"geocortex/workflow/MapActivityHandlers":function(){define(["require","exports","./../essentials/utilities/SiteResourceIdComparer","./../essentials/LayerType","./../essentials/ReportParameters","./../essentials/Resolution","./../essentials/Scale","./../essentials/TextField"],function(e,t,i,r,n,s,a,o){"use strict";var l;Object.defineProperty(t,"__esModule",{value:!0}),(l=t.MapActivityHandlers||(t.MapActivityHandlers={})).handleRefreshMap=function(e){var t=e.getValue("MapServiceId");if(null==e.getEsriMap())throw new Error("Refresh Map: no map available.");var r=function(e){var t=e.serviceLayer;if("function"==typeof t.refresh)if("boolean"==typeof t.disableClientCaching){var i=t.disableClientCaching;t.disableClientCaching=!0,t.refresh(),t.disableClientCaching=i}else t.refresh()},n=e.workflow().site.essentialsMap.mapServices;if(t){var s=i.SiteResourceIdComparer.lookUp(n,t);s&&r(s)}else dojo.forEach(n,function(e){r(e)});e.completeActivity()},l.handleGetMapExtent=function(e){var t=e.getEsriMap();if(null==t)throw new Error("Get Map Extent: No map available.");e.setValue("Extent",t.extent),e.completeActivity()},l.handleGetMapInfo=function(e){var t=e.getEsriMap();if(null==t)throw new Error("Get Map Info: No map available.");e.setValue("Extent",t.extent),e.setValue("Scale",esri.geometry.getScale(t)),e.setValue("SpatialReference",t.spatialReference),e.setValue("Height",t.height),e.setValue("Width",t.width);var i=[];null!=t.layerIds&&(i=i.concat(t.layerIds)),null!=t.graphicsLayerIds&&(i=i.concat(t.graphicsLayerIds)),e.setValue("MapServiceIds",i),e.completeActivity()},l.handleSetMapExtent=function(e){var t=e.getValue("Extent");if(null==t)throw new Error("Set Map Extent: required Extent argument was not supplied.");var i=e.getEsriMap();if(null==i)throw new Error("Set Map Extent: No map available.");t.spatialReference&&(t.spatialReference.wkid||t.spatialReference.wkt)||(t.spatialReference=i.spatialReference);var r=e.getSite();r&&r.essentialsMap?r.essentialsMap.extentManager.setExtentWithPriority(t,10):i.setExtent(t),e.completeActivity()},l.handleCaptureGeometry=function(e){function t(t,r,n){n.deactivate(),dojo.disconnect(r),i.setDrawObjectContext(null),e.setValue("Result",t),e.completeActivity()}var i=e.dispatcher();if(!i.abortMapBasedActivity())throw new Error("Could not deactivate current map based activity.");var r=e.getValue("CaptureType"),n=e.getEsriMap();if(null==n)throw new Error("Capture Geometry: No map available.");if("function"!=typeof esri.toolbars.Draw)throw new Error('dojo.require("esri.toolbars.draw") must be added to your client code to use CaptureGeometry activity.');var s=new esri.toolbars.Draw(n),a=dojo.connect(s,"onDrawEnd",dojo.hitch(a,function(e){t(e,a,s)})),o=!0,l=function(e){var i;switch(r){case 0:i=esri.toolbars.Draw.EXTENT;break;case 1:i=esri.toolbars.Draw.FREEHAND_POLYGON;break;case 2:i=esri.toolbars.Draw.FREEHAND_POLYLINE;break;case 3:i=esri.toolbars.Draw.LINE;break;case 4:i=esri.toolbars.Draw.POINT;break;case 5:i=esri.toolbars.Draw.MULTI_POINT;break;case 6:i=esri.toolbars.Draw.POLYGON;break;case 7:i=esri.toolbars.Draw.POLYLINE;break;case 8:t(n.extent,a,s),o=!1;break;default:i=esri.toolbars.Draw.EXTENT}return i}();o&&s.activate(l),i.setDrawObjectContext({activityContext:e,toolbar:s,drawEvent:a})},l._pickSupported=function(e,t){if(!e||e.length<=0)return null;if(t)for(var i=t.toUpperCase(),r=0;r<e.length;r++){var n=e[r];if(n&&n.toUpperCase()===i)return e[r]}return e[0]},l.handleIntersectLayers=function(e){var t,i,n,s,a,o=[],l=[],u=[],c=[],p=null,h=null,d=!1,f=null,y=-1,m=e.getValue("InputLayers");if(m&&m.length>0)for(n=0;n<m.length;n++)(y=m[n].lastIndexOf("\\\\"))>=0&&(m[n]=m[n].substring(y+"\\\\".length));else e.dispatcher().handleError(new Error("Intersect Layers: no input layers provided."),e);for((s=e.getSite())||e.dispatcher().handleError(new Error("Intersect Layers: no site available."),e),(a=s.essentialsMap)||e.dispatcher().handleError(new Error("Intersect Layers: no map available."),e),(!a.mapServices||a.mapServices.length<=0)&&e.dispatcher().handleError(new Error("Intersect Layers: no map service is configured for the map."),e),t=0;t<a.mapServices.length;t++){p=a.mapServices[t].layers,f=[];var v=m.length,g="";for(p.forEach(function(e){g=e.name;for(var t=0;t<v;++t)if(g===m[t]){f.push(e);break}}),i=0;i<f.length;i++){switch(d=!1,(h=f[i]).type){case r.LayerType.FEATURE_LAYER:l.push(h.name),d=!0;break;case r.LayerType.GROUP_LAYER:u.push(h.name),d=!0;break;case r.LayerType.RASTER_LAYER:c.push(h.name),d=!0}d&&o.push(h.name)}}e.setValue("OutputLayers",o),e.setValue("FeatureLayers",l),e.setValue("GroupLayers",u),e.setValue("RasterLayers",c),e.completeActivity()},l.handleExportMap=function(e){var t,i=e.getValue("TargetSpatialReference"),r=e.getValue("CustomExtent"),o=e.getValue("Resolution"),u=e.getValue("OutputFormat"),c=e.getValue("Scale"),p=e.getValue("ImageHeight"),h=e.getValue("ImageWidth"),d=e.getValue("UseTransparentBackground"),f=null,y=null,m=null;(f=e.getSite())||e.dispatcher().handleError(new Error("Export Map: no site available."),e),(t=f.getMap())||e.dispatcher().handleError(new Error("Export Map: no map available."),e),(y=f.essentialsMap)||e.dispatcher().handleError(new Error("Export Map: no map available."),e),(m=new n.ReportParameters).outputFormat=l._pickSupported(y.supportedExportFormats,u),o&&(m.resolution=new s.Resolution("",o)),c&&(m.scale=new a.Scale("",c)),m.imageHeight=p||t.height,m.imageWidth=h||t.width,r&&(m.customExtent=r),m.extentType=r?n.ReportParameters.CUSTOM_EXTENT:n.ReportParameters.CURRENT_EXTENT,m.useTransparentBackground=d,i&&(m.targetSpatialReference=i),t&&m.populateMapGraphicsLayers(t),y.exportMap(m,function(t){var i=t?t.href:null;e.setValue("ResultUrl",i),e.completeActivity()},function(t){e.dispatcher().handleError(new Error("Error exporting map '"+t.message+"'"),e)})},l.handlePrintMap=function(e){var t=e.getValue("TargetSpatialReference"),i=e.getValue("TextFields"),r=e.getValue("CustomExtent"),u=e.getValue("NotificationEmailAddress"),c=e.getValue("Resolution"),p=e.getValue("OutputFormat"),h=e.getValue("Scale"),d=e.getValue("PrintTemplateId"),f=e.getValue("GridId"),y=null;(y=e.getSite())||e.dispatcher().handleError(new Error("Print Map: no site available."),e),y.getMap()||e.dispatcher().handleError(new Error("Print Map: no map available."),e);var m=y.findPrintTemplateById(d);m||e.dispatcher().handleError(new Error("Print Map: unable to find print template '"+d+"'."),e),m.isPrinting()&&e.dispatcher().handleError(new Error("Print Map: unable to perform print operation because print template '"+d+"' is busy."),e);var v=new n.ReportParameters;if(v.outputFormat=l._pickSupported(m.supportedOutputFormats,p),c&&(v.resolution=new s.Resolution("",c)),h&&(v.scale=new a.Scale("",h)),u&&(v.notificationEmailAddress=u),r&&(v.customExtent=r),v.extentType=r?n.ReportParameters.CUSTOM_EXTENT:n.ReportParameters.CURRENT_EXTENT,t&&(v.targetSpatialReference=t),m.textFields&&m.textFields.length>0&&i)for(var g=0;g<i.length;g++)if(i[g])for(var _=0;_<m.textFields.length;_++)if(i[g].Key===m.textFields[_].displayName){var S=new o.TextField(m.textFields[_].id,"",i[g].Value,!1);v.fields.push(S)}if(f){var b=dojo.filter(m.grids,function(e){return e.id==f});b.length>0&&(v.grid=b[0])}m.print(v,function(t){var i=t?t.href:null;e.setValue("ResultUrl",i),e.completeActivity()},function(t){e.dispatcher().handleError(new Error("Error printing map '"+t.message+"'"),e)})}})},"geocortex/workflow/MapServiceActivityHandlers":function(){define(["require","exports","./../essentials/utilities/SiteResourceIdComparer"],function(e,t,i){"use strict";function r(e,t){return t&&e&&e.essentialsMap&&e.essentialsMap.mapServices?i.SiteResourceIdComparer.lookUp(e.essentialsMap.mapServices,t):null}function n(e,t){if(!e||!t)return null;if(null!=e.layerIds)for(r=0;r<e.layerIds.length;r++)if(null!=(n=e.getLayer(e.layerIds[r]))&&i.SiteResourceIdComparer.equals(n.id,t))return n;if(null!=e.graphicsLayerIds)for(var r=0;r<e.graphicsLayerIds.length;r++){var n=e.getLayer(e.graphicsLayerIds[r]);if(null!=n&&i.SiteResourceIdComparer.equals(n.id,t))return n}return null}Object.defineProperty(t,"__esModule",{value:!0}),t.findMapServiceById=r,t.findMapServiceByMap=n,t.handleRemoveMapService=function(e){var t=e.getValue("MapServiceId"),i=e.getEsriMap();if(null==i)throw new Error("Remove Map Service: No map available.");var r=n(i,t);if(r){i.removeLayer(r);var s=e.getSite();s&&s.essentialsMap&&s.essentialsMap.mapServices&&s.essentialsMap.removeServiceLayer(r)}e.completeActivity()},t.handleSetImageServiceInfo=function(t){var i=t.getValue("ImageServiceId"),r=t.getValue("BandIds"),s=t.getValue("MosaicRule"),a=t.getValue("RenderingRule"),o=t.getEsriMap();if(null==o)throw new Error("Set Image Service Info: No map available.");e(["esri/layers/RasterFunction"],function(e){var l=n(o,i);if(l instanceof esri.layers.ArcGISImageServiceLayer){var u=l;if(r&&u.setBandIds(r,!0),s){var c=new esri.layers.MosaicRule(s);c.method||(c=u.defaultMosaicRule),u.setMosaicRule(c,!0)}if(a){var p=new esri.layers.RasterFunction(a);p.functionName||(p=null),u.setRenderingRule(p,!0)}u.refresh()}t.completeActivity()})},t.handleSetMapServiceVisibility=function(e){var t=e.getValue("MapServiceId"),i=e.getValue("Visible");if(null==t)throw new Error("Set Map Service Visibility: required MapServiceId argument was not supplied.");if(null==i)throw new Error("Set Map Service Visibility: required Visible argument was not supplied.");var s=e.getEsriMap(),a=e.getSite();if(null==s)throw new Error("Set Map Service Visibility: No map available.");var o=null;if(null==(o=n(s,t)))throw new Error("Set Map Service Visibility: Unable to find map service with ID '"+t+"'");if(o.setVisibility(i),e.completeActivity(),a&&t){var l=r(a,t);dojo.publish("MapServiceVisibilityChangedEvent",l)}},t.handleGetMapServiceInfo=function(e){if(!e)throw new Error("Get Map Service Info: required context was not supplied.");var t=e.getValue("MapServiceId"),i=e.getValue("LayerName");if(null==t)throw new Error("Get Map Service Info: required MapServiceId argument was not supplied.");var s=null,a=null,o=null,l=null,u=!1,c=e.getEsriMap();if(null==c)throw new Error("Get Map Service Info: No map available.");var p=e.getSite(),h=null,d=null;if(null!=p&&null!=p.essentialsMap&&null!=(d=r(p,t))&&(h=d.serviceLayer,s=d.serviceUrl,a=d.findServiceToken(),u=d.isVisible()),null==h&&(h=n(c,t))&&(s=h.url,"boolean"==typeof h.visible&&(u=h.visible)),null!=i){var f=!1;if(h.supportsDynamicLayers&&h.dynamicLayerInfos)for(var y=h.dynamicLayerInfos,m=0;m<y.length;m++)if((v=y[m]).name===i||"{0}".format(v.id)===i){f=!0,o="dynamicLayer",l=v.source;break}if(!f&&h.layerInfos)for(y=h.layerInfos,m=0;m<y.length;m++){var v=y[m];if(null!=v&&null!=v.id&&v.name==i){f=!0,o=v.id;break}}if(!f&&d){var g=d.findLayerOrTableByName(i);g&&(f=!0,o=g.id)}}e.setValue("MapServiceUrl",s),e.setValue("Token",a),e.setValue("LayerId",o),e.setValue("Source",l),e.setValue("Visible",u),e.completeActivity()},t.handleSetMapServiceProperty=function(e){var t="Set Map Service Property",i=e.getValue("MapServiceId"),r=e.getValue("PropertyName"),s=e.getValue("Value");if(!i)throw new Error("{0}: required MapServiceId argument was not supplied.".format(t));if(!r)throw new Error("{0}: required PropertyName argument was not supplied.".format(t));var a=e.getEsriMap();if(!a)throw new Error("{0}: no map available.".format(t));var o=n(a,i);if(!o)throw new Error("{0}: unable to find map service with ID '{1}'.".format(t,i));if("gdbversion"===r.toLowerCase())if(o instanceof esri.layers.FeatureLayer){if(!o.isDataVersioned)throw new Error("{0}: map service with ID '{1}' is not versioned.".format(t,i));o.setGDBVersion(s)}else{if(!(o instanceof esri.layers.ArcGISDynamicMapServiceLayer))throw new Error("{0}: map service with ID '{1}' does not support GDB version.".format(t,i));o.setGDBVersion(s)}else if("visible"===r.toLowerCase())o.setVisibility(s);else{r="set"+r.toLowerCase();var l=null;for(var u in o)if(u.toLowerCase()===r){l=u;break}if(!l)throw new Error("{0}: map service property '{1}' does not exist.".format(t,r));o[l](s)}e.completeActivity()}})},"geocortex/workflow/NativeActivityHandlers":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleGetCurrentPosition=function(e){if(!navigator.geolocation)return e.setValue("ErrorCode",2),e.setValue("ErrorMessage","Geolocation is not supported."),void e.completeActivity();var t={enableHighAccuracy:e.getValue("EnableHighAccuracy"),timeout:e.getValue("Timeout")||2e4,maximumAge:e.getValue("MaximumAge")};navigator.geolocation.getCurrentPosition(function(t){e.setValue("Latitude",t.coords.latitude),e.setValue("Longitude",t.coords.longitude),e.setValue("Altitude",t.coords.altitude),e.setValue("Accuracy",t.coords.accuracy),e.setValue("AltitudeAccuracy",t.coords.altitudeAccuracy),e.setValue("Heading",t.coords.heading),e.setValue("Speed",t.coords.speed),e.setValue("Timestamp",t.timestamp),e.completeActivity()},function(t){e.setValue("ErrorCode",t.code),e.setValue("ErrorMessage",t.message),e.completeActivity()},t)},t.handleGetPhoto=function(e){if(!navigator.camera)return e.setValue("Message","camera is not supported."),void e.completeActivity();var t={quality:e.getValue("Quality"),destinationType:e.getValue("DestinationType"),sourceType:e.getValue("SourceType"),allowEdit:e.getValue("AllowEdit"),encodingType:e.getValue("EncodingType"),targetWidth:e.getValue("TargetWidth"),targetHeight:e.getValue("TargetHeight")};navigator.camera.getPicture(function(t){e.setValue("ImageData",t),e.completeActivity()},function(t){e.setValue("Message",t),e.completeActivity()},t)}})},"geocortex/workflow/SimpleActivityDispatcher":function(){define(["require","exports","./DefaultActivityDispatcher"],function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t,r,n,s,a,o,l){this._defaultActivityDispatcher=new i.DefaultActivityDispatcher,this._drawObjectContext=null,this.isBusy=null,this._dispatchFunction=e||null,this._handleErrorFunction=t||null,this._activityBeginFunction=r||null,this._activityCompleteFunction=n||null,this._workflowCompleteFunction=s||null,this._workflowAbortFunction=a||null,this._webRequestBeginFunction=o||null,this._webRequestCompleteFunction=l||null}return e.prototype.dispatch=function(e){this._defaultActivityDispatcher.canHandleActivity(e)?this._defaultActivityDispatcher.dispatch(e):null!=this._dispatchFunction&&this._dispatchFunction(e)},e.prototype.handleError=function(e,t){null!=this._handleErrorFunction&&this._handleErrorFunction(e,t)},e.prototype.abortMapBasedActivity=function(){if(this._drawObjectContext){if(!this._drawObjectContext.toolbar||!this._drawObjectContext.drawEvent||!this._drawObjectContext.activityContext)return!1;this._drawObjectContext.toolbar.deactivate(),dojo.disconnect(this._drawObjectContext.drawEvent),this._drawObjectContext.activityContext.abortActivity(),this._drawObjectContext=null}return!0},e.prototype.setDrawObjectContext=function(e){this._drawObjectContext=e},e.prototype.activityBegin=function(e){null!=this._activityBeginFunction&&this._activityBeginFunction(e)},e.prototype.activityComplete=function(e){null!=this._activityCompleteFunction&&this._activityCompleteFunction(e)},e.prototype.activityAbort=function(e){this.workflowAbort(e,e.workflow())},e.prototype.webRequestBegin=function(e,t){null!=this._webRequestBeginFunction&&this._webRequestBeginFunction(e,t)},e.prototype.webRequestComplete=function(e,t){null!=this._webRequestCompleteFunction&&this._webRequestCompleteFunction(e,t)},e.prototype.workflowComplete=function(e,t){null!=this._workflowCompleteFunction&&this._workflowCompleteFunction(e,t)},e.prototype.workflowAbort=function(e,t){null!=this._workflowAbortFunction&&this._workflowAbortFunction(e,t)},e.prototype.handleOpenReportUrl=function(e,t){window.open(e)},e}();t.SimpleActivityDispatcher=r})},"geocortex/workflow/WorkflowControllerProxy":function(){define(["require","exports","./WorkflowState","./ActivityContext","./../geocortex","./DefaultActivityHandlers","./ExternalActivityInfo","./ArgumentInfo"],function(e,t,i,r,n,s,a,o){"use strict";function l(e,t,i,r,s){var a={};if(null==e){var o=new Error("workflow cannot be null");if(null!=t)return void t.handleError(o,null);throw o}var l=e.url+"/run";if(r&&(p(r),a.inargs=JSON.stringify(r)),null!=i){for(var c=i.pendingExternalActivities,h=0;h<c.length;h++)p(c[h].outputs);a.workflow=JSON.stringify(i)}a=n.encodeJson(dojo.mixin({f:"json"},a)),null!=t&&(t.isBusy=!0),t.webRequestBegin(l,e),n.request({url:l,content:a,load:dojo.hitch(this,function(i){t.webRequestComplete(l,e),u(i,e,t)}),error:dojo.hitch(this,function(e){if(null==t)throw e;t.isBusy=!1,t.handleError(e,s)}),callbackParamName:"CallBack"},{usePost:!0})}function u(e,t,n){if(null!=n&&(n.isBusy=!1),e)if(e.error){var a=new Error("Error running workflow: "+e.error.message);c(n,a)}else{var o=new i.WorkflowState(e.instanceId,e.status,d(e.pendingExternalActivities),f(e.outputs),e.workflowData,e.instanceData);if("Completed"==o.status)null!=n&&n.workflowComplete(o.outputs,t);else if("WaitingForExternalActivities"==o.status){var l=o.pendingExternalActivities;if(null!=l)for(var u=0;u<l.length;u++){var h=new r.ActivityContext(n,u,t,o);null!=n&&n.activityBegin(h);var m=l[u];p(m.inputs);try{"debugger"===h.getActivityExternalId()||m&&m.debug?s.showDebug(h,!0,function(){y(h)}):y(h)}catch(a){c(n,a,h)}}}}}function c(e,t,i){if(null==e)throw t;e.handleError(t,i||null)}function p(e){if(null!=e)for(var t=0;t<e.length;t++){var i=function(e){var t=e,i=e.indexOf(",");return i>0&&(t=e.substring(0,i)),t},r=i(e[t].runtimeTypeName);if(e[t].value=h(e[t].value,r),null==e[t].value){var n=i(e[t].typeName);e[t].value=h(e[t].value,n)}}}function h(e,t){var i=e;switch(t){case"ESRI.ArcGIS.Client.Tasks.FeatureSet":var r=e;if(null!=r){var n=new esri.tasks.FeatureSet(r);n.features=n.features||[],i=n}break;case"ESRI.ArcGIS.Client.Geometry.Geometry":case"ESRI.ArcGIS.Client.Geometry.Envelope":case"ESRI.ArcGIS.Client.Geometry.MapPoint":case"ESRI.ArcGIS.Client.Geometry.MultiPoint":case"ESRI.ArcGIS.Client.Geometry.Polygon":case"ESRI.ArcGIS.Client.Geometry.Polyline":var s=e;if(null!=s){var a=esri.geometry.fromJson(s);a&&a.spatialReference&&!s.spatialReference&&(a.spatialReference=null),i=a}break;case"ESRI.ArcGIS.Client.Geometry.SpatialReference":var o=e;null!=o&&(i=new esri.SpatialReference(o));break;case"ESRI.ArcGIS.Client.LayerMapSource":(l=e)&&(i=new esri.layers.LayerMapSource(l));break;case"ESRI.ArcGIS.Client.LayerDataSource":var l=e;l&&(i=new esri.layers.LayerDataSource(l));break;case"ESRI.ArcGIS.Client.TimeExtent":if(e instanceof Array){var u=e;if(u.length>0){var c=new Date(u[0]),p=u.length>1?new Date(u[1]):c;i=new esri.TimeExtent(c,p)}}break;case"ESRI.ArcGIS.Client.Graphic":e&&(i=e.toJson());break;case"System.DateTime":e instanceof Date&&(i="/Date("+e.getTime()+")/")}return i}function d(e){var t=[];if(null!=e)for(var i=0;i<e.length;i++){var r=e[i],n=new a.ExternalActivityInfo;n._configureObject(r),t[i]=n}return t}function f(e){var t=[];if(null!=e)for(var i=0;i<e.length;i++){var r=e[i],n=new o.ArgumentInfo;n._configureObject(r),t[i]=n}return t}function y(e){if(null==e.dispatcher())throw new Error("Unhandled activity: "+e.getActivityTypeName());e.dispatcher().dispatch(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.startWorkflow=function(e,t,i){l(e,t,null,i,null)},t._executeWorkflow=l,t._processWorkflowResults=u,t._handleErrorInternal=c,t._preProcessArguments=p,t._getObjectFromJsonWithType=h,t._getExternalActivities=d,t._getArguments=f,t._dispatch=y})},"geocortex/workflow/WorkflowState":function(){define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(e,t,i,r,n,s){this.instanceId=e,this.status=t,this.pendingExternalActivities=i,this.outputs=r,this.workflowData=n,this.instanceData=s};t.WorkflowState=i})}}}),require({cache:{"geocortex/workflow":function(){}}});
